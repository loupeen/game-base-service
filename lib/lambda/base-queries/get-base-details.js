"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const shared_mocks_1 = require("../../lib/shared-mocks");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const logger = new shared_mocks_1.StructuredLogger('GetBaseDetailsHandler');
const PLAYER_BASES_TABLE = process.env.PLAYER_BASES_TABLE ?? '';
const BASE_UPGRADES_TABLE = process.env.BASE_UPGRADES_TABLE ?? '';
/**
 * Get Base Details Handler
 *
 * Provides comprehensive base information following SOLID principles:
 * - Single Responsibility: Only handles detailed base information retrieval
 * - Open/Closed: Extensible for additional detail types
 * - Liskov Substitution: Consistent detail interface for all base types
 * - Interface Segregation: Focused on specific base detail needs
 * - Dependency Inversion: Depends on shared data access patterns
 *
 * Features:
 * - Complete base information with all stats
 * - Active upgrade information
 * - Movement status and timing
 * - Historical upgrade information
 * - Territory and alliance context
 * - Resource production calculations
 */
const handler = async (event) => {
    return (0, shared_mocks_1.withErrorHandling)(async () => {
        logger.info('Processing get base details request', {
            requestId: event.requestContext?.requestId
        });
        // Extract parameters from path
        const playerId = event.pathParameters?.playerId;
        const baseId = event.pathParameters?.baseId;
        if (!playerId || !baseId) {
            throw new shared_mocks_1.GameEngineError('Missing required parameters: playerId and baseId', 'INVALID_PARAMETERS', { playerId, baseId });
        }
        // Get base details
        const baseDetails = await getBaseDetails(playerId, baseId);
        // Get active upgrades
        const activeUpgrades = await getActiveUpgrades(playerId, baseId);
        // Calculate additional metrics
        const metrics = calculateBaseMetrics(baseDetails, activeUpgrades);
        logger.info('Base details retrieved successfully', {
            playerId,
            baseId,
            baseType: baseDetails.baseType,
            status: baseDetails.status
        });
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                success: true,
                data: {
                    base: baseDetails,
                    activeUpgrades: activeUpgrades,
                    metrics: metrics
                }
            })
        };
    }, logger);
};
exports.handler = handler;
async function getBaseDetails(playerId, baseId) {
    try {
        const command = new lib_dynamodb_1.GetCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: { playerId, baseId }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError('Base not found', 'BASE_NOT_FOUND', { playerId, baseId });
        }
        const base = response.Item;
        // Enrich base data with computed fields
        const enrichedBase = {
            ...base,
            // Status information
            isActive: base.status === 'active',
            isBuilding: base.status === 'building',
            isMoving: base.status === 'moving',
            isDestroyed: base.status === 'destroyed',
            // Timing information
            ageInDays: Math.floor((Date.now() - base.createdAt) / (24 * 60 * 60 * 1000)),
            lastActiveHours: Math.floor((Date.now() - base.lastActiveAt) / (60 * 60 * 1000)),
            // Coordinate information
            location: `${base.coordinates.x}, ${base.coordinates.y}`,
            mapSection: base.mapSectionId,
            // Movement information
            canMove: base.status === 'active' && (!base.lastMovedAt ||
                (Date.now() - base.lastMovedAt) >= (60 * 60 * 1000)),
            movementCooldownRemaining: base.lastMovedAt ?
                Math.max(0, (60 * 60 * 1000) - (Date.now() - base.lastMovedAt)) : 0,
            // Building/Movement completion times
            ...(base.status === 'building' && base.buildCompletionTime && {
                buildingCompletesIn: Math.max(0, base.buildCompletionTime - Date.now()),
                buildingCompletesAt: new Date(base.buildCompletionTime).toISOString()
            }),
            ...(base.status === 'moving' && base.arrivalTime && {
                arrivalIn: Math.max(0, base.arrivalTime - Date.now()),
                arrivalAt: new Date(base.arrivalTime).toISOString()
            }),
            // Resource production (calculated based on base stats)
            resourceProduction: {
                gold: calculateGoldProduction(base),
                food: calculateFoodProduction(base),
                materials: calculateMaterialsProduction(base),
                energy: calculateEnergyProduction(base)
            },
            // Defense calculations
            defenseRating: calculateDefenseRating(base),
            // Storage information
            storageCapacity: base.stats?.storage ?? 0,
            // Alliance context
            ...(base.allianceId && {
                allianceId: base.allianceId,
                // TODO: Get alliance name and other details from alliance service
            })
        };
        return enrichedBase;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to retrieve base details', 'BASE_RETRIEVAL_ERROR', { playerId, baseId, error: error.message });
    }
}
async function getActiveUpgrades(playerId, baseId) {
    try {
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: BASE_UPGRADES_TABLE,
            KeyConditionExpression: 'playerId = :playerId',
            FilterExpression: 'baseId = :baseId AND #status = :status',
            ExpressionAttributeNames: {
                '#status': 'status'
            },
            ExpressionAttributeValues: {
                ':playerId': playerId,
                ':baseId': baseId,
                ':status': 'in_progress'
            },
            ScanIndexForward: false // Most recent first
        });
        const response = await docClient.send(command);
        return (response.Items ?? []).map(upgrade => ({
            ...upgrade,
            // Timing information
            completesIn: Math.max(0, upgrade.completionTime - Date.now()),
            completesAt: new Date(upgrade.completionTime).toISOString(),
            progress: Math.min(1, (Date.now() - upgrade.startedAt) / (upgrade.completionTime - upgrade.startedAt)),
            // Upgrade details
            levelChange: `${String(upgrade.fromLevel)} â†’ ${String(upgrade.toLevel)}`,
            timeRemaining: Math.max(0, upgrade.completionTime - Date.now())
        }));
    }
    catch (error) {
        logger.warn('Failed to retrieve active upgrades', {
            playerId,
            baseId,
            error: error.message
        });
        return [];
    }
}
function calculateBaseMetrics(base, activeUpgrades) {
    const now = Date.now();
    return {
        // Overall base score (composite metric)
        baseScore: calculateBaseScore(base),
        // Efficiency metrics
        efficiency: {
            productionEfficiency: calculateProductionEfficiency(base),
            defenseEfficiency: calculateDefenseEfficiency(base),
            storageEfficiency: calculateStorageEfficiency(base)
        },
        // Activity metrics
        activity: {
            lastActiveHours: Math.floor((now - base.lastActiveAt) / (60 * 60 * 1000)),
            totalUpgrades: activeUpgrades.length,
            isActivelyDeveloping: activeUpgrades.length > 0 ||
                (base.lastActiveAt && (now - base.lastActiveAt) < (24 * 60 * 60 * 1000))
        },
        // Strategic metrics
        strategic: {
            territoryValue: calculateTerritoryValue(base),
            defensivePosition: calculateDefensivePosition(base),
            resourceAccessibility: calculateResourceAccessibility(base)
        },
        // Recommendations
        recommendations: generateRecommendations(base, activeUpgrades)
    };
}
// Calculation helper functions
function calculateGoldProduction(base) {
    const baseProduction = base.stats?.production ?? 0;
    const levelMultiplier = 1 + (base.level * 0.1);
    return Math.floor(baseProduction * levelMultiplier * 0.4); // 40% of production goes to gold
}
function calculateFoodProduction(base) {
    const baseProduction = base.stats?.production ?? 0;
    const levelMultiplier = 1 + (base.level * 0.1);
    return Math.floor(baseProduction * levelMultiplier * 0.3); // 30% to food
}
function calculateMaterialsProduction(base) {
    const baseProduction = base.stats?.production ?? 0;
    const levelMultiplier = 1 + (base.level * 0.1);
    return Math.floor(baseProduction * levelMultiplier * 0.2); // 20% to materials
}
function calculateEnergyProduction(base) {
    const baseProduction = base.stats?.production ?? 0;
    const levelMultiplier = 1 + (base.level * 0.1);
    return Math.floor(baseProduction * levelMultiplier * 0.1); // 10% to energy
}
function calculateDefenseRating(base) {
    const defense = base.stats?.defense ?? 0;
    if (defense < 50)
        return 'Weak';
    if (defense < 150)
        return 'Moderate';
    if (defense < 300)
        return 'Strong';
    if (defense < 500)
        return 'Fortified';
    return 'Impenetrable';
}
function calculateBaseScore(base) {
    const level = base.level || 1;
    const stats = base.stats || {};
    const defense = stats.defense ?? 0;
    const production = stats.production ?? 0;
    const storage = stats.storage ?? 0;
    return Math.floor((level * 100) + (defense * 0.5) + (production * 2) + (storage * 0.1));
}
function calculateProductionEfficiency(base) {
    const expectedProduction = base.level * 50; // Expected production per level
    const actualProduction = base.stats?.production ?? 0;
    return Math.min(1, actualProduction / expectedProduction);
}
function calculateDefenseEfficiency(base) {
    const expectedDefense = base.level * 30; // Expected defense per level
    const actualDefense = base.stats?.defense ?? 0;
    return Math.min(1, actualDefense / expectedDefense);
}
function calculateStorageEfficiency(base) {
    const expectedStorage = base.level * 200; // Expected storage per level
    const actualStorage = base.stats?.storage ?? 0;
    return Math.min(1, actualStorage / expectedStorage);
}
function calculateTerritoryValue(base) {
    // Simple territory value based on coordinates (closer to center = higher value)
    const distanceFromCenter = Math.sqrt(base.coordinates.x ** 2 + base.coordinates.y ** 2);
    return Math.max(0.1, 1 - (distanceFromCenter / 10000));
}
function calculateDefensivePosition(base) {
    const x = Math.abs(base.coordinates.x);
    const y = Math.abs(base.coordinates.y);
    if (x < 100 && y < 100)
        return 'Central Hub';
    if (x > 1000 || y > 1000)
        return 'Remote Outpost';
    return 'Standard Position';
}
function calculateResourceAccessibility(_base) {
    // Simplified calculation based on map position
    // TODO: Integrate with actual resource node locations
    return Math.random() * 0.4 + 0.6; // Random between 0.6-1.0 for now
}
function generateRecommendations(base, activeUpgrades) {
    const recommendations = [];
    if (base.level < 5) {
        recommendations.push('Consider upgrading base level for improved stats');
    }
    if (base.stats?.defense < base.level * 20) {
        recommendations.push('Defense is below recommended level - consider defensive upgrades');
    }
    if (base.stats?.production < base.level * 40) {
        recommendations.push('Production could be improved with resource upgrades');
    }
    if (activeUpgrades.length === 0 && base.status === 'active') {
        recommendations.push('Base is idle - consider starting an upgrade');
    }
    if (!base.allianceId) {
        recommendations.push('Joining an alliance provides strategic advantages');
    }
    const timeSinceMove = base.lastMovedAt ? Date.now() - base.lastMovedAt : Infinity;
    if (timeSinceMove > (30 * 24 * 60 * 60 * 1000)) { // 30 days
        recommendations.push('Consider relocating for better strategic positioning');
    }
    return recommendations;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWJhc2UtZGV0YWlscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xhbWJkYS9iYXNlLXF1ZXJpZXMvZ2V0LWJhc2UtZGV0YWlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSw4REFBMEQ7QUFDMUQsd0RBQXlGO0FBQ3pGLHlEQUlnQztBQU1oQyxNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDNUMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQzVELE1BQU0sTUFBTSxHQUFHLElBQUksK0JBQWdCLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUU3RCxNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDO0FBQ2hFLE1BQU0sbUJBQW1CLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsSUFBSSxFQUFFLENBQUM7QUFFbEU7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBaUJHO0FBQ0ksTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUMxQixLQUEyQixFQUNLLEVBQUU7SUFDbEMsT0FBTyxJQUFBLGdDQUFpQixFQUFDLEtBQUssSUFBSSxFQUFFO1FBQ2xDLE1BQU0sQ0FBQyxJQUFJLENBQUMscUNBQXFDLEVBQUU7WUFDakQsU0FBUyxFQUFFLEtBQUssQ0FBQyxjQUFjLEVBQUUsU0FBUztTQUMzQyxDQUFDLENBQUM7UUFFSCwrQkFBK0I7UUFDL0IsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLGNBQWMsRUFBRSxRQUFRLENBQUM7UUFDaEQsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLGNBQWMsRUFBRSxNQUFNLENBQUM7UUFFNUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ3pCLE1BQU0sSUFBSSw4QkFBZSxDQUN2QixrREFBa0QsRUFDbEQsb0JBQW9C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SSxDQUFDLEtBQUssR0FBRyxFQUFFLEVBQUUsQ0FBQztRQUM3QyxlQUFlLENBQUMsSUFBSSxDQUFDLHFEQUFxRCxDQUFDLENBQUM7SUFDOUUsQ0FBQztJQUVELElBQUksY0FBYyxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxRQUFRLEVBQUUsQ0FBQztRQUM1RCxlQUFlLENBQUMsSUFBSSxDQUFDLDZDQUE2QyxDQUFDLENBQUM7SUFDdEUsQ0FBQztJQUVELElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDckIsZUFBZSxDQUFDLElBQUksQ0FBQyxtREFBbUQsQ0FBQyxDQUFDO0lBQzVFLENBQUM7SUFFRCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDO0lBQ2xGLElBQUksYUFBYSxHQUFHLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxVQUFVO1FBQzFELGVBQWUsQ0FBQyxJQUFJLENBQUMsc0RBQXNELENBQUMsQ0FBQztJQUMvRSxDQUFDO0lBRUQsT0FBTyxlQUFlLENBQUM7QUFDekIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIEdldENvbW1hbmQsIFF1ZXJ5Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBcbiAgU3RydWN0dXJlZExvZ2dlciwgXG4gIEdhbWVFbmdpbmVFcnJvcixcbiAgd2l0aEVycm9ySGFuZGxpbmcgXG59IGZyb20gJy4uLy4uL2xpYi9zaGFyZWQtbW9ja3MnO1xuaW1wb3J0IHsgXG4gIFBsYXllckJhc2UsIFxuICBFbnJpY2hlZFBsYXllckJhc2Vcbn0gZnJvbSAnLi4vdHlwZXMvZ2FtZS1iYXNlLXR5cGVzJztcblxuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkeW5hbW9DbGllbnQpO1xuY29uc3QgbG9nZ2VyID0gbmV3IFN0cnVjdHVyZWRMb2dnZXIoJ0dldEJhc2VEZXRhaWxzSGFuZGxlcicpO1xuXG5jb25zdCBQTEFZRVJfQkFTRVNfVEFCTEUgPSBwcm9jZXNzLmVudi5QTEFZRVJfQkFTRVNfVEFCTEUgPz8gJyc7XG5jb25zdCBCQVNFX1VQR1JBREVTX1RBQkxFID0gcHJvY2Vzcy5lbnYuQkFTRV9VUEdSQURFU19UQUJMRSA/PyAnJztcblxuLyoqXG4gKiBHZXQgQmFzZSBEZXRhaWxzIEhhbmRsZXJcbiAqIFxuICogUHJvdmlkZXMgY29tcHJlaGVuc2l2ZSBiYXNlIGluZm9ybWF0aW9uIGZvbGxvd2luZyBTT0xJRCBwcmluY2lwbGVzOlxuICogLSBTaW5nbGUgUmVzcG9uc2liaWxpdHk6IE9ubHkgaGFuZGxlcyBkZXRhaWxlZCBiYXNlIGluZm9ybWF0aW9uIHJldHJpZXZhbFxuICogLSBPcGVuL0Nsb3NlZDogRXh0ZW5zaWJsZSBmb3IgYWRkaXRpb25hbCBkZXRhaWwgdHlwZXNcbiAqIC0gTGlza292IFN1YnN0aXR1dGlvbjogQ29uc2lzdGVudCBkZXRhaWwgaW50ZXJmYWNlIGZvciBhbGwgYmFzZSB0eXBlc1xuICogLSBJbnRlcmZhY2UgU2VncmVnYXRpb246IEZvY3VzZWQgb24gc3BlY2lmaWMgYmFzZSBkZXRhaWwgbmVlZHNcbiAqIC0gRGVwZW5kZW5jeSBJbnZlcnNpb246IERlcGVuZHMgb24gc2hhcmVkIGRhdGEgYWNjZXNzIHBhdHRlcm5zXG4gKiBcbiAqIEZlYXR1cmVzOlxuICogLSBDb21wbGV0ZSBiYXNlIGluZm9ybWF0aW9uIHdpdGggYWxsIHN0YXRzXG4gKiAtIEFjdGl2ZSB1cGdyYWRlIGluZm9ybWF0aW9uXG4gKiAtIE1vdmVtZW50IHN0YXR1cyBhbmQgdGltaW5nXG4gKiAtIEhpc3RvcmljYWwgdXBncmFkZSBpbmZvcm1hdGlvblxuICogLSBUZXJyaXRvcnkgYW5kIGFsbGlhbmNlIGNvbnRleHRcbiAqIC0gUmVzb3VyY2UgcHJvZHVjdGlvbiBjYWxjdWxhdGlvbnNcbiAqL1xuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgcmV0dXJuIHdpdGhFcnJvckhhbmRsaW5nKGFzeW5jICgpID0+IHtcbiAgICBsb2dnZXIuaW5mbygnUHJvY2Vzc2luZyBnZXQgYmFzZSBkZXRhaWxzIHJlcXVlc3QnLCB7IFxuICAgICAgcmVxdWVzdElkOiBldmVudC5yZXF1ZXN0Q29udGV4dD8ucmVxdWVzdElkIFxuICAgIH0pO1xuXG4gICAgLy8gRXh0cmFjdCBwYXJhbWV0ZXJzIGZyb20gcGF0aFxuICAgIGNvbnN0IHBsYXllcklkID0gZXZlbnQucGF0aFBhcmFtZXRlcnM/LnBsYXllcklkO1xuICAgIGNvbnN0IGJhc2VJZCA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5iYXNlSWQ7XG5cbiAgICBpZiAoIXBsYXllcklkIHx8ICFiYXNlSWQpIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdNaXNzaW5nIHJlcXVpcmVkIHBhcmFtZXRlcnM6IHBsYXllcklkIGFuZCBiYXNlSWQnLFxuICAgICAgICAnSU5WQUxJRF9QQVJBTUVURVJTJyxcbiAgICAgICAgeyBwbGF5ZXJJZCwgYmFzZUlkIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gR2V0IGJhc2UgZGV0YWlsc1xuICAgIGNvbnN0IGJhc2VEZXRhaWxzID0gYXdhaXQgZ2V0QmFzZURldGFpbHMocGxheWVySWQsIGJhc2VJZCk7XG4gICAgXG4gICAgLy8gR2V0IGFjdGl2ZSB1cGdyYWRlc1xuICAgIGNvbnN0IGFjdGl2ZVVwZ3JhZGVzID0gYXdhaXQgZ2V0QWN0aXZlVXBncmFkZXMocGxheWVySWQsIGJhc2VJZCk7XG4gICAgXG4gICAgLy8gQ2FsY3VsYXRlIGFkZGl0aW9uYWwgbWV0cmljc1xuICAgIGNvbnN0IG1ldHJpY3MgPSBjYWxjdWxhdGVCYXNlTWV0cmljcyhiYXNlRGV0YWlscywgYWN0aXZlVXBncmFkZXMpO1xuXG4gICAgbG9nZ2VyLmluZm8oJ0Jhc2UgZGV0YWlscyByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5Jywge1xuICAgICAgcGxheWVySWQsXG4gICAgICBiYXNlSWQsXG4gICAgICBiYXNlVHlwZTogYmFzZURldGFpbHMuYmFzZVR5cGUsXG4gICAgICBzdGF0dXM6IGJhc2VEZXRhaWxzLnN0YXR1c1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJ1xuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGJhc2U6IGJhc2VEZXRhaWxzLFxuICAgICAgICAgIGFjdGl2ZVVwZ3JhZGVzOiBhY3RpdmVVcGdyYWRlcyxcbiAgICAgICAgICBtZXRyaWNzOiBtZXRyaWNzXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfTtcbiAgfSwgbG9nZ2VyKTtcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEJhc2VEZXRhaWxzKHBsYXllcklkOiBzdHJpbmcsIGJhc2VJZDogc3RyaW5nKTogUHJvbWlzZTxFbnJpY2hlZFBsYXllckJhc2U+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBQTEFZRVJfQkFTRVNfVEFCTEUsXG4gICAgICBLZXk6IHsgcGxheWVySWQsIGJhc2VJZCB9XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIFxuICAgIGlmICghcmVzcG9uc2UuSXRlbSkge1xuICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgJ0Jhc2Ugbm90IGZvdW5kJyxcbiAgICAgICAgJ0JBU0VfTk9UX0ZPVU5EJyxcbiAgICAgICAgeyBwbGF5ZXJJZCwgYmFzZUlkIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgYmFzZSA9IHJlc3BvbnNlLkl0ZW0gYXMgUGxheWVyQmFzZTtcbiAgICBcbiAgICAvLyBFbnJpY2ggYmFzZSBkYXRhIHdpdGggY29tcHV0ZWQgZmllbGRzXG4gICAgY29uc3QgZW5yaWNoZWRCYXNlID0ge1xuICAgICAgLi4uYmFzZSxcbiAgICAgIFxuICAgICAgLy8gU3RhdHVzIGluZm9ybWF0aW9uXG4gICAgICBpc0FjdGl2ZTogYmFzZS5zdGF0dXMgPT09ICdhY3RpdmUnLFxuICAgICAgaXNCdWlsZGluZzogYmFzZS5zdGF0dXMgPT09ICdidWlsZGluZycsXG4gICAgICBpc01vdmluZzogYmFzZS5zdGF0dXMgPT09ICdtb3ZpbmcnLFxuICAgICAgaXNEZXN0cm95ZWQ6IGJhc2Uuc3RhdHVzID09PSAnZGVzdHJveWVkJyxcbiAgICAgIFxuICAgICAgLy8gVGltaW5nIGluZm9ybWF0aW9uXG4gICAgICBhZ2VJbkRheXM6IE1hdGguZmxvb3IoKERhdGUubm93KCkgLSBiYXNlLmNyZWF0ZWRBdCkgLyAoMjQgKiA2MCAqIDYwICogMTAwMCkpLFxuICAgICAgbGFzdEFjdGl2ZUhvdXJzOiBNYXRoLmZsb29yKChEYXRlLm5vdygpIC0gYmFzZS5sYXN0QWN0aXZlQXQpIC8gKDYwICogNjAgKiAxMDAwKSksXG4gICAgICBcbiAgICAgIC8vIENvb3JkaW5hdGUgaW5mb3JtYXRpb25cbiAgICAgIGxvY2F0aW9uOiBgJHtiYXNlLmNvb3JkaW5hdGVzLnh9LCAke2Jhc2UuY29vcmRpbmF0ZXMueX1gLFxuICAgICAgbWFwU2VjdGlvbjogYmFzZS5tYXBTZWN0aW9uSWQsXG4gICAgICBcbiAgICAgIC8vIE1vdmVtZW50IGluZm9ybWF0aW9uXG4gICAgICBjYW5Nb3ZlOiBiYXNlLnN0YXR1cyA9PT0gJ2FjdGl2ZScgJiYgKCFiYXNlLmxhc3RNb3ZlZEF0IHx8IFxuICAgICAgICAoRGF0ZS5ub3coKSAtIGJhc2UubGFzdE1vdmVkQXQpID49ICg2MCAqIDYwICogMTAwMCkpLFxuICAgICAgbW92ZW1lbnRDb29sZG93blJlbWFpbmluZzogYmFzZS5sYXN0TW92ZWRBdCA/IFxuICAgICAgICBNYXRoLm1heCgwLCAoNjAgKiA2MCAqIDEwMDApIC0gKERhdGUubm93KCkgLSBiYXNlLmxhc3RNb3ZlZEF0KSkgOiAwLFxuICAgICAgXG4gICAgICAvLyBCdWlsZGluZy9Nb3ZlbWVudCBjb21wbGV0aW9uIHRpbWVzXG4gICAgICAuLi4oYmFzZS5zdGF0dXMgPT09ICdidWlsZGluZycgJiYgYmFzZS5idWlsZENvbXBsZXRpb25UaW1lICYmIHtcbiAgICAgICAgYnVpbGRpbmdDb21wbGV0ZXNJbjogTWF0aC5tYXgoMCwgYmFzZS5idWlsZENvbXBsZXRpb25UaW1lIC0gRGF0ZS5ub3coKSksXG4gICAgICAgIGJ1aWxkaW5nQ29tcGxldGVzQXQ6IG5ldyBEYXRlKGJhc2UuYnVpbGRDb21wbGV0aW9uVGltZSkudG9JU09TdHJpbmcoKVxuICAgICAgfSksXG4gICAgICBcbiAgICAgIC4uLihiYXNlLnN0YXR1cyA9PT0gJ21vdmluZycgJiYgYmFzZS5hcnJpdmFsVGltZSAmJiB7XG4gICAgICAgIGFycml2YWxJbjogTWF0aC5tYXgoMCwgYmFzZS5hcnJpdmFsVGltZSAtIERhdGUubm93KCkpLFxuICAgICAgICBhcnJpdmFsQXQ6IG5ldyBEYXRlKGJhc2UuYXJyaXZhbFRpbWUpLnRvSVNPU3RyaW5nKClcbiAgICAgIH0pLFxuICAgICAgXG4gICAgICAvLyBSZXNvdXJjZSBwcm9kdWN0aW9uIChjYWxjdWxhdGVkIGJhc2VkIG9uIGJhc2Ugc3RhdHMpXG4gICAgICByZXNvdXJjZVByb2R1Y3Rpb246IHtcbiAgICAgICAgZ29sZDogY2FsY3VsYXRlR29sZFByb2R1Y3Rpb24oYmFzZSksXG4gICAgICAgIGZvb2Q6IGNhbGN1bGF0ZUZvb2RQcm9kdWN0aW9uKGJhc2UpLFxuICAgICAgICBtYXRlcmlhbHM6IGNhbGN1bGF0ZU1hdGVyaWFsc1Byb2R1Y3Rpb24oYmFzZSksXG4gICAgICAgIGVuZXJneTogY2FsY3VsYXRlRW5lcmd5UHJvZHVjdGlvbihiYXNlKVxuICAgICAgfSxcbiAgICAgIFxuICAgICAgLy8gRGVmZW5zZSBjYWxjdWxhdGlvbnNcbiAgICAgIGRlZmVuc2VSYXRpbmc6IGNhbGN1bGF0ZURlZmVuc2VSYXRpbmcoYmFzZSksXG4gICAgICBcbiAgICAgIC8vIFN0b3JhZ2UgaW5mb3JtYXRpb25cbiAgICAgIHN0b3JhZ2VDYXBhY2l0eTogYmFzZS5zdGF0cz8uc3RvcmFnZSA/PyAwLFxuICAgICAgXG4gICAgICAvLyBBbGxpYW5jZSBjb250ZXh0XG4gICAgICAuLi4oYmFzZS5hbGxpYW5jZUlkICYmIHtcbiAgICAgICAgYWxsaWFuY2VJZDogYmFzZS5hbGxpYW5jZUlkLFxuICAgICAgICAvLyBUT0RPOiBHZXQgYWxsaWFuY2UgbmFtZSBhbmQgb3RoZXIgZGV0YWlscyBmcm9tIGFsbGlhbmNlIHNlcnZpY2VcbiAgICAgIH0pXG4gICAgfTtcblxuICAgIHJldHVybiBlbnJpY2hlZEJhc2UgYXMgdW5rbm93biBhcyBFbnJpY2hlZFBsYXllckJhc2U7XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBHYW1lRW5naW5lRXJyb3IpIHRocm93IGVycm9yO1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIHJldHJpZXZlIGJhc2UgZGV0YWlscycsXG4gICAgICAnQkFTRV9SRVRSSUVWQUxfRVJST1InLFxuICAgICAgeyBwbGF5ZXJJZCwgYmFzZUlkLCBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIH1cbiAgICApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFjdGl2ZVVwZ3JhZGVzKHBsYXllcklkOiBzdHJpbmcsIGJhc2VJZDogc3RyaW5nKTogUHJvbWlzZTx1bmtub3duW10+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IEJBU0VfVVBHUkFERVNfVEFCTEUsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAncGxheWVySWQgPSA6cGxheWVySWQnLFxuICAgICAgRmlsdGVyRXhwcmVzc2lvbjogJ2Jhc2VJZCA9IDpiYXNlSWQgQU5EICNzdGF0dXMgPSA6c3RhdHVzJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAnI3N0YXR1cyc6ICdzdGF0dXMnXG4gICAgICB9LFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOnBsYXllcklkJzogcGxheWVySWQsXG4gICAgICAgICc6YmFzZUlkJzogYmFzZUlkLFxuICAgICAgICAnOnN0YXR1cyc6ICdpbl9wcm9ncmVzcydcbiAgICAgIH0sXG4gICAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZSAvLyBNb3N0IHJlY2VudCBmaXJzdFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBcbiAgICByZXR1cm4gKHJlc3BvbnNlLkl0ZW1zID8/IFtdKS5tYXAodXBncmFkZSA9PiAoe1xuICAgICAgLi4udXBncmFkZSxcbiAgICAgIFxuICAgICAgLy8gVGltaW5nIGluZm9ybWF0aW9uXG4gICAgICBjb21wbGV0ZXNJbjogTWF0aC5tYXgoMCwgKHVwZ3JhZGUgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pLmNvbXBsZXRpb25UaW1lIGFzIG51bWJlciAtIERhdGUubm93KCkpLFxuICAgICAgY29tcGxldGVzQXQ6IG5ldyBEYXRlKCh1cGdyYWRlIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KS5jb21wbGV0aW9uVGltZSBhcyBudW1iZXIpLnRvSVNPU3RyaW5nKCksXG4gICAgICBwcm9ncmVzczogTWF0aC5taW4oMSwgKERhdGUubm93KCkgLSAoKHVwZ3JhZGUgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pLnN0YXJ0ZWRBdCBhcyBudW1iZXIpKSAvICgoKHVwZ3JhZGUgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pLmNvbXBsZXRpb25UaW1lIGFzIG51bWJlcikgLSAoKHVwZ3JhZGUgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pLnN0YXJ0ZWRBdCBhcyBudW1iZXIpKSksXG4gICAgICBcbiAgICAgIC8vIFVwZ3JhZGUgZGV0YWlsc1xuICAgICAgbGV2ZWxDaGFuZ2U6IGAke1N0cmluZygodXBncmFkZSBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikuZnJvbUxldmVsKX0g4oaSICR7U3RyaW5nKCh1cGdyYWRlIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KS50b0xldmVsKX1gLFxuICAgICAgdGltZVJlbWFpbmluZzogTWF0aC5tYXgoMCwgKHVwZ3JhZGUgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pLmNvbXBsZXRpb25UaW1lIGFzIG51bWJlciAtIERhdGUubm93KCkpXG4gICAgfSkpO1xuXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLndhcm4oJ0ZhaWxlZCB0byByZXRyaWV2ZSBhY3RpdmUgdXBncmFkZXMnLCB7IFxuICAgICAgcGxheWVySWQsIFxuICAgICAgYmFzZUlkLCBcbiAgICAgIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgXG4gICAgfSk7XG4gICAgcmV0dXJuIFtdO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUJhc2VNZXRyaWNzKGJhc2U6IFBsYXllckJhc2UsIGFjdGl2ZVVwZ3JhZGVzOiB1bmtub3duW10pOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiB7XG4gIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gIFxuICByZXR1cm4ge1xuICAgIC8vIE92ZXJhbGwgYmFzZSBzY29yZSAoY29tcG9zaXRlIG1ldHJpYylcbiAgICBiYXNlU2NvcmU6IGNhbGN1bGF0ZUJhc2VTY29yZShiYXNlKSxcbiAgICBcbiAgICAvLyBFZmZpY2llbmN5IG1ldHJpY3NcbiAgICBlZmZpY2llbmN5OiB7XG4gICAgICBwcm9kdWN0aW9uRWZmaWNpZW5jeTogY2FsY3VsYXRlUHJvZHVjdGlvbkVmZmljaWVuY3koYmFzZSksXG4gICAgICBkZWZlbnNlRWZmaWNpZW5jeTogY2FsY3VsYXRlRGVmZW5zZUVmZmljaWVuY3koYmFzZSksXG4gICAgICBzdG9yYWdlRWZmaWNpZW5jeTogY2FsY3VsYXRlU3RvcmFnZUVmZmljaWVuY3koYmFzZSlcbiAgICB9LFxuICAgIFxuICAgIC8vIEFjdGl2aXR5IG1ldHJpY3NcbiAgICBhY3Rpdml0eToge1xuICAgICAgbGFzdEFjdGl2ZUhvdXJzOiBNYXRoLmZsb29yKChub3cgLSBiYXNlLmxhc3RBY3RpdmVBdCkgLyAoNjAgKiA2MCAqIDEwMDApKSxcbiAgICAgIHRvdGFsVXBncmFkZXM6IGFjdGl2ZVVwZ3JhZGVzLmxlbmd0aCxcbiAgICAgIGlzQWN0aXZlbHlEZXZlbG9waW5nOiBhY3RpdmVVcGdyYWRlcy5sZW5ndGggPiAwIHx8IFxuICAgICAgICAoYmFzZS5sYXN0QWN0aXZlQXQgJiYgKG5vdyAtIGJhc2UubGFzdEFjdGl2ZUF0KSA8ICgyNCAqIDYwICogNjAgKiAxMDAwKSlcbiAgICB9LFxuICAgIFxuICAgIC8vIFN0cmF0ZWdpYyBtZXRyaWNzXG4gICAgc3RyYXRlZ2ljOiB7XG4gICAgICB0ZXJyaXRvcnlWYWx1ZTogY2FsY3VsYXRlVGVycml0b3J5VmFsdWUoYmFzZSksXG4gICAgICBkZWZlbnNpdmVQb3NpdGlvbjogY2FsY3VsYXRlRGVmZW5zaXZlUG9zaXRpb24oYmFzZSksXG4gICAgICByZXNvdXJjZUFjY2Vzc2liaWxpdHk6IGNhbGN1bGF0ZVJlc291cmNlQWNjZXNzaWJpbGl0eShiYXNlKVxuICAgIH0sXG4gICAgXG4gICAgLy8gUmVjb21tZW5kYXRpb25zXG4gICAgcmVjb21tZW5kYXRpb25zOiBnZW5lcmF0ZVJlY29tbWVuZGF0aW9ucyhiYXNlLCBhY3RpdmVVcGdyYWRlcylcbiAgfTtcbn1cblxuLy8gQ2FsY3VsYXRpb24gaGVscGVyIGZ1bmN0aW9uc1xuZnVuY3Rpb24gY2FsY3VsYXRlR29sZFByb2R1Y3Rpb24oYmFzZTogUGxheWVyQmFzZSk6IG51bWJlciB7XG4gIGNvbnN0IGJhc2VQcm9kdWN0aW9uID0gYmFzZS5zdGF0cz8ucHJvZHVjdGlvbiA/PyAwO1xuICBjb25zdCBsZXZlbE11bHRpcGxpZXIgPSAxICsgKGJhc2UubGV2ZWwgKiAwLjEpO1xuICByZXR1cm4gTWF0aC5mbG9vcihiYXNlUHJvZHVjdGlvbiAqIGxldmVsTXVsdGlwbGllciAqIDAuNCk7IC8vIDQwJSBvZiBwcm9kdWN0aW9uIGdvZXMgdG8gZ29sZFxufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVGb29kUHJvZHVjdGlvbihiYXNlOiBQbGF5ZXJCYXNlKTogbnVtYmVyIHtcbiAgY29uc3QgYmFzZVByb2R1Y3Rpb24gPSBiYXNlLnN0YXRzPy5wcm9kdWN0aW9uID8/IDA7XG4gIGNvbnN0IGxldmVsTXVsdGlwbGllciA9IDEgKyAoYmFzZS5sZXZlbCAqIDAuMSk7XG4gIHJldHVybiBNYXRoLmZsb29yKGJhc2VQcm9kdWN0aW9uICogbGV2ZWxNdWx0aXBsaWVyICogMC4zKTsgLy8gMzAlIHRvIGZvb2Rcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlTWF0ZXJpYWxzUHJvZHVjdGlvbihiYXNlOiBQbGF5ZXJCYXNlKTogbnVtYmVyIHtcbiAgY29uc3QgYmFzZVByb2R1Y3Rpb24gPSBiYXNlLnN0YXRzPy5wcm9kdWN0aW9uID8/IDA7XG4gIGNvbnN0IGxldmVsTXVsdGlwbGllciA9IDEgKyAoYmFzZS5sZXZlbCAqIDAuMSk7XG4gIHJldHVybiBNYXRoLmZsb29yKGJhc2VQcm9kdWN0aW9uICogbGV2ZWxNdWx0aXBsaWVyICogMC4yKTsgLy8gMjAlIHRvIG1hdGVyaWFsc1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVFbmVyZ3lQcm9kdWN0aW9uKGJhc2U6IFBsYXllckJhc2UpOiBudW1iZXIge1xuICBjb25zdCBiYXNlUHJvZHVjdGlvbiA9IGJhc2Uuc3RhdHM/LnByb2R1Y3Rpb24gPz8gMDtcbiAgY29uc3QgbGV2ZWxNdWx0aXBsaWVyID0gMSArIChiYXNlLmxldmVsICogMC4xKTtcbiAgcmV0dXJuIE1hdGguZmxvb3IoYmFzZVByb2R1Y3Rpb24gKiBsZXZlbE11bHRpcGxpZXIgKiAwLjEpOyAvLyAxMCUgdG8gZW5lcmd5XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZURlZmVuc2VSYXRpbmcoYmFzZTogUGxheWVyQmFzZSk6IHN0cmluZyB7XG4gIGNvbnN0IGRlZmVuc2UgPSBiYXNlLnN0YXRzPy5kZWZlbnNlID8/IDA7XG4gIGlmIChkZWZlbnNlIDwgNTApIHJldHVybiAnV2Vhayc7XG4gIGlmIChkZWZlbnNlIDwgMTUwKSByZXR1cm4gJ01vZGVyYXRlJztcbiAgaWYgKGRlZmVuc2UgPCAzMDApIHJldHVybiAnU3Ryb25nJztcbiAgaWYgKGRlZmVuc2UgPCA1MDApIHJldHVybiAnRm9ydGlmaWVkJztcbiAgcmV0dXJuICdJbXBlbmV0cmFibGUnO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVCYXNlU2NvcmUoYmFzZTogUGxheWVyQmFzZSk6IG51bWJlciB7XG4gIGNvbnN0IGxldmVsID0gYmFzZS5sZXZlbCB8fCAxO1xuICBjb25zdCBzdGF0cyA9IGJhc2Uuc3RhdHMgfHwge307XG4gIGNvbnN0IGRlZmVuc2UgPSBzdGF0cy5kZWZlbnNlID8/IDA7XG4gIGNvbnN0IHByb2R1Y3Rpb24gPSBzdGF0cy5wcm9kdWN0aW9uID8/IDA7XG4gIGNvbnN0IHN0b3JhZ2UgPSBzdGF0cy5zdG9yYWdlID8/IDA7XG4gIFxuICByZXR1cm4gTWF0aC5mbG9vcigobGV2ZWwgKiAxMDApICsgKGRlZmVuc2UgKiAwLjUpICsgKHByb2R1Y3Rpb24gKiAyKSArIChzdG9yYWdlICogMC4xKSk7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZVByb2R1Y3Rpb25FZmZpY2llbmN5KGJhc2U6IFBsYXllckJhc2UpOiBudW1iZXIge1xuICBjb25zdCBleHBlY3RlZFByb2R1Y3Rpb24gPSBiYXNlLmxldmVsICogNTA7IC8vIEV4cGVjdGVkIHByb2R1Y3Rpb24gcGVyIGxldmVsXG4gIGNvbnN0IGFjdHVhbFByb2R1Y3Rpb24gPSBiYXNlLnN0YXRzPy5wcm9kdWN0aW9uID8/IDA7XG4gIHJldHVybiBNYXRoLm1pbigxLCBhY3R1YWxQcm9kdWN0aW9uIC8gZXhwZWN0ZWRQcm9kdWN0aW9uKTtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlRGVmZW5zZUVmZmljaWVuY3koYmFzZTogUGxheWVyQmFzZSk6IG51bWJlciB7XG4gIGNvbnN0IGV4cGVjdGVkRGVmZW5zZSA9IGJhc2UubGV2ZWwgKiAzMDsgLy8gRXhwZWN0ZWQgZGVmZW5zZSBwZXIgbGV2ZWxcbiAgY29uc3QgYWN0dWFsRGVmZW5zZSA9IGJhc2Uuc3RhdHM/LmRlZmVuc2UgPz8gMDtcbiAgcmV0dXJuIE1hdGgubWluKDEsIGFjdHVhbERlZmVuc2UgLyBleHBlY3RlZERlZmVuc2UpO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVTdG9yYWdlRWZmaWNpZW5jeShiYXNlOiBQbGF5ZXJCYXNlKTogbnVtYmVyIHtcbiAgY29uc3QgZXhwZWN0ZWRTdG9yYWdlID0gYmFzZS5sZXZlbCAqIDIwMDsgLy8gRXhwZWN0ZWQgc3RvcmFnZSBwZXIgbGV2ZWxcbiAgY29uc3QgYWN0dWFsU3RvcmFnZSA9IGJhc2Uuc3RhdHM/LnN0b3JhZ2UgPz8gMDtcbiAgcmV0dXJuIE1hdGgubWluKDEsIGFjdHVhbFN0b3JhZ2UgLyBleHBlY3RlZFN0b3JhZ2UpO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVUZXJyaXRvcnlWYWx1ZShiYXNlOiBQbGF5ZXJCYXNlKTogbnVtYmVyIHtcbiAgLy8gU2ltcGxlIHRlcnJpdG9yeSB2YWx1ZSBiYXNlZCBvbiBjb29yZGluYXRlcyAoY2xvc2VyIHRvIGNlbnRlciA9IGhpZ2hlciB2YWx1ZSlcbiAgY29uc3QgZGlzdGFuY2VGcm9tQ2VudGVyID0gTWF0aC5zcXJ0KGJhc2UuY29vcmRpbmF0ZXMueCAqKiAyICsgYmFzZS5jb29yZGluYXRlcy55ICoqIDIpO1xuICByZXR1cm4gTWF0aC5tYXgoMC4xLCAxIC0gKGRpc3RhbmNlRnJvbUNlbnRlciAvIDEwMDAwKSk7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZURlZmVuc2l2ZVBvc2l0aW9uKGJhc2U6IFBsYXllckJhc2UpOiBzdHJpbmcge1xuICBjb25zdCB4ID0gTWF0aC5hYnMoYmFzZS5jb29yZGluYXRlcy54KTtcbiAgY29uc3QgeSA9IE1hdGguYWJzKGJhc2UuY29vcmRpbmF0ZXMueSk7XG4gIFxuICBpZiAoeCA8IDEwMCAmJiB5IDwgMTAwKSByZXR1cm4gJ0NlbnRyYWwgSHViJztcbiAgaWYgKHggPiAxMDAwIHx8IHkgPiAxMDAwKSByZXR1cm4gJ1JlbW90ZSBPdXRwb3N0JztcbiAgcmV0dXJuICdTdGFuZGFyZCBQb3NpdGlvbic7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZVJlc291cmNlQWNjZXNzaWJpbGl0eShfYmFzZTogUGxheWVyQmFzZSk6IG51bWJlciB7XG4gIC8vIFNpbXBsaWZpZWQgY2FsY3VsYXRpb24gYmFzZWQgb24gbWFwIHBvc2l0aW9uXG4gIC8vIFRPRE86IEludGVncmF0ZSB3aXRoIGFjdHVhbCByZXNvdXJjZSBub2RlIGxvY2F0aW9uc1xuICByZXR1cm4gTWF0aC5yYW5kb20oKSAqIDAuNCArIDAuNjsgLy8gUmFuZG9tIGJldHdlZW4gMC42LTEuMCBmb3Igbm93XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlUmVjb21tZW5kYXRpb25zKGJhc2U6IFBsYXllckJhc2UsIGFjdGl2ZVVwZ3JhZGVzOiB1bmtub3duW10pOiBzdHJpbmdbXSB7XG4gIGNvbnN0IHJlY29tbWVuZGF0aW9uczogc3RyaW5nW10gPSBbXTtcbiAgXG4gIGlmIChiYXNlLmxldmVsIDwgNSkge1xuICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdDb25zaWRlciB1cGdyYWRpbmcgYmFzZSBsZXZlbCBmb3IgaW1wcm92ZWQgc3RhdHMnKTtcbiAgfVxuICBcbiAgaWYgKGJhc2Uuc3RhdHM/LmRlZmVuc2UgPCBiYXNlLmxldmVsICogMjApIHtcbiAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgnRGVmZW5zZSBpcyBiZWxvdyByZWNvbW1lbmRlZCBsZXZlbCAtIGNvbnNpZGVyIGRlZmVuc2l2ZSB1cGdyYWRlcycpO1xuICB9XG4gIFxuICBpZiAoYmFzZS5zdGF0cz8ucHJvZHVjdGlvbiA8IGJhc2UubGV2ZWwgKiA0MCkge1xuICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdQcm9kdWN0aW9uIGNvdWxkIGJlIGltcHJvdmVkIHdpdGggcmVzb3VyY2UgdXBncmFkZXMnKTtcbiAgfVxuICBcbiAgaWYgKGFjdGl2ZVVwZ3JhZGVzLmxlbmd0aCA9PT0gMCAmJiBiYXNlLnN0YXR1cyA9PT0gJ2FjdGl2ZScpIHtcbiAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgnQmFzZSBpcyBpZGxlIC0gY29uc2lkZXIgc3RhcnRpbmcgYW4gdXBncmFkZScpO1xuICB9XG4gIFxuICBpZiAoIWJhc2UuYWxsaWFuY2VJZCkge1xuICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdKb2luaW5nIGFuIGFsbGlhbmNlIHByb3ZpZGVzIHN0cmF0ZWdpYyBhZHZhbnRhZ2VzJyk7XG4gIH1cbiAgXG4gIGNvbnN0IHRpbWVTaW5jZU1vdmUgPSBiYXNlLmxhc3RNb3ZlZEF0ID8gRGF0ZS5ub3coKSAtIGJhc2UubGFzdE1vdmVkQXQgOiBJbmZpbml0eTtcbiAgaWYgKHRpbWVTaW5jZU1vdmUgPiAoMzAgKiAyNCAqIDYwICogNjAgKiAxMDAwKSkgeyAvLyAzMCBkYXlzXG4gICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ0NvbnNpZGVyIHJlbG9jYXRpbmcgZm9yIGJldHRlciBzdHJhdGVnaWMgcG9zaXRpb25pbmcnKTtcbiAgfVxuICBcbiAgcmV0dXJuIHJlY29tbWVuZGF0aW9ucztcbn0iXX0=