"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const shared_mocks_1 = require("../../lib/shared-mocks");
const zod_1 = require("zod");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const logger = new shared_mocks_1.StructuredLogger('ListBasesHandler');
const PLAYER_BASES_TABLE = process.env.PLAYER_BASES_TABLE ?? '';
const ListBasesRequestSchema = zod_1.z.object({
    playerId: zod_1.z.string().min(1).max(50),
    status: zod_1.z.enum(['active', 'building', 'moving', 'destroyed', 'all']).optional().default('all'),
    limit: zod_1.z.number().min(1).max(100).optional().default(20),
    lastEvaluatedKey: zod_1.z.string().optional(),
    includeStats: zod_1.z.boolean().optional().default(true)
});
/**
 * List Bases Handler
 *
 * Implements base listing with efficient pagination following SOLID principles:
 * - Single Responsibility: Only handles base listing operations
 * - Open/Closed: Extensible for additional filtering options
 * - Liskov Substitution: Consistent query interface across all filters
 * - Interface Segregation: Clear separation of query concerns
 * - Dependency Inversion: Depends on shared query abstractions
 *
 * Features:
 * - Paginated results for performance
 * - Status-based filtering (active, building, moving, etc.)
 * - Optional detailed stats inclusion
 * - Efficient DynamoDB querying with proper indexing
 * - Summary statistics (total bases, by status)
 */
const handler = async (event) => {
    return (0, shared_mocks_1.withErrorHandling)(async () => {
        logger.info('Processing list bases request', {
            requestId: event.requestContext?.requestId
        });
        // Extract request from query parameters for GET request
        const request = extractListBasesRequest(event);
        // Validate the extracted request
        const validatedRequest = ListBasesRequestSchema.parse(request);
        // Get player bases with pagination
        const result = await getPlayerBases(validatedRequest);
        // Calculate summary statistics
        const summary = await calculateBaseSummary(validatedRequest.playerId);
        logger.info('Bases listed successfully', {
            playerId: validatedRequest.playerId,
            baseCount: result.bases.length,
            hasMore: !!result.lastEvaluatedKey
        });
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                success: true,
                data: {
                    bases: result.bases,
                    summary: summary,
                    pagination: {
                        limit: validatedRequest.limit,
                        lastEvaluatedKey: result.lastEvaluatedKey,
                        hasMore: !!result.lastEvaluatedKey
                    }
                }
            })
        };
    }, logger);
};
exports.handler = handler;
function extractListBasesRequest(event) {
    const queryParams = event.queryStringParameters ?? {};
    const pathParams = event.pathParameters ?? {};
    return {
        playerId: (pathParams.playerId ?? queryParams.playerId) ?? '',
        status: queryParams.status ?? 'all',
        limit: queryParams.limit ? parseInt(queryParams.limit) : 20,
        lastEvaluatedKey: queryParams.lastEvaluatedKey,
        includeStats: queryParams.includeStats !== 'false'
    };
}
async function getPlayerBases(request) {
    try {
        const keyConditionExpression = 'playerId = :playerId';
        let filterExpression;
        const expressionAttributeValues = {
            ':playerId': request.playerId
        };
        const expressionAttributeNames = {};
        // Add status filtering if not 'all'
        if (request.status !== 'all') {
            filterExpression = '#status = :status';
            expressionAttributeValues[':status'] = request.status;
            expressionAttributeNames['#status'] = 'status';
        }
        // Prepare projection expression based on includeStats
        let projectionExpression;
        if (!request.includeStats) {
            projectionExpression = 'playerId, baseId, baseName, baseType, #level, coordinates, #status, createdAt, lastActiveAt';
            expressionAttributeNames['#level'] = 'level';
            expressionAttributeNames['#status'] = 'status'; // Needed for projection
        }
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: PLAYER_BASES_TABLE,
            KeyConditionExpression: keyConditionExpression,
            FilterExpression: filterExpression,
            ExpressionAttributeNames: Object.keys(expressionAttributeNames).length > 0 ? expressionAttributeNames : undefined,
            ExpressionAttributeValues: expressionAttributeValues,
            ProjectionExpression: projectionExpression,
            Limit: request.limit,
            ExclusiveStartKey: request.lastEvaluatedKey ? JSON.parse(Buffer.from(request.lastEvaluatedKey, 'base64').toString()) : undefined,
            ScanIndexForward: false // Most recent bases first
        });
        const response = await docClient.send(command);
        // Process and enrich the base data
        const bases = (response.Items ?? []).map(item => {
            // Type assertion to ensure we have the expected structure
            const base = item;
            return {
                ...base,
                // Add computed fields
                isActive: base.status === 'active',
                isUpgrading: Boolean(base.buildCompletionTime && base.buildCompletionTime > Date.now()),
                canMove: base.status === 'active' && (!base.lastMovedAt ||
                    (Date.now() - base.lastMovedAt) >= (60 * 60 * 1000)), // 60 minute cooldown
                // Format coordinates for display
                location: `${base.coordinates.x}, ${base.coordinates.y}`,
                // Calculate age
                ageInDays: Math.floor((Date.now() - base.createdAt) / (24 * 60 * 60 * 1000)),
                // Status-specific information
                ...(base.status === 'building' && base.buildCompletionTime && {
                    completionIn: Math.max(0, base.buildCompletionTime - Date.now())
                }),
                ...(base.status === 'moving' && base.arrivalTime && {
                    arrivalIn: Math.max(0, base.arrivalTime - Date.now())
                })
            };
        });
        // Encode pagination key
        const lastEvaluatedKey = response.LastEvaluatedKey ?
            Buffer.from(JSON.stringify(response.LastEvaluatedKey)).toString('base64') :
            undefined;
        return {
            bases: bases,
            lastEvaluatedKey: lastEvaluatedKey
        };
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to retrieve player bases', 'BASE_QUERY_ERROR', { playerId: request.playerId, error: error.message });
    }
}
async function calculateBaseSummary(playerId) {
    try {
        // Get all bases for summary statistics
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: PLAYER_BASES_TABLE,
            KeyConditionExpression: 'playerId = :playerId',
            ExpressionAttributeValues: {
                ':playerId': playerId
            },
            ProjectionExpression: '#status, baseType, #level, createdAt',
            ExpressionAttributeNames: {
                '#status': 'status',
                '#level': 'level'
            }
        });
        const response = await docClient.send(command);
        const bases = (response.Items ?? []).map(item => item);
        // Calculate statistics
        const summary = {
            totalBases: bases.length,
            activeBases: bases.filter(b => b.status === 'active').length,
            buildingBases: bases.filter(b => b.status === 'building').length,
            movingBases: bases.filter(b => b.status === 'moving').length,
            destroyedBases: bases.filter(b => b.status === 'destroyed').length,
            // Base type distribution
            baseTypes: bases.reduce((acc, base) => {
                acc[base.baseType] = (acc[base.baseType] ?? 0) + 1;
                return acc;
            }, {}),
            // Level distribution
            averageLevel: bases.length > 0 ?
                Math.round(bases.reduce((sum, base) => sum + (base.level ?? 1), 0) / bases.length * 10) / 10 : 0,
            maxLevel: bases.length > 0 ? Math.max(...bases.map(base => base.level ?? 1)) : 0,
            // TODO: Add subscription info (max bases allowed)
            maxBasesAllowed: 5, // Default for free players
            canCreateMore: bases.filter(b => b.status !== 'destroyed').length < 5,
            // Oldest and newest base
            oldestBase: bases.length > 0 ? Math.min(...bases.map(base => base.createdAt)) : null,
            newestBase: bases.length > 0 ? Math.max(...bases.map(base => base.createdAt)) : null
        };
        return summary;
    }
    catch (error) {
        // Return basic summary if detailed calculation fails
        logger.warn('Failed to calculate detailed base summary', {
            playerId,
            error: error.message
        });
        return {
            totalBases: 0,
            activeBases: 0,
            buildingBases: 0,
            movingBases: 0,
            destroyedBases: 0,
            baseTypes: {},
            averageLevel: 0,
            maxLevel: 0,
            maxBasesAllowed: 5,
            canCreateMore: true,
            oldestBase: null,
            newestBase: null
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC1iYXNlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xhbWJkYS9iYXNlLXF1ZXJpZXMvbGlzdC1iYXNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSw4REFBMEQ7QUFDMUQsd0RBQTZFO0FBQzdFLHlEQUlnQztBQUNoQyw2QkFBd0I7QUFNeEIsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUM1RCxNQUFNLE1BQU0sR0FBRyxJQUFJLCtCQUFnQixDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFFeEQsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLEVBQUUsQ0FBQztBQUVoRSxNQUFNLHNCQUFzQixHQUFHLE9BQUMsQ0FBQyxNQUFNLENBQUM7SUFDdEMsUUFBUSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztJQUNuQyxNQUFNLEVBQUUsT0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7SUFDOUYsS0FBSyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7SUFDeEQsZ0JBQWdCLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUN2QyxZQUFZLEVBQUUsT0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFD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LENBQUMsQ0FBQyxJQUFJO1lBQ3BGLFVBQVUsRUFBRSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSTtTQUNyRixDQUFDO1FBRUYsT0FBTyxPQUFPLENBQUM7SUFFakIsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixxREFBcUQ7UUFDckQsTUFBTSxDQUFDLElBQUksQ0FBQywyQ0FBMkMsRUFBRTtZQUN2RCxRQUFRO1lBQ1IsS0FBSyxFQUFHLEtBQWUsQ0FBQyxPQUFPO1NBQ2hDLENBQUMsQ0FBQztRQUVILE9BQU87WUFDTCxVQUFVLEVBQUUsQ0FBQztZQUNiLFdBQVcsRUFBRSxDQUFDO1lBQ2QsYUFBYSxFQUFFLENBQUM7WUFDaEIsV0FBVyxFQUFFLENBQUM7WUFDZCxjQUFjLEVBQUUsQ0FBQztZQUNqQixTQUFTLEVBQUUsRUFBRTtZQUNiLFlBQVksRUFBRSxDQUFDO1lBQ2YsUUFBUSxFQUFFLENBQUM7WUFDWCxlQUFlLEVBQUUsQ0FBQztZQUNsQixhQUFhLEVBQUUsSUFBSTtZQUNuQixVQUFVLEVBQUUsSUFBSTtZQUNoQixVQUFVLEVBQUUsSUFBSTtTQUNqQixDQUFDO0lBQ0osQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBRdWVyeUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgXG4gIFN0cnVjdHVyZWRMb2dnZXIsIFxuICBHYW1lRW5naW5lRXJyb3IsXG4gIHdpdGhFcnJvckhhbmRsaW5nXG59IGZyb20gJy4uLy4uL2xpYi9zaGFyZWQtbW9ja3MnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyBcbiAgQmFzZVN1bW1hcnksIFxuICBFbnJpY2hlZFBsYXllckJhc2Vcbn0gZnJvbSAnLi4vdHlwZXMvZ2FtZS1iYXNlLXR5cGVzJztcblxuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkeW5hbW9DbGllbnQpO1xuY29uc3QgbG9nZ2VyID0gbmV3IFN0cnVjdHVyZWRMb2dnZXIoJ0xpc3RCYXNlc0hhbmRsZXInKTtcblxuY29uc3QgUExBWUVSX0JBU0VTX1RBQkxFID0gcHJvY2Vzcy5lbnYuUExBWUVSX0JBU0VTX1RBQkxFID8/ICcnO1xuXG5jb25zdCBMaXN0QmFzZXNSZXF1ZXN0U2NoZW1hID0gei5vYmplY3Qoe1xuICBwbGF5ZXJJZDogei5zdHJpbmcoKS5taW4oMSkubWF4KDUwKSxcbiAgc3RhdHVzOiB6LmVudW0oWydhY3RpdmUnLCAnYnVpbGRpbmcnLCAnbW92aW5nJywgJ2Rlc3Ryb3llZCcsICdhbGwnXSkub3B0aW9uYWwoKS5kZWZhdWx0KCdhbGwnKSxcbiAgbGltaXQ6IHoubnVtYmVyKCkubWluKDEpLm1heCgxMDApLm9wdGlvbmFsKCkuZGVmYXVsdCgyMCksXG4gIGxhc3RFdmFsdWF0ZWRLZXk6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgaW5jbHVkZVN0YXRzOiB6LmJvb2xlYW4oKS5vcHRpb25hbCgpLmRlZmF1bHQodHJ1ZSlcbn0pO1xuXG50eXBlIExpc3RCYXNlc1JlcXVlc3RJbnB1dCA9IHouaW5mZXI8dHlwZW9mIExpc3RCYXNlc1JlcXVlc3RTY2hlbWE+O1xuXG4vKipcbiAqIExpc3QgQmFzZXMgSGFuZGxlclxuICogXG4gKiBJbXBsZW1lbnRzIGJhc2UgbGlzdGluZyB3aXRoIGVmZmljaWVudCBwYWdpbmF0aW9uIGZvbGxvd2luZyBTT0xJRCBwcmluY2lwbGVzOlxuICogLSBTaW5nbGUgUmVzcG9uc2liaWxpdHk6IE9ubHkgaGFuZGxlcyBiYXNlIGxpc3Rpbmcgb3BlcmF0aW9uc1xuICogLSBPcGVuL0Nsb3NlZDogRXh0ZW5zaWJsZSBmb3IgYWRkaXRpb25hbCBmaWx0ZXJpbmcgb3B0aW9uc1xuICogLSBMaXNrb3YgU3Vic3RpdHV0aW9uOiBDb25zaXN0ZW50IHF1ZXJ5IGludGVyZmFjZSBhY3Jvc3MgYWxsIGZpbHRlcnNcbiAqIC0gSW50ZXJmYWNlIFNlZ3JlZ2F0aW9uOiBDbGVhciBzZXBhcmF0aW9uIG9mIHF1ZXJ5IGNvbmNlcm5zXG4gKiAtIERlcGVuZGVuY3kgSW52ZXJzaW9uOiBEZXBlbmRzIG9uIHNoYXJlZCBxdWVyeSBhYnN0cmFjdGlvbnNcbiAqIFxuICogRmVhdHVyZXM6XG4gKiAtIFBhZ2luYXRlZCByZXN1bHRzIGZvciBwZXJmb3JtYW5jZVxuICogLSBTdGF0dXMtYmFzZWQgZmlsdGVyaW5nIChhY3RpdmUsIGJ1aWxkaW5nLCBtb3ZpbmcsIGV0Yy4pXG4gKiAtIE9wdGlvbmFsIGRldGFpbGVkIHN0YXRzIGluY2x1c2lvblxuICogLSBFZmZpY2llbnQgRHluYW1vREIgcXVlcnlpbmcgd2l0aCBwcm9wZXIgaW5kZXhpbmdcbiAqIC0gU3VtbWFyeSBzdGF0aXN0aWNzICh0b3RhbCBiYXNlcywgYnkgc3RhdHVzKVxuICovXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICByZXR1cm4gd2l0aEVycm9ySGFuZGxpbmcoYXN5bmMgKCkgPT4ge1xuICAgIGxvZ2dlci5pbmZvKCdQcm9jZXNzaW5nIGxpc3QgYmFzZXMgcmVxdWVzdCcsIHsgXG4gICAgICByZXF1ZXN0SWQ6IGV2ZW50LnJlcXVlc3RDb250ZXh0Py5yZXF1ZXN0SWQgXG4gICAgfSk7XG5cbiAgICAvLyBFeHRyYWN0IHJlcXVlc3QgZnJvbSBxdWVyeSBwYXJhbWV0ZXJzIGZvciBHRVQgcmVxdWVzdFxuICAgIGNvbnN0IHJlcXVlc3QgPSBleHRyYWN0TGlzdEJhc2VzUmVxdWVzdChldmVudCk7XG4gICAgXG4gICAgLy8gVmFsaWRhdGUgdGhlIGV4dHJhY3RlZCByZXF1ZXN0XG4gICAgY29uc3QgdmFsaWRhdGVkUmVxdWVzdCA9IExpc3RCYXNlc1JlcXVlc3RTY2hlbWEucGFyc2UocmVxdWVzdCk7XG4gICAgXG4gICAgLy8gR2V0IHBsYXllciBiYXNlcyB3aXRoIHBhZ2luYXRpb25cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZXRQbGF5ZXJCYXNlcyh2YWxpZGF0ZWRSZXF1ZXN0KTtcbiAgICBcbiAgICAvLyBDYWxjdWxhdGUgc3VtbWFyeSBzdGF0aXN0aWNzXG4gICAgY29uc3Qgc3VtbWFyeSA9IGF3YWl0IGNhbGN1bGF0ZUJhc2VTdW1tYXJ5KHZhbGlkYXRlZFJlcXVlc3QucGxheWVySWQpO1xuXG4gICAgbG9nZ2VyLmluZm8oJ0Jhc2VzIGxpc3RlZCBzdWNjZXNzZnVsbHknLCB7XG4gICAgICBwbGF5ZXJJZDogdmFsaWRhdGVkUmVxdWVzdC5wbGF5ZXJJZCxcbiAgICAgIGJhc2VDb3VudDogcmVzdWx0LmJhc2VzLmxlbmd0aCxcbiAgICAgIGhhc01vcmU6ICEhcmVzdWx0Lmxhc3RFdmFsdWF0ZWRLZXlcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKidcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBiYXNlczogcmVzdWx0LmJhc2VzLFxuICAgICAgICAgIHN1bW1hcnk6IHN1bW1hcnksXG4gICAgICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICAgICAgbGltaXQ6IHZhbGlkYXRlZFJlcXVlc3QubGltaXQsXG4gICAgICAgICAgICBsYXN0RXZhbHVhdGVkS2V5OiByZXN1bHQubGFzdEV2YWx1YXRlZEtleSxcbiAgICAgICAgICAgIGhhc01vcmU6ICEhcmVzdWx0Lmxhc3RFdmFsdWF0ZWRLZXlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfTtcbiAgfSwgbG9nZ2VyKTtcbn07XG5cbmZ1bmN0aW9uIGV4dHJhY3RMaXN0QmFzZXNSZXF1ZXN0KGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IExpc3RCYXNlc1JlcXVlc3RJbnB1dCB7XG4gIGNvbnN0IHF1ZXJ5UGFyYW1zID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzID8/IHt9O1xuICBjb25zdCBwYXRoUGFyYW1zID0gZXZlbnQucGF0aFBhcmFtZXRlcnMgPz8ge307XG4gIFxuICByZXR1cm4ge1xuICAgIHBsYXllcklkOiAocGF0aFBhcmFtcy5wbGF5ZXJJZCA/PyBxdWVyeVBhcmFtcy5wbGF5ZXJJZCkgPz8gJycsXG4gICAgc3RhdHVzOiAocXVlcnlQYXJhbXMuc3RhdHVzIGFzICdhY3RpdmUnIHwgJ2J1aWxkaW5nJyB8ICdtb3ZpbmcnIHwgJ2Rlc3Ryb3llZCcgfCAnYWxsJykgPz8gJ2FsbCcsXG4gICAgbGltaXQ6IHF1ZXJ5UGFyYW1zLmxpbWl0ID8gcGFyc2VJbnQocXVlcnlQYXJhbXMubGltaXQpIDogMjAsXG4gICAgbGFzdEV2YWx1YXRlZEtleTogcXVlcnlQYXJhbXMubGFzdEV2YWx1YXRlZEtleSxcbiAgICBpbmNsdWRlU3RhdHM6IHF1ZXJ5UGFyYW1zLmluY2x1ZGVTdGF0cyAhPT0gJ2ZhbHNlJ1xuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRQbGF5ZXJCYXNlcyhyZXF1ZXN0OiBMaXN0QmFzZXNSZXF1ZXN0SW5wdXQpOiBQcm9taXNlPHtcbiAgYmFzZXM6IEVucmljaGVkUGxheWVyQmFzZVtdO1xuICBsYXN0RXZhbHVhdGVkS2V5Pzogc3RyaW5nO1xufT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGtleUNvbmRpdGlvbkV4cHJlc3Npb24gPSAncGxheWVySWQgPSA6cGxheWVySWQnO1xuICAgIGxldCBmaWx0ZXJFeHByZXNzaW9uOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgXG4gICAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4gPSB7XG4gICAgICAnOnBsYXllcklkJzogcmVxdWVzdC5wbGF5ZXJJZFxuICAgIH07XG5cbiAgICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcblxuICAgIC8vIEFkZCBzdGF0dXMgZmlsdGVyaW5nIGlmIG5vdCAnYWxsJ1xuICAgIGlmIChyZXF1ZXN0LnN0YXR1cyAhPT0gJ2FsbCcpIHtcbiAgICAgIGZpbHRlckV4cHJlc3Npb24gPSAnI3N0YXR1cyA9IDpzdGF0dXMnO1xuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXR1cyddID0gcmVxdWVzdC5zdGF0dXM7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXNbJyNzdGF0dXMnXSA9ICdzdGF0dXMnO1xuICAgIH1cblxuICAgIC8vIFByZXBhcmUgcHJvamVjdGlvbiBleHByZXNzaW9uIGJhc2VkIG9uIGluY2x1ZGVTdGF0c1xuICAgIGxldCBwcm9qZWN0aW9uRXhwcmVzc2lvbjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGlmICghcmVxdWVzdC5pbmNsdWRlU3RhdHMpIHtcbiAgICAgIHByb2plY3Rpb25FeHByZXNzaW9uID0gJ3BsYXllcklkLCBiYXNlSWQsIGJhc2VOYW1lLCBiYXNlVHlwZSwgI2xldmVsLCBjb29yZGluYXRlcywgI3N0YXR1cywgY3JlYXRlZEF0LCBsYXN0QWN0aXZlQXQnO1xuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzWycjbGV2ZWwnXSA9ICdsZXZlbCc7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXNbJyNzdGF0dXMnXSA9ICdzdGF0dXMnOyAvLyBOZWVkZWQgZm9yIHByb2plY3Rpb25cbiAgICB9XG5cbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFBMQVlFUl9CQVNFU19UQUJMRSxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246IGtleUNvbmRpdGlvbkV4cHJlc3Npb24sXG4gICAgICBGaWx0ZXJFeHByZXNzaW9uOiBmaWx0ZXJFeHByZXNzaW9uLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBPYmplY3Qua2V5cyhleHByZXNzaW9uQXR0cmlidXRlTmFtZXMpLmxlbmd0aCA+IDAgPyBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMgOiB1bmRlZmluZWQsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgUHJvamVjdGlvbkV4cHJlc3Npb246IHByb2plY3Rpb25FeHByZXNzaW9uLFxuICAgICAgTGltaXQ6IHJlcXVlc3QubGltaXQsXG4gICAgICBFeGNsdXNpdmVTdGFydEtleTogcmVxdWVzdC5sYXN0RXZhbHVhdGVkS2V5ID8gSlNPTi5wYXJzZShcbiAgICAgICAgQnVmZmVyLmZyb20ocmVxdWVzdC5sYXN0RXZhbHVhdGVkS2V5LCAnYmFzZTY0JykudG9TdHJpbmcoKVxuICAgICAgKSBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiA6IHVuZGVmaW5lZCxcbiAgICAgIFNjYW5JbmRleEZvcndhcmQ6IGZhbHNlIC8vIE1vc3QgcmVjZW50IGJhc2VzIGZpcnN0XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIFxuICAgIC8vIFByb2Nlc3MgYW5kIGVucmljaCB0aGUgYmFzZSBkYXRhXG4gICAgY29uc3QgYmFzZXMgPSAocmVzcG9uc2UuSXRlbXMgPz8gW10pLm1hcChpdGVtID0+IHtcbiAgICAgIC8vIFR5cGUgYXNzZXJ0aW9uIHRvIGVuc3VyZSB3ZSBoYXZlIHRoZSBleHBlY3RlZCBzdHJ1Y3R1cmVcbiAgICAgIGNvbnN0IGJhc2UgPSBpdGVtIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+ICYge1xuICAgICAgICBjb29yZGluYXRlczogeyB4OiBudW1iZXI7IHk6IG51bWJlciB9O1xuICAgICAgICBzdGF0dXM6IHN0cmluZztcbiAgICAgICAgYnVpbGRDb21wbGV0aW9uVGltZT86IG51bWJlcjtcbiAgICAgICAgYXJyaXZhbFRpbWU/OiBudW1iZXI7XG4gICAgICAgIGxhc3RNb3ZlZEF0PzogbnVtYmVyO1xuICAgICAgICBjcmVhdGVkQXQ6IG51bWJlcjtcbiAgICAgIH07XG4gICAgICBcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLmJhc2UsXG4gICAgICAgIC8vIEFkZCBjb21wdXRlZCBmaWVsZHNcbiAgICAgICAgaXNBY3RpdmU6IGJhc2Uuc3RhdHVzID09PSAnYWN0aXZlJyxcbiAgICAgICAgaXNVcGdyYWRpbmc6IEJvb2xlYW4oYmFzZS5idWlsZENvbXBsZXRpb25UaW1lICYmIGJhc2UuYnVpbGRDb21wbGV0aW9uVGltZSA+IERhdGUubm93KCkpLFxuICAgICAgICBjYW5Nb3ZlOiBiYXNlLnN0YXR1cyA9PT0gJ2FjdGl2ZScgJiYgKCFiYXNlLmxhc3RNb3ZlZEF0IHx8IFxuICAgICAgICAgIChEYXRlLm5vdygpIC0gYmFzZS5sYXN0TW92ZWRBdCkgPj0gKDYwICogNjAgKiAxMDAwKSksIC8vIDYwIG1pbnV0ZSBjb29sZG93blxuICAgICAgICBcbiAgICAgICAgLy8gRm9ybWF0IGNvb3JkaW5hdGVzIGZvciBkaXNwbGF5XG4gICAgICAgIGxvY2F0aW9uOiBgJHtiYXNlLmNvb3JkaW5hdGVzLnh9LCAke2Jhc2UuY29vcmRpbmF0ZXMueX1gLFxuICAgICAgICBcbiAgICAgICAgLy8gQ2FsY3VsYXRlIGFnZVxuICAgICAgICBhZ2VJbkRheXM6IE1hdGguZmxvb3IoKERhdGUubm93KCkgLSBiYXNlLmNyZWF0ZWRBdCkgLyAoMjQgKiA2MCAqIDYwICogMTAwMCkpLFxuICAgICAgICBcbiAgICAgICAgLy8gU3RhdHVzLXNwZWNpZmljIGluZm9ybWF0aW9uXG4gICAgICAgIC4uLihiYXNlLnN0YXR1cyA9PT0gJ2J1aWxkaW5nJyAmJiBiYXNlLmJ1aWxkQ29tcGxldGlvblRpbWUgJiYge1xuICAgICAgICAgIGNvbXBsZXRpb25JbjogTWF0aC5tYXgoMCwgYmFzZS5idWlsZENvbXBsZXRpb25UaW1lIC0gRGF0ZS5ub3coKSlcbiAgICAgICAgfSksXG4gICAgICAgIC4uLihiYXNlLnN0YXR1cyA9PT0gJ21vdmluZycgJiYgYmFzZS5hcnJpdmFsVGltZSAmJiB7XG4gICAgICAgICAgYXJyaXZhbEluOiBNYXRoLm1heCgwLCBiYXNlLmFycml2YWxUaW1lIC0gRGF0ZS5ub3coKSlcbiAgICAgICAgfSlcbiAgICAgIH0gYXMgRW5yaWNoZWRQbGF5ZXJCYXNlO1xuICAgIH0pO1xuXG4gICAgLy8gRW5jb2RlIHBhZ2luYXRpb24ga2V5XG4gICAgY29uc3QgbGFzdEV2YWx1YXRlZEtleSA9IHJlc3BvbnNlLkxhc3RFdmFsdWF0ZWRLZXkgPyBcbiAgICAgIEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlLkxhc3RFdmFsdWF0ZWRLZXkpKS50b1N0cmluZygnYmFzZTY0JykgOiBcbiAgICAgIHVuZGVmaW5lZDtcblxuICAgIHJldHVybiB7XG4gICAgICBiYXNlczogYmFzZXMsXG4gICAgICBsYXN0RXZhbHVhdGVkS2V5OiBsYXN0RXZhbHVhdGVkS2V5XG4gICAgfTtcblxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIHJldHJpZXZlIHBsYXllciBiYXNlcycsXG4gICAgICAnQkFTRV9RVUVSWV9FUlJPUicsXG4gICAgICB7IHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLCBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIH1cbiAgICApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNhbGN1bGF0ZUJhc2VTdW1tYXJ5KHBsYXllcklkOiBzdHJpbmcpOiBQcm9taXNlPEJhc2VTdW1tYXJ5PiB7XG4gIHRyeSB7XG4gICAgLy8gR2V0IGFsbCBiYXNlcyBmb3Igc3VtbWFyeSBzdGF0aXN0aWNzXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBQTEFZRVJfQkFTRVNfVEFCTEUsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAncGxheWVySWQgPSA6cGxheWVySWQnLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOnBsYXllcklkJzogcGxheWVySWRcbiAgICAgIH0sXG4gICAgICBQcm9qZWN0aW9uRXhwcmVzc2lvbjogJyNzdGF0dXMsIGJhc2VUeXBlLCAjbGV2ZWwsIGNyZWF0ZWRBdCcsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgJyNzdGF0dXMnOiAnc3RhdHVzJyxcbiAgICAgICAgJyNsZXZlbCc6ICdsZXZlbCdcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgY29uc3QgYmFzZXMgPSAocmVzcG9uc2UuSXRlbXMgPz8gW10pLm1hcChpdGVtID0+IGl0ZW0gYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4gJiB7XG4gICAgICBzdGF0dXM6IHN0cmluZztcbiAgICAgIGJhc2VUeXBlOiBzdHJpbmc7XG4gICAgICBsZXZlbD86IG51bWJlcjtcbiAgICAgIGNyZWF0ZWRBdDogbnVtYmVyO1xuICAgIH0pO1xuXG4gICAgLy8gQ2FsY3VsYXRlIHN0YXRpc3RpY3NcbiAgICBjb25zdCBzdW1tYXJ5OiBCYXNlU3VtbWFyeSA9IHtcbiAgICAgIHRvdGFsQmFzZXM6IGJhc2VzLmxlbmd0aCxcbiAgICAgIGFjdGl2ZUJhc2VzOiBiYXNlcy5maWx0ZXIoYiA9PiBiLnN0YXR1cyA9PT0gJ2FjdGl2ZScpLmxlbmd0aCxcbiAgICAgIGJ1aWxkaW5nQmFzZXM6IGJhc2VzLmZpbHRlcihiID0+IGIuc3RhdHVzID09PSAnYnVpbGRpbmcnKS5sZW5ndGgsXG4gICAgICBtb3ZpbmdCYXNlczogYmFzZXMuZmlsdGVyKGIgPT4gYi5zdGF0dXMgPT09ICdtb3ZpbmcnKS5sZW5ndGgsXG4gICAgICBkZXN0cm95ZWRCYXNlczogYmFzZXMuZmlsdGVyKGIgPT4gYi5zdGF0dXMgPT09ICdkZXN0cm95ZWQnKS5sZW5ndGgsXG4gICAgICBcbiAgICAgIC8vIEJhc2UgdHlwZSBkaXN0cmlidXRpb25cbiAgICAgIGJhc2VUeXBlczogYmFzZXMucmVkdWNlKChhY2MsIGJhc2UpID0+IHtcbiAgICAgICAgYWNjW2Jhc2UuYmFzZVR5cGVdID0gKGFjY1tiYXNlLmJhc2VUeXBlXSA/PyAwKSArIDE7XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LCB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+KSxcbiAgICAgIFxuICAgICAgLy8gTGV2ZWwgZGlzdHJpYnV0aW9uXG4gICAgICBhdmVyYWdlTGV2ZWw6IGJhc2VzLmxlbmd0aCA+IDAgPyBcbiAgICAgICAgTWF0aC5yb3VuZChiYXNlcy5yZWR1Y2UoKHN1bSwgYmFzZSkgPT4gc3VtICsgKGJhc2UubGV2ZWwgPz8gMSksIDApIC8gYmFzZXMubGVuZ3RoICogMTApIC8gMTAgOiAwLFxuICAgICAgbWF4TGV2ZWw6IGJhc2VzLmxlbmd0aCA+IDAgPyBNYXRoLm1heCguLi5iYXNlcy5tYXAoYmFzZSA9PiBiYXNlLmxldmVsID8/IDEpKSA6IDAsXG4gICAgICBcbiAgICAgIC8vIFRPRE86IEFkZCBzdWJzY3JpcHRpb24gaW5mbyAobWF4IGJhc2VzIGFsbG93ZWQpXG4gICAgICBtYXhCYXNlc0FsbG93ZWQ6IDUsIC8vIERlZmF1bHQgZm9yIGZyZWUgcGxheWVyc1xuICAgICAgY2FuQ3JlYXRlTW9yZTogYmFzZXMuZmlsdGVyKGIgPT4gYi5zdGF0dXMgIT09ICdkZXN0cm95ZWQnKS5sZW5ndGggPCA1LFxuICAgICAgXG4gICAgICAvLyBPbGRlc3QgYW5kIG5ld2VzdCBiYXNlXG4gICAgICBvbGRlc3RCYXNlOiBiYXNlcy5sZW5ndGggPiAwID8gTWF0aC5taW4oLi4uYmFzZXMubWFwKGJhc2UgPT4gYmFzZS5jcmVhdGVkQXQpKSA6IG51bGwsXG4gICAgICBuZXdlc3RCYXNlOiBiYXNlcy5sZW5ndGggPiAwID8gTWF0aC5tYXgoLi4uYmFzZXMubWFwKGJhc2UgPT4gYmFzZS5jcmVhdGVkQXQpKSA6IG51bGxcbiAgICB9O1xuXG4gICAgcmV0dXJuIHN1bW1hcnk7XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAvLyBSZXR1cm4gYmFzaWMgc3VtbWFyeSBpZiBkZXRhaWxlZCBjYWxjdWxhdGlvbiBmYWlsc1xuICAgIGxvZ2dlci53YXJuKCdGYWlsZWQgdG8gY2FsY3VsYXRlIGRldGFpbGVkIGJhc2Ugc3VtbWFyeScsIHsgXG4gICAgICBwbGF5ZXJJZCwgXG4gICAgICBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIFxuICAgIH0pO1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICB0b3RhbEJhc2VzOiAwLFxuICAgICAgYWN0aXZlQmFzZXM6IDAsXG4gICAgICBidWlsZGluZ0Jhc2VzOiAwLFxuICAgICAgbW92aW5nQmFzZXM6IDAsXG4gICAgICBkZXN0cm95ZWRCYXNlczogMCxcbiAgICAgIGJhc2VUeXBlczoge30sXG4gICAgICBhdmVyYWdlTGV2ZWw6IDAsXG4gICAgICBtYXhMZXZlbDogMCxcbiAgICAgIG1heEJhc2VzQWxsb3dlZDogNSxcbiAgICAgIGNhbkNyZWF0ZU1vcmU6IHRydWUsXG4gICAgICBvbGRlc3RCYXNlOiBudWxsLFxuICAgICAgbmV3ZXN0QmFzZTogbnVsbFxuICAgIH07XG4gIH1cbn0iXX0=