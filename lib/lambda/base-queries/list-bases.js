"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const shared_mocks_1 = require("../../lib/shared-mocks");
const zod_1 = require("zod");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const logger = new shared_mocks_1.StructuredLogger('ListBasesHandler');
const PLAYER_BASES_TABLE = process.env.PLAYER_BASES_TABLE;
const ListBasesRequestSchema = zod_1.z.object({
    playerId: zod_1.z.string().min(1).max(50),
    status: zod_1.z.enum(['active', 'building', 'moving', 'destroyed', 'all']).optional().default('all'),
    limit: zod_1.z.number().min(1).max(100).optional().default(20),
    lastEvaluatedKey: zod_1.z.string().optional(),
    includeStats: zod_1.z.boolean().optional().default(true)
});
/**
 * List Bases Handler
 *
 * Implements base listing with efficient pagination following SOLID principles:
 * - Single Responsibility: Only handles base listing operations
 * - Open/Closed: Extensible for additional filtering options
 * - Liskov Substitution: Consistent query interface across all filters
 * - Interface Segregation: Clear separation of query concerns
 * - Dependency Inversion: Depends on shared query abstractions
 *
 * Features:
 * - Paginated results for performance
 * - Status-based filtering (active, building, moving, etc.)
 * - Optional detailed stats inclusion
 * - Efficient DynamoDB querying with proper indexing
 * - Summary statistics (total bases, by status)
 */
const handler = async (event) => {
    return (0, shared_mocks_1.withErrorHandling)(async () => {
        logger.info('Processing list bases request', {
            requestId: event.requestContext?.requestId
        });
        // Extract request from query parameters for GET request
        const request = extractListBasesRequest(event);
        // Validate the extracted request
        const validatedRequest = ListBasesRequestSchema.parse(request);
        // Get player bases with pagination
        const result = await getPlayerBases(validatedRequest);
        // Calculate summary statistics
        const summary = await calculateBaseSummary(validatedRequest.playerId);
        logger.info('Bases listed successfully', {
            playerId: validatedRequest.playerId,
            baseCount: result.bases.length,
            hasMore: !!result.lastEvaluatedKey
        });
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                success: true,
                data: {
                    bases: result.bases,
                    summary: summary,
                    pagination: {
                        limit: validatedRequest.limit,
                        lastEvaluatedKey: result.lastEvaluatedKey,
                        hasMore: !!result.lastEvaluatedKey
                    }
                }
            })
        };
    }, logger);
};
exports.handler = handler;
function extractListBasesRequest(event) {
    const queryParams = event.queryStringParameters || {};
    const pathParams = event.pathParameters || {};
    return {
        playerId: pathParams.playerId || queryParams.playerId || '',
        status: queryParams.status || 'all',
        limit: queryParams.limit ? parseInt(queryParams.limit) : 20,
        lastEvaluatedKey: queryParams.lastEvaluatedKey,
        includeStats: queryParams.includeStats !== 'false'
    };
}
async function getPlayerBases(request) {
    try {
        let keyConditionExpression = 'playerId = :playerId';
        let filterExpression;
        const expressionAttributeValues = {
            ':playerId': request.playerId
        };
        // Add status filtering if not 'all'
        if (request.status !== 'all') {
            filterExpression = '#status = :status';
            expressionAttributeValues[':status'] = request.status;
        }
        // Prepare projection expression based on includeStats
        let projectionExpression;
        if (!request.includeStats) {
            projectionExpression = 'playerId, baseId, baseName, baseType, #level, coordinates, #status, createdAt, lastActiveAt';
        }
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: PLAYER_BASES_TABLE,
            KeyConditionExpression: keyConditionExpression,
            FilterExpression: filterExpression,
            ExpressionAttributeNames: {
                '#status': 'status',
                '#level': 'level'
            },
            ExpressionAttributeValues: expressionAttributeValues,
            ProjectionExpression: projectionExpression,
            Limit: request.limit,
            ExclusiveStartKey: request.lastEvaluatedKey ? JSON.parse(Buffer.from(request.lastEvaluatedKey, 'base64').toString()) : undefined,
            ScanIndexForward: false // Most recent bases first
        });
        const response = await docClient.send(command);
        // Process and enrich the base data
        const bases = response.Items?.map(base => ({
            ...base,
            // Add computed fields
            isActive: base.status === 'active',
            isUpgrading: base.buildCompletionTime && base.buildCompletionTime > Date.now(),
            canMove: base.status === 'active' && (!base.lastMovedAt ||
                (Date.now() - base.lastMovedAt) >= (60 * 60 * 1000)), // 60 minute cooldown
            // Format coordinates for display
            location: `${base.coordinates.x}, ${base.coordinates.y}`,
            // Calculate age
            ageInDays: Math.floor((Date.now() - base.createdAt) / (24 * 60 * 60 * 1000)),
            // Status-specific information
            ...(base.status === 'building' && base.buildCompletionTime && {
                completionIn: Math.max(0, base.buildCompletionTime - Date.now())
            }),
            ...(base.status === 'moving' && base.arrivalTime && {
                arrivalIn: Math.max(0, base.arrivalTime - Date.now())
            })
        })) || [];
        // Encode pagination key
        const lastEvaluatedKey = response.LastEvaluatedKey ?
            Buffer.from(JSON.stringify(response.LastEvaluatedKey)).toString('base64') :
            undefined;
        return {
            bases: bases,
            lastEvaluatedKey: lastEvaluatedKey
        };
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to retrieve player bases', 'BASE_QUERY_ERROR', { playerId: request.playerId, error: error.message });
    }
}
async function calculateBaseSummary(playerId) {
    try {
        // Get all bases for summary statistics
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: PLAYER_BASES_TABLE,
            KeyConditionExpression: 'playerId = :playerId',
            ExpressionAttributeValues: {
                ':playerId': playerId
            },
            ProjectionExpression: '#status, baseType, #level, createdAt',
            ExpressionAttributeNames: {
                '#status': 'status',
                '#level': 'level'
            }
        });
        const response = await docClient.send(command);
        const bases = response.Items || [];
        // Calculate statistics
        const summary = {
            totalBases: bases.length,
            activeBase: bases.filter(b => b.status === 'active').length,
            buildingBases: bases.filter(b => b.status === 'building').length,
            movingBases: bases.filter(b => b.status === 'moving').length,
            destroyedBases: bases.filter(b => b.status === 'destroyed').length,
            // Base type distribution
            baseTypes: bases.reduce((acc, base) => {
                acc[base.baseType] = (acc[base.baseType] || 0) + 1;
                return acc;
            }, {}),
            // Level distribution
            averageLevel: bases.length > 0 ?
                Math.round(bases.reduce((sum, base) => sum + (base.level || 1), 0) / bases.length * 10) / 10 : 0,
            maxLevel: bases.length > 0 ? Math.max(...bases.map(base => base.level || 1)) : 0,
            // TODO: Add subscription info (max bases allowed)
            maxBasesAllowed: 5, // Default for free players
            canCreateMore: bases.filter(b => b.status !== 'destroyed').length < 5,
            // Oldest and newest base
            oldestBase: bases.length > 0 ? Math.min(...bases.map(base => base.createdAt)) : null,
            newestBase: bases.length > 0 ? Math.max(...bases.map(base => base.createdAt)) : null
        };
        return summary;
    }
    catch (error) {
        // Return basic summary if detailed calculation fails
        logger.warn('Failed to calculate detailed base summary', {
            playerId,
            error: error.message
        });
        return {
            totalBases: 0,
            activeBases: 0,
            buildingBases: 0,
            movingBases: 0,
            destroyedBases: 0,
            baseTypes: {},
            averageLevel: 0,
            maxLevel: 0,
            maxBasesAllowed: 5,
            canCreateMore: true,
            oldestBase: null,
            newestBase: null
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC1iYXNlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xhbWJkYS9iYXNlLXF1ZXJpZXMvbGlzdC1iYXNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSw4REFBMEQ7QUFDMUQsd0RBQTZFO0FBQzdFLHlEQUtnQztBQUNoQyw2QkFBd0I7QUFFeEIsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUM1RCxNQUFNLE1BQU0sR0FBRyxJQUFJLCtCQUFnQixDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFFeEQsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFtQixDQUFDO0FBRTNELE1BQU0sc0JBQXNCLEdBQUcsT0FBQyxDQUFDLE1BQU0sQ0FBQztJQUN0QyxRQUFRLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO0lBQ25DLE1BQU0sRUFBRSxPQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztJQUM5RixLQUFLLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztJQUN4RCxnQkFBZ0IsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQ3ZDLFlBQVksRUFBRSxPQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxFQUFF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QVcsRUFBRSxDQUFDO1lBQ2QsYUFBYSxFQUFFLENBQUM7WUFDaEIsV0FBVyxFQUFFLENBQUM7WUFDZCxjQUFjLEVBQUUsQ0FBQztZQUNqQixTQUFTLEVBQUUsRUFBRTtZQUNiLFlBQVksRUFBRSxDQUFDO1lBQ2YsUUFBUSxFQUFFLENBQUM7WUFDWCxlQUFlLEVBQUUsQ0FBQztZQUNsQixhQUFhLEVBQUUsSUFBSTtZQUNuQixVQUFVLEVBQUUsSUFBSTtZQUNoQixVQUFVLEVBQUUsSUFBSTtTQUNqQixDQUFDO0lBQ0osQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBRdWVyeUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgXG4gIFN0cnVjdHVyZWRMb2dnZXIsIFxuICBHYW1lRW5naW5lRXJyb3IsXG4gIHdpdGhFcnJvckhhbmRsaW5nLFxuICB2YWxpZGF0ZVJlcXVlc3QgXG59IGZyb20gJy4uLy4uL2xpYi9zaGFyZWQtbW9ja3MnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5cbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vQ2xpZW50KTtcbmNvbnN0IGxvZ2dlciA9IG5ldyBTdHJ1Y3R1cmVkTG9nZ2VyKCdMaXN0QmFzZXNIYW5kbGVyJyk7XG5cbmNvbnN0IFBMQVlFUl9CQVNFU19UQUJMRSA9IHByb2Nlc3MuZW52LlBMQVlFUl9CQVNFU19UQUJMRSE7XG5cbmNvbnN0IExpc3RCYXNlc1JlcXVlc3RTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIHBsYXllcklkOiB6LnN0cmluZygpLm1pbigxKS5tYXgoNTApLFxuICBzdGF0dXM6IHouZW51bShbJ2FjdGl2ZScsICdidWlsZGluZycsICdtb3ZpbmcnLCAnZGVzdHJveWVkJywgJ2FsbCddKS5vcHRpb25hbCgpLmRlZmF1bHQoJ2FsbCcpLFxuICBsaW1pdDogei5udW1iZXIoKS5taW4oMSkubWF4KDEwMCkub3B0aW9uYWwoKS5kZWZhdWx0KDIwKSxcbiAgbGFzdEV2YWx1YXRlZEtleTogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBpbmNsdWRlU3RhdHM6IHouYm9vbGVhbigpLm9wdGlvbmFsKCkuZGVmYXVsdCh0cnVlKVxufSk7XG5cbnR5cGUgTGlzdEJhc2VzUmVxdWVzdCA9IHouaW5mZXI8dHlwZW9mIExpc3RCYXNlc1JlcXVlc3RTY2hlbWE+O1xuXG4vKipcbiAqIExpc3QgQmFzZXMgSGFuZGxlclxuICogXG4gKiBJbXBsZW1lbnRzIGJhc2UgbGlzdGluZyB3aXRoIGVmZmljaWVudCBwYWdpbmF0aW9uIGZvbGxvd2luZyBTT0xJRCBwcmluY2lwbGVzOlxuICogLSBTaW5nbGUgUmVzcG9uc2liaWxpdHk6IE9ubHkgaGFuZGxlcyBiYXNlIGxpc3Rpbmcgb3BlcmF0aW9uc1xuICogLSBPcGVuL0Nsb3NlZDogRXh0ZW5zaWJsZSBmb3IgYWRkaXRpb25hbCBmaWx0ZXJpbmcgb3B0aW9uc1xuICogLSBMaXNrb3YgU3Vic3RpdHV0aW9uOiBDb25zaXN0ZW50IHF1ZXJ5IGludGVyZmFjZSBhY3Jvc3MgYWxsIGZpbHRlcnNcbiAqIC0gSW50ZXJmYWNlIFNlZ3JlZ2F0aW9uOiBDbGVhciBzZXBhcmF0aW9uIG9mIHF1ZXJ5IGNvbmNlcm5zXG4gKiAtIERlcGVuZGVuY3kgSW52ZXJzaW9uOiBEZXBlbmRzIG9uIHNoYXJlZCBxdWVyeSBhYnN0cmFjdGlvbnNcbiAqIFxuICogRmVhdHVyZXM6XG4gKiAtIFBhZ2luYXRlZCByZXN1bHRzIGZvciBwZXJmb3JtYW5jZVxuICogLSBTdGF0dXMtYmFzZWQgZmlsdGVyaW5nIChhY3RpdmUsIGJ1aWxkaW5nLCBtb3ZpbmcsIGV0Yy4pXG4gKiAtIE9wdGlvbmFsIGRldGFpbGVkIHN0YXRzIGluY2x1c2lvblxuICogLSBFZmZpY2llbnQgRHluYW1vREIgcXVlcnlpbmcgd2l0aCBwcm9wZXIgaW5kZXhpbmdcbiAqIC0gU3VtbWFyeSBzdGF0aXN0aWNzICh0b3RhbCBiYXNlcywgYnkgc3RhdHVzKVxuICovXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICByZXR1cm4gd2l0aEVycm9ySGFuZGxpbmcoYXN5bmMgKCkgPT4ge1xuICAgIGxvZ2dlci5pbmZvKCdQcm9jZXNzaW5nIGxpc3QgYmFzZXMgcmVxdWVzdCcsIHsgXG4gICAgICByZXF1ZXN0SWQ6IGV2ZW50LnJlcXVlc3RDb250ZXh0Py5yZXF1ZXN0SWQgXG4gICAgfSk7XG5cbiAgICAvLyBFeHRyYWN0IHJlcXVlc3QgZnJvbSBxdWVyeSBwYXJhbWV0ZXJzIGZvciBHRVQgcmVxdWVzdFxuICAgIGNvbnN0IHJlcXVlc3QgPSBleHRyYWN0TGlzdEJhc2VzUmVxdWVzdChldmVudCk7XG4gICAgXG4gICAgLy8gVmFsaWRhdGUgdGhlIGV4dHJhY3RlZCByZXF1ZXN0XG4gICAgY29uc3QgdmFsaWRhdGVkUmVxdWVzdCA9IExpc3RCYXNlc1JlcXVlc3RTY2hlbWEucGFyc2UocmVxdWVzdCk7XG4gICAgXG4gICAgLy8gR2V0IHBsYXllciBiYXNlcyB3aXRoIHBhZ2luYXRpb25cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZXRQbGF5ZXJCYXNlcyh2YWxpZGF0ZWRSZXF1ZXN0KTtcbiAgICBcbiAgICAvLyBDYWxjdWxhdGUgc3VtbWFyeSBzdGF0aXN0aWNzXG4gICAgY29uc3Qgc3VtbWFyeSA9IGF3YWl0IGNhbGN1bGF0ZUJhc2VTdW1tYXJ5KHZhbGlkYXRlZFJlcXVlc3QucGxheWVySWQpO1xuXG4gICAgbG9nZ2VyLmluZm8oJ0Jhc2VzIGxpc3RlZCBzdWNjZXNzZnVsbHknLCB7XG4gICAgICBwbGF5ZXJJZDogdmFsaWRhdGVkUmVxdWVzdC5wbGF5ZXJJZCxcbiAgICAgIGJhc2VDb3VudDogcmVzdWx0LmJhc2VzLmxlbmd0aCxcbiAgICAgIGhhc01vcmU6ICEhcmVzdWx0Lmxhc3RFdmFsdWF0ZWRLZXlcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKidcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBiYXNlczogcmVzdWx0LmJhc2VzLFxuICAgICAgICAgIHN1bW1hcnk6IHN1bW1hcnksXG4gICAgICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICAgICAgbGltaXQ6IHZhbGlkYXRlZFJlcXVlc3QubGltaXQsXG4gICAgICAgICAgICBsYXN0RXZhbHVhdGVkS2V5OiByZXN1bHQubGFzdEV2YWx1YXRlZEtleSxcbiAgICAgICAgICAgIGhhc01vcmU6ICEhcmVzdWx0Lmxhc3RFdmFsdWF0ZWRLZXlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfTtcbiAgfSwgbG9nZ2VyKTtcbn07XG5cbmZ1bmN0aW9uIGV4dHJhY3RMaXN0QmFzZXNSZXF1ZXN0KGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IExpc3RCYXNlc1JlcXVlc3Qge1xuICBjb25zdCBxdWVyeVBhcmFtcyA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fTtcbiAgY29uc3QgcGF0aFBhcmFtcyA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzIHx8IHt9O1xuICBcbiAgcmV0dXJuIHtcbiAgICBwbGF5ZXJJZDogcGF0aFBhcmFtcy5wbGF5ZXJJZCB8fCBxdWVyeVBhcmFtcy5wbGF5ZXJJZCB8fCAnJyxcbiAgICBzdGF0dXM6IChxdWVyeVBhcmFtcy5zdGF0dXMgYXMgYW55KSB8fCAnYWxsJyxcbiAgICBsaW1pdDogcXVlcnlQYXJhbXMubGltaXQgPyBwYXJzZUludChxdWVyeVBhcmFtcy5saW1pdCkgOiAyMCxcbiAgICBsYXN0RXZhbHVhdGVkS2V5OiBxdWVyeVBhcmFtcy5sYXN0RXZhbHVhdGVkS2V5LFxuICAgIGluY2x1ZGVTdGF0czogcXVlcnlQYXJhbXMuaW5jbHVkZVN0YXRzICE9PSAnZmFsc2UnXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFBsYXllckJhc2VzKHJlcXVlc3Q6IExpc3RCYXNlc1JlcXVlc3QpOiBQcm9taXNlPHtcbiAgYmFzZXM6IGFueVtdO1xuICBsYXN0RXZhbHVhdGVkS2V5Pzogc3RyaW5nO1xufT4ge1xuICB0cnkge1xuICAgIGxldCBrZXlDb25kaXRpb25FeHByZXNzaW9uID0gJ3BsYXllcklkID0gOnBsYXllcklkJztcbiAgICBsZXQgZmlsdGVyRXhwcmVzc2lvbjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIFxuICAgIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7XG4gICAgICAnOnBsYXllcklkJzogcmVxdWVzdC5wbGF5ZXJJZFxuICAgIH07XG5cbiAgICAvLyBBZGQgc3RhdHVzIGZpbHRlcmluZyBpZiBub3QgJ2FsbCdcbiAgICBpZiAocmVxdWVzdC5zdGF0dXMgIT09ICdhbGwnKSB7XG4gICAgICBmaWx0ZXJFeHByZXNzaW9uID0gJyNzdGF0dXMgPSA6c3RhdHVzJztcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzpzdGF0dXMnXSA9IHJlcXVlc3Quc3RhdHVzO1xuICAgIH1cblxuICAgIC8vIFByZXBhcmUgcHJvamVjdGlvbiBleHByZXNzaW9uIGJhc2VkIG9uIGluY2x1ZGVTdGF0c1xuICAgIGxldCBwcm9qZWN0aW9uRXhwcmVzc2lvbjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGlmICghcmVxdWVzdC5pbmNsdWRlU3RhdHMpIHtcbiAgICAgIHByb2plY3Rpb25FeHByZXNzaW9uID0gJ3BsYXllcklkLCBiYXNlSWQsIGJhc2VOYW1lLCBiYXNlVHlwZSwgI2xldmVsLCBjb29yZGluYXRlcywgI3N0YXR1cywgY3JlYXRlZEF0LCBsYXN0QWN0aXZlQXQnO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogUExBWUVSX0JBU0VTX1RBQkxFLFxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjoga2V5Q29uZGl0aW9uRXhwcmVzc2lvbixcbiAgICAgIEZpbHRlckV4cHJlc3Npb246IGZpbHRlckV4cHJlc3Npb24sXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgJyNzdGF0dXMnOiAnc3RhdHVzJyxcbiAgICAgICAgJyNsZXZlbCc6ICdsZXZlbCdcbiAgICAgIH0sXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgUHJvamVjdGlvbkV4cHJlc3Npb246IHByb2plY3Rpb25FeHByZXNzaW9uLFxuICAgICAgTGltaXQ6IHJlcXVlc3QubGltaXQsXG4gICAgICBFeGNsdXNpdmVTdGFydEtleTogcmVxdWVzdC5sYXN0RXZhbHVhdGVkS2V5ID8gSlNPTi5wYXJzZShcbiAgICAgICAgQnVmZmVyLmZyb20ocmVxdWVzdC5sYXN0RXZhbHVhdGVkS2V5LCAnYmFzZTY0JykudG9TdHJpbmcoKVxuICAgICAgKSA6IHVuZGVmaW5lZCxcbiAgICAgIFNjYW5JbmRleEZvcndhcmQ6IGZhbHNlIC8vIE1vc3QgcmVjZW50IGJhc2VzIGZpcnN0XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIFxuICAgIC8vIFByb2Nlc3MgYW5kIGVucmljaCB0aGUgYmFzZSBkYXRhXG4gICAgY29uc3QgYmFzZXMgPSByZXNwb25zZS5JdGVtcz8ubWFwKGJhc2UgPT4gKHtcbiAgICAgIC4uLmJhc2UsXG4gICAgICAvLyBBZGQgY29tcHV0ZWQgZmllbGRzXG4gICAgICBpc0FjdGl2ZTogYmFzZS5zdGF0dXMgPT09ICdhY3RpdmUnLFxuICAgICAgaXNVcGdyYWRpbmc6IGJhc2UuYnVpbGRDb21wbGV0aW9uVGltZSAmJiBiYXNlLmJ1aWxkQ29tcGxldGlvblRpbWUgPiBEYXRlLm5vdygpLFxuICAgICAgY2FuTW92ZTogYmFzZS5zdGF0dXMgPT09ICdhY3RpdmUnICYmICghYmFzZS5sYXN0TW92ZWRBdCB8fCBcbiAgICAgICAgKERhdGUubm93KCkgLSBiYXNlLmxhc3RNb3ZlZEF0KSA+PSAoNjAgKiA2MCAqIDEwMDApKSwgLy8gNjAgbWludXRlIGNvb2xkb3duXG4gICAgICBcbiAgICAgIC8vIEZvcm1hdCBjb29yZGluYXRlcyBmb3IgZGlzcGxheVxuICAgICAgbG9jYXRpb246IGAke2Jhc2UuY29vcmRpbmF0ZXMueH0sICR7YmFzZS5jb29yZGluYXRlcy55fWAsXG4gICAgICBcbiAgICAgIC8vIENhbGN1bGF0ZSBhZ2VcbiAgICAgIGFnZUluRGF5czogTWF0aC5mbG9vcigoRGF0ZS5ub3coKSAtIGJhc2UuY3JlYXRlZEF0KSAvICgyNCAqIDYwICogNjAgKiAxMDAwKSksXG4gICAgICBcbiAgICAgIC8vIFN0YXR1cy1zcGVjaWZpYyBpbmZvcm1hdGlvblxuICAgICAgLi4uKGJhc2Uuc3RhdHVzID09PSAnYnVpbGRpbmcnICYmIGJhc2UuYnVpbGRDb21wbGV0aW9uVGltZSAmJiB7XG4gICAgICAgIGNvbXBsZXRpb25JbjogTWF0aC5tYXgoMCwgYmFzZS5idWlsZENvbXBsZXRpb25UaW1lIC0gRGF0ZS5ub3coKSlcbiAgICAgIH0pLFxuICAgICAgLi4uKGJhc2Uuc3RhdHVzID09PSAnbW92aW5nJyAmJiBiYXNlLmFycml2YWxUaW1lICYmIHtcbiAgICAgICAgYXJyaXZhbEluOiBNYXRoLm1heCgwLCBiYXNlLmFycml2YWxUaW1lIC0gRGF0ZS5ub3coKSlcbiAgICAgIH0pXG4gICAgfSkpIHx8IFtdO1xuXG4gICAgLy8gRW5jb2RlIHBhZ2luYXRpb24ga2V5XG4gICAgY29uc3QgbGFzdEV2YWx1YXRlZEtleSA9IHJlc3BvbnNlLkxhc3RFdmFsdWF0ZWRLZXkgPyBcbiAgICAgIEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlLkxhc3RFdmFsdWF0ZWRLZXkpKS50b1N0cmluZygnYmFzZTY0JykgOiBcbiAgICAgIHVuZGVmaW5lZDtcblxuICAgIHJldHVybiB7XG4gICAgICBiYXNlczogYmFzZXMsXG4gICAgICBsYXN0RXZhbHVhdGVkS2V5OiBsYXN0RXZhbHVhdGVkS2V5XG4gICAgfTtcblxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIHJldHJpZXZlIHBsYXllciBiYXNlcycsXG4gICAgICAnQkFTRV9RVUVSWV9FUlJPUicsXG4gICAgICB7IHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLCBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIH1cbiAgICApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNhbGN1bGF0ZUJhc2VTdW1tYXJ5KHBsYXllcklkOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICB0cnkge1xuICAgIC8vIEdldCBhbGwgYmFzZXMgZm9yIHN1bW1hcnkgc3RhdGlzdGljc1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogUExBWUVSX0JBU0VTX1RBQkxFLFxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ3BsYXllcklkID0gOnBsYXllcklkJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpwbGF5ZXJJZCc6IHBsYXllcklkXG4gICAgICB9LFxuICAgICAgUHJvamVjdGlvbkV4cHJlc3Npb246ICcjc3RhdHVzLCBiYXNlVHlwZSwgI2xldmVsLCBjcmVhdGVkQXQnLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICcjc3RhdHVzJzogJ3N0YXR1cycsXG4gICAgICAgICcjbGV2ZWwnOiAnbGV2ZWwnXG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIGNvbnN0IGJhc2VzID0gcmVzcG9uc2UuSXRlbXMgfHwgW107XG5cbiAgICAvLyBDYWxjdWxhdGUgc3RhdGlzdGljc1xuICAgIGNvbnN0IHN1bW1hcnkgPSB7XG4gICAgICB0b3RhbEJhc2VzOiBiYXNlcy5sZW5ndGgsXG4gICAgICBhY3RpdmVCYXNlOiBiYXNlcy5maWx0ZXIoYiA9PiBiLnN0YXR1cyA9PT0gJ2FjdGl2ZScpLmxlbmd0aCxcbiAgICAgIGJ1aWxkaW5nQmFzZXM6IGJhc2VzLmZpbHRlcihiID0+IGIuc3RhdHVzID09PSAnYnVpbGRpbmcnKS5sZW5ndGgsXG4gICAgICBtb3ZpbmdCYXNlczogYmFzZXMuZmlsdGVyKGIgPT4gYi5zdGF0dXMgPT09ICdtb3ZpbmcnKS5sZW5ndGgsXG4gICAgICBkZXN0cm95ZWRCYXNlczogYmFzZXMuZmlsdGVyKGIgPT4gYi5zdGF0dXMgPT09ICdkZXN0cm95ZWQnKS5sZW5ndGgsXG4gICAgICBcbiAgICAgIC8vIEJhc2UgdHlwZSBkaXN0cmlidXRpb25cbiAgICAgIGJhc2VUeXBlczogYmFzZXMucmVkdWNlKChhY2MsIGJhc2UpID0+IHtcbiAgICAgICAgYWNjW2Jhc2UuYmFzZVR5cGVdID0gKGFjY1tiYXNlLmJhc2VUeXBlXSB8fCAwKSArIDE7XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LCB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+KSxcbiAgICAgIFxuICAgICAgLy8gTGV2ZWwgZGlzdHJpYnV0aW9uXG4gICAgICBhdmVyYWdlTGV2ZWw6IGJhc2VzLmxlbmd0aCA+IDAgPyBcbiAgICAgICAgTWF0aC5yb3VuZChiYXNlcy5yZWR1Y2UoKHN1bSwgYmFzZSkgPT4gc3VtICsgKGJhc2UubGV2ZWwgfHwgMSksIDApIC8gYmFzZXMubGVuZ3RoICogMTApIC8gMTAgOiAwLFxuICAgICAgbWF4TGV2ZWw6IGJhc2VzLmxlbmd0aCA+IDAgPyBNYXRoLm1heCguLi5iYXNlcy5tYXAoYmFzZSA9PiBiYXNlLmxldmVsIHx8IDEpKSA6IDAsXG4gICAgICBcbiAgICAgIC8vIFRPRE86IEFkZCBzdWJzY3JpcHRpb24gaW5mbyAobWF4IGJhc2VzIGFsbG93ZWQpXG4gICAgICBtYXhCYXNlc0FsbG93ZWQ6IDUsIC8vIERlZmF1bHQgZm9yIGZyZWUgcGxheWVyc1xuICAgICAgY2FuQ3JlYXRlTW9yZTogYmFzZXMuZmlsdGVyKGIgPT4gYi5zdGF0dXMgIT09ICdkZXN0cm95ZWQnKS5sZW5ndGggPCA1LFxuICAgICAgXG4gICAgICAvLyBPbGRlc3QgYW5kIG5ld2VzdCBiYXNlXG4gICAgICBvbGRlc3RCYXNlOiBiYXNlcy5sZW5ndGggPiAwID8gTWF0aC5taW4oLi4uYmFzZXMubWFwKGJhc2UgPT4gYmFzZS5jcmVhdGVkQXQpKSA6IG51bGwsXG4gICAgICBuZXdlc3RCYXNlOiBiYXNlcy5sZW5ndGggPiAwID8gTWF0aC5tYXgoLi4uYmFzZXMubWFwKGJhc2UgPT4gYmFzZS5jcmVhdGVkQXQpKSA6IG51bGxcbiAgICB9O1xuXG4gICAgcmV0dXJuIHN1bW1hcnk7XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAvLyBSZXR1cm4gYmFzaWMgc3VtbWFyeSBpZiBkZXRhaWxlZCBjYWxjdWxhdGlvbiBmYWlsc1xuICAgIGxvZ2dlci53YXJuKCdGYWlsZWQgdG8gY2FsY3VsYXRlIGRldGFpbGVkIGJhc2Ugc3VtbWFyeScsIHsgXG4gICAgICBwbGF5ZXJJZCwgXG4gICAgICBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIFxuICAgIH0pO1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICB0b3RhbEJhc2VzOiAwLFxuICAgICAgYWN0aXZlQmFzZXM6IDAsXG4gICAgICBidWlsZGluZ0Jhc2VzOiAwLFxuICAgICAgbW92aW5nQmFzZXM6IDAsXG4gICAgICBkZXN0cm95ZWRCYXNlczogMCxcbiAgICAgIGJhc2VUeXBlczoge30sXG4gICAgICBhdmVyYWdlTGV2ZWw6IDAsXG4gICAgICBtYXhMZXZlbDogMCxcbiAgICAgIG1heEJhc2VzQWxsb3dlZDogNSxcbiAgICAgIGNhbkNyZWF0ZU1vcmU6IHRydWUsXG4gICAgICBvbGRlc3RCYXNlOiBudWxsLFxuICAgICAgbmV3ZXN0QmFzZTogbnVsbFxuICAgIH07XG4gIH1cbn0iXX0=