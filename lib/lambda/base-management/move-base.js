"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const shared_mocks_1 = require("../../lib/shared-mocks");
const zod_1 = require("zod");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const logger = new shared_mocks_1.StructuredLogger('MoveBaseHandler');
const PLAYER_BASES_TABLE = process.env.PLAYER_BASES_TABLE ?? '';
const MoveBaseRequestSchema = zod_1.z.object({
    playerId: zod_1.z.string().min(1).max(50),
    baseId: zod_1.z.string().min(1).max(50),
    newCoordinates: zod_1.z.object({
        x: zod_1.z.number().min(-1000000).max(1000000),
        y: zod_1.z.number().min(-1000000).max(1000000)
    }),
    useTeleport: zod_1.z.boolean().optional().default(false) // Instant movement for gold
});
/**
 * Move Base Handler
 *
 * Implements base movement system following SOLID principles:
 * - Single Responsibility: Only handles base relocation
 * - Open/Closed: Extensible for different movement types
 * - Liskov Substitution: All movement types follow same pattern
 * - Interface Segregation: Clear movement operation interface
 * - Dependency Inversion: Depends on shared game utilities
 *
 * Game Mechanics:
 * - Validates movement cooldown (60 minutes default)
 * - Supports instant teleportation for gold cost
 * - Prevents movement to occupied coordinates
 * - Calculates travel time based on distance
 * - Updates map sectioning for efficient queries
 * - Implements movement restrictions near enemy bases
 */
const handler = async (event) => {
    return (0, shared_mocks_1.withErrorHandling)(async () => {
        logger.info('Processing base movement request', {
            requestId: event.requestContext?.requestId
        });
        const request = await (0, shared_mocks_1.validateRequest)(MoveBaseRequestSchema, event.body);
        // Get current base state
        const currentBase = await getPlayerBase(request.playerId, request.baseId);
        // Validate movement is allowed
        validateMovement(currentBase, request.newCoordinates, request.useTeleport);
        // Check destination is available
        await validateDestination(request.newCoordinates, request.baseId);
        // Calculate movement cost and time
        const movementDetails = calculateMovementDetails(currentBase, request.newCoordinates, request.useTeleport);
        // Execute the movement
        const result = await executeBaseMovement(request, currentBase, movementDetails);
        logger.info('Base movement processed', {
            playerId: request.playerId,
            baseId: request.baseId,
            fromCoordinates: currentBase.coordinates,
            toCoordinates: request.newCoordinates,
            teleport: request.useTeleport,
            travelTime: movementDetails.travelTime
        });
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                success: true,
                data: {
                    movement: result,
                    message: request.useTeleport
                        ? 'Base teleported instantly'
                        : `Base movement initiated, arrival in ${Math.ceil(movementDetails.travelTime / 60)} minutes`
                }
            })
        };
    }, logger);
};
exports.handler = handler;
async function getPlayerBase(playerId, baseId) {
    try {
        const command = new lib_dynamodb_1.GetCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: { playerId, baseId }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError('Base not found', 'BASE_NOT_FOUND', { playerId, baseId });
        }
        const base = response.Item;
        if (base.status !== 'active') {
            throw new shared_mocks_1.GameEngineError(`Cannot move base with status: ${base.status}`, 'INVALID_BASE_STATUS', { playerId, baseId, status: base.status });
        }
        return base;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to retrieve base', 'BASE_RETRIEVAL_ERROR', { playerId, baseId, error: error.message });
    }
}
function validateMovement(base, newCoordinates, useTeleport) {
    try {
        const now = Date.now();
        const cooldownPeriod = 60 * 60 * 1000; // 60 minutes in milliseconds
        // Check movement cooldown (unless using teleport)
        if (!useTeleport && base.lastMovedAt && (now - base.lastMovedAt) < cooldownPeriod) {
            const remainingCooldown = cooldownPeriod - (now - base.lastMovedAt);
            throw new shared_mocks_1.GameEngineError('Base movement on cooldown', 'MOVEMENT_COOLDOWN', {
                baseId: base.baseId,
                remainingMinutes: Math.ceil(remainingCooldown / (60 * 1000))
            });
        }
        // Validate coordinates are different
        if (base.coordinates.x === newCoordinates.x && base.coordinates.y === newCoordinates.y) {
            throw new shared_mocks_1.GameEngineError('New coordinates must be different from current location', 'SAME_COORDINATES', { currentCoordinates: base.coordinates, newCoordinates });
        }
        // Validate movement distance (max 1000 units for normal movement)
        if (!useTeleport) {
            const distance = calculateDistance(base.coordinates, newCoordinates);
            const maxDistance = 1000;
            if (distance > maxDistance) {
                throw new shared_mocks_1.GameEngineError(`Movement distance exceeds maximum (${maxDistance} units)`, 'DISTANCE_TOO_FAR', { distance, maxDistance, coordinates: { from: base.coordinates, to: newCoordinates } });
            }
        }
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Movement validation failed', 'MOVEMENT_VALIDATION_ERROR', { baseId: base.baseId, error: error.message });
    }
}
async function validateDestination(coordinates, excludeBaseId) {
    try {
        const coordinateHash = `${coordinates.x},${coordinates.y}`;
        // Check if coordinates are occupied by another base
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: PLAYER_BASES_TABLE,
            IndexName: 'LocationIndex',
            KeyConditionExpression: 'mapSectionId = :sectionId AND coordinateHash = :coordHash',
            ExpressionAttributeValues: {
                ':sectionId': `${Math.floor(coordinates.x / 100)},${Math.floor(coordinates.y / 100)}`,
                ':coordHash': coordinateHash,
                ':excludeBaseId': excludeBaseId,
                ':destroyed': 'destroyed'
            },
            FilterExpression: 'baseId <> :excludeBaseId AND #status <> :destroyed',
            ExpressionAttributeNames: {
                '#status': 'status'
            }
        });
        const response = await docClient.send(command);
        if (response.Items && response.Items.length > 0) {
            throw new shared_mocks_1.GameEngineError('Destination coordinates are occupied', 'COORDINATES_OCCUPIED', { coordinates, occupiedBy: response.Items[0].baseId });
        }
        // TODO: Add validation for restricted zones, enemy alliance territories, etc.
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Destination validation failed', 'DESTINATION_VALIDATION_ERROR', { coordinates, error: error.message });
    }
}
function calculateMovementDetails(base, newCoordinates, useTeleport) {
    const distance = calculateDistance(base.coordinates, newCoordinates);
    if (useTeleport) {
        // Instant teleportation with gold cost
        const goldCost = Math.max(50, Math.ceil(distance / 10)); // 1 gold per 10 units, minimum 50
        return {
            travelTime: 0,
            goldCost: goldCost,
            distance: distance
        };
    }
    else {
        // Calculate travel time: 1 minute per unit distance (minimum 5 minutes)
        const travelTime = Math.max(300, distance * 60); // seconds
        return {
            travelTime: travelTime,
            distance: distance
        };
    }
}
function calculateDistance(from, to) {
    const dx = to.x - from.x;
    const dy = to.y - from.y;
    return Math.sqrt(dx * dx + dy * dy);
}
async function executeBaseMovement(request, base, movementDetails) {
    try {
        const now = Date.now();
        const arrivalTime = now + (movementDetails.travelTime * 1000);
        // Calculate new map section
        const newMapSectionId = `${Math.floor(request.newCoordinates.x / 100)},${Math.floor(request.newCoordinates.y / 100)}`;
        const newCoordinateHash = `${request.newCoordinates.x},${request.newCoordinates.y}`;
        const updateExpression = request.useTeleport
            ? 'SET coordinates = :newCoords, mapSectionId = :newSection, coordinateHash = :newHash, lastMovedAt = :now, lastActiveAt = :now'
            : 'SET coordinates = :newCoords, mapSectionId = :newSection, coordinateHash = :newHash, #status = :moving, lastMovedAt = :now, lastActiveAt = :now, arrivalTime = :arrivalTime';
        const expressionAttributeNames = request.useTeleport ? {} : { '#status': 'status' };
        const expressionAttributeValues = {
            ':newCoords': request.newCoordinates,
            ':newSection': newMapSectionId,
            ':newHash': newCoordinateHash,
            ':now': now
        };
        if (!request.useTeleport) {
            expressionAttributeValues[':moving'] = 'moving';
            expressionAttributeValues[':arrivalTime'] = arrivalTime;
        }
        const command = new lib_dynamodb_1.UpdateCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: {
                playerId: request.playerId,
                baseId: request.baseId
            },
            UpdateExpression: updateExpression,
            ExpressionAttributeNames: Object.keys(expressionAttributeNames).length > 0 ? expressionAttributeNames : undefined,
            ExpressionAttributeValues: expressionAttributeValues,
            ReturnValues: 'ALL_NEW'
        });
        const response = await docClient.send(command);
        // TODO: If teleport, deduct gold cost from player resources (integrate with resource service)
        return response.Attributes;
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to execute base movement', 'MOVEMENT_EXECUTION_ERROR', {
            playerId: request.playerId,
            baseId: request.baseId,
            error: error.message
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW92ZS1iYXNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGFtYmRhL2Jhc2UtbWFuYWdlbWVudC9tb3ZlLWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUF3RztBQUN4Ryx5REFLZ0M7QUFDaEMsNkJBQXdCO0FBTXhCLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUM1QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDNUQsTUFBTSxNQUFNLEdBQUcsSUFBSSwrQkFBZ0IsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBRXZELE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsSUFBSSxFQUFFLENBQUM7QUFFaEUsTUFBTSxxQkFBcUIsR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3JDLFFBQVEsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7SUFDbkMsTUFBTSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztJQUNqQyxjQUFjLEVBQUUsT0FBQyxDQUFDLE1BQU0sQ0FBQztRQUN2QixDQUFDLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUM7UUFDeEMsQ0FBQyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0tBQ3pDLENBQUM7SUFDRixXQUFXLEVBQUUsT0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFD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IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgR2V0Q29tbWFuZCwgVXBkYXRlQ29tbWFuZCwgUXVlcnlDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IFxuICBTdHJ1Y3R1cmVkTG9nZ2VyLCBcbiAgR2FtZUVuZ2luZUVycm9yLFxuICB3aXRoRXJyb3JIYW5kbGluZyxcbiAgdmFsaWRhdGVSZXF1ZXN0IFxufSBmcm9tICcuLi8uLi9saWIvc2hhcmVkLW1vY2tzJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuaW1wb3J0IHsgXG4gIFBsYXllckJhc2UsIFxuICBDb29yZGluYXRlcyBcbn0gZnJvbSAnLi4vdHlwZXMvZ2FtZS1iYXNlLXR5cGVzJztcblxuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkeW5hbW9DbGllbnQpO1xuY29uc3QgbG9nZ2VyID0gbmV3IFN0cnVjdHVyZWRMb2dnZXIoJ01vdmVCYXNlSGFuZGxlcicpO1xuXG5jb25zdCBQTEFZRVJfQkFTRVNfVEFCTEUgPSBwcm9jZXNzLmVudi5QTEFZRVJfQkFTRVNfVEFCTEUgPz8gJyc7XG5cbmNvbnN0IE1vdmVCYXNlUmVxdWVzdFNjaGVtYSA9IHoub2JqZWN0KHtcbiAgcGxheWVySWQ6IHouc3RyaW5nKCkubWluKDEpLm1heCg1MCksXG4gIGJhc2VJZDogei5zdHJpbmcoKS5taW4oMSkubWF4KDUwKSxcbiAgbmV3Q29vcmRpbmF0ZXM6IHoub2JqZWN0KHtcbiAgICB4OiB6Lm51bWJlcigpLm1pbigtMTAwMDAwMCkubWF4KDEwMDAwMDApLFxuICAgIHk6IHoubnVtYmVyKCkubWluKC0xMDAwMDAwKS5tYXgoMTAwMDAwMClcbiAgfSksXG4gIHVzZVRlbGVwb3J0OiB6LmJvb2xlYW4oKS5vcHRpb25hbCgpLmRlZmF1bHQoZmFsc2UpIC8vIEluc3RhbnQgbW92ZW1lbnQgZm9yIGdvbGRcbn0pO1xuXG50eXBlIE1vdmVCYXNlUmVxdWVzdElucHV0ID0gei5pbmZlcjx0eXBlb2YgTW92ZUJhc2VSZXF1ZXN0U2NoZW1hPjtcblxuLyoqXG4gKiBNb3ZlIEJhc2UgSGFuZGxlclxuICogXG4gKiBJbXBsZW1lbnRzIGJhc2UgbW92ZW1lbnQgc3lzdGVtIGZvbGxvd2luZyBTT0xJRCBwcmluY2lwbGVzOlxuICogLSBTaW5nbGUgUmVzcG9uc2liaWxpdHk6IE9ubHkgaGFuZGxlcyBiYXNlIHJlbG9jYXRpb25cbiAqIC0gT3Blbi9DbG9zZWQ6IEV4dGVuc2libGUgZm9yIGRpZmZlcmVudCBtb3ZlbWVudCB0eXBlc1xuICogLSBMaXNrb3YgU3Vic3RpdHV0aW9uOiBBbGwgbW92ZW1lbnQgdHlwZXMgZm9sbG93IHNhbWUgcGF0dGVyblxuICogLSBJbnRlcmZhY2UgU2VncmVnYXRpb246IENsZWFyIG1vdmVtZW50IG9wZXJhdGlvbiBpbnRlcmZhY2VcbiAqIC0gRGVwZW5kZW5jeSBJbnZlcnNpb246IERlcGVuZHMgb24gc2hhcmVkIGdhbWUgdXRpbGl0aWVzXG4gKiBcbiAqIEdhbWUgTWVjaGFuaWNzOlxuICogLSBWYWxpZGF0ZXMgbW92ZW1lbnQgY29vbGRvd24gKDYwIG1pbnV0ZXMgZGVmYXVsdClcbiAqIC0gU3VwcG9ydHMgaW5zdGFudCB0ZWxlcG9ydGF0aW9uIGZvciBnb2xkIGNvc3RcbiAqIC0gUHJldmVudHMgbW92ZW1lbnQgdG8gb2NjdXBpZWQgY29vcmRpbmF0ZXNcbiAqIC0gQ2FsY3VsYXRlcyB0cmF2ZWwgdGltZSBiYXNlZCBvbiBkaXN0YW5jZVxuICogLSBVcGRhdGVzIG1hcCBzZWN0aW9uaW5nIGZvciBlZmZpY2llbnQgcXVlcmllc1xuICogLSBJbXBsZW1lbnRzIG1vdmVtZW50IHJlc3RyaWN0aW9ucyBuZWFyIGVuZW15IGJhc2VzXG4gKi9cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIHJldHVybiB3aXRoRXJyb3JIYW5kbGluZyhhc3luYyAoKSA9PiB7XG4gICAgbG9nZ2VyLmluZm8oJ1Byb2Nlc3NpbmcgYmFzZSBtb3ZlbWVudCByZXF1ZXN0JywgeyBcbiAgICAgIHJlcXVlc3RJZDogZXZlbnQucmVxdWVzdENvbnRleHQ/LnJlcXVlc3RJZCBcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlcXVlc3QgPSBhd2FpdCB2YWxpZGF0ZVJlcXVlc3Q8TW92ZUJhc2VSZXF1ZXN0SW5wdXQ+KE1vdmVCYXNlUmVxdWVzdFNjaGVtYSwgZXZlbnQuYm9keSk7XG4gICAgXG4gICAgLy8gR2V0IGN1cnJlbnQgYmFzZSBzdGF0ZVxuICAgIGNvbnN0IGN1cnJlbnRCYXNlID0gYXdhaXQgZ2V0UGxheWVyQmFzZShyZXF1ZXN0LnBsYXllcklkLCByZXF1ZXN0LmJhc2VJZCk7XG4gICAgXG4gICAgLy8gVmFsaWRhdGUgbW92ZW1lbnQgaXMgYWxsb3dlZFxuICAgIHZhbGlkYXRlTW92ZW1lbnQoY3VycmVudEJhc2UsIHJlcXVlc3QubmV3Q29vcmRpbmF0ZXMsIHJlcXVlc3QudXNlVGVsZXBvcnQpO1xuICAgIFxuICAgIC8vIENoZWNrIGRlc3RpbmF0aW9uIGlzIGF2YWlsYWJsZVxuICAgIGF3YWl0IHZhbGlkYXRlRGVzdGluYXRpb24ocmVxdWVzdC5uZXdDb29yZGluYXRlcywgcmVxdWVzdC5iYXNlSWQpO1xuICAgIFxuICAgIC8vIENhbGN1bGF0ZSBtb3ZlbWVudCBjb3N0IGFuZCB0aW1lXG4gICAgY29uc3QgbW92ZW1lbnREZXRhaWxzID0gY2FsY3VsYXRlTW92ZW1lbnREZXRhaWxzKGN1cnJlbnRCYXNlLCByZXF1ZXN0Lm5ld0Nvb3JkaW5hdGVzLCByZXF1ZXN0LnVzZVRlbGVwb3J0KTtcbiAgICBcbiAgICAvLyBFeGVjdXRlIHRoZSBtb3ZlbWVudFxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGV4ZWN1dGVCYXNlTW92ZW1lbnQocmVxdWVzdCwgY3VycmVudEJhc2UsIG1vdmVtZW50RGV0YWlscyk7XG5cbiAgICBsb2dnZXIuaW5mbygnQmFzZSBtb3ZlbWVudCBwcm9jZXNzZWQnLCB7XG4gICAgICBwbGF5ZXJJZDogcmVxdWVzdC5wbGF5ZXJJZCxcbiAgICAgIGJhc2VJZDogcmVxdWVzdC5iYXNlSWQsXG4gICAgICBmcm9tQ29vcmRpbmF0ZXM6IGN1cnJlbnRCYXNlLmNvb3JkaW5hdGVzLFxuICAgICAgdG9Db29yZGluYXRlczogcmVxdWVzdC5uZXdDb29yZGluYXRlcyxcbiAgICAgIHRlbGVwb3J0OiByZXF1ZXN0LnVzZVRlbGVwb3J0LFxuICAgICAgdHJhdmVsVGltZTogbW92ZW1lbnREZXRhaWxzLnRyYXZlbFRpbWVcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKidcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBtb3ZlbWVudDogcmVzdWx0LFxuICAgICAgICAgIG1lc3NhZ2U6IHJlcXVlc3QudXNlVGVsZXBvcnQgXG4gICAgICAgICAgICA/ICdCYXNlIHRlbGVwb3J0ZWQgaW5zdGFudGx5JyBcbiAgICAgICAgICAgIDogYEJhc2UgbW92ZW1lbnQgaW5pdGlhdGVkLCBhcnJpdmFsIGluICR7TWF0aC5jZWlsKG1vdmVtZW50RGV0YWlscy50cmF2ZWxUaW1lIC8gNjApfSBtaW51dGVzYFxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH07XG4gIH0sIGxvZ2dlcik7XG59O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRQbGF5ZXJCYXNlKHBsYXllcklkOiBzdHJpbmcsIGJhc2VJZDogc3RyaW5nKTogUHJvbWlzZTxQbGF5ZXJCYXNlPiB7XG4gIHRyeSB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogUExBWUVSX0JBU0VTX1RBQkxFLFxuICAgICAgS2V5OiB7IHBsYXllcklkLCBiYXNlSWQgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBcbiAgICBpZiAoIXJlc3BvbnNlLkl0ZW0pIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdCYXNlIG5vdCBmb3VuZCcsXG4gICAgICAgICdCQVNFX05PVF9GT1VORCcsXG4gICAgICAgIHsgcGxheWVySWQsIGJhc2VJZCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IGJhc2UgPSByZXNwb25zZS5JdGVtIGFzIFBsYXllckJhc2U7XG4gICAgXG4gICAgaWYgKGJhc2Uuc3RhdHVzICE9PSAnYWN0aXZlJykge1xuICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgYENhbm5vdCBtb3ZlIGJhc2Ugd2l0aCBzdGF0dXM6ICR7YmFzZS5zdGF0dXN9YCxcbiAgICAgICAgJ0lOVkFMSURfQkFTRV9TVEFUVVMnLFxuICAgICAgICB7IHBsYXllcklkLCBiYXNlSWQsIHN0YXR1czogYmFzZS5zdGF0dXMgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYmFzZTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBHYW1lRW5naW5lRXJyb3IpIHRocm93IGVycm9yO1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIHJldHJpZXZlIGJhc2UnLFxuICAgICAgJ0JBU0VfUkVUUklFVkFMX0VSUk9SJyxcbiAgICAgIHsgcGxheWVySWQsIGJhc2VJZCwgZXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSB9XG4gICAgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZU1vdmVtZW50KFxuICBiYXNlOiBQbGF5ZXJCYXNlLCBcbiAgbmV3Q29vcmRpbmF0ZXM6IENvb3JkaW5hdGVzLCBcbiAgdXNlVGVsZXBvcnQ6IGJvb2xlYW5cbik6IHZvaWQge1xuICB0cnkge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgY29uc3QgY29vbGRvd25QZXJpb2QgPSA2MCAqIDYwICogMTAwMDsgLy8gNjAgbWludXRlcyBpbiBtaWxsaXNlY29uZHNcbiAgICBcbiAgICAvLyBDaGVjayBtb3ZlbWVudCBjb29sZG93biAodW5sZXNzIHVzaW5nIHRlbGVwb3J0KVxuICAgIGlmICghdXNlVGVsZXBvcnQgJiYgYmFzZS5sYXN0TW92ZWRBdCAmJiAobm93IC0gYmFzZS5sYXN0TW92ZWRBdCkgPCBjb29sZG93blBlcmlvZCkge1xuICAgICAgY29uc3QgcmVtYWluaW5nQ29vbGRvd24gPSBjb29sZG93blBlcmlvZCAtIChub3cgLSBiYXNlLmxhc3RNb3ZlZEF0KTtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdCYXNlIG1vdmVtZW50IG9uIGNvb2xkb3duJyxcbiAgICAgICAgJ01PVkVNRU5UX0NPT0xET1dOJyxcbiAgICAgICAgeyBcbiAgICAgICAgICBiYXNlSWQ6IGJhc2UuYmFzZUlkLCBcbiAgICAgICAgICByZW1haW5pbmdNaW51dGVzOiBNYXRoLmNlaWwocmVtYWluaW5nQ29vbGRvd24gLyAoNjAgKiAxMDAwKSlcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBjb29yZGluYXRlcyBhcmUgZGlmZmVyZW50XG4gICAgaWYgKGJhc2UuY29vcmRpbmF0ZXMueCA9PT0gbmV3Q29vcmRpbmF0ZXMueCAmJiBiYXNlLmNvb3JkaW5hdGVzLnkgPT09IG5ld0Nvb3JkaW5hdGVzLnkpIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdOZXcgY29vcmRpbmF0ZXMgbXVzdCBiZSBkaWZmZXJlbnQgZnJvbSBjdXJyZW50IGxvY2F0aW9uJyxcbiAgICAgICAgJ1NBTUVfQ09PUkRJTkFURVMnLFxuICAgICAgICB7IGN1cnJlbnRDb29yZGluYXRlczogYmFzZS5jb29yZGluYXRlcywgbmV3Q29vcmRpbmF0ZXMgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBtb3ZlbWVudCBkaXN0YW5jZSAobWF4IDEwMDAgdW5pdHMgZm9yIG5vcm1hbCBtb3ZlbWVudClcbiAgICBpZiAoIXVzZVRlbGVwb3J0KSB7XG4gICAgICBjb25zdCBkaXN0YW5jZSA9IGNhbGN1bGF0ZURpc3RhbmNlKGJhc2UuY29vcmRpbmF0ZXMsIG5ld0Nvb3JkaW5hdGVzKTtcbiAgICAgIGNvbnN0IG1heERpc3RhbmNlID0gMTAwMDtcbiAgICAgIFxuICAgICAgaWYgKGRpc3RhbmNlID4gbWF4RGlzdGFuY2UpIHtcbiAgICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgICBgTW92ZW1lbnQgZGlzdGFuY2UgZXhjZWVkcyBtYXhpbXVtICgke21heERpc3RhbmNlfSB1bml0cylgLFxuICAgICAgICAgICdESVNUQU5DRV9UT09fRkFSJyxcbiAgICAgICAgICB7IGRpc3RhbmNlLCBtYXhEaXN0YW5jZSwgY29vcmRpbmF0ZXM6IHsgZnJvbTogYmFzZS5jb29yZGluYXRlcywgdG86IG5ld0Nvb3JkaW5hdGVzIH0gfVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEdhbWVFbmdpbmVFcnJvcikgdGhyb3cgZXJyb3I7XG4gICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICdNb3ZlbWVudCB2YWxpZGF0aW9uIGZhaWxlZCcsXG4gICAgICAnTU9WRU1FTlRfVkFMSURBVElPTl9FUlJPUicsXG4gICAgICB7IGJhc2VJZDogYmFzZS5iYXNlSWQsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gdmFsaWRhdGVEZXN0aW5hdGlvbihcbiAgY29vcmRpbmF0ZXM6IENvb3JkaW5hdGVzLCBcbiAgZXhjbHVkZUJhc2VJZDogc3RyaW5nXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBjb29yZGluYXRlSGFzaCA9IGAke2Nvb3JkaW5hdGVzLnh9LCR7Y29vcmRpbmF0ZXMueX1gO1xuICAgIFxuICAgIC8vIENoZWNrIGlmIGNvb3JkaW5hdGVzIGFyZSBvY2N1cGllZCBieSBhbm90aGVyIGJhc2VcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFBMQVlFUl9CQVNFU19UQUJMRSxcbiAgICAgIEluZGV4TmFtZTogJ0xvY2F0aW9uSW5kZXgnLFxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ21hcFNlY3Rpb25JZCA9IDpzZWN0aW9uSWQgQU5EIGNvb3JkaW5hdGVIYXNoID0gOmNvb3JkSGFzaCcsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6c2VjdGlvbklkJzogYCR7TWF0aC5mbG9vcihjb29yZGluYXRlcy54IC8gMTAwKX0sJHtNYXRoLmZsb29yKGNvb3JkaW5hdGVzLnkgLyAxMDApfWAsXG4gICAgICAgICc6Y29vcmRIYXNoJzogY29vcmRpbmF0ZUhhc2gsXG4gICAgICAgICc6ZXhjbHVkZUJhc2VJZCc6IGV4Y2x1ZGVCYXNlSWQsXG4gICAgICAgICc6ZGVzdHJveWVkJzogJ2Rlc3Ryb3llZCdcbiAgICAgIH0sXG4gICAgICBGaWx0ZXJFeHByZXNzaW9uOiAnYmFzZUlkIDw+IDpleGNsdWRlQmFzZUlkIEFORCAjc3RhdHVzIDw+IDpkZXN0cm95ZWQnLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICcjc3RhdHVzJzogJ3N0YXR1cydcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgXG4gICAgaWYgKHJlc3BvbnNlLkl0ZW1zICYmIHJlc3BvbnNlLkl0ZW1zLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdEZXN0aW5hdGlvbiBjb29yZGluYXRlcyBhcmUgb2NjdXBpZWQnLFxuICAgICAgICAnQ09PUkRJTkFURVNfT0NDVVBJRUQnLFxuICAgICAgICB7IGNvb3JkaW5hdGVzLCBvY2N1cGllZEJ5OiByZXNwb25zZS5JdGVtc1swXS5iYXNlSWQgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBBZGQgdmFsaWRhdGlvbiBmb3IgcmVzdHJpY3RlZCB6b25lcywgZW5lbXkgYWxsaWFuY2UgdGVycml0b3JpZXMsIGV0Yy5cbiAgICBcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBHYW1lRW5naW5lRXJyb3IpIHRocm93IGVycm9yO1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRGVzdGluYXRpb24gdmFsaWRhdGlvbiBmYWlsZWQnLFxuICAgICAgJ0RFU1RJTkFUSU9OX1ZBTElEQVRJT05fRVJST1InLFxuICAgICAgeyBjb29yZGluYXRlcywgZXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSB9XG4gICAgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVNb3ZlbWVudERldGFpbHMoXG4gIGJhc2U6IFBsYXllckJhc2UsIFxuICBuZXdDb29yZGluYXRlczogQ29vcmRpbmF0ZXMsIFxuICB1c2VUZWxlcG9ydDogYm9vbGVhblxuKTogeyB0cmF2ZWxUaW1lOiBudW1iZXI7IGdvbGRDb3N0PzogbnVtYmVyOyBkaXN0YW5jZTogbnVtYmVyIH0ge1xuICBjb25zdCBkaXN0YW5jZSA9IGNhbGN1bGF0ZURpc3RhbmNlKGJhc2UuY29vcmRpbmF0ZXMsIG5ld0Nvb3JkaW5hdGVzKTtcbiAgXG4gIGlmICh1c2VUZWxlcG9ydCkge1xuICAgIC8vIEluc3RhbnQgdGVsZXBvcnRhdGlvbiB3aXRoIGdvbGQgY29zdFxuICAgIGNvbnN0IGdvbGRDb3N0ID0gTWF0aC5tYXgoNTAsIE1hdGguY2VpbChkaXN0YW5jZSAvIDEwKSk7IC8vIDEgZ29sZCBwZXIgMTAgdW5pdHMsIG1pbmltdW0gNTBcbiAgICByZXR1cm4ge1xuICAgICAgdHJhdmVsVGltZTogMCxcbiAgICAgIGdvbGRDb3N0OiBnb2xkQ29zdCxcbiAgICAgIGRpc3RhbmNlOiBkaXN0YW5jZVxuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgLy8gQ2FsY3VsYXRlIHRyYXZlbCB0aW1lOiAxIG1pbnV0ZSBwZXIgdW5pdCBkaXN0YW5jZSAobWluaW11bSA1IG1pbnV0ZXMpXG4gICAgY29uc3QgdHJhdmVsVGltZSA9IE1hdGgubWF4KDMwMCwgZGlzdGFuY2UgKiA2MCk7IC8vIHNlY29uZHNcbiAgICByZXR1cm4ge1xuICAgICAgdHJhdmVsVGltZTogdHJhdmVsVGltZSxcbiAgICAgIGRpc3RhbmNlOiBkaXN0YW5jZVxuICAgIH07XG4gIH1cbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlRGlzdGFuY2UoXG4gIGZyb206IENvb3JkaW5hdGVzLCBcbiAgdG86IENvb3JkaW5hdGVzXG4pOiBudW1iZXIge1xuICBjb25zdCBkeCA9IHRvLnggLSBmcm9tLng7XG4gIGNvbnN0IGR5ID0gdG8ueSAtIGZyb20ueTtcbiAgcmV0dXJuIE1hdGguc3FydChkeCAqIGR4ICsgZHkgKiBkeSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGVCYXNlTW92ZW1lbnQoXG4gIHJlcXVlc3Q6IE1vdmVCYXNlUmVxdWVzdElucHV0LFxuICBiYXNlOiBQbGF5ZXJCYXNlLFxuICBtb3ZlbWVudERldGFpbHM6IHsgdHJhdmVsVGltZTogbnVtYmVyOyBnb2xkQ29zdD86IG51bWJlcjsgZGlzdGFuY2U6IG51bWJlciB9XG4pOiBQcm9taXNlPFBsYXllckJhc2U+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IGFycml2YWxUaW1lID0gbm93ICsgKG1vdmVtZW50RGV0YWlscy50cmF2ZWxUaW1lICogMTAwMCk7XG4gICAgXG4gICAgLy8gQ2FsY3VsYXRlIG5ldyBtYXAgc2VjdGlvblxuICAgIGNvbnN0IG5ld01hcFNlY3Rpb25JZCA9IGAke01hdGguZmxvb3IocmVxdWVzdC5uZXdDb29yZGluYXRlcy54IC8gMTAwKX0sJHtNYXRoLmZsb29yKHJlcXVlc3QubmV3Q29vcmRpbmF0ZXMueSAvIDEwMCl9YDtcbiAgICBjb25zdCBuZXdDb29yZGluYXRlSGFzaCA9IGAke3JlcXVlc3QubmV3Q29vcmRpbmF0ZXMueH0sJHtyZXF1ZXN0Lm5ld0Nvb3JkaW5hdGVzLnl9YDtcbiAgICBcbiAgICBjb25zdCB1cGRhdGVFeHByZXNzaW9uID0gcmVxdWVzdC51c2VUZWxlcG9ydFxuICAgICAgPyAnU0VUIGNvb3JkaW5hdGVzID0gOm5ld0Nvb3JkcywgbWFwU2VjdGlvbklkID0gOm5ld1NlY3Rpb24sIGNvb3JkaW5hdGVIYXNoID0gOm5ld0hhc2gsIGxhc3RNb3ZlZEF0ID0gOm5vdywgbGFzdEFjdGl2ZUF0ID0gOm5vdydcbiAgICAgIDogJ1NFVCBjb29yZGluYXRlcyA9IDpuZXdDb29yZHMsIG1hcFNlY3Rpb25JZCA9IDpuZXdTZWN0aW9uLCBjb29yZGluYXRlSGFzaCA9IDpuZXdIYXNoLCAjc3RhdHVzID0gOm1vdmluZywgbGFzdE1vdmVkQXQgPSA6bm93LCBsYXN0QWN0aXZlQXQgPSA6bm93LCBhcnJpdmFsVGltZSA9IDphcnJpdmFsVGltZSc7XG4gICAgXG4gICAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0gcmVxdWVzdC51c2VUZWxlcG9ydCA/IHt9IDogeyAnI3N0YXR1cyc6ICdzdGF0dXMnIH07XG4gICAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogUmVjb3JkPHN0cmluZywgYW55PiA9IHtcbiAgICAgICc6bmV3Q29vcmRzJzogcmVxdWVzdC5uZXdDb29yZGluYXRlcyxcbiAgICAgICc6bmV3U2VjdGlvbic6IG5ld01hcFNlY3Rpb25JZCxcbiAgICAgICc6bmV3SGFzaCc6IG5ld0Nvb3JkaW5hdGVIYXNoLFxuICAgICAgJzpub3cnOiBub3dcbiAgICB9O1xuXG4gICAgaWYgKCFyZXF1ZXN0LnVzZVRlbGVwb3J0KSB7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6bW92aW5nJ10gPSAnbW92aW5nJztcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzphcnJpdmFsVGltZSddID0gYXJyaXZhbFRpbWU7XG4gICAgfVxuXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBVcGRhdGVDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogUExBWUVSX0JBU0VTX1RBQkxFLFxuICAgICAgS2V5OiB7XG4gICAgICAgIHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLFxuICAgICAgICBiYXNlSWQ6IHJlcXVlc3QuYmFzZUlkXG4gICAgICB9LFxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogdXBkYXRlRXhwcmVzc2lvbixcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogT2JqZWN0LmtleXMoZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzKS5sZW5ndGggPiAwID8gZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzIDogdW5kZWZpbmVkLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgIFJldHVyblZhbHVlczogJ0FMTF9ORVcnXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuXG4gICAgLy8gVE9ETzogSWYgdGVsZXBvcnQsIGRlZHVjdCBnb2xkIGNvc3QgZnJvbSBwbGF5ZXIgcmVzb3VyY2VzIChpbnRlZ3JhdGUgd2l0aCByZXNvdXJjZSBzZXJ2aWNlKVxuXG4gICAgcmV0dXJuIHJlc3BvbnNlLkF0dHJpYnV0ZXMgYXMgUGxheWVyQmFzZTtcblxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIGV4ZWN1dGUgYmFzZSBtb3ZlbWVudCcsXG4gICAgICAnTU9WRU1FTlRfRVhFQ1VUSU9OX0VSUk9SJyxcbiAgICAgIHsgXG4gICAgICAgIHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLCBcbiAgICAgICAgYmFzZUlkOiByZXF1ZXN0LmJhc2VJZCxcbiAgICAgICAgZXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSBcbiAgICAgIH1cbiAgICApO1xuICB9XG59Il19