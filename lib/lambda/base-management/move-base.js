"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const shared_mocks_1 = require("../../lib/shared-mocks");
const zod_1 = require("zod");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const logger = new shared_mocks_1.StructuredLogger('MoveBaseHandler');
const PLAYER_BASES_TABLE = process.env.PLAYER_BASES_TABLE;
const ENVIRONMENT = process.env.ENVIRONMENT;
const MoveBaseRequestSchema = zod_1.z.object({
    playerId: zod_1.z.string().min(1).max(50),
    baseId: zod_1.z.string().min(1).max(50),
    newCoordinates: zod_1.z.object({
        x: zod_1.z.number().min(-1000000).max(1000000),
        y: zod_1.z.number().min(-1000000).max(1000000)
    }),
    useTeleport: zod_1.z.boolean().optional().default(false) // Instant movement for gold
});
/**
 * Move Base Handler
 *
 * Implements base movement system following SOLID principles:
 * - Single Responsibility: Only handles base relocation
 * - Open/Closed: Extensible for different movement types
 * - Liskov Substitution: All movement types follow same pattern
 * - Interface Segregation: Clear movement operation interface
 * - Dependency Inversion: Depends on shared game utilities
 *
 * Game Mechanics:
 * - Validates movement cooldown (60 minutes default)
 * - Supports instant teleportation for gold cost
 * - Prevents movement to occupied coordinates
 * - Calculates travel time based on distance
 * - Updates map sectioning for efficient queries
 * - Implements movement restrictions near enemy bases
 */
const handler = async (event) => {
    return (0, shared_mocks_1.withErrorHandling)(async () => {
        logger.info('Processing base movement request', {
            requestId: event.requestContext?.requestId
        });
        const request = await (0, shared_mocks_1.validateRequest)(MoveBaseRequestSchema, event.body);
        // Get current base state
        const currentBase = await getPlayerBase(request.playerId, request.baseId);
        // Validate movement is allowed
        await validateMovement(currentBase, request.newCoordinates, request.useTeleport);
        // Check destination is available
        await validateDestination(request.newCoordinates, request.baseId);
        // Calculate movement cost and time
        const movementDetails = calculateMovementDetails(currentBase, request.newCoordinates, request.useTeleport);
        // Execute the movement
        const result = await executeBaseMovement(request, currentBase, movementDetails);
        logger.info('Base movement processed', {
            playerId: request.playerId,
            baseId: request.baseId,
            fromCoordinates: currentBase.coordinates,
            toCoordinates: request.newCoordinates,
            teleport: request.useTeleport,
            travelTime: movementDetails.travelTime
        });
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                success: true,
                data: {
                    movement: result,
                    message: request.useTeleport
                        ? 'Base teleported instantly'
                        : `Base movement initiated, arrival in ${Math.ceil(movementDetails.travelTime / 60)} minutes`
                }
            })
        };
    }, logger);
};
exports.handler = handler;
async function getPlayerBase(playerId, baseId) {
    try {
        const command = new lib_dynamodb_1.GetCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: { playerId, baseId }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError('Base not found', 'BASE_NOT_FOUND', { playerId, baseId });
        }
        const base = response.Item;
        if (base.status !== 'active') {
            throw new shared_mocks_1.GameEngineError(`Cannot move base with status: ${base.status}`, 'INVALID_BASE_STATUS', { playerId, baseId, status: base.status });
        }
        return base;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to retrieve base', 'BASE_RETRIEVAL_ERROR', { playerId, baseId, error: error.message });
    }
}
async function validateMovement(base, newCoordinates, useTeleport) {
    try {
        const now = Date.now();
        const cooldownPeriod = 60 * 60 * 1000; // 60 minutes in milliseconds
        // Check movement cooldown (unless using teleport)
        if (!useTeleport && base.lastMovedAt && (now - base.lastMovedAt) < cooldownPeriod) {
            const remainingCooldown = cooldownPeriod - (now - base.lastMovedAt);
            throw new shared_mocks_1.GameEngineError('Base movement on cooldown', 'MOVEMENT_COOLDOWN', {
                baseId: base.baseId,
                remainingMinutes: Math.ceil(remainingCooldown / (60 * 1000))
            });
        }
        // Validate coordinates are different
        if (base.coordinates.x === newCoordinates.x && base.coordinates.y === newCoordinates.y) {
            throw new shared_mocks_1.GameEngineError('New coordinates must be different from current location', 'SAME_COORDINATES', { currentCoordinates: base.coordinates, newCoordinates });
        }
        // Validate movement distance (max 1000 units for normal movement)
        if (!useTeleport) {
            const distance = calculateDistance(base.coordinates, newCoordinates);
            const maxDistance = 1000;
            if (distance > maxDistance) {
                throw new shared_mocks_1.GameEngineError(`Movement distance exceeds maximum (${maxDistance} units)`, 'DISTANCE_TOO_FAR', { distance, maxDistance, coordinates: { from: base.coordinates, to: newCoordinates } });
            }
        }
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Movement validation failed', 'MOVEMENT_VALIDATION_ERROR', { baseId: base.baseId, error: error.message });
    }
}
async function validateDestination(coordinates, excludeBaseId) {
    try {
        const coordinateHash = `${coordinates.x},${coordinates.y}`;
        // Check if coordinates are occupied by another base
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: PLAYER_BASES_TABLE,
            IndexName: 'LocationIndex',
            KeyConditionExpression: 'mapSectionId = :sectionId AND coordinateHash = :coordHash',
            ExpressionAttributeValues: {
                ':sectionId': `${Math.floor(coordinates.x / 100)},${Math.floor(coordinates.y / 100)}`,
                ':coordHash': coordinateHash,
                ':excludeBaseId': excludeBaseId,
                ':destroyed': 'destroyed'
            },
            FilterExpression: 'baseId <> :excludeBaseId AND #status <> :destroyed',
            ExpressionAttributeNames: {
                '#status': 'status'
            }
        });
        const response = await docClient.send(command);
        if (response.Items && response.Items.length > 0) {
            throw new shared_mocks_1.GameEngineError('Destination coordinates are occupied', 'COORDINATES_OCCUPIED', { coordinates, occupiedBy: response.Items[0].baseId });
        }
        // TODO: Add validation for restricted zones, enemy alliance territories, etc.
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Destination validation failed', 'DESTINATION_VALIDATION_ERROR', { coordinates, error: error.message });
    }
}
function calculateMovementDetails(base, newCoordinates, useTeleport) {
    const distance = calculateDistance(base.coordinates, newCoordinates);
    if (useTeleport) {
        // Instant teleportation with gold cost
        const goldCost = Math.max(50, Math.ceil(distance / 10)); // 1 gold per 10 units, minimum 50
        return {
            travelTime: 0,
            goldCost: goldCost,
            distance: distance
        };
    }
    else {
        // Calculate travel time: 1 minute per unit distance (minimum 5 minutes)
        const travelTime = Math.max(300, distance * 60); // seconds
        return {
            travelTime: travelTime,
            distance: distance
        };
    }
}
function calculateDistance(from, to) {
    const dx = to.x - from.x;
    const dy = to.y - from.y;
    return Math.sqrt(dx * dx + dy * dy);
}
async function executeBaseMovement(request, base, movementDetails) {
    try {
        const now = Date.now();
        const arrivalTime = now + (movementDetails.travelTime * 1000);
        // Calculate new map section
        const newMapSectionId = `${Math.floor(request.newCoordinates.x / 100)},${Math.floor(request.newCoordinates.y / 100)}`;
        const newCoordinateHash = `${request.newCoordinates.x},${request.newCoordinates.y}`;
        const updateExpression = request.useTeleport
            ? 'SET coordinates = :newCoords, mapSectionId = :newSection, coordinateHash = :newHash, lastMovedAt = :now, lastActiveAt = :now'
            : 'SET coordinates = :newCoords, mapSectionId = :newSection, coordinateHash = :newHash, #status = :moving, lastMovedAt = :now, lastActiveAt = :now, arrivalTime = :arrivalTime';
        const expressionAttributeNames = request.useTeleport ? {} : { '#status': 'status' };
        const expressionAttributeValues = {
            ':newCoords': request.newCoordinates,
            ':newSection': newMapSectionId,
            ':newHash': newCoordinateHash,
            ':now': now
        };
        if (!request.useTeleport) {
            expressionAttributeValues[':moving'] = 'moving';
            expressionAttributeValues[':arrivalTime'] = arrivalTime;
        }
        const command = new lib_dynamodb_1.UpdateCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: {
                playerId: request.playerId,
                baseId: request.baseId
            },
            UpdateExpression: updateExpression,
            ExpressionAttributeNames: Object.keys(expressionAttributeNames).length > 0 ? expressionAttributeNames : undefined,
            ExpressionAttributeValues: expressionAttributeValues,
            ReturnValues: 'ALL_NEW'
        });
        const response = await docClient.send(command);
        // TODO: If teleport, deduct gold cost from player resources (integrate with resource service)
        return {
            baseId: request.baseId,
            newCoordinates: request.newCoordinates,
            status: request.useTeleport ? 'active' : 'moving',
            arrivalTime: request.useTeleport ? now : arrivalTime,
            goldCost: movementDetails.goldCost,
            distance: movementDetails.distance
        };
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to execute base movement', 'MOVEMENT_EXECUTION_ERROR', {
            playerId: request.playerId,
            baseId: request.baseId,
            error: error.message
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW92ZS1iYXNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGFtYmRhL2Jhc2UtbWFuYWdlbWVudC9tb3ZlLWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUF3RztBQUN4Ryx5REFLZ0M7QUFDaEMsNkJBQXdCO0FBRXhCLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUM1QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDNUQsTUFBTSxNQUFNLEdBQUcsSUFBSSwrQkFBZ0IsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBRXZELE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBbUIsQ0FBQztBQUMzRCxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVksQ0FBQztBQUU3QyxNQUFNLHFCQUFxQixHQUFHLE9BQUMsQ0FBQyxNQUFNLENBQUM7SUFDckMsUUFBUSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztJQUNuQyxNQUFNLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO0lBQ2pDLGNBQWMsRUFBRSxPQUFDLENBQUMsTUFBTSxDQUFDO1FBQ3ZCLENBQUMsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUN4QyxDQUFDLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUM7S0FDekMsQ0FB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LGVBQWUsQ0FBQyxRQUFRO1lBQ2xDLFFBQVEsRUFBRSxlQUFlLENBQUMsUUFBUTtTQUNuQyxDQUFDO0lBRUosQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixNQUFNLElBQUksOEJBQWUsQ0FDdkIsaUNBQWlDLEVBQ2pDLDBCQUEwQixFQUMxQjtZQUNFLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtZQUMxQixNQUFNLEVBQUUsT0FBTyxDQUFDLE1BQU07WUFDdEIsS0FBSyxFQUFHLEtBQWUsQ0FBQyxPQUFPO1NBQ2hDLENBQ0YsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgR2V0Q29tbWFuZCwgVXBkYXRlQ29tbWFuZCwgUXVlcnlDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IFxuICBTdHJ1Y3R1cmVkTG9nZ2VyLCBcbiAgR2FtZUVuZ2luZUVycm9yLFxuICB3aXRoRXJyb3JIYW5kbGluZyxcbiAgdmFsaWRhdGVSZXF1ZXN0IFxufSBmcm9tICcuLi8uLi9saWIvc2hhcmVkLW1vY2tzJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuXG5jb25zdCBkeW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGR5bmFtb0NsaWVudCk7XG5jb25zdCBsb2dnZXIgPSBuZXcgU3RydWN0dXJlZExvZ2dlcignTW92ZUJhc2VIYW5kbGVyJyk7XG5cbmNvbnN0IFBMQVlFUl9CQVNFU19UQUJMRSA9IHByb2Nlc3MuZW52LlBMQVlFUl9CQVNFU19UQUJMRSE7XG5jb25zdCBFTlZJUk9OTUVOVCA9IHByb2Nlc3MuZW52LkVOVklST05NRU5UITtcblxuY29uc3QgTW92ZUJhc2VSZXF1ZXN0U2NoZW1hID0gei5vYmplY3Qoe1xuICBwbGF5ZXJJZDogei5zdHJpbmcoKS5taW4oMSkubWF4KDUwKSxcbiAgYmFzZUlkOiB6LnN0cmluZygpLm1pbigxKS5tYXgoNTApLFxuICBuZXdDb29yZGluYXRlczogei5vYmplY3Qoe1xuICAgIHg6IHoubnVtYmVyKCkubWluKC0xMDAwMDAwKS5tYXgoMTAwMDAwMCksXG4gICAgeTogei5udW1iZXIoKS5taW4oLTEwMDAwMDApLm1heCgxMDAwMDAwKVxuICB9KSxcbiAgdXNlVGVsZXBvcnQ6IHouYm9vbGVhbigpLm9wdGlvbmFsKCkuZGVmYXVsdChmYWxzZSkgLy8gSW5zdGFudCBtb3ZlbWVudCBmb3IgZ29sZFxufSk7XG5cbnR5cGUgTW92ZUJhc2VSZXF1ZXN0ID0gei5pbmZlcjx0eXBlb2YgTW92ZUJhc2VSZXF1ZXN0U2NoZW1hPjtcblxuLyoqXG4gKiBNb3ZlIEJhc2UgSGFuZGxlclxuICogXG4gKiBJbXBsZW1lbnRzIGJhc2UgbW92ZW1lbnQgc3lzdGVtIGZvbGxvd2luZyBTT0xJRCBwcmluY2lwbGVzOlxuICogLSBTaW5nbGUgUmVzcG9uc2liaWxpdHk6IE9ubHkgaGFuZGxlcyBiYXNlIHJlbG9jYXRpb25cbiAqIC0gT3Blbi9DbG9zZWQ6IEV4dGVuc2libGUgZm9yIGRpZmZlcmVudCBtb3ZlbWVudCB0eXBlc1xuICogLSBMaXNrb3YgU3Vic3RpdHV0aW9uOiBBbGwgbW92ZW1lbnQgdHlwZXMgZm9sbG93IHNhbWUgcGF0dGVyblxuICogLSBJbnRlcmZhY2UgU2VncmVnYXRpb246IENsZWFyIG1vdmVtZW50IG9wZXJhdGlvbiBpbnRlcmZhY2VcbiAqIC0gRGVwZW5kZW5jeSBJbnZlcnNpb246IERlcGVuZHMgb24gc2hhcmVkIGdhbWUgdXRpbGl0aWVzXG4gKiBcbiAqIEdhbWUgTWVjaGFuaWNzOlxuICogLSBWYWxpZGF0ZXMgbW92ZW1lbnQgY29vbGRvd24gKDYwIG1pbnV0ZXMgZGVmYXVsdClcbiAqIC0gU3VwcG9ydHMgaW5zdGFudCB0ZWxlcG9ydGF0aW9uIGZvciBnb2xkIGNvc3RcbiAqIC0gUHJldmVudHMgbW92ZW1lbnQgdG8gb2NjdXBpZWQgY29vcmRpbmF0ZXNcbiAqIC0gQ2FsY3VsYXRlcyB0cmF2ZWwgdGltZSBiYXNlZCBvbiBkaXN0YW5jZVxuICogLSBVcGRhdGVzIG1hcCBzZWN0aW9uaW5nIGZvciBlZmZpY2llbnQgcXVlcmllc1xuICogLSBJbXBsZW1lbnRzIG1vdmVtZW50IHJlc3RyaWN0aW9ucyBuZWFyIGVuZW15IGJhc2VzXG4gKi9cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIHJldHVybiB3aXRoRXJyb3JIYW5kbGluZyhhc3luYyAoKSA9PiB7XG4gICAgbG9nZ2VyLmluZm8oJ1Byb2Nlc3NpbmcgYmFzZSBtb3ZlbWVudCByZXF1ZXN0JywgeyBcbiAgICAgIHJlcXVlc3RJZDogZXZlbnQucmVxdWVzdENvbnRleHQ/LnJlcXVlc3RJZCBcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlcXVlc3QgPSBhd2FpdCB2YWxpZGF0ZVJlcXVlc3Q8TW92ZUJhc2VSZXF1ZXN0PihNb3ZlQmFzZVJlcXVlc3RTY2hlbWEsIGV2ZW50LmJvZHkpO1xuICAgIFxuICAgIC8vIEdldCBjdXJyZW50IGJhc2Ugc3RhdGVcbiAgICBjb25zdCBjdXJyZW50QmFzZSA9IGF3YWl0IGdldFBsYXllckJhc2UocmVxdWVzdC5wbGF5ZXJJZCwgcmVxdWVzdC5iYXNlSWQpO1xuICAgIFxuICAgIC8vIFZhbGlkYXRlIG1vdmVtZW50IGlzIGFsbG93ZWRcbiAgICBhd2FpdCB2YWxpZGF0ZU1vdmVtZW50KGN1cnJlbnRCYXNlLCByZXF1ZXN0Lm5ld0Nvb3JkaW5hdGVzLCByZXF1ZXN0LnVzZVRlbGVwb3J0KTtcbiAgICBcbiAgICAvLyBDaGVjayBkZXN0aW5hdGlvbiBpcyBhdmFpbGFibGVcbiAgICBhd2FpdCB2YWxpZGF0ZURlc3RpbmF0aW9uKHJlcXVlc3QubmV3Q29vcmRpbmF0ZXMsIHJlcXVlc3QuYmFzZUlkKTtcbiAgICBcbiAgICAvLyBDYWxjdWxhdGUgbW92ZW1lbnQgY29zdCBhbmQgdGltZVxuICAgIGNvbnN0IG1vdmVtZW50RGV0YWlscyA9IGNhbGN1bGF0ZU1vdmVtZW50RGV0YWlscyhjdXJyZW50QmFzZSwgcmVxdWVzdC5uZXdDb29yZGluYXRlcywgcmVxdWVzdC51c2VUZWxlcG9ydCk7XG4gICAgXG4gICAgLy8gRXhlY3V0ZSB0aGUgbW92ZW1lbnRcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBleGVjdXRlQmFzZU1vdmVtZW50KHJlcXVlc3QsIGN1cnJlbnRCYXNlLCBtb3ZlbWVudERldGFpbHMpO1xuXG4gICAgbG9nZ2VyLmluZm8oJ0Jhc2UgbW92ZW1lbnQgcHJvY2Vzc2VkJywge1xuICAgICAgcGxheWVySWQ6IHJlcXVlc3QucGxheWVySWQsXG4gICAgICBiYXNlSWQ6IHJlcXVlc3QuYmFzZUlkLFxuICAgICAgZnJvbUNvb3JkaW5hdGVzOiBjdXJyZW50QmFzZS5jb29yZGluYXRlcyxcbiAgICAgIHRvQ29vcmRpbmF0ZXM6IHJlcXVlc3QubmV3Q29vcmRpbmF0ZXMsXG4gICAgICB0ZWxlcG9ydDogcmVxdWVzdC51c2VUZWxlcG9ydCxcbiAgICAgIHRyYXZlbFRpbWU6IG1vdmVtZW50RGV0YWlscy50cmF2ZWxUaW1lXG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonXG4gICAgICB9LFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgbW92ZW1lbnQ6IHJlc3VsdCxcbiAgICAgICAgICBtZXNzYWdlOiByZXF1ZXN0LnVzZVRlbGVwb3J0IFxuICAgICAgICAgICAgPyAnQmFzZSB0ZWxlcG9ydGVkIGluc3RhbnRseScgXG4gICAgICAgICAgICA6IGBCYXNlIG1vdmVtZW50IGluaXRpYXRlZCwgYXJyaXZhbCBpbiAke01hdGguY2VpbChtb3ZlbWVudERldGFpbHMudHJhdmVsVGltZSAvIDYwKX0gbWludXRlc2BcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9O1xuICB9LCBsb2dnZXIpO1xufTtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0UGxheWVyQmFzZShwbGF5ZXJJZDogc3RyaW5nLCBiYXNlSWQ6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogUExBWUVSX0JBU0VTX1RBQkxFLFxuICAgICAgS2V5OiB7IHBsYXllcklkLCBiYXNlSWQgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBcbiAgICBpZiAoIXJlc3BvbnNlLkl0ZW0pIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdCYXNlIG5vdCBmb3VuZCcsXG4gICAgICAgICdCQVNFX05PVF9GT1VORCcsXG4gICAgICAgIHsgcGxheWVySWQsIGJhc2VJZCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IGJhc2UgPSByZXNwb25zZS5JdGVtO1xuICAgIFxuICAgIGlmIChiYXNlLnN0YXR1cyAhPT0gJ2FjdGl2ZScpIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgIGBDYW5ub3QgbW92ZSBiYXNlIHdpdGggc3RhdHVzOiAke2Jhc2Uuc3RhdHVzfWAsXG4gICAgICAgICdJTlZBTElEX0JBU0VfU1RBVFVTJyxcbiAgICAgICAgeyBwbGF5ZXJJZCwgYmFzZUlkLCBzdGF0dXM6IGJhc2Uuc3RhdHVzIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGJhc2U7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgR2FtZUVuZ2luZUVycm9yKSB0aHJvdyBlcnJvcjtcbiAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgJ0ZhaWxlZCB0byByZXRyaWV2ZSBiYXNlJyxcbiAgICAgICdCQVNFX1JFVFJJRVZBTF9FUlJPUicsXG4gICAgICB7IHBsYXllcklkLCBiYXNlSWQsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gdmFsaWRhdGVNb3ZlbWVudChcbiAgYmFzZTogYW55LCBcbiAgbmV3Q29vcmRpbmF0ZXM6IHsgeDogbnVtYmVyOyB5OiBudW1iZXIgfSwgXG4gIHVzZVRlbGVwb3J0OiBib29sZWFuXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IGNvb2xkb3duUGVyaW9kID0gNjAgKiA2MCAqIDEwMDA7IC8vIDYwIG1pbnV0ZXMgaW4gbWlsbGlzZWNvbmRzXG4gICAgXG4gICAgLy8gQ2hlY2sgbW92ZW1lbnQgY29vbGRvd24gKHVubGVzcyB1c2luZyB0ZWxlcG9ydClcbiAgICBpZiAoIXVzZVRlbGVwb3J0ICYmIGJhc2UubGFzdE1vdmVkQXQgJiYgKG5vdyAtIGJhc2UubGFzdE1vdmVkQXQpIDwgY29vbGRvd25QZXJpb2QpIHtcbiAgICAgIGNvbnN0IHJlbWFpbmluZ0Nvb2xkb3duID0gY29vbGRvd25QZXJpb2QgLSAobm93IC0gYmFzZS5sYXN0TW92ZWRBdCk7XG4gICAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgICAnQmFzZSBtb3ZlbWVudCBvbiBjb29sZG93bicsXG4gICAgICAgICdNT1ZFTUVOVF9DT09MRE9XTicsXG4gICAgICAgIHsgXG4gICAgICAgICAgYmFzZUlkOiBiYXNlLmJhc2VJZCwgXG4gICAgICAgICAgcmVtYWluaW5nTWludXRlczogTWF0aC5jZWlsKHJlbWFpbmluZ0Nvb2xkb3duIC8gKDYwICogMTAwMCkpXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgY29vcmRpbmF0ZXMgYXJlIGRpZmZlcmVudFxuICAgIGlmIChiYXNlLmNvb3JkaW5hdGVzLnggPT09IG5ld0Nvb3JkaW5hdGVzLnggJiYgYmFzZS5jb29yZGluYXRlcy55ID09PSBuZXdDb29yZGluYXRlcy55KSB7XG4gICAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgICAnTmV3IGNvb3JkaW5hdGVzIG11c3QgYmUgZGlmZmVyZW50IGZyb20gY3VycmVudCBsb2NhdGlvbicsXG4gICAgICAgICdTQU1FX0NPT1JESU5BVEVTJyxcbiAgICAgICAgeyBjdXJyZW50Q29vcmRpbmF0ZXM6IGJhc2UuY29vcmRpbmF0ZXMsIG5ld0Nvb3JkaW5hdGVzIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgbW92ZW1lbnQgZGlzdGFuY2UgKG1heCAxMDAwIHVuaXRzIGZvciBub3JtYWwgbW92ZW1lbnQpXG4gICAgaWYgKCF1c2VUZWxlcG9ydCkge1xuICAgICAgY29uc3QgZGlzdGFuY2UgPSBjYWxjdWxhdGVEaXN0YW5jZShiYXNlLmNvb3JkaW5hdGVzLCBuZXdDb29yZGluYXRlcyk7XG4gICAgICBjb25zdCBtYXhEaXN0YW5jZSA9IDEwMDA7XG4gICAgICBcbiAgICAgIGlmIChkaXN0YW5jZSA+IG1heERpc3RhbmNlKSB7XG4gICAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICAgYE1vdmVtZW50IGRpc3RhbmNlIGV4Y2VlZHMgbWF4aW11bSAoJHttYXhEaXN0YW5jZX0gdW5pdHMpYCxcbiAgICAgICAgICAnRElTVEFOQ0VfVE9PX0ZBUicsXG4gICAgICAgICAgeyBkaXN0YW5jZSwgbWF4RGlzdGFuY2UsIGNvb3JkaW5hdGVzOiB7IGZyb206IGJhc2UuY29vcmRpbmF0ZXMsIHRvOiBuZXdDb29yZGluYXRlcyB9IH1cbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBHYW1lRW5naW5lRXJyb3IpIHRocm93IGVycm9yO1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnTW92ZW1lbnQgdmFsaWRhdGlvbiBmYWlsZWQnLFxuICAgICAgJ01PVkVNRU5UX1ZBTElEQVRJT05fRVJST1InLFxuICAgICAgeyBiYXNlSWQ6IGJhc2UuYmFzZUlkLCBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIH1cbiAgICApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHZhbGlkYXRlRGVzdGluYXRpb24oXG4gIGNvb3JkaW5hdGVzOiB7IHg6IG51bWJlcjsgeTogbnVtYmVyIH0sIFxuICBleGNsdWRlQmFzZUlkOiBzdHJpbmdcbik6IFByb21pc2U8dm9pZD4ge1xuICB0cnkge1xuICAgIGNvbnN0IGNvb3JkaW5hdGVIYXNoID0gYCR7Y29vcmRpbmF0ZXMueH0sJHtjb29yZGluYXRlcy55fWA7XG4gICAgXG4gICAgLy8gQ2hlY2sgaWYgY29vcmRpbmF0ZXMgYXJlIG9jY3VwaWVkIGJ5IGFub3RoZXIgYmFzZVxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogUExBWUVSX0JBU0VTX1RBQkxFLFxuICAgICAgSW5kZXhOYW1lOiAnTG9jYXRpb25JbmRleCcsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnbWFwU2VjdGlvbklkID0gOnNlY3Rpb25JZCBBTkQgY29vcmRpbmF0ZUhhc2ggPSA6Y29vcmRIYXNoJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpzZWN0aW9uSWQnOiBgJHtNYXRoLmZsb29yKGNvb3JkaW5hdGVzLnggLyAxMDApfSwke01hdGguZmxvb3IoY29vcmRpbmF0ZXMueSAvIDEwMCl9YCxcbiAgICAgICAgJzpjb29yZEhhc2gnOiBjb29yZGluYXRlSGFzaCxcbiAgICAgICAgJzpleGNsdWRlQmFzZUlkJzogZXhjbHVkZUJhc2VJZCxcbiAgICAgICAgJzpkZXN0cm95ZWQnOiAnZGVzdHJveWVkJ1xuICAgICAgfSxcbiAgICAgIEZpbHRlckV4cHJlc3Npb246ICdiYXNlSWQgPD4gOmV4Y2x1ZGVCYXNlSWQgQU5EICNzdGF0dXMgPD4gOmRlc3Ryb3llZCcsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgJyNzdGF0dXMnOiAnc3RhdHVzJ1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBcbiAgICBpZiAocmVzcG9uc2UuSXRlbXMgJiYgcmVzcG9uc2UuSXRlbXMubGVuZ3RoID4gMCkge1xuICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgJ0Rlc3RpbmF0aW9uIGNvb3JkaW5hdGVzIGFyZSBvY2N1cGllZCcsXG4gICAgICAgICdDT09SRElOQVRFU19PQ0NVUElFRCcsXG4gICAgICAgIHsgY29vcmRpbmF0ZXMsIG9jY3VwaWVkQnk6IHJlc3BvbnNlLkl0ZW1zWzBdLmJhc2VJZCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFRPRE86IEFkZCB2YWxpZGF0aW9uIGZvciByZXN0cmljdGVkIHpvbmVzLCBlbmVteSBhbGxpYW5jZSB0ZXJyaXRvcmllcywgZXRjLlxuICAgIFxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEdhbWVFbmdpbmVFcnJvcikgdGhyb3cgZXJyb3I7XG4gICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICdEZXN0aW5hdGlvbiB2YWxpZGF0aW9uIGZhaWxlZCcsXG4gICAgICAnREVTVElOQVRJT05fVkFMSURBVElPTl9FUlJPUicsXG4gICAgICB7IGNvb3JkaW5hdGVzLCBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIH1cbiAgICApO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZU1vdmVtZW50RGV0YWlscyhcbiAgYmFzZTogYW55LCBcbiAgbmV3Q29vcmRpbmF0ZXM6IHsgeDogbnVtYmVyOyB5OiBudW1iZXIgfSwgXG4gIHVzZVRlbGVwb3J0OiBib29sZWFuXG4pOiB7IHRyYXZlbFRpbWU6IG51bWJlcjsgZ29sZENvc3Q/OiBudW1iZXI7IGRpc3RhbmNlOiBudW1iZXIgfSB7XG4gIGNvbnN0IGRpc3RhbmNlID0gY2FsY3VsYXRlRGlzdGFuY2UoYmFzZS5jb29yZGluYXRlcywgbmV3Q29vcmRpbmF0ZXMpO1xuICBcbiAgaWYgKHVzZVRlbGVwb3J0KSB7XG4gICAgLy8gSW5zdGFudCB0ZWxlcG9ydGF0aW9uIHdpdGggZ29sZCBjb3N0XG4gICAgY29uc3QgZ29sZENvc3QgPSBNYXRoLm1heCg1MCwgTWF0aC5jZWlsKGRpc3RhbmNlIC8gMTApKTsgLy8gMSBnb2xkIHBlciAxMCB1bml0cywgbWluaW11bSA1MFxuICAgIHJldHVybiB7XG4gICAgICB0cmF2ZWxUaW1lOiAwLFxuICAgICAgZ29sZENvc3Q6IGdvbGRDb3N0LFxuICAgICAgZGlzdGFuY2U6IGRpc3RhbmNlXG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICAvLyBDYWxjdWxhdGUgdHJhdmVsIHRpbWU6IDEgbWludXRlIHBlciB1bml0IGRpc3RhbmNlIChtaW5pbXVtIDUgbWludXRlcylcbiAgICBjb25zdCB0cmF2ZWxUaW1lID0gTWF0aC5tYXgoMzAwLCBkaXN0YW5jZSAqIDYwKTsgLy8gc2Vjb25kc1xuICAgIHJldHVybiB7XG4gICAgICB0cmF2ZWxUaW1lOiB0cmF2ZWxUaW1lLFxuICAgICAgZGlzdGFuY2U6IGRpc3RhbmNlXG4gICAgfTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVEaXN0YW5jZShcbiAgZnJvbTogeyB4OiBudW1iZXI7IHk6IG51bWJlciB9LCBcbiAgdG86IHsgeDogbnVtYmVyOyB5OiBudW1iZXIgfVxuKTogbnVtYmVyIHtcbiAgY29uc3QgZHggPSB0by54IC0gZnJvbS54O1xuICBjb25zdCBkeSA9IHRvLnkgLSBmcm9tLnk7XG4gIHJldHVybiBNYXRoLnNxcnQoZHggKiBkeCArIGR5ICogZHkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBleGVjdXRlQmFzZU1vdmVtZW50KFxuICByZXF1ZXN0OiBNb3ZlQmFzZVJlcXVlc3QsXG4gIGJhc2U6IGFueSxcbiAgbW92ZW1lbnREZXRhaWxzOiB7IHRyYXZlbFRpbWU6IG51bWJlcjsgZ29sZENvc3Q/OiBudW1iZXI7IGRpc3RhbmNlOiBudW1iZXIgfVxuKTogUHJvbWlzZTxhbnk+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IGFycml2YWxUaW1lID0gbm93ICsgKG1vdmVtZW50RGV0YWlscy50cmF2ZWxUaW1lICogMTAwMCk7XG4gICAgXG4gICAgLy8gQ2FsY3VsYXRlIG5ldyBtYXAgc2VjdGlvblxuICAgIGNvbnN0IG5ld01hcFNlY3Rpb25JZCA9IGAke01hdGguZmxvb3IocmVxdWVzdC5uZXdDb29yZGluYXRlcy54IC8gMTAwKX0sJHtNYXRoLmZsb29yKHJlcXVlc3QubmV3Q29vcmRpbmF0ZXMueSAvIDEwMCl9YDtcbiAgICBjb25zdCBuZXdDb29yZGluYXRlSGFzaCA9IGAke3JlcXVlc3QubmV3Q29vcmRpbmF0ZXMueH0sJHtyZXF1ZXN0Lm5ld0Nvb3JkaW5hdGVzLnl9YDtcbiAgICBcbiAgICBjb25zdCB1cGRhdGVFeHByZXNzaW9uID0gcmVxdWVzdC51c2VUZWxlcG9ydFxuICAgICAgPyAnU0VUIGNvb3JkaW5hdGVzID0gOm5ld0Nvb3JkcywgbWFwU2VjdGlvbklkID0gOm5ld1NlY3Rpb24sIGNvb3JkaW5hdGVIYXNoID0gOm5ld0hhc2gsIGxhc3RNb3ZlZEF0ID0gOm5vdywgbGFzdEFjdGl2ZUF0ID0gOm5vdydcbiAgICAgIDogJ1NFVCBjb29yZGluYXRlcyA9IDpuZXdDb29yZHMsIG1hcFNlY3Rpb25JZCA9IDpuZXdTZWN0aW9uLCBjb29yZGluYXRlSGFzaCA9IDpuZXdIYXNoLCAjc3RhdHVzID0gOm1vdmluZywgbGFzdE1vdmVkQXQgPSA6bm93LCBsYXN0QWN0aXZlQXQgPSA6bm93LCBhcnJpdmFsVGltZSA9IDphcnJpdmFsVGltZSc7XG4gICAgXG4gICAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0gcmVxdWVzdC51c2VUZWxlcG9ydCA/IHt9IDogeyAnI3N0YXR1cyc6ICdzdGF0dXMnIH07XG4gICAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogUmVjb3JkPHN0cmluZywgYW55PiA9IHtcbiAgICAgICc6bmV3Q29vcmRzJzogcmVxdWVzdC5uZXdDb29yZGluYXRlcyxcbiAgICAgICc6bmV3U2VjdGlvbic6IG5ld01hcFNlY3Rpb25JZCxcbiAgICAgICc6bmV3SGFzaCc6IG5ld0Nvb3JkaW5hdGVIYXNoLFxuICAgICAgJzpub3cnOiBub3dcbiAgICB9O1xuXG4gICAgaWYgKCFyZXF1ZXN0LnVzZVRlbGVwb3J0KSB7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6bW92aW5nJ10gPSAnbW92aW5nJztcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzphcnJpdmFsVGltZSddID0gYXJyaXZhbFRpbWU7XG4gICAgfVxuXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBVcGRhdGVDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogUExBWUVSX0JBU0VTX1RBQkxFLFxuICAgICAgS2V5OiB7XG4gICAgICAgIHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLFxuICAgICAgICBiYXNlSWQ6IHJlcXVlc3QuYmFzZUlkXG4gICAgICB9LFxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogdXBkYXRlRXhwcmVzc2lvbixcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogT2JqZWN0LmtleXMoZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzKS5sZW5ndGggPiAwID8gZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzIDogdW5kZWZpbmVkLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgIFJldHVyblZhbHVlczogJ0FMTF9ORVcnXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuXG4gICAgLy8gVE9ETzogSWYgdGVsZXBvcnQsIGRlZHVjdCBnb2xkIGNvc3QgZnJvbSBwbGF5ZXIgcmVzb3VyY2VzIChpbnRlZ3JhdGUgd2l0aCByZXNvdXJjZSBzZXJ2aWNlKVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGJhc2VJZDogcmVxdWVzdC5iYXNlSWQsXG4gICAgICBuZXdDb29yZGluYXRlczogcmVxdWVzdC5uZXdDb29yZGluYXRlcyxcbiAgICAgIHN0YXR1czogcmVxdWVzdC51c2VUZWxlcG9ydCA/ICdhY3RpdmUnIDogJ21vdmluZycsXG4gICAgICBhcnJpdmFsVGltZTogcmVxdWVzdC51c2VUZWxlcG9ydCA/IG5vdyA6IGFycml2YWxUaW1lLFxuICAgICAgZ29sZENvc3Q6IG1vdmVtZW50RGV0YWlscy5nb2xkQ29zdCxcbiAgICAgIGRpc3RhbmNlOiBtb3ZlbWVudERldGFpbHMuZGlzdGFuY2VcbiAgICB9O1xuXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICdGYWlsZWQgdG8gZXhlY3V0ZSBiYXNlIG1vdmVtZW50JyxcbiAgICAgICdNT1ZFTUVOVF9FWEVDVVRJT05fRVJST1InLFxuICAgICAgeyBcbiAgICAgICAgcGxheWVySWQ6IHJlcXVlc3QucGxheWVySWQsIFxuICAgICAgICBiYXNlSWQ6IHJlcXVlc3QuYmFzZUlkLFxuICAgICAgICBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIFxuICAgICAgfVxuICAgICk7XG4gIH1cbn0iXX0=