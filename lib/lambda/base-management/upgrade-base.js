"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const shared_mocks_1 = require("../../lib/shared-mocks");
const zod_1 = require("zod");
const uuid_1 = require("uuid");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const logger = new shared_mocks_1.StructuredLogger('UpgradeBaseHandler');
const PLAYER_BASES_TABLE = process.env.PLAYER_BASES_TABLE ?? '';
const BASE_TEMPLATES_TABLE = process.env.BASE_TEMPLATES_TABLE ?? '';
const BASE_UPGRADES_TABLE = process.env.BASE_UPGRADES_TABLE ?? '';
const ENVIRONMENT = process.env.ENVIRONMENT ?? '';
const UpgradeBaseRequestSchema = zod_1.z.object({
    playerId: zod_1.z.string().min(1).max(50),
    baseId: zod_1.z.string().min(1).max(50),
    upgradeType: zod_1.z.enum(['level', 'defense', 'storage', 'production', 'specialized']),
    skipTime: zod_1.z.boolean().optional().default(false) // For premium players
});
/**
 * Upgrade Base Handler
 *
 * Implements base upgrade system following SOLID principles:
 * - Single Responsibility: Only handles base upgrades
 * - Open/Closed: Extensible for new upgrade types
 * - Liskov Substitution: All upgrade types follow same pattern
 * - Interface Segregation: Clear upgrade operation interfaces
 * - Dependency Inversion: Depends on shared abstractions
 *
 * Game Mechanics:
 * - Validates upgrade requirements (resources, level, time)
 * - Supports instant upgrades for premium players (gold cost)
 * - Tracks upgrade progress with completion times
 * - Updates base stats upon completion
 * - Implements upgrade queue system
 */
const handler = async (event) => {
    return (0, shared_mocks_1.withErrorHandling)(async () => {
        logger.info('Processing base upgrade request', {
            requestId: event.requestContext?.requestId
        });
        const request = await (0, shared_mocks_1.validateRequest)(UpgradeBaseRequestSchema, event.body);
        // Get current base state
        const currentBase = await getPlayerBase(request.playerId, request.baseId);
        // Validate upgrade is possible
        const upgradeTemplate = await validateUpgradeRequirements(currentBase, request.upgradeType);
        // Check for existing active upgrades
        await checkActiveUpgrades(request.playerId, request.baseId);
        // Create upgrade record
        const upgrade = await createUpgradeRecord(request, currentBase, upgradeTemplate);
        // If instant upgrade (skipTime), complete immediately
        if (request.skipTime) {
            await completeInstantUpgrade(upgrade, currentBase);
        }
        logger.info('Base upgrade initiated', {
            playerId: request.playerId,
            baseId: request.baseId,
            upgradeType: request.upgradeType,
            instant: request.skipTime
        });
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                success: true,
                data: {
                    upgrade: upgrade,
                    message: request.skipTime
                        ? 'Base upgrade completed instantly'
                        : 'Base upgrade started successfully'
                }
            })
        };
    }, logger);
};
exports.handler = handler;
async function getPlayerBase(playerId, baseId) {
    try {
        const command = new lib_dynamodb_1.GetCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: { playerId, baseId }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError('Base not found', 'BASE_NOT_FOUND', { playerId, baseId });
        }
        if (response.Item.status === 'destroyed') {
            throw new shared_mocks_1.GameEngineError('Cannot upgrade destroyed base', 'INVALID_BASE_STATUS', { playerId, baseId, status: response.Item.status });
        }
        return response.Item;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to retrieve base', 'BASE_RETRIEVAL_ERROR', { playerId, baseId, error: error.message });
    }
}
async function validateUpgradeRequirements(base, upgradeType) {
    try {
        const nextLevel = base.level + 1;
        const templateId = `${base.baseType}-level-${nextLevel}`;
        const command = new lib_dynamodb_1.GetCommand({
            TableName: BASE_TEMPLATES_TABLE,
            Key: { templateId }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError(`No upgrade template found for ${base.baseType} level ${nextLevel}`, 'UPGRADE_TEMPLATE_NOT_FOUND', { baseType: base.baseType, currentLevel: base.level, nextLevel });
        }
        const template = response.Item;
        // TODO: Validate player has required resources
        // This would integrate with resource service
        return template;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to validate upgrade requirements', 'UPGRADE_VALIDATION_ERROR', { baseId: base.baseId, upgradeType, error: error.message });
    }
}
async function checkActiveUpgrades(playerId, baseId) {
    try {
        // Check if base already has active upgrade
        const command = new lib_dynamodb_1.GetCommand({
            TableName: BASE_UPGRADES_TABLE,
            Key: {
                playerId,
                upgradeId: `${baseId}-active`
            }
        });
        const response = await docClient.send(command);
        if (response.Item && response.Item.status === 'in_progress') {
            throw new shared_mocks_1.GameEngineError('Base already has an active upgrade', 'UPGRADE_IN_PROGRESS', { playerId, baseId, activeUpgrade: response.Item.upgradeId });
        }
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to check active upgrades', 'ACTIVE_UPGRADE_CHECK_ERROR', { playerId, baseId, error: error.message });
    }
}
async function createUpgradeRecord(request, base, template) {
    try {
        const now = Date.now();
        const upgradeTime = template.buildTime || 3600; // Default 1 hour
        const completionTime = now + (upgradeTime * 1000);
        const upgrade = {
            playerId: request.playerId,
            upgradeId: `${request.baseId}-${(0, uuid_1.v4)()}`,
            baseId: request.baseId,
            upgradeType: request.upgradeType,
            fromLevel: base.level,
            toLevel: base.level + 1,
            requirements: {
                resources: template.requirements?.resources || {},
                time: upgradeTime,
                goldCost: request.skipTime ? calculateInstantUpgradeCost(upgradeTime) : undefined
            },
            status: 'in_progress',
            startedAt: now,
            completionTime: completionTime,
            ttl: completionTime + (7 * 24 * 60 * 60 * 1000) // Cleanup after 7 days
        };
        const command = new lib_dynamodb_1.PutCommand({
            TableName: BASE_UPGRADES_TABLE,
            Item: upgrade
        });
        await docClient.send(command);
        return upgrade;
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to create upgrade record', 'UPGRADE_RECORD_ERROR', {
            playerId: request.playerId,
            baseId: request.baseId,
            error: error.message
        });
    }
}
async function completeInstantUpgrade(upgrade, base) {
    try {
        const now = Date.now();
        // Update upgrade record to completed
        const updateUpgradeCommand = new lib_dynamodb_1.UpdateCommand({
            TableName: BASE_UPGRADES_TABLE,
            Key: {
                playerId: upgrade.playerId,
                upgradeId: upgrade.upgradeId
            },
            UpdateExpression: 'SET #status = :status, completionTime = :now',
            ExpressionAttributeNames: {
                '#status': 'status'
            },
            ExpressionAttributeValues: {
                ':status': 'completed',
                ':now': now
            }
        });
        // Update base level and stats
        const updateBaseCommand = new lib_dynamodb_1.UpdateCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: {
                playerId: base.playerId,
                baseId: base.baseId
            },
            UpdateExpression: 'SET #level = #level + :inc, lastActiveAt = :now, stats.defense = stats.defense + :defenseInc, stats.storage = stats.storage + :storageInc, stats.production = stats.production + :prodInc',
            ExpressionAttributeNames: {
                '#level': 'level'
            },
            ExpressionAttributeValues: {
                ':inc': 1,
                ':now': now,
                ':defenseInc': 10, // TODO: Get from template
                ':storageInc': 100,
                ':prodInc': 5
            }
        });
        // Execute both updates
        await Promise.all([
            docClient.send(updateUpgradeCommand),
            docClient.send(updateBaseCommand)
        ]);
        // TODO: Deduct gold cost from player resources (integrate with resource service)
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to complete instant upgrade', 'INSTANT_UPGRADE_ERROR', { upgradeId: upgrade.upgradeId, error: error.message });
    }
}
function calculateInstantUpgradeCost(upgradeTimeSeconds) {
    // Formula: 1 gold per minute of upgrade time (minimum 10 gold)
    return Math.max(10, Math.ceil(upgradeTimeSeconds / 60));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBncmFkZS1iYXNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGFtYmRhL2Jhc2UtbWFuYWdlbWVudC91cGdyYWRlLWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUFzRztBQUN0Ryx5REFLZ0M7QUFDaEMsNkJBQXdCO0FBQ3hCLCtCQUFvQztBQUVwQyxNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDNUMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQzVELE1BQU0sTUFBTSxHQUFHLElBQUksK0JBQWdCLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUUxRCxNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDO0FBQ2hFLE1BQU0sb0JBQW9CLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsSUFBSSxFQUFFLENBQUM7QUFDcEUsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLEVBQUUsQ0FBQztBQUNsRSxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUM7QUFFbEQsTUFBTSx3QkFBd0IsR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3hDLFFBQVEsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7SUFDbkMsTUFBTSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztJQUNqQyxXQUFXLEVBQUUsT0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxTQUFTLEVB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QWtCLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUMxRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgR2V0Q29tbWFuZCwgVXBkYXRlQ29tbWFuZCwgUHV0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBcbiAgU3RydWN0dXJlZExvZ2dlciwgXG4gIEdhbWVFbmdpbmVFcnJvcixcbiAgd2l0aEVycm9ySGFuZGxpbmcsXG4gIHZhbGlkYXRlUmVxdWVzdCBcbn0gZnJvbSAnLi4vLi4vbGliL3NoYXJlZC1tb2Nrcyc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuXG5jb25zdCBkeW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGR5bmFtb0NsaWVudCk7XG5jb25zdCBsb2dnZXIgPSBuZXcgU3RydWN0dXJlZExvZ2dlcignVXBncmFkZUJhc2VIYW5kbGVyJyk7XG5cbmNvbnN0IFBMQVlFUl9CQVNFU19UQUJMRSA9IHByb2Nlc3MuZW52LlBMQVlFUl9CQVNFU19UQUJMRSA/PyAnJztcbmNvbnN0IEJBU0VfVEVNUExBVEVTX1RBQkxFID0gcHJvY2Vzcy5lbnYuQkFTRV9URU1QTEFURVNfVEFCTEUgPz8gJyc7XG5jb25zdCBCQVNFX1VQR1JBREVTX1RBQkxFID0gcHJvY2Vzcy5lbnYuQkFTRV9VUEdSQURFU19UQUJMRSA/PyAnJztcbmNvbnN0IEVOVklST05NRU5UID0gcHJvY2Vzcy5lbnYuRU5WSVJPTk1FTlQgPz8gJyc7XG5cbmNvbnN0IFVwZ3JhZGVCYXNlUmVxdWVzdFNjaGVtYSA9IHoub2JqZWN0KHtcbiAgcGxheWVySWQ6IHouc3RyaW5nKCkubWluKDEpLm1heCg1MCksXG4gIGJhc2VJZDogei5zdHJpbmcoKS5taW4oMSkubWF4KDUwKSxcbiAgdXBncmFkZVR5cGU6IHouZW51bShbJ2xldmVsJywgJ2RlZmVuc2UnLCAnc3RvcmFnZScsICdwcm9kdWN0aW9uJywgJ3NwZWNpYWxpemVkJ10pLFxuICBza2lwVGltZTogei5ib29sZWFuKCkub3B0aW9uYWwoKS5kZWZhdWx0KGZhbHNlKSAvLyBGb3IgcHJlbWl1bSBwbGF5ZXJzXG59KTtcblxudHlwZSBVcGdyYWRlQmFzZVJlcXVlc3QgPSB6LmluZmVyPHR5cGVvZiBVcGdyYWRlQmFzZVJlcXVlc3RTY2hlbWE+O1xuXG5pbnRlcmZhY2UgQmFzZVVwZ3JhZGUge1xuICBwbGF5ZXJJZDogc3RyaW5nO1xuICB1cGdyYWRlSWQ6IHN0cmluZztcbiAgYmFzZUlkOiBzdHJpbmc7XG4gIHVwZ3JhZGVUeXBlOiBzdHJpbmc7XG4gIGZyb21MZXZlbDogbnVtYmVyO1xuICB0b0xldmVsOiBudW1iZXI7XG4gIHJlcXVpcmVtZW50czoge1xuICAgIHJlc291cmNlczogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcbiAgICB0aW1lOiBudW1iZXI7XG4gICAgZ29sZENvc3Q/OiBudW1iZXI7XG4gIH07XG4gIHN0YXR1czogJ2luX3Byb2dyZXNzJyB8ICdjb21wbGV0ZWQnIHwgJ2NhbmNlbGxlZCc7XG4gIHN0YXJ0ZWRBdDogbnVtYmVyO1xuICBjb21wbGV0aW9uVGltZTogbnVtYmVyO1xuICB0dGw/OiBudW1iZXI7XG59XG5cbi8qKlxuICogVXBncmFkZSBCYXNlIEhhbmRsZXJcbiAqIFxuICogSW1wbGVtZW50cyBiYXNlIHVwZ3JhZGUgc3lzdGVtIGZvbGxvd2luZyBTT0xJRCBwcmluY2lwbGVzOlxuICogLSBTaW5nbGUgUmVzcG9uc2liaWxpdHk6IE9ubHkgaGFuZGxlcyBiYXNlIHVwZ3JhZGVzXG4gKiAtIE9wZW4vQ2xvc2VkOiBFeHRlbnNpYmxlIGZvciBuZXcgdXBncmFkZSB0eXBlc1xuICogLSBMaXNrb3YgU3Vic3RpdHV0aW9uOiBBbGwgdXBncmFkZSB0eXBlcyBmb2xsb3cgc2FtZSBwYXR0ZXJuXG4gKiAtIEludGVyZmFjZSBTZWdyZWdhdGlvbjogQ2xlYXIgdXBncmFkZSBvcGVyYXRpb24gaW50ZXJmYWNlc1xuICogLSBEZXBlbmRlbmN5IEludmVyc2lvbjogRGVwZW5kcyBvbiBzaGFyZWQgYWJzdHJhY3Rpb25zXG4gKiBcbiAqIEdhbWUgTWVjaGFuaWNzOlxuICogLSBWYWxpZGF0ZXMgdXBncmFkZSByZXF1aXJlbWVudHMgKHJlc291cmNlcywgbGV2ZWwsIHRpbWUpXG4gKiAtIFN1cHBvcnRzIGluc3RhbnQgdXBncmFkZXMgZm9yIHByZW1pdW0gcGxheWVycyAoZ29sZCBjb3N0KVxuICogLSBUcmFja3MgdXBncmFkZSBwcm9ncmVzcyB3aXRoIGNvbXBsZXRpb24gdGltZXNcbiAqIC0gVXBkYXRlcyBiYXNlIHN0YXRzIHVwb24gY29tcGxldGlvblxuICogLSBJbXBsZW1lbnRzIHVwZ3JhZGUgcXVldWUgc3lzdGVtXG4gKi9cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIHJldHVybiB3aXRoRXJyb3JIYW5kbGluZyhhc3luYyAoKSA9PiB7XG4gICAgbG9nZ2VyLmluZm8oJ1Byb2Nlc3NpbmcgYmFzZSB1cGdyYWRlIHJlcXVlc3QnLCB7IFxuICAgICAgcmVxdWVzdElkOiBldmVudC5yZXF1ZXN0Q29udGV4dD8ucmVxdWVzdElkIFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVxdWVzdCA9IGF3YWl0IHZhbGlkYXRlUmVxdWVzdDxVcGdyYWRlQmFzZVJlcXVlc3Q+KFVwZ3JhZGVCYXNlUmVxdWVzdFNjaGVtYSwgZXZlbnQuYm9keSk7XG4gICAgXG4gICAgLy8gR2V0IGN1cnJlbnQgYmFzZSBzdGF0ZVxuICAgIGNvbnN0IGN1cnJlbnRCYXNlID0gYXdhaXQgZ2V0UGxheWVyQmFzZShyZXF1ZXN0LnBsYXllcklkLCByZXF1ZXN0LmJhc2VJZCk7XG4gICAgXG4gICAgLy8gVmFsaWRhdGUgdXBncmFkZSBpcyBwb3NzaWJsZVxuICAgIGNvbnN0IHVwZ3JhZGVUZW1wbGF0ZSA9IGF3YWl0IHZhbGlkYXRlVXBncmFkZVJlcXVpcmVtZW50cyhjdXJyZW50QmFzZSwgcmVxdWVzdC51cGdyYWRlVHlwZSk7XG4gICAgXG4gICAgLy8gQ2hlY2sgZm9yIGV4aXN0aW5nIGFjdGl2ZSB1cGdyYWRlc1xuICAgIGF3YWl0IGNoZWNrQWN0aXZlVXBncmFkZXMocmVxdWVzdC5wbGF5ZXJJZCwgcmVxdWVzdC5iYXNlSWQpO1xuICAgIFxuICAgIC8vIENyZWF0ZSB1cGdyYWRlIHJlY29yZFxuICAgIGNvbnN0IHVwZ3JhZGUgPSBhd2FpdCBjcmVhdGVVcGdyYWRlUmVjb3JkKHJlcXVlc3QsIGN1cnJlbnRCYXNlLCB1cGdyYWRlVGVtcGxhdGUpO1xuICAgIFxuICAgIC8vIElmIGluc3RhbnQgdXBncmFkZSAoc2tpcFRpbWUpLCBjb21wbGV0ZSBpbW1lZGlhdGVseVxuICAgIGlmIChyZXF1ZXN0LnNraXBUaW1lKSB7XG4gICAgICBhd2FpdCBjb21wbGV0ZUluc3RhbnRVcGdyYWRlKHVwZ3JhZGUsIGN1cnJlbnRCYXNlKTtcbiAgICB9XG5cbiAgICBsb2dnZXIuaW5mbygnQmFzZSB1cGdyYWRlIGluaXRpYXRlZCcsIHtcbiAgICAgIHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLFxuICAgICAgYmFzZUlkOiByZXF1ZXN0LmJhc2VJZCxcbiAgICAgIHVwZ3JhZGVUeXBlOiByZXF1ZXN0LnVwZ3JhZGVUeXBlLFxuICAgICAgaW5zdGFudDogcmVxdWVzdC5za2lwVGltZVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJ1xuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHVwZ3JhZGU6IHVwZ3JhZGUsXG4gICAgICAgICAgbWVzc2FnZTogcmVxdWVzdC5za2lwVGltZSBcbiAgICAgICAgICAgID8gJ0Jhc2UgdXBncmFkZSBjb21wbGV0ZWQgaW5zdGFudGx5JyBcbiAgICAgICAgICAgIDogJ0Jhc2UgdXBncmFkZSBzdGFydGVkIHN1Y2Nlc3NmdWxseSdcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9O1xuICB9LCBsb2dnZXIpO1xufTtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0UGxheWVyQmFzZShwbGF5ZXJJZDogc3RyaW5nLCBiYXNlSWQ6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogUExBWUVSX0JBU0VTX1RBQkxFLFxuICAgICAgS2V5OiB7IHBsYXllcklkLCBiYXNlSWQgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBcbiAgICBpZiAoIXJlc3BvbnNlLkl0ZW0pIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdCYXNlIG5vdCBmb3VuZCcsXG4gICAgICAgICdCQVNFX05PVF9GT1VORCcsXG4gICAgICAgIHsgcGxheWVySWQsIGJhc2VJZCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChyZXNwb25zZS5JdGVtLnN0YXR1cyA9PT0gJ2Rlc3Ryb3llZCcpIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdDYW5ub3QgdXBncmFkZSBkZXN0cm95ZWQgYmFzZScsXG4gICAgICAgICdJTlZBTElEX0JBU0VfU1RBVFVTJyxcbiAgICAgICAgeyBwbGF5ZXJJZCwgYmFzZUlkLCBzdGF0dXM6IHJlc3BvbnNlLkl0ZW0uc3RhdHVzIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3BvbnNlLkl0ZW07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgR2FtZUVuZ2luZUVycm9yKSB0aHJvdyBlcnJvcjtcbiAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgJ0ZhaWxlZCB0byByZXRyaWV2ZSBiYXNlJyxcbiAgICAgICdCQVNFX1JFVFJJRVZBTF9FUlJPUicsXG4gICAgICB7IHBsYXllcklkLCBiYXNlSWQsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gdmFsaWRhdGVVcGdyYWRlUmVxdWlyZW1lbnRzKGJhc2U6IGFueSwgdXBncmFkZVR5cGU6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgbmV4dExldmVsID0gYmFzZS5sZXZlbCArIDE7XG4gICAgY29uc3QgdGVtcGxhdGVJZCA9IGAke2Jhc2UuYmFzZVR5cGV9LWxldmVsLSR7bmV4dExldmVsfWA7XG4gICAgXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogQkFTRV9URU1QTEFURVNfVEFCTEUsXG4gICAgICBLZXk6IHsgdGVtcGxhdGVJZCB9XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIFxuICAgIGlmICghcmVzcG9uc2UuSXRlbSkge1xuICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgYE5vIHVwZ3JhZGUgdGVtcGxhdGUgZm91bmQgZm9yICR7YmFzZS5iYXNlVHlwZX0gbGV2ZWwgJHtuZXh0TGV2ZWx9YCxcbiAgICAgICAgJ1VQR1JBREVfVEVNUExBVEVfTk9UX0ZPVU5EJyxcbiAgICAgICAgeyBiYXNlVHlwZTogYmFzZS5iYXNlVHlwZSwgY3VycmVudExldmVsOiBiYXNlLmxldmVsLCBuZXh0TGV2ZWwgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCB0ZW1wbGF0ZSA9IHJlc3BvbnNlLkl0ZW07XG4gICAgXG4gICAgLy8gVE9ETzogVmFsaWRhdGUgcGxheWVyIGhhcyByZXF1aXJlZCByZXNvdXJjZXNcbiAgICAvLyBUaGlzIHdvdWxkIGludGVncmF0ZSB3aXRoIHJlc291cmNlIHNlcnZpY2VcbiAgICBcbiAgICByZXR1cm4gdGVtcGxhdGU7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgR2FtZUVuZ2luZUVycm9yKSB0aHJvdyBlcnJvcjtcbiAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgJ0ZhaWxlZCB0byB2YWxpZGF0ZSB1cGdyYWRlIHJlcXVpcmVtZW50cycsXG4gICAgICAnVVBHUkFERV9WQUxJREFUSU9OX0VSUk9SJyxcbiAgICAgIHsgYmFzZUlkOiBiYXNlLmJhc2VJZCwgdXBncmFkZVR5cGUsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tBY3RpdmVVcGdyYWRlcyhwbGF5ZXJJZDogc3RyaW5nLCBiYXNlSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICB0cnkge1xuICAgIC8vIENoZWNrIGlmIGJhc2UgYWxyZWFkeSBoYXMgYWN0aXZlIHVwZ3JhZGVcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBCQVNFX1VQR1JBREVTX1RBQkxFLFxuICAgICAgS2V5OiB7IFxuICAgICAgICBwbGF5ZXJJZCxcbiAgICAgICAgdXBncmFkZUlkOiBgJHtiYXNlSWR9LWFjdGl2ZWBcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgXG4gICAgaWYgKHJlc3BvbnNlLkl0ZW0gJiYgcmVzcG9uc2UuSXRlbS5zdGF0dXMgPT09ICdpbl9wcm9ncmVzcycpIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdCYXNlIGFscmVhZHkgaGFzIGFuIGFjdGl2ZSB1cGdyYWRlJyxcbiAgICAgICAgJ1VQR1JBREVfSU5fUFJPR1JFU1MnLFxuICAgICAgICB7IHBsYXllcklkLCBiYXNlSWQsIGFjdGl2ZVVwZ3JhZGU6IHJlc3BvbnNlLkl0ZW0udXBncmFkZUlkIH1cbiAgICAgICk7XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEdhbWVFbmdpbmVFcnJvcikgdGhyb3cgZXJyb3I7XG4gICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICdGYWlsZWQgdG8gY2hlY2sgYWN0aXZlIHVwZ3JhZGVzJyxcbiAgICAgICdBQ1RJVkVfVVBHUkFERV9DSEVDS19FUlJPUicsXG4gICAgICB7IHBsYXllcklkLCBiYXNlSWQsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlVXBncmFkZVJlY29yZChcbiAgcmVxdWVzdDogVXBncmFkZUJhc2VSZXF1ZXN0LFxuICBiYXNlOiBhbnksXG4gIHRlbXBsYXRlOiBhbnlcbik6IFByb21pc2U8QmFzZVVwZ3JhZGU+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IHVwZ3JhZGVUaW1lID0gdGVtcGxhdGUuYnVpbGRUaW1lIHx8IDM2MDA7IC8vIERlZmF1bHQgMSBob3VyXG4gICAgY29uc3QgY29tcGxldGlvblRpbWUgPSBub3cgKyAodXBncmFkZVRpbWUgKiAxMDAwKTtcbiAgICBcbiAgICBjb25zdCB1cGdyYWRlOiBCYXNlVXBncmFkZSA9IHtcbiAgICAgIHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLFxuICAgICAgdXBncmFkZUlkOiBgJHtyZXF1ZXN0LmJhc2VJZH0tJHt1dWlkdjQoKX1gLFxuICAgICAgYmFzZUlkOiByZXF1ZXN0LmJhc2VJZCxcbiAgICAgIHVwZ3JhZGVUeXBlOiByZXF1ZXN0LnVwZ3JhZGVUeXBlLFxuICAgICAgZnJvbUxldmVsOiBiYXNlLmxldmVsLFxuICAgICAgdG9MZXZlbDogYmFzZS5sZXZlbCArIDEsXG4gICAgICByZXF1aXJlbWVudHM6IHtcbiAgICAgICAgcmVzb3VyY2VzOiB0ZW1wbGF0ZS5yZXF1aXJlbWVudHM/LnJlc291cmNlcyB8fCB7fSxcbiAgICAgICAgdGltZTogdXBncmFkZVRpbWUsXG4gICAgICAgIGdvbGRDb3N0OiByZXF1ZXN0LnNraXBUaW1lID8gY2FsY3VsYXRlSW5zdGFudFVwZ3JhZGVDb3N0KHVwZ3JhZGVUaW1lKSA6IHVuZGVmaW5lZFxuICAgICAgfSxcbiAgICAgIHN0YXR1czogJ2luX3Byb2dyZXNzJyxcbiAgICAgIHN0YXJ0ZWRBdDogbm93LFxuICAgICAgY29tcGxldGlvblRpbWU6IGNvbXBsZXRpb25UaW1lLFxuICAgICAgdHRsOiBjb21wbGV0aW9uVGltZSArICg3ICogMjQgKiA2MCAqIDYwICogMTAwMCkgLy8gQ2xlYW51cCBhZnRlciA3IGRheXNcbiAgICB9O1xuXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBQdXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogQkFTRV9VUEdSQURFU19UQUJMRSxcbiAgICAgIEl0ZW06IHVwZ3JhZGVcbiAgICB9KTtcblxuICAgIGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIHJldHVybiB1cGdyYWRlO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIGNyZWF0ZSB1cGdyYWRlIHJlY29yZCcsXG4gICAgICAnVVBHUkFERV9SRUNPUkRfRVJST1InLFxuICAgICAgeyBcbiAgICAgICAgcGxheWVySWQ6IHJlcXVlc3QucGxheWVySWQsIFxuICAgICAgICBiYXNlSWQ6IHJlcXVlc3QuYmFzZUlkLCBcbiAgICAgICAgZXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSBcbiAgICAgIH1cbiAgICApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbXBsZXRlSW5zdGFudFVwZ3JhZGUodXBncmFkZTogQmFzZVVwZ3JhZGUsIGJhc2U6IGFueSk6IFByb21pc2U8dm9pZD4ge1xuICB0cnkge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgXG4gICAgLy8gVXBkYXRlIHVwZ3JhZGUgcmVjb3JkIHRvIGNvbXBsZXRlZFxuICAgIGNvbnN0IHVwZGF0ZVVwZ3JhZGVDb21tYW5kID0gbmV3IFVwZGF0ZUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBCQVNFX1VQR1JBREVTX1RBQkxFLFxuICAgICAgS2V5OiB7XG4gICAgICAgIHBsYXllcklkOiB1cGdyYWRlLnBsYXllcklkLFxuICAgICAgICB1cGdyYWRlSWQ6IHVwZ3JhZGUudXBncmFkZUlkXG4gICAgICB9LFxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogJ1NFVCAjc3RhdHVzID0gOnN0YXR1cywgY29tcGxldGlvblRpbWUgPSA6bm93JyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAnI3N0YXR1cyc6ICdzdGF0dXMnXG4gICAgICB9LFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOnN0YXR1cyc6ICdjb21wbGV0ZWQnLFxuICAgICAgICAnOm5vdyc6IG5vd1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gVXBkYXRlIGJhc2UgbGV2ZWwgYW5kIHN0YXRzXG4gICAgY29uc3QgdXBkYXRlQmFzZUNvbW1hbmQgPSBuZXcgVXBkYXRlQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFBMQVlFUl9CQVNFU19UQUJMRSxcbiAgICAgIEtleToge1xuICAgICAgICBwbGF5ZXJJZDogYmFzZS5wbGF5ZXJJZCxcbiAgICAgICAgYmFzZUlkOiBiYXNlLmJhc2VJZFxuICAgICAgfSxcbiAgICAgIFVwZGF0ZUV4cHJlc3Npb246ICdTRVQgI2xldmVsID0gI2xldmVsICsgOmluYywgbGFzdEFjdGl2ZUF0ID0gOm5vdywgc3RhdHMuZGVmZW5zZSA9IHN0YXRzLmRlZmVuc2UgKyA6ZGVmZW5zZUluYywgc3RhdHMuc3RvcmFnZSA9IHN0YXRzLnN0b3JhZ2UgKyA6c3RvcmFnZUluYywgc3RhdHMucHJvZHVjdGlvbiA9IHN0YXRzLnByb2R1Y3Rpb24gKyA6cHJvZEluYycsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgJyNsZXZlbCc6ICdsZXZlbCdcbiAgICAgIH0sXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6aW5jJzogMSxcbiAgICAgICAgJzpub3cnOiBub3csXG4gICAgICAgICc6ZGVmZW5zZUluYyc6IDEwLCAvLyBUT0RPOiBHZXQgZnJvbSB0ZW1wbGF0ZVxuICAgICAgICAnOnN0b3JhZ2VJbmMnOiAxMDAsXG4gICAgICAgICc6cHJvZEluYyc6IDVcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIEV4ZWN1dGUgYm90aCB1cGRhdGVzXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgZG9jQ2xpZW50LnNlbmQodXBkYXRlVXBncmFkZUNvbW1hbmQpLFxuICAgICAgZG9jQ2xpZW50LnNlbmQodXBkYXRlQmFzZUNvbW1hbmQpXG4gICAgXSk7XG5cbiAgICAvLyBUT0RPOiBEZWR1Y3QgZ29sZCBjb3N0IGZyb20gcGxheWVyIHJlc291cmNlcyAoaW50ZWdyYXRlIHdpdGggcmVzb3VyY2Ugc2VydmljZSlcbiAgICBcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgJ0ZhaWxlZCB0byBjb21wbGV0ZSBpbnN0YW50IHVwZ3JhZGUnLFxuICAgICAgJ0lOU1RBTlRfVVBHUkFERV9FUlJPUicsXG4gICAgICB7IHVwZ3JhZGVJZDogdXBncmFkZS51cGdyYWRlSWQsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlSW5zdGFudFVwZ3JhZGVDb3N0KHVwZ3JhZGVUaW1lU2Vjb25kczogbnVtYmVyKTogbnVtYmVyIHtcbiAgLy8gRm9ybXVsYTogMSBnb2xkIHBlciBtaW51dGUgb2YgdXBncmFkZSB0aW1lIChtaW5pbXVtIDEwIGdvbGQpXG4gIHJldHVybiBNYXRoLm1heCgxMCwgTWF0aC5jZWlsKHVwZ3JhZGVUaW1lU2Vjb25kcyAvIDYwKSk7XG59Il19