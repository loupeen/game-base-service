"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const shared_mocks_1 = require("../../lib/shared-mocks");
const zod_1 = require("zod");
const uuid_1 = require("uuid");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const logger = new shared_mocks_1.StructuredLogger('UpgradeBaseHandler');
const PLAYER_BASES_TABLE = process.env.PLAYER_BASES_TABLE ?? '';
const BASE_TEMPLATES_TABLE = process.env.BASE_TEMPLATES_TABLE ?? '';
const BASE_UPGRADES_TABLE = process.env.BASE_UPGRADES_TABLE ?? '';
// Environment available if needed
const UpgradeBaseRequestSchema = zod_1.z.object({
    playerId: zod_1.z.string().min(1).max(50),
    baseId: zod_1.z.string().min(1).max(50),
    upgradeType: zod_1.z.enum(['level', 'defense', 'storage', 'production', 'specialized']),
    skipTime: zod_1.z.boolean().optional().default(false) // For premium players
});
/**
 * Upgrade Base Handler
 *
 * Implements base upgrade system following SOLID principles:
 * - Single Responsibility: Only handles base upgrades
 * - Open/Closed: Extensible for new upgrade types
 * - Liskov Substitution: All upgrade types follow same pattern
 * - Interface Segregation: Clear upgrade operation interfaces
 * - Dependency Inversion: Depends on shared abstractions
 *
 * Game Mechanics:
 * - Validates upgrade requirements (resources, level, time)
 * - Supports instant upgrades for premium players (gold cost)
 * - Tracks upgrade progress with completion times
 * - Updates base stats upon completion
 * - Implements upgrade queue system
 */
const handler = async (event) => {
    return (0, shared_mocks_1.withErrorHandling)(async () => {
        logger.info('Processing base upgrade request', {
            requestId: event.requestContext?.requestId
        });
        const request = await (0, shared_mocks_1.validateRequest)(UpgradeBaseRequestSchema, event.body);
        // Get current base state
        const currentBase = await getPlayerBase(request.playerId, request.baseId);
        // Validate upgrade is possible
        const upgradeTemplate = await validateUpgradeRequirements(currentBase, request.upgradeType);
        // Check for existing active upgrades
        await checkActiveUpgrades(request.playerId, request.baseId);
        // Create upgrade record
        const upgrade = await createUpgradeRecord(request, currentBase, upgradeTemplate);
        // If instant upgrade (skipTime), complete immediately
        if (request.skipTime) {
            await completeInstantUpgrade(upgrade, currentBase);
        }
        logger.info('Base upgrade initiated', {
            playerId: request.playerId,
            baseId: request.baseId,
            upgradeType: request.upgradeType,
            instant: request.skipTime
        });
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                success: true,
                data: {
                    upgrade: upgrade,
                    message: request.skipTime
                        ? 'Base upgrade completed instantly'
                        : 'Base upgrade started successfully'
                }
            })
        };
    }, logger);
};
exports.handler = handler;
async function getPlayerBase(playerId, baseId) {
    try {
        const command = new lib_dynamodb_1.GetCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: { playerId, baseId }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError('Base not found', 'BASE_NOT_FOUND', { playerId, baseId });
        }
        if (response.Item.status === 'destroyed') {
            throw new shared_mocks_1.GameEngineError('Cannot upgrade destroyed base', 'INVALID_BASE_STATUS', { playerId, baseId, status: response.Item.status });
        }
        return response.Item;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to retrieve base', 'BASE_RETRIEVAL_ERROR', { playerId, baseId, error: error.message });
    }
}
async function validateUpgradeRequirements(base, upgradeType) {
    try {
        const nextLevel = base.level + 1;
        const templateId = `${base.baseType}-level-${nextLevel}`;
        const command = new lib_dynamodb_1.GetCommand({
            TableName: BASE_TEMPLATES_TABLE,
            Key: { templateId }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError(`No upgrade template found for ${base.baseType} level ${nextLevel}`, 'UPGRADE_TEMPLATE_NOT_FOUND', { baseType: base.baseType, currentLevel: base.level, nextLevel });
        }
        const template = response.Item;
        // TODO: Validate player has required resources
        // This would integrate with resource service
        return template;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to validate upgrade requirements', 'UPGRADE_VALIDATION_ERROR', { baseId: base.baseId, upgradeType, error: error.message });
    }
}
async function checkActiveUpgrades(playerId, baseId) {
    try {
        // Check if base already has active upgrade
        const command = new lib_dynamodb_1.GetCommand({
            TableName: BASE_UPGRADES_TABLE,
            Key: {
                playerId,
                upgradeId: `${baseId}-active`
            }
        });
        const response = await docClient.send(command);
        if (response.Item && response.Item.status === 'in_progress') {
            throw new shared_mocks_1.GameEngineError('Base already has an active upgrade', 'UPGRADE_IN_PROGRESS', { playerId, baseId, activeUpgrade: response.Item.upgradeId });
        }
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to check active upgrades', 'ACTIVE_UPGRADE_CHECK_ERROR', { playerId, baseId, error: error.message });
    }
}
async function createUpgradeRecord(request, base, template) {
    try {
        const now = Date.now();
        const upgradeTime = template.buildTime || 3600; // Default 1 hour
        const completionTime = now + (upgradeTime * 1000);
        const upgrade = {
            playerId: request.playerId,
            upgradeId: `${request.baseId}-${(0, uuid_1.v4)()}`,
            baseId: request.baseId,
            upgradeType: request.upgradeType,
            fromLevel: base.level,
            toLevel: base.level + 1,
            requirements: {
                resources: template.requirements?.resources || {},
                time: upgradeTime,
                goldCost: request.skipTime ? calculateInstantUpgradeCost(upgradeTime) : undefined
            },
            status: 'in_progress',
            startedAt: now,
            completionTime: completionTime,
            ttl: completionTime + (7 * 24 * 60 * 60 * 1000) // Cleanup after 7 days
        };
        const command = new lib_dynamodb_1.PutCommand({
            TableName: BASE_UPGRADES_TABLE,
            Item: upgrade
        });
        await docClient.send(command);
        return upgrade;
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to create upgrade record', 'UPGRADE_RECORD_ERROR', {
            playerId: request.playerId,
            baseId: request.baseId,
            error: error.message
        });
    }
}
async function completeInstantUpgrade(upgrade, base) {
    try {
        const now = Date.now();
        // Update upgrade record to completed
        const updateUpgradeCommand = new lib_dynamodb_1.UpdateCommand({
            TableName: BASE_UPGRADES_TABLE,
            Key: {
                playerId: upgrade.playerId,
                upgradeId: upgrade.upgradeId
            },
            UpdateExpression: 'SET #status = :status, completionTime = :now',
            ExpressionAttributeNames: {
                '#status': 'status'
            },
            ExpressionAttributeValues: {
                ':status': 'completed',
                ':now': now
            }
        });
        // Update base level and stats
        const updateBaseCommand = new lib_dynamodb_1.UpdateCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: {
                playerId: base.playerId,
                baseId: base.baseId
            },
            UpdateExpression: 'SET #level = #level + :inc, lastActiveAt = :now, stats.defense = stats.defense + :defenseInc, stats.storage = stats.storage + :storageInc, stats.production = stats.production + :prodInc',
            ExpressionAttributeNames: {
                '#level': 'level'
            },
            ExpressionAttributeValues: {
                ':inc': 1,
                ':now': now,
                ':defenseInc': 10, // TODO: Get from template
                ':storageInc': 100,
                ':prodInc': 5
            }
        });
        // Execute both updates
        await Promise.all([
            docClient.send(updateUpgradeCommand),
            docClient.send(updateBaseCommand)
        ]);
        // TODO: Deduct gold cost from player resources (integrate with resource service)
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to complete instant upgrade', 'INSTANT_UPGRADE_ERROR', { upgradeId: upgrade.upgradeId, error: error.message });
    }
}
function calculateInstantUpgradeCost(upgradeTimeSeconds) {
    // Formula: 1 gold per minute of upgrade time (minimum 10 gold)
    return Math.max(10, Math.ceil(upgradeTimeSeconds / 60));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBncmFkZS1iYXNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGFtYmRhL2Jhc2UtbWFuYWdlbWVudC91cGdyYWRlLWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUFzRztBQUN0Ryx5REFLZ0M7QUFDaEMsNkJBQXdCO0FBQ3hCLCtCQUFvQztBQUVwQyxNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDNUMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQzVELE1BQU0sTUFBTSxHQUFHLElBQUksK0JBQWdCLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUUxRCxNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDO0FBQ2hFLE1BQU0sb0JBQW9CLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsSUFBSSxFQUFFLENBQUM7QUFDcEUsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLEVBQUUsQ0FBQztBQUNsRSxrQ0FBa0M7QUFFbEMsTUFBTSx3QkFBd0IsR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3hDLFFBQVEsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7SUFDbkMsTUFBTSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztJQUNqQyxXQUFXLEVBQUUsT0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxhQUFhLENBQUMsQ0FBQztJQUNqRixRQUFR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c0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgR2V0Q29tbWFuZCwgVXBkYXRlQ29tbWFuZCwgUHV0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBcbiAgU3RydWN0dXJlZExvZ2dlciwgXG4gIEdhbWVFbmdpbmVFcnJvcixcbiAgd2l0aEVycm9ySGFuZGxpbmcsXG4gIHZhbGlkYXRlUmVxdWVzdCBcbn0gZnJvbSAnLi4vLi4vbGliL3NoYXJlZC1tb2Nrcyc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuXG5jb25zdCBkeW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGR5bmFtb0NsaWVudCk7XG5jb25zdCBsb2dnZXIgPSBuZXcgU3RydWN0dXJlZExvZ2dlcignVXBncmFkZUJhc2VIYW5kbGVyJyk7XG5cbmNvbnN0IFBMQVlFUl9CQVNFU19UQUJMRSA9IHByb2Nlc3MuZW52LlBMQVlFUl9CQVNFU19UQUJMRSA/PyAnJztcbmNvbnN0IEJBU0VfVEVNUExBVEVTX1RBQkxFID0gcHJvY2Vzcy5lbnYuQkFTRV9URU1QTEFURVNfVEFCTEUgPz8gJyc7XG5jb25zdCBCQVNFX1VQR1JBREVTX1RBQkxFID0gcHJvY2Vzcy5lbnYuQkFTRV9VUEdSQURFU19UQUJMRSA/PyAnJztcbi8vIEVudmlyb25tZW50IGF2YWlsYWJsZSBpZiBuZWVkZWRcblxuY29uc3QgVXBncmFkZUJhc2VSZXF1ZXN0U2NoZW1hID0gei5vYmplY3Qoe1xuICBwbGF5ZXJJZDogei5zdHJpbmcoKS5taW4oMSkubWF4KDUwKSxcbiAgYmFzZUlkOiB6LnN0cmluZygpLm1pbigxKS5tYXgoNTApLFxuICB1cGdyYWRlVHlwZTogei5lbnVtKFsnbGV2ZWwnLCAnZGVmZW5zZScsICdzdG9yYWdlJywgJ3Byb2R1Y3Rpb24nLCAnc3BlY2lhbGl6ZWQnXSksXG4gIHNraXBUaW1lOiB6LmJvb2xlYW4oKS5vcHRpb25hbCgpLmRlZmF1bHQoZmFsc2UpIC8vIEZvciBwcmVtaXVtIHBsYXllcnNcbn0pO1xuXG50eXBlIFVwZ3JhZGVCYXNlUmVxdWVzdCA9IHouaW5mZXI8dHlwZW9mIFVwZ3JhZGVCYXNlUmVxdWVzdFNjaGVtYT47XG5cbmludGVyZmFjZSBCYXNlVXBncmFkZSB7XG4gIHBsYXllcklkOiBzdHJpbmc7XG4gIHVwZ3JhZGVJZDogc3RyaW5nO1xuICBiYXNlSWQ6IHN0cmluZztcbiAgdXBncmFkZVR5cGU6IHN0cmluZztcbiAgZnJvbUxldmVsOiBudW1iZXI7XG4gIHRvTGV2ZWw6IG51bWJlcjtcbiAgcmVxdWlyZW1lbnRzOiB7XG4gICAgcmVzb3VyY2VzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+O1xuICAgIHRpbWU6IG51bWJlcjtcbiAgICBnb2xkQ29zdD86IG51bWJlcjtcbiAgfTtcbiAgc3RhdHVzOiAnaW5fcHJvZ3Jlc3MnIHwgJ2NvbXBsZXRlZCcgfCAnY2FuY2VsbGVkJztcbiAgc3RhcnRlZEF0OiBudW1iZXI7XG4gIGNvbXBsZXRpb25UaW1lOiBudW1iZXI7XG4gIHR0bD86IG51bWJlcjtcbn1cblxuLyoqXG4gKiBVcGdyYWRlIEJhc2UgSGFuZGxlclxuICogXG4gKiBJbXBsZW1lbnRzIGJhc2UgdXBncmFkZSBzeXN0ZW0gZm9sbG93aW5nIFNPTElEIHByaW5jaXBsZXM6XG4gKiAtIFNpbmdsZSBSZXNwb25zaWJpbGl0eTogT25seSBoYW5kbGVzIGJhc2UgdXBncmFkZXNcbiAqIC0gT3Blbi9DbG9zZWQ6IEV4dGVuc2libGUgZm9yIG5ldyB1cGdyYWRlIHR5cGVzXG4gKiAtIExpc2tvdiBTdWJzdGl0dXRpb246IEFsbCB1cGdyYWRlIHR5cGVzIGZvbGxvdyBzYW1lIHBhdHRlcm5cbiAqIC0gSW50ZXJmYWNlIFNlZ3JlZ2F0aW9uOiBDbGVhciB1cGdyYWRlIG9wZXJhdGlvbiBpbnRlcmZhY2VzXG4gKiAtIERlcGVuZGVuY3kgSW52ZXJzaW9uOiBEZXBlbmRzIG9uIHNoYXJlZCBhYnN0cmFjdGlvbnNcbiAqIFxuICogR2FtZSBNZWNoYW5pY3M6XG4gKiAtIFZhbGlkYXRlcyB1cGdyYWRlIHJlcXVpcmVtZW50cyAocmVzb3VyY2VzLCBsZXZlbCwgdGltZSlcbiAqIC0gU3VwcG9ydHMgaW5zdGFudCB1cGdyYWRlcyBmb3IgcHJlbWl1bSBwbGF5ZXJzIChnb2xkIGNvc3QpXG4gKiAtIFRyYWNrcyB1cGdyYWRlIHByb2dyZXNzIHdpdGggY29tcGxldGlvbiB0aW1lc1xuICogLSBVcGRhdGVzIGJhc2Ugc3RhdHMgdXBvbiBjb21wbGV0aW9uXG4gKiAtIEltcGxlbWVudHMgdXBncmFkZSBxdWV1ZSBzeXN0ZW1cbiAqL1xuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgcmV0dXJuIHdpdGhFcnJvckhhbmRsaW5nKGFzeW5jICgpID0+IHtcbiAgICBsb2dnZXIuaW5mbygnUHJvY2Vzc2luZyBiYXNlIHVwZ3JhZGUgcmVxdWVzdCcsIHsgXG4gICAgICByZXF1ZXN0SWQ6IGV2ZW50LnJlcXVlc3RDb250ZXh0Py5yZXF1ZXN0SWQgXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXF1ZXN0ID0gYXdhaXQgdmFsaWRhdGVSZXF1ZXN0PFVwZ3JhZGVCYXNlUmVxdWVzdD4oVXBncmFkZUJhc2VSZXF1ZXN0U2NoZW1hLCBldmVudC5ib2R5KTtcbiAgICBcbiAgICAvLyBHZXQgY3VycmVudCBiYXNlIHN0YXRlXG4gICAgY29uc3QgY3VycmVudEJhc2UgPSBhd2FpdCBnZXRQbGF5ZXJCYXNlKHJlcXVlc3QucGxheWVySWQsIHJlcXVlc3QuYmFzZUlkKTtcbiAgICBcbiAgICAvLyBWYWxpZGF0ZSB1cGdyYWRlIGlzIHBvc3NpYmxlXG4gICAgY29uc3QgdXBncmFkZVRlbXBsYXRlID0gYXdhaXQgdmFsaWRhdGVVcGdyYWRlUmVxdWlyZW1lbnRzKGN1cnJlbnRCYXNlLCByZXF1ZXN0LnVwZ3JhZGVUeXBlKTtcbiAgICBcbiAgICAvLyBDaGVjayBmb3IgZXhpc3RpbmcgYWN0aXZlIHVwZ3JhZGVzXG4gICAgYXdhaXQgY2hlY2tBY3RpdmVVcGdyYWRlcyhyZXF1ZXN0LnBsYXllcklkLCByZXF1ZXN0LmJhc2VJZCk7XG4gICAgXG4gICAgLy8gQ3JlYXRlIHVwZ3JhZGUgcmVjb3JkXG4gICAgY29uc3QgdXBncmFkZSA9IGF3YWl0IGNyZWF0ZVVwZ3JhZGVSZWNvcmQocmVxdWVzdCwgY3VycmVudEJhc2UsIHVwZ3JhZGVUZW1wbGF0ZSk7XG4gICAgXG4gICAgLy8gSWYgaW5zdGFudCB1cGdyYWRlIChza2lwVGltZSksIGNvbXBsZXRlIGltbWVkaWF0ZWx5XG4gICAgaWYgKHJlcXVlc3Quc2tpcFRpbWUpIHtcbiAgICAgIGF3YWl0IGNvbXBsZXRlSW5zdGFudFVwZ3JhZGUodXBncmFkZSwgY3VycmVudEJhc2UpO1xuICAgIH1cblxuICAgIGxvZ2dlci5pbmZvKCdCYXNlIHVwZ3JhZGUgaW5pdGlhdGVkJywge1xuICAgICAgcGxheWVySWQ6IHJlcXVlc3QucGxheWVySWQsXG4gICAgICBiYXNlSWQ6IHJlcXVlc3QuYmFzZUlkLFxuICAgICAgdXBncmFkZVR5cGU6IHJlcXVlc3QudXBncmFkZVR5cGUsXG4gICAgICBpbnN0YW50OiByZXF1ZXN0LnNraXBUaW1lXG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonXG4gICAgICB9LFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdXBncmFkZTogdXBncmFkZSxcbiAgICAgICAgICBtZXNzYWdlOiByZXF1ZXN0LnNraXBUaW1lIFxuICAgICAgICAgICAgPyAnQmFzZSB1cGdyYWRlIGNvbXBsZXRlZCBpbnN0YW50bHknIFxuICAgICAgICAgICAgOiAnQmFzZSB1cGdyYWRlIHN0YXJ0ZWQgc3VjY2Vzc2Z1bGx5J1xuICAgICAgICB9XG4gICAgICB9KVxuICAgIH07XG4gIH0sIGxvZ2dlcik7XG59O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRQbGF5ZXJCYXNlKHBsYXllcklkOiBzdHJpbmcsIGJhc2VJZDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBQTEFZRVJfQkFTRVNfVEFCTEUsXG4gICAgICBLZXk6IHsgcGxheWVySWQsIGJhc2VJZCB9XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIFxuICAgIGlmICghcmVzcG9uc2UuSXRlbSkge1xuICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgJ0Jhc2Ugbm90IGZvdW5kJyxcbiAgICAgICAgJ0JBU0VfTk9UX0ZPVU5EJyxcbiAgICAgICAgeyBwbGF5ZXJJZCwgYmFzZUlkIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHJlc3BvbnNlLkl0ZW0uc3RhdHVzID09PSAnZGVzdHJveWVkJykge1xuICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgJ0Nhbm5vdCB1cGdyYWRlIGRlc3Ryb3llZCBiYXNlJyxcbiAgICAgICAgJ0lOVkFMSURfQkFTRV9TVEFUVVMnLFxuICAgICAgICB7IHBsYXllcklkLCBiYXNlSWQsIHN0YXR1czogcmVzcG9uc2UuSXRlbS5zdGF0dXMgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzcG9uc2UuSXRlbTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBHYW1lRW5naW5lRXJyb3IpIHRocm93IGVycm9yO1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIHJldHJpZXZlIGJhc2UnLFxuICAgICAgJ0JBU0VfUkVUUklFVkFMX0VSUk9SJyxcbiAgICAgIHsgcGxheWVySWQsIGJhc2VJZCwgZXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSB9XG4gICAgKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB2YWxpZGF0ZVVwZ3JhZGVSZXF1aXJlbWVudHMoYmFzZTogYW55LCB1cGdyYWRlVHlwZTogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBuZXh0TGV2ZWwgPSBiYXNlLmxldmVsICsgMTtcbiAgICBjb25zdCB0ZW1wbGF0ZUlkID0gYCR7YmFzZS5iYXNlVHlwZX0tbGV2ZWwtJHtuZXh0TGV2ZWx9YDtcbiAgICBcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBCQVNFX1RFTVBMQVRFU19UQUJMRSxcbiAgICAgIEtleTogeyB0ZW1wbGF0ZUlkIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgXG4gICAgaWYgKCFyZXNwb25zZS5JdGVtKSB7XG4gICAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgICBgTm8gdXBncmFkZSB0ZW1wbGF0ZSBmb3VuZCBmb3IgJHtiYXNlLmJhc2VUeXBlfSBsZXZlbCAke25leHRMZXZlbH1gLFxuICAgICAgICAnVVBHUkFERV9URU1QTEFURV9OT1RfRk9VTkQnLFxuICAgICAgICB7IGJhc2VUeXBlOiBiYXNlLmJhc2VUeXBlLCBjdXJyZW50TGV2ZWw6IGJhc2UubGV2ZWwsIG5leHRMZXZlbCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHRlbXBsYXRlID0gcmVzcG9uc2UuSXRlbTtcbiAgICBcbiAgICAvLyBUT0RPOiBWYWxpZGF0ZSBwbGF5ZXIgaGFzIHJlcXVpcmVkIHJlc291cmNlc1xuICAgIC8vIFRoaXMgd291bGQgaW50ZWdyYXRlIHdpdGggcmVzb3VyY2Ugc2VydmljZVxuICAgIFxuICAgIHJldHVybiB0ZW1wbGF0ZTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBHYW1lRW5naW5lRXJyb3IpIHRocm93IGVycm9yO1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIHZhbGlkYXRlIHVwZ3JhZGUgcmVxdWlyZW1lbnRzJyxcbiAgICAgICdVUEdSQURFX1ZBTElEQVRJT05fRVJST1InLFxuICAgICAgeyBiYXNlSWQ6IGJhc2UuYmFzZUlkLCB1cGdyYWRlVHlwZSwgZXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSB9XG4gICAgKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBjaGVja0FjdGl2ZVVwZ3JhZGVzKHBsYXllcklkOiBzdHJpbmcsIGJhc2VJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gIHRyeSB7XG4gICAgLy8gQ2hlY2sgaWYgYmFzZSBhbHJlYWR5IGhhcyBhY3RpdmUgdXBncmFkZVxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IEJBU0VfVVBHUkFERVNfVEFCTEUsXG4gICAgICBLZXk6IHsgXG4gICAgICAgIHBsYXllcklkLFxuICAgICAgICB1cGdyYWRlSWQ6IGAke2Jhc2VJZH0tYWN0aXZlYFxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBcbiAgICBpZiAocmVzcG9uc2UuSXRlbSAmJiByZXNwb25zZS5JdGVtLnN0YXR1cyA9PT0gJ2luX3Byb2dyZXNzJykge1xuICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgJ0Jhc2UgYWxyZWFkeSBoYXMgYW4gYWN0aXZlIHVwZ3JhZGUnLFxuICAgICAgICAnVVBHUkFERV9JTl9QUk9HUkVTUycsXG4gICAgICAgIHsgcGxheWVySWQsIGJhc2VJZCwgYWN0aXZlVXBncmFkZTogcmVzcG9uc2UuSXRlbS51cGdyYWRlSWQgfVxuICAgICAgKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgR2FtZUVuZ2luZUVycm9yKSB0aHJvdyBlcnJvcjtcbiAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgJ0ZhaWxlZCB0byBjaGVjayBhY3RpdmUgdXBncmFkZXMnLFxuICAgICAgJ0FDVElWRV9VUEdSQURFX0NIRUNLX0VSUk9SJyxcbiAgICAgIHsgcGxheWVySWQsIGJhc2VJZCwgZXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSB9XG4gICAgKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVVcGdyYWRlUmVjb3JkKFxuICByZXF1ZXN0OiBVcGdyYWRlQmFzZVJlcXVlc3QsXG4gIGJhc2U6IGFueSxcbiAgdGVtcGxhdGU6IGFueVxuKTogUHJvbWlzZTxCYXNlVXBncmFkZT4ge1xuICB0cnkge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgY29uc3QgdXBncmFkZVRpbWUgPSB0ZW1wbGF0ZS5idWlsZFRpbWUgfHwgMzYwMDsgLy8gRGVmYXVsdCAxIGhvdXJcbiAgICBjb25zdCBjb21wbGV0aW9uVGltZSA9IG5vdyArICh1cGdyYWRlVGltZSAqIDEwMDApO1xuICAgIFxuICAgIGNvbnN0IHVwZ3JhZGU6IEJhc2VVcGdyYWRlID0ge1xuICAgICAgcGxheWVySWQ6IHJlcXVlc3QucGxheWVySWQsXG4gICAgICB1cGdyYWRlSWQ6IGAke3JlcXVlc3QuYmFzZUlkfS0ke3V1aWR2NCgpfWAsXG4gICAgICBiYXNlSWQ6IHJlcXVlc3QuYmFzZUlkLFxuICAgICAgdXBncmFkZVR5cGU6IHJlcXVlc3QudXBncmFkZVR5cGUsXG4gICAgICBmcm9tTGV2ZWw6IGJhc2UubGV2ZWwsXG4gICAgICB0b0xldmVsOiBiYXNlLmxldmVsICsgMSxcbiAgICAgIHJlcXVpcmVtZW50czoge1xuICAgICAgICByZXNvdXJjZXM6IHRlbXBsYXRlLnJlcXVpcmVtZW50cz8ucmVzb3VyY2VzIHx8IHt9LFxuICAgICAgICB0aW1lOiB1cGdyYWRlVGltZSxcbiAgICAgICAgZ29sZENvc3Q6IHJlcXVlc3Quc2tpcFRpbWUgPyBjYWxjdWxhdGVJbnN0YW50VXBncmFkZUNvc3QodXBncmFkZVRpbWUpIDogdW5kZWZpbmVkXG4gICAgICB9LFxuICAgICAgc3RhdHVzOiAnaW5fcHJvZ3Jlc3MnLFxuICAgICAgc3RhcnRlZEF0OiBub3csXG4gICAgICBjb21wbGV0aW9uVGltZTogY29tcGxldGlvblRpbWUsXG4gICAgICB0dGw6IGNvbXBsZXRpb25UaW1lICsgKDcgKiAyNCAqIDYwICogNjAgKiAxMDAwKSAvLyBDbGVhbnVwIGFmdGVyIDcgZGF5c1xuICAgIH07XG5cbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFB1dENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBCQVNFX1VQR1JBREVTX1RBQkxFLFxuICAgICAgSXRlbTogdXBncmFkZVxuICAgIH0pO1xuXG4gICAgYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgcmV0dXJuIHVwZ3JhZGU7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICdGYWlsZWQgdG8gY3JlYXRlIHVwZ3JhZGUgcmVjb3JkJyxcbiAgICAgICdVUEdSQURFX1JFQ09SRF9FUlJPUicsXG4gICAgICB7IFxuICAgICAgICBwbGF5ZXJJZDogcmVxdWVzdC5wbGF5ZXJJZCwgXG4gICAgICAgIGJhc2VJZDogcmVxdWVzdC5iYXNlSWQsIFxuICAgICAgICBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIFxuICAgICAgfVxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY29tcGxldGVJbnN0YW50VXBncmFkZSh1cGdyYWRlOiBCYXNlVXBncmFkZSwgYmFzZTogYW55KTogUHJvbWlzZTx2b2lkPiB7XG4gIHRyeSB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICAvLyBVcGRhdGUgdXBncmFkZSByZWNvcmQgdG8gY29tcGxldGVkXG4gICAgY29uc3QgdXBkYXRlVXBncmFkZUNvbW1hbmQgPSBuZXcgVXBkYXRlQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IEJBU0VfVVBHUkFERVNfVEFCTEUsXG4gICAgICBLZXk6IHtcbiAgICAgICAgcGxheWVySWQ6IHVwZ3JhZGUucGxheWVySWQsXG4gICAgICAgIHVwZ3JhZGVJZDogdXBncmFkZS51cGdyYWRlSWRcbiAgICAgIH0sXG4gICAgICBVcGRhdGVFeHByZXNzaW9uOiAnU0VUICNzdGF0dXMgPSA6c3RhdHVzLCBjb21wbGV0aW9uVGltZSA9IDpub3cnLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICcjc3RhdHVzJzogJ3N0YXR1cydcbiAgICAgIH0sXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6c3RhdHVzJzogJ2NvbXBsZXRlZCcsXG4gICAgICAgICc6bm93Jzogbm93XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBVcGRhdGUgYmFzZSBsZXZlbCBhbmQgc3RhdHNcbiAgICBjb25zdCB1cGRhdGVCYXNlQ29tbWFuZCA9IG5ldyBVcGRhdGVDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogUExBWUVSX0JBU0VTX1RBQkxFLFxuICAgICAgS2V5OiB7XG4gICAgICAgIHBsYXllcklkOiBiYXNlLnBsYXllcklkLFxuICAgICAgICBiYXNlSWQ6IGJhc2UuYmFzZUlkXG4gICAgICB9LFxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogJ1NFVCAjbGV2ZWwgPSAjbGV2ZWwgKyA6aW5jLCBsYXN0QWN0aXZlQXQgPSA6bm93LCBzdGF0cy5kZWZlbnNlID0gc3RhdHMuZGVmZW5zZSArIDpkZWZlbnNlSW5jLCBzdGF0cy5zdG9yYWdlID0gc3RhdHMuc3RvcmFnZSArIDpzdG9yYWdlSW5jLCBzdGF0cy5wcm9kdWN0aW9uID0gc3RhdHMucHJvZHVjdGlvbiArIDpwcm9kSW5jJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAnI2xldmVsJzogJ2xldmVsJ1xuICAgICAgfSxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzppbmMnOiAxLFxuICAgICAgICAnOm5vdyc6IG5vdyxcbiAgICAgICAgJzpkZWZlbnNlSW5jJzogMTAsIC8vIFRPRE86IEdldCBmcm9tIHRlbXBsYXRlXG4gICAgICAgICc6c3RvcmFnZUluYyc6IDEwMCxcbiAgICAgICAgJzpwcm9kSW5jJzogNVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gRXhlY3V0ZSBib3RoIHVwZGF0ZXNcbiAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICBkb2NDbGllbnQuc2VuZCh1cGRhdGVVcGdyYWRlQ29tbWFuZCksXG4gICAgICBkb2NDbGllbnQuc2VuZCh1cGRhdGVCYXNlQ29tbWFuZClcbiAgICBdKTtcblxuICAgIC8vIFRPRE86IERlZHVjdCBnb2xkIGNvc3QgZnJvbSBwbGF5ZXIgcmVzb3VyY2VzIChpbnRlZ3JhdGUgd2l0aCByZXNvdXJjZSBzZXJ2aWNlKVxuICAgIFxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIGNvbXBsZXRlIGluc3RhbnQgdXBncmFkZScsXG4gICAgICAnSU5TVEFOVF9VUEdSQURFX0VSUk9SJyxcbiAgICAgIHsgdXBncmFkZUlkOiB1cGdyYWRlLnVwZ3JhZGVJZCwgZXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSB9XG4gICAgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVJbnN0YW50VXBncmFkZUNvc3QodXBncmFkZVRpbWVTZWNvbmRzOiBudW1iZXIpOiBudW1iZXIge1xuICAvLyBGb3JtdWxhOiAxIGdvbGQgcGVyIG1pbnV0ZSBvZiB1cGdyYWRlIHRpbWUgKG1pbmltdW0gMTAgZ29sZClcbiAgcmV0dXJuIE1hdGgubWF4KDEwLCBNYXRoLmNlaWwodXBncmFkZVRpbWVTZWNvbmRzIC8gNjApKTtcbn0iXX0=