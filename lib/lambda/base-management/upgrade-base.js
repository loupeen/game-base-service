"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const shared_mocks_1 = require("../../lib/shared-mocks");
const zod_1 = require("zod");
const uuid_1 = require("uuid");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const logger = new shared_mocks_1.StructuredLogger('UpgradeBaseHandler');
const PLAYER_BASES_TABLE = process.env.PLAYER_BASES_TABLE ?? '';
const BASE_TEMPLATES_TABLE = process.env.BASE_TEMPLATES_TABLE ?? '';
const BASE_UPGRADES_TABLE = process.env.BASE_UPGRADES_TABLE ?? '';
// Environment available if needed
const UpgradeBaseRequestSchema = zod_1.z.object({
    playerId: zod_1.z.string().min(1).max(50),
    baseId: zod_1.z.string().min(1).max(50),
    upgradeType: zod_1.z.enum(['level', 'defense', 'storage', 'production', 'specialized']),
    skipTime: zod_1.z.boolean().optional().default(false) // For premium players
});
/**
 * Upgrade Base Handler
 *
 * Implements base upgrade system following SOLID principles:
 * - Single Responsibility: Only handles base upgrades
 * - Open/Closed: Extensible for new upgrade types
 * - Liskov Substitution: All upgrade types follow same pattern
 * - Interface Segregation: Clear upgrade operation interfaces
 * - Dependency Inversion: Depends on shared abstractions
 *
 * Game Mechanics:
 * - Validates upgrade requirements (resources, level, time)
 * - Supports instant upgrades for premium players (gold cost)
 * - Tracks upgrade progress with completion times
 * - Updates base stats upon completion
 * - Implements upgrade queue system
 */
const handler = async (event) => {
    return (0, shared_mocks_1.withErrorHandling)(async () => {
        logger.info('Processing base upgrade request', {
            requestId: event.requestContext?.requestId
        });
        const request = await (0, shared_mocks_1.validateRequest)(UpgradeBaseRequestSchema, event.body);
        // Get current base state
        const currentBase = await getPlayerBase(request.playerId, request.baseId);
        // Validate upgrade is possible
        const upgradeTemplate = await validateUpgradeRequirements(currentBase, request.upgradeType);
        // Check for existing active upgrades
        await checkActiveUpgrades(request.playerId, request.baseId);
        // Create upgrade record
        const upgrade = await createUpgradeRecord(request, currentBase, upgradeTemplate);
        // If instant upgrade (skipTime), complete immediately
        if (request.skipTime) {
            await completeInstantUpgrade(upgrade, currentBase);
        }
        logger.info('Base upgrade initiated', {
            playerId: request.playerId,
            baseId: request.baseId,
            upgradeType: request.upgradeType,
            instant: request.skipTime
        });
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                success: true,
                data: {
                    upgrade: upgrade,
                    message: request.skipTime
                        ? 'Base upgrade completed instantly'
                        : 'Base upgrade started successfully'
                }
            })
        };
    }, logger);
};
exports.handler = handler;
async function getPlayerBase(playerId, baseId) {
    try {
        const command = new lib_dynamodb_1.GetCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: { playerId, baseId }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError('Base not found', 'BASE_NOT_FOUND', { playerId, baseId });
        }
        const base = response.Item;
        if (base.status === 'destroyed') {
            throw new shared_mocks_1.GameEngineError('Cannot upgrade destroyed base', 'INVALID_BASE_STATUS', { playerId, baseId, status: base.status });
        }
        return base;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to retrieve base', 'BASE_RETRIEVAL_ERROR', { playerId, baseId, error: error.message });
    }
}
async function validateUpgradeRequirements(base, upgradeType) {
    try {
        const nextLevel = base.level + 1;
        const templateId = `${base.baseType}-level-${nextLevel}`;
        const command = new lib_dynamodb_1.GetCommand({
            TableName: BASE_TEMPLATES_TABLE,
            Key: { templateId }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError(`No upgrade template found for ${base.baseType} level ${nextLevel}`, 'UPGRADE_TEMPLATE_NOT_FOUND', { baseType: base.baseType, currentLevel: base.level, nextLevel });
        }
        const template = response.Item;
        // TODO: Validate player has required resources
        // This would integrate with resource service
        return template;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to validate upgrade requirements', 'UPGRADE_VALIDATION_ERROR', { baseId: base.baseId, upgradeType, error: error.message });
    }
}
async function checkActiveUpgrades(playerId, baseId) {
    try {
        // Check if base already has active upgrade
        const command = new lib_dynamodb_1.GetCommand({
            TableName: BASE_UPGRADES_TABLE,
            Key: {
                playerId,
                upgradeId: `${baseId}-active`
            }
        });
        const response = await docClient.send(command);
        if (response.Item && response.Item.status === 'in_progress') {
            throw new shared_mocks_1.GameEngineError('Base already has an active upgrade', 'UPGRADE_IN_PROGRESS', { playerId, baseId, activeUpgrade: response.Item.upgradeId });
        }
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to check active upgrades', 'ACTIVE_UPGRADE_CHECK_ERROR', { playerId, baseId, error: error.message });
    }
}
async function createUpgradeRecord(request, base, template) {
    try {
        const now = Date.now();
        const upgradeTime = template.buildTime ?? 3600; // Default 1 hour
        const completionTime = now + (upgradeTime * 1000);
        const upgrade = {
            playerId: request.playerId,
            upgradeId: `${request.baseId}-${(0, uuid_1.v4)()}`,
            baseId: request.baseId,
            upgradeType: request.upgradeType,
            fromLevel: base.level,
            toLevel: base.level + 1,
            requirements: {
                resources: template.requirements?.resources ?? {},
                time: upgradeTime,
                goldCost: request.skipTime ? calculateInstantUpgradeCost(upgradeTime) : undefined
            },
            status: 'in_progress',
            startedAt: now,
            completionTime: completionTime,
            ttl: completionTime + (7 * 24 * 60 * 60 * 1000) // Cleanup after 7 days
        };
        const command = new lib_dynamodb_1.PutCommand({
            TableName: BASE_UPGRADES_TABLE,
            Item: upgrade
        });
        await docClient.send(command);
        return upgrade;
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to create upgrade record', 'UPGRADE_RECORD_ERROR', {
            playerId: request.playerId,
            baseId: request.baseId,
            error: error.message
        });
    }
}
async function completeInstantUpgrade(upgrade, base) {
    try {
        const now = Date.now();
        // Update upgrade record to completed
        const updateUpgradeCommand = new lib_dynamodb_1.UpdateCommand({
            TableName: BASE_UPGRADES_TABLE,
            Key: {
                playerId: upgrade.playerId,
                upgradeId: upgrade.upgradeId
            },
            UpdateExpression: 'SET #status = :status, completionTime = :now',
            ExpressionAttributeNames: {
                '#status': 'status'
            },
            ExpressionAttributeValues: {
                ':status': 'completed',
                ':now': now
            }
        });
        // Update base level and stats
        const updateBaseCommand = new lib_dynamodb_1.UpdateCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: {
                playerId: base.playerId,
                baseId: base.baseId
            },
            UpdateExpression: 'SET #level = #level + :inc, lastActiveAt = :now, stats.defense = stats.defense + :defenseInc, stats.storage = stats.storage + :storageInc, stats.production = stats.production + :prodInc',
            ExpressionAttributeNames: {
                '#level': 'level'
            },
            ExpressionAttributeValues: {
                ':inc': 1,
                ':now': now,
                ':defenseInc': 10, // TODO: Get from template
                ':storageInc': 100,
                ':prodInc': 5
            }
        });
        // Execute both updates
        await Promise.all([
            docClient.send(updateUpgradeCommand),
            docClient.send(updateBaseCommand)
        ]);
        // TODO: Deduct gold cost from player resources (integrate with resource service)
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to complete instant upgrade', 'INSTANT_UPGRADE_ERROR', { upgradeId: upgrade.upgradeId, error: error.message });
    }
}
function calculateInstantUpgradeCost(upgradeTimeSeconds) {
    // Formula: 1 gold per minute of upgrade time (minimum 10 gold)
    return Math.max(10, Math.ceil(upgradeTimeSeconds / 60));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBncmFkZS1iYXNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGFtYmRhL2Jhc2UtbWFuYWdlbWVudC91cGdyYWRlLWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUFzRztBQUN0Ryx5REFLZ0M7QUFDaEMsNkJBQXdCO0FBQ3hCLCtCQUFvQztBQU1wQyxNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDNUMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQzVELE1BQU0sTUFBTSxHQUFHLElBQUksK0JBQWdCLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUUxRCxNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDO0FBQ2hFLE1BQU0sb0JBQW9CLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsSUFBSSxFQUFFLENBQUM7QUFDcEUsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLEVBQUUsQ0FBQztBQUNsRSxrQ0FBa0M7QUFFbEMsTUFBTSx3QkFBd0IsR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3hDLFFBQVEsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7SUFDbkMsTUFBTSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztJQUNqQyxXQUFXLEVBQUUsT0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxhQUFhLENBQUMsQ0FBQztJQUNqRixRQUFR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QUMxRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgR2V0Q29tbWFuZCwgVXBkYXRlQ29tbWFuZCwgUHV0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBcbiAgU3RydWN0dXJlZExvZ2dlciwgXG4gIEdhbWVFbmdpbmVFcnJvcixcbiAgd2l0aEVycm9ySGFuZGxpbmcsXG4gIHZhbGlkYXRlUmVxdWVzdCBcbn0gZnJvbSAnLi4vLi4vbGliL3NoYXJlZC1tb2Nrcyc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuaW1wb3J0IHsgXG4gIFBsYXllckJhc2UsIFxuICBCYXNlVGVtcGxhdGVcbn0gZnJvbSAnLi4vdHlwZXMvZ2FtZS1iYXNlLXR5cGVzJztcblxuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkeW5hbW9DbGllbnQpO1xuY29uc3QgbG9nZ2VyID0gbmV3IFN0cnVjdHVyZWRMb2dnZXIoJ1VwZ3JhZGVCYXNlSGFuZGxlcicpO1xuXG5jb25zdCBQTEFZRVJfQkFTRVNfVEFCTEUgPSBwcm9jZXNzLmVudi5QTEFZRVJfQkFTRVNfVEFCTEUgPz8gJyc7XG5jb25zdCBCQVNFX1RFTVBMQVRFU19UQUJMRSA9IHByb2Nlc3MuZW52LkJBU0VfVEVNUExBVEVTX1RBQkxFID8/ICcnO1xuY29uc3QgQkFTRV9VUEdSQURFU19UQUJMRSA9IHByb2Nlc3MuZW52LkJBU0VfVVBHUkFERVNfVEFCTEUgPz8gJyc7XG4vLyBFbnZpcm9ubWVudCBhdmFpbGFibGUgaWYgbmVlZGVkXG5cbmNvbnN0IFVwZ3JhZGVCYXNlUmVxdWVzdFNjaGVtYSA9IHoub2JqZWN0KHtcbiAgcGxheWVySWQ6IHouc3RyaW5nKCkubWluKDEpLm1heCg1MCksXG4gIGJhc2VJZDogei5zdHJpbmcoKS5taW4oMSkubWF4KDUwKSxcbiAgdXBncmFkZVR5cGU6IHouZW51bShbJ2xldmVsJywgJ2RlZmVuc2UnLCAnc3RvcmFnZScsICdwcm9kdWN0aW9uJywgJ3NwZWNpYWxpemVkJ10pLFxuICBza2lwVGltZTogei5ib29sZWFuKCkub3B0aW9uYWwoKS5kZWZhdWx0KGZhbHNlKSAvLyBGb3IgcHJlbWl1bSBwbGF5ZXJzXG59KTtcblxudHlwZSBVcGdyYWRlQmFzZVJlcXVlc3RJbnB1dCA9IHouaW5mZXI8dHlwZW9mIFVwZ3JhZGVCYXNlUmVxdWVzdFNjaGVtYT47XG5cbmludGVyZmFjZSBCYXNlVXBncmFkZSB7XG4gIHBsYXllcklkOiBzdHJpbmc7XG4gIHVwZ3JhZGVJZDogc3RyaW5nO1xuICBiYXNlSWQ6IHN0cmluZztcbiAgdXBncmFkZVR5cGU6IHN0cmluZztcbiAgZnJvbUxldmVsOiBudW1iZXI7XG4gIHRvTGV2ZWw6IG51bWJlcjtcbiAgcmVxdWlyZW1lbnRzOiB7XG4gICAgcmVzb3VyY2VzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+O1xuICAgIHRpbWU6IG51bWJlcjtcbiAgICBnb2xkQ29zdD86IG51bWJlcjtcbiAgfTtcbiAgc3RhdHVzOiAnaW5fcHJvZ3Jlc3MnIHwgJ2NvbXBsZXRlZCcgfCAnY2FuY2VsbGVkJztcbiAgc3RhcnRlZEF0OiBudW1iZXI7XG4gIGNvbXBsZXRpb25UaW1lOiBudW1iZXI7XG4gIHR0bD86IG51bWJlcjtcbn1cblxuLyoqXG4gKiBVcGdyYWRlIEJhc2UgSGFuZGxlclxuICogXG4gKiBJbXBsZW1lbnRzIGJhc2UgdXBncmFkZSBzeXN0ZW0gZm9sbG93aW5nIFNPTElEIHByaW5jaXBsZXM6XG4gKiAtIFNpbmdsZSBSZXNwb25zaWJpbGl0eTogT25seSBoYW5kbGVzIGJhc2UgdXBncmFkZXNcbiAqIC0gT3Blbi9DbG9zZWQ6IEV4dGVuc2libGUgZm9yIG5ldyB1cGdyYWRlIHR5cGVzXG4gKiAtIExpc2tvdiBTdWJzdGl0dXRpb246IEFsbCB1cGdyYWRlIHR5cGVzIGZvbGxvdyBzYW1lIHBhdHRlcm5cbiAqIC0gSW50ZXJmYWNlIFNlZ3JlZ2F0aW9uOiBDbGVhciB1cGdyYWRlIG9wZXJhdGlvbiBpbnRlcmZhY2VzXG4gKiAtIERlcGVuZGVuY3kgSW52ZXJzaW9uOiBEZXBlbmRzIG9uIHNoYXJlZCBhYnN0cmFjdGlvbnNcbiAqIFxuICogR2FtZSBNZWNoYW5pY3M6XG4gKiAtIFZhbGlkYXRlcyB1cGdyYWRlIHJlcXVpcmVtZW50cyAocmVzb3VyY2VzLCBsZXZlbCwgdGltZSlcbiAqIC0gU3VwcG9ydHMgaW5zdGFudCB1cGdyYWRlcyBmb3IgcHJlbWl1bSBwbGF5ZXJzIChnb2xkIGNvc3QpXG4gKiAtIFRyYWNrcyB1cGdyYWRlIHByb2dyZXNzIHdpdGggY29tcGxldGlvbiB0aW1lc1xuICogLSBVcGRhdGVzIGJhc2Ugc3RhdHMgdXBvbiBjb21wbGV0aW9uXG4gKiAtIEltcGxlbWVudHMgdXBncmFkZSBxdWV1ZSBzeXN0ZW1cbiAqL1xuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgcmV0dXJuIHdpdGhFcnJvckhhbmRsaW5nKGFzeW5jICgpID0+IHtcbiAgICBsb2dnZXIuaW5mbygnUHJvY2Vzc2luZyBiYXNlIHVwZ3JhZGUgcmVxdWVzdCcsIHsgXG4gICAgICByZXF1ZXN0SWQ6IGV2ZW50LnJlcXVlc3RDb250ZXh0Py5yZXF1ZXN0SWQgXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXF1ZXN0ID0gYXdhaXQgdmFsaWRhdGVSZXF1ZXN0PFVwZ3JhZGVCYXNlUmVxdWVzdElucHV0PihVcGdyYWRlQmFzZVJlcXVlc3RTY2hlbWEsIGV2ZW50LmJvZHkpO1xuICAgIFxuICAgIC8vIEdldCBjdXJyZW50IGJhc2Ugc3RhdGVcbiAgICBjb25zdCBjdXJyZW50QmFzZSA9IGF3YWl0IGdldFBsYXllckJhc2UocmVxdWVzdC5wbGF5ZXJJZCwgcmVxdWVzdC5iYXNlSWQpO1xuICAgIFxuICAgIC8vIFZhbGlkYXRlIHVwZ3JhZGUgaXMgcG9zc2libGVcbiAgICBjb25zdCB1cGdyYWRlVGVtcGxhdGUgPSBhd2FpdCB2YWxpZGF0ZVVwZ3JhZGVSZXF1aXJlbWVudHMoY3VycmVudEJhc2UsIHJlcXVlc3QudXBncmFkZVR5cGUpO1xuICAgIFxuICAgIC8vIENoZWNrIGZvciBleGlzdGluZyBhY3RpdmUgdXBncmFkZXNcbiAgICBhd2FpdCBjaGVja0FjdGl2ZVVwZ3JhZGVzKHJlcXVlc3QucGxheWVySWQsIHJlcXVlc3QuYmFzZUlkKTtcbiAgICBcbiAgICAvLyBDcmVhdGUgdXBncmFkZSByZWNvcmRcbiAgICBjb25zdCB1cGdyYWRlID0gYXdhaXQgY3JlYXRlVXBncmFkZVJlY29yZChyZXF1ZXN0LCBjdXJyZW50QmFzZSwgdXBncmFkZVRlbXBsYXRlKTtcbiAgICBcbiAgICAvLyBJZiBpbnN0YW50IHVwZ3JhZGUgKHNraXBUaW1lKSwgY29tcGxldGUgaW1tZWRpYXRlbHlcbiAgICBpZiAocmVxdWVzdC5za2lwVGltZSkge1xuICAgICAgYXdhaXQgY29tcGxldGVJbnN0YW50VXBncmFkZSh1cGdyYWRlLCBjdXJyZW50QmFzZSk7XG4gICAgfVxuXG4gICAgbG9nZ2VyLmluZm8oJ0Jhc2UgdXBncmFkZSBpbml0aWF0ZWQnLCB7XG4gICAgICBwbGF5ZXJJZDogcmVxdWVzdC5wbGF5ZXJJZCxcbiAgICAgIGJhc2VJZDogcmVxdWVzdC5iYXNlSWQsXG4gICAgICB1cGdyYWRlVHlwZTogcmVxdWVzdC51cGdyYWRlVHlwZSxcbiAgICAgIGluc3RhbnQ6IHJlcXVlc3Quc2tpcFRpbWVcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKidcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB1cGdyYWRlOiB1cGdyYWRlLFxuICAgICAgICAgIG1lc3NhZ2U6IHJlcXVlc3Quc2tpcFRpbWUgXG4gICAgICAgICAgICA/ICdCYXNlIHVwZ3JhZGUgY29tcGxldGVkIGluc3RhbnRseScgXG4gICAgICAgICAgICA6ICdCYXNlIHVwZ3JhZGUgc3RhcnRlZCBzdWNjZXNzZnVsbHknXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfTtcbiAgfSwgbG9nZ2VyKTtcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFBsYXllckJhc2UocGxheWVySWQ6IHN0cmluZywgYmFzZUlkOiBzdHJpbmcpOiBQcm9taXNlPFBsYXllckJhc2U+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBQTEFZRVJfQkFTRVNfVEFCTEUsXG4gICAgICBLZXk6IHsgcGxheWVySWQsIGJhc2VJZCB9XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIFxuICAgIGlmICghcmVzcG9uc2UuSXRlbSkge1xuICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgJ0Jhc2Ugbm90IGZvdW5kJyxcbiAgICAgICAgJ0JBU0VfTk9UX0ZPVU5EJyxcbiAgICAgICAgeyBwbGF5ZXJJZCwgYmFzZUlkIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgYmFzZSA9IHJlc3BvbnNlLkl0ZW0gYXMgUGxheWVyQmFzZTtcbiAgICBcbiAgICBpZiAoYmFzZS5zdGF0dXMgPT09ICdkZXN0cm95ZWQnKSB7XG4gICAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgICAnQ2Fubm90IHVwZ3JhZGUgZGVzdHJveWVkIGJhc2UnLFxuICAgICAgICAnSU5WQUxJRF9CQVNFX1NUQVRVUycsXG4gICAgICAgIHsgcGxheWVySWQsIGJhc2VJZCwgc3RhdHVzOiBiYXNlLnN0YXR1cyB9XG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBiYXNlO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEdhbWVFbmdpbmVFcnJvcikgdGhyb3cgZXJyb3I7XG4gICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICdGYWlsZWQgdG8gcmV0cmlldmUgYmFzZScsXG4gICAgICAnQkFTRV9SRVRSSUVWQUxfRVJST1InLFxuICAgICAgeyBwbGF5ZXJJZCwgYmFzZUlkLCBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIH1cbiAgICApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHZhbGlkYXRlVXBncmFkZVJlcXVpcmVtZW50cyhiYXNlOiBQbGF5ZXJCYXNlLCB1cGdyYWRlVHlwZTogc3RyaW5nKTogUHJvbWlzZTxCYXNlVGVtcGxhdGU+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBuZXh0TGV2ZWwgPSBiYXNlLmxldmVsICsgMTtcbiAgICBjb25zdCB0ZW1wbGF0ZUlkID0gYCR7YmFzZS5iYXNlVHlwZX0tbGV2ZWwtJHtuZXh0TGV2ZWx9YDtcbiAgICBcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBCQVNFX1RFTVBMQVRFU19UQUJMRSxcbiAgICAgIEtleTogeyB0ZW1wbGF0ZUlkIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgXG4gICAgaWYgKCFyZXNwb25zZS5JdGVtKSB7XG4gICAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgICBgTm8gdXBncmFkZSB0ZW1wbGF0ZSBmb3VuZCBmb3IgJHtiYXNlLmJhc2VUeXBlfSBsZXZlbCAke25leHRMZXZlbH1gLFxuICAgICAgICAnVVBHUkFERV9URU1QTEFURV9OT1RfRk9VTkQnLFxuICAgICAgICB7IGJhc2VUeXBlOiBiYXNlLmJhc2VUeXBlLCBjdXJyZW50TGV2ZWw6IGJhc2UubGV2ZWwsIG5leHRMZXZlbCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHRlbXBsYXRlID0gcmVzcG9uc2UuSXRlbSBhcyBCYXNlVGVtcGxhdGU7XG4gICAgXG4gICAgLy8gVE9ETzogVmFsaWRhdGUgcGxheWVyIGhhcyByZXF1aXJlZCByZXNvdXJjZXNcbiAgICAvLyBUaGlzIHdvdWxkIGludGVncmF0ZSB3aXRoIHJlc291cmNlIHNlcnZpY2VcbiAgICBcbiAgICByZXR1cm4gdGVtcGxhdGU7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgR2FtZUVuZ2luZUVycm9yKSB0aHJvdyBlcnJvcjtcbiAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgJ0ZhaWxlZCB0byB2YWxpZGF0ZSB1cGdyYWRlIHJlcXVpcmVtZW50cycsXG4gICAgICAnVVBHUkFERV9WQUxJREFUSU9OX0VSUk9SJyxcbiAgICAgIHsgYmFzZUlkOiBiYXNlLmJhc2VJZCwgdXBncmFkZVR5cGUsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tBY3RpdmVVcGdyYWRlcyhwbGF5ZXJJZDogc3RyaW5nLCBiYXNlSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICB0cnkge1xuICAgIC8vIENoZWNrIGlmIGJhc2UgYWxyZWFkeSBoYXMgYWN0aXZlIHVwZ3JhZGVcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBCQVNFX1VQR1JBREVTX1RBQkxFLFxuICAgICAgS2V5OiB7IFxuICAgICAgICBwbGF5ZXJJZCxcbiAgICAgICAgdXBncmFkZUlkOiBgJHtiYXNlSWR9LWFjdGl2ZWBcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgXG4gICAgaWYgKHJlc3BvbnNlLkl0ZW0gJiYgcmVzcG9uc2UuSXRlbS5zdGF0dXMgPT09ICdpbl9wcm9ncmVzcycpIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdCYXNlIGFscmVhZHkgaGFzIGFuIGFjdGl2ZSB1cGdyYWRlJyxcbiAgICAgICAgJ1VQR1JBREVfSU5fUFJPR1JFU1MnLFxuICAgICAgICB7IHBsYXllcklkLCBiYXNlSWQsIGFjdGl2ZVVwZ3JhZGU6IHJlc3BvbnNlLkl0ZW0udXBncmFkZUlkIH1cbiAgICAgICk7XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEdhbWVFbmdpbmVFcnJvcikgdGhyb3cgZXJyb3I7XG4gICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICdGYWlsZWQgdG8gY2hlY2sgYWN0aXZlIHVwZ3JhZGVzJyxcbiAgICAgICdBQ1RJVkVfVVBHUkFERV9DSEVDS19FUlJPUicsXG4gICAgICB7IHBsYXllcklkLCBiYXNlSWQsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlVXBncmFkZVJlY29yZChcbiAgcmVxdWVzdDogVXBncmFkZUJhc2VSZXF1ZXN0SW5wdXQsXG4gIGJhc2U6IFBsYXllckJhc2UsXG4gIHRlbXBsYXRlOiBCYXNlVGVtcGxhdGVcbik6IFByb21pc2U8QmFzZVVwZ3JhZGU+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IHVwZ3JhZGVUaW1lID0gdGVtcGxhdGUuYnVpbGRUaW1lID8/IDM2MDA7IC8vIERlZmF1bHQgMSBob3VyXG4gICAgY29uc3QgY29tcGxldGlvblRpbWUgPSBub3cgKyAodXBncmFkZVRpbWUgKiAxMDAwKTtcbiAgICBcbiAgICBjb25zdCB1cGdyYWRlOiBCYXNlVXBncmFkZSA9IHtcbiAgICAgIHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLFxuICAgICAgdXBncmFkZUlkOiBgJHtyZXF1ZXN0LmJhc2VJZH0tJHt1dWlkdjQoKX1gLFxuICAgICAgYmFzZUlkOiByZXF1ZXN0LmJhc2VJZCxcbiAgICAgIHVwZ3JhZGVUeXBlOiByZXF1ZXN0LnVwZ3JhZGVUeXBlLFxuICAgICAgZnJvbUxldmVsOiBiYXNlLmxldmVsLFxuICAgICAgdG9MZXZlbDogYmFzZS5sZXZlbCArIDEsXG4gICAgICByZXF1aXJlbWVudHM6IHtcbiAgICAgICAgcmVzb3VyY2VzOiB0ZW1wbGF0ZS5yZXF1aXJlbWVudHM/LnJlc291cmNlcyA/PyB7fSxcbiAgICAgICAgdGltZTogdXBncmFkZVRpbWUsXG4gICAgICAgIGdvbGRDb3N0OiByZXF1ZXN0LnNraXBUaW1lID8gY2FsY3VsYXRlSW5zdGFudFVwZ3JhZGVDb3N0KHVwZ3JhZGVUaW1lKSA6IHVuZGVmaW5lZFxuICAgICAgfSxcbiAgICAgIHN0YXR1czogJ2luX3Byb2dyZXNzJyxcbiAgICAgIHN0YXJ0ZWRBdDogbm93LFxuICAgICAgY29tcGxldGlvblRpbWU6IGNvbXBsZXRpb25UaW1lLFxuICAgICAgdHRsOiBjb21wbGV0aW9uVGltZSArICg3ICogMjQgKiA2MCAqIDYwICogMTAwMCkgLy8gQ2xlYW51cCBhZnRlciA3IGRheXNcbiAgICB9O1xuXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBQdXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogQkFTRV9VUEdSQURFU19UQUJMRSxcbiAgICAgIEl0ZW06IHVwZ3JhZGVcbiAgICB9KTtcblxuICAgIGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIHJldHVybiB1cGdyYWRlO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIGNyZWF0ZSB1cGdyYWRlIHJlY29yZCcsXG4gICAgICAnVVBHUkFERV9SRUNPUkRfRVJST1InLFxuICAgICAgeyBcbiAgICAgICAgcGxheWVySWQ6IHJlcXVlc3QucGxheWVySWQsIFxuICAgICAgICBiYXNlSWQ6IHJlcXVlc3QuYmFzZUlkLCBcbiAgICAgICAgZXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSBcbiAgICAgIH1cbiAgICApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbXBsZXRlSW5zdGFudFVwZ3JhZGUodXBncmFkZTogQmFzZVVwZ3JhZGUsIGJhc2U6IFBsYXllckJhc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIC8vIFVwZGF0ZSB1cGdyYWRlIHJlY29yZCB0byBjb21wbGV0ZWRcbiAgICBjb25zdCB1cGRhdGVVcGdyYWRlQ29tbWFuZCA9IG5ldyBVcGRhdGVDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogQkFTRV9VUEdSQURFU19UQUJMRSxcbiAgICAgIEtleToge1xuICAgICAgICBwbGF5ZXJJZDogdXBncmFkZS5wbGF5ZXJJZCxcbiAgICAgICAgdXBncmFkZUlkOiB1cGdyYWRlLnVwZ3JhZGVJZFxuICAgICAgfSxcbiAgICAgIFVwZGF0ZUV4cHJlc3Npb246ICdTRVQgI3N0YXR1cyA9IDpzdGF0dXMsIGNvbXBsZXRpb25UaW1lID0gOm5vdycsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgJyNzdGF0dXMnOiAnc3RhdHVzJ1xuICAgICAgfSxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpzdGF0dXMnOiAnY29tcGxldGVkJyxcbiAgICAgICAgJzpub3cnOiBub3dcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIFVwZGF0ZSBiYXNlIGxldmVsIGFuZCBzdGF0c1xuICAgIGNvbnN0IHVwZGF0ZUJhc2VDb21tYW5kID0gbmV3IFVwZGF0ZUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBQTEFZRVJfQkFTRVNfVEFCTEUsXG4gICAgICBLZXk6IHtcbiAgICAgICAgcGxheWVySWQ6IGJhc2UucGxheWVySWQsXG4gICAgICAgIGJhc2VJZDogYmFzZS5iYXNlSWRcbiAgICAgIH0sXG4gICAgICBVcGRhdGVFeHByZXNzaW9uOiAnU0VUICNsZXZlbCA9ICNsZXZlbCArIDppbmMsIGxhc3RBY3RpdmVBdCA9IDpub3csIHN0YXRzLmRlZmVuc2UgPSBzdGF0cy5kZWZlbnNlICsgOmRlZmVuc2VJbmMsIHN0YXRzLnN0b3JhZ2UgPSBzdGF0cy5zdG9yYWdlICsgOnN0b3JhZ2VJbmMsIHN0YXRzLnByb2R1Y3Rpb24gPSBzdGF0cy5wcm9kdWN0aW9uICsgOnByb2RJbmMnLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICcjbGV2ZWwnOiAnbGV2ZWwnXG4gICAgICB9LFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOmluYyc6IDEsXG4gICAgICAgICc6bm93Jzogbm93LFxuICAgICAgICAnOmRlZmVuc2VJbmMnOiAxMCwgLy8gVE9ETzogR2V0IGZyb20gdGVtcGxhdGVcbiAgICAgICAgJzpzdG9yYWdlSW5jJzogMTAwLFxuICAgICAgICAnOnByb2RJbmMnOiA1XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBFeGVjdXRlIGJvdGggdXBkYXRlc1xuICAgIGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIGRvY0NsaWVudC5zZW5kKHVwZGF0ZVVwZ3JhZGVDb21tYW5kKSxcbiAgICAgIGRvY0NsaWVudC5zZW5kKHVwZGF0ZUJhc2VDb21tYW5kKVxuICAgIF0pO1xuXG4gICAgLy8gVE9ETzogRGVkdWN0IGdvbGQgY29zdCBmcm9tIHBsYXllciByZXNvdXJjZXMgKGludGVncmF0ZSB3aXRoIHJlc291cmNlIHNlcnZpY2UpXG4gICAgXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICdGYWlsZWQgdG8gY29tcGxldGUgaW5zdGFudCB1cGdyYWRlJyxcbiAgICAgICdJTlNUQU5UX1VQR1JBREVfRVJST1InLFxuICAgICAgeyB1cGdyYWRlSWQ6IHVwZ3JhZGUudXBncmFkZUlkLCBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIH1cbiAgICApO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUluc3RhbnRVcGdyYWRlQ29zdCh1cGdyYWRlVGltZVNlY29uZHM6IG51bWJlcik6IG51bWJlciB7XG4gIC8vIEZvcm11bGE6IDEgZ29sZCBwZXIgbWludXRlIG9mIHVwZ3JhZGUgdGltZSAobWluaW11bSAxMCBnb2xkKVxuICByZXR1cm4gTWF0aC5tYXgoMTAsIE1hdGguY2VpbCh1cGdyYWRlVGltZVNlY29uZHMgLyA2MCkpO1xufSJdfQ==