"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const shared_mocks_1 = require("../../lib/shared-mocks");
const zod_1 = require("zod");
const uuid_1 = require("uuid");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const logger = new shared_mocks_1.StructuredLogger('UpgradeBaseHandler');
const PLAYER_BASES_TABLE = process.env.PLAYER_BASES_TABLE ?? '';
const BASE_TEMPLATES_TABLE = process.env.BASE_TEMPLATES_TABLE ?? '';
const BASE_UPGRADES_TABLE = process.env.BASE_UPGRADES_TABLE ?? '';
// Environment available if needed
const UpgradeBaseRequestSchema = zod_1.z.object({
    playerId: zod_1.z.string().min(1).max(50),
    baseId: zod_1.z.string().min(1).max(50),
    upgradeType: zod_1.z.enum(['level', 'defense', 'storage', 'production', 'specialized']),
    skipTime: zod_1.z.boolean().optional().default(false) // For premium players
});
/**
 * Upgrade Base Handler
 *
 * Implements base upgrade system following SOLID principles:
 * - Single Responsibility: Only handles base upgrades
 * - Open/Closed: Extensible for new upgrade types
 * - Liskov Substitution: All upgrade types follow same pattern
 * - Interface Segregation: Clear upgrade operation interfaces
 * - Dependency Inversion: Depends on shared abstractions
 *
 * Game Mechanics:
 * - Validates upgrade requirements (resources, level, time)
 * - Supports instant upgrades for premium players (gold cost)
 * - Tracks upgrade progress with completion times
 * - Updates base stats upon completion
 * - Implements upgrade queue system
 */
const handler = async (event) => {
    return (0, shared_mocks_1.withErrorHandling)(async () => {
        logger.info('Processing base upgrade request', {
            requestId: event.requestContext?.requestId
        });
        const request = await (0, shared_mocks_1.validateRequest)(UpgradeBaseRequestSchema, event.body);
        // Get current base state
        const currentBase = await getPlayerBase(request.playerId, request.baseId);
        // Validate upgrade is possible
        const upgradeTemplate = await validateUpgradeRequirements(currentBase, request.upgradeType);
        // Check for existing active upgrades
        await checkActiveUpgrades(request.playerId, request.baseId);
        // Create upgrade record
        const upgrade = await createUpgradeRecord(request, currentBase, upgradeTemplate);
        // If instant upgrade (skipTime), complete immediately
        if (request.skipTime) {
            await completeInstantUpgrade(upgrade, currentBase);
        }
        logger.info('Base upgrade initiated', {
            playerId: request.playerId,
            baseId: request.baseId,
            upgradeType: request.upgradeType,
            instant: request.skipTime
        });
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                success: true,
                data: {
                    upgrade: upgrade,
                    message: request.skipTime
                        ? 'Base upgrade completed instantly'
                        : 'Base upgrade started successfully'
                }
            })
        };
    }, logger);
};
exports.handler = handler;
async function getPlayerBase(playerId, baseId) {
    try {
        const command = new lib_dynamodb_1.GetCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: { playerId, baseId }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError('Base not found', 'BASE_NOT_FOUND', { playerId, baseId });
        }
        const base = response.Item;
        if (base.status === 'destroyed') {
            throw new shared_mocks_1.GameEngineError('Cannot upgrade destroyed base', 'INVALID_BASE_STATUS', { playerId, baseId, status: base.status });
        }
        return base;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to retrieve base', 'BASE_RETRIEVAL_ERROR', { playerId, baseId, error: error.message });
    }
}
async function validateUpgradeRequirements(base, upgradeType) {
    try {
        const nextLevel = base.level + 1;
        const templateId = `${base.baseType}-level-${nextLevel}`;
        const command = new lib_dynamodb_1.GetCommand({
            TableName: BASE_TEMPLATES_TABLE,
            Key: { templateId }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError(`No upgrade template found for ${base.baseType} level ${nextLevel}`, 'UPGRADE_TEMPLATE_NOT_FOUND', { baseType: base.baseType, currentLevel: base.level, nextLevel });
        }
        const template = response.Item;
        // TODO: Validate player has required resources
        // This would integrate with resource service
        return template;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to validate upgrade requirements', 'UPGRADE_VALIDATION_ERROR', { baseId: base.baseId, upgradeType, error: error.message });
    }
}
async function checkActiveUpgrades(playerId, baseId) {
    try {
        // Check if base already has active upgrade
        const command = new lib_dynamodb_1.GetCommand({
            TableName: BASE_UPGRADES_TABLE,
            Key: {
                playerId,
                upgradeId: `${baseId}-active`
            }
        });
        const response = await docClient.send(command);
        if (response.Item && response.Item.status === 'in_progress') {
            throw new shared_mocks_1.GameEngineError('Base already has an active upgrade', 'UPGRADE_IN_PROGRESS', { playerId, baseId, activeUpgrade: response.Item.upgradeId });
        }
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to check active upgrades', 'ACTIVE_UPGRADE_CHECK_ERROR', { playerId, baseId, error: error.message });
    }
}
async function createUpgradeRecord(request, base, template) {
    try {
        const now = Date.now();
        const upgradeTime = template.buildTime ?? 3600; // Default 1 hour
        const completionTime = now + (upgradeTime * 1000);
        const upgrade = {
            playerId: request.playerId,
            upgradeId: `${request.baseId}-${(0, uuid_1.v4)()}`,
            baseId: request.baseId,
            upgradeType: request.upgradeType,
            fromLevel: base.level,
            toLevel: base.level + 1,
            requirements: {
                resources: template.requirements?.resources ?? {},
                time: upgradeTime,
                goldCost: request.skipTime ? calculateInstantUpgradeCost(upgradeTime) : undefined
            },
            status: 'in_progress',
            startedAt: now,
            completionTime: completionTime,
            ttl: completionTime + (7 * 24 * 60 * 60 * 1000) // Cleanup after 7 days
        };
        const command = new lib_dynamodb_1.PutCommand({
            TableName: BASE_UPGRADES_TABLE,
            Item: upgrade
        });
        await docClient.send(command);
        return upgrade;
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to create upgrade record', 'UPGRADE_RECORD_ERROR', {
            playerId: request.playerId,
            baseId: request.baseId,
            error: error.message
        });
    }
}
async function completeInstantUpgrade(upgrade, base) {
    try {
        const now = Date.now();
        // Update upgrade record to completed
        const updateUpgradeCommand = new lib_dynamodb_1.UpdateCommand({
            TableName: BASE_UPGRADES_TABLE,
            Key: {
                playerId: upgrade.playerId,
                upgradeId: upgrade.upgradeId
            },
            UpdateExpression: 'SET #status = :status, completionTime = :now',
            ExpressionAttributeNames: {
                '#status': 'status'
            },
            ExpressionAttributeValues: {
                ':status': 'completed',
                ':now': now
            }
        });
        // Update base level and stats
        const updateBaseCommand = new lib_dynamodb_1.UpdateCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: {
                playerId: base.playerId,
                baseId: base.baseId
            },
            UpdateExpression: 'SET #level = #level + :inc, lastActiveAt = :now, stats.defense = stats.defense + :defenseInc, stats.storage = stats.storage + :storageInc, stats.production = stats.production + :prodInc',
            ExpressionAttributeNames: {
                '#level': 'level'
            },
            ExpressionAttributeValues: {
                ':inc': 1,
                ':now': now,
                ':defenseInc': 10, // TODO: Get from template
                ':storageInc': 100,
                ':prodInc': 5
            }
        });
        // Execute both updates
        await Promise.all([
            docClient.send(updateUpgradeCommand),
            docClient.send(updateBaseCommand)
        ]);
        // TODO: Deduct gold cost from player resources (integrate with resource service)
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to complete instant upgrade', 'INSTANT_UPGRADE_ERROR', { upgradeId: upgrade.upgradeId, error: error.message });
    }
}
function calculateInstantUpgradeCost(upgradeTimeSeconds) {
    // Formula: 1 gold per minute of upgrade time (minimum 10 gold)
    return Math.max(10, Math.ceil(upgradeTimeSeconds / 60));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBncmFkZS1iYXNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGFtYmRhL2Jhc2UtbWFuYWdlbWVudC91cGdyYWRlLWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUFzRztBQUN0Ryx5REFLZ0M7QUFDaEMsNkJBQXdCO0FBQ3hCLCtCQUFvQztBQVFwQyxNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDNUMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQzVELE1BQU0sTUFBTSxHQUFHLElBQUksK0JBQWdCLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUUxRCxNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDO0FBQ2hFLE1BQU0sb0JBQW9CLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsSUFBSSxFQUFFLENBQUM7QUFDcEUsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLEVBQUUsQ0FBQztBQUNsRSxrQ0FBa0M7QUFFbEMsTUFBTSx3QkFBd0IsR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3hDLFFBQVEsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7SUFDbkMsTUFBTSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztJQUNqQyxXQUFXLEVBQUUsT0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxhQUFhLENBQUMsQ0FBQztJQUNqRixRQUFR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QUMxRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgR2V0Q29tbWFuZCwgVXBkYXRlQ29tbWFuZCwgUHV0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBcbiAgU3RydWN0dXJlZExvZ2dlciwgXG4gIEdhbWVFbmdpbmVFcnJvcixcbiAgd2l0aEVycm9ySGFuZGxpbmcsXG4gIHZhbGlkYXRlUmVxdWVzdCBcbn0gZnJvbSAnLi4vLi4vbGliL3NoYXJlZC1tb2Nrcyc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuaW1wb3J0IHsgXG4gIFBsYXllckJhc2UsIFxuICBCYXNlVGVtcGxhdGUsIFxuICBCYXNlVXBncmFkZVRlbXBsYXRlLFxuICBVcGdyYWRlQmFzZVJlcXVlc3QgXG59IGZyb20gJy4uL3R5cGVzL2dhbWUtYmFzZS10eXBlcyc7XG5cbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vQ2xpZW50KTtcbmNvbnN0IGxvZ2dlciA9IG5ldyBTdHJ1Y3R1cmVkTG9nZ2VyKCdVcGdyYWRlQmFzZUhhbmRsZXInKTtcblxuY29uc3QgUExBWUVSX0JBU0VTX1RBQkxFID0gcHJvY2Vzcy5lbnYuUExBWUVSX0JBU0VTX1RBQkxFID8/ICcnO1xuY29uc3QgQkFTRV9URU1QTEFURVNfVEFCTEUgPSBwcm9jZXNzLmVudi5CQVNFX1RFTVBMQVRFU19UQUJMRSA/PyAnJztcbmNvbnN0IEJBU0VfVVBHUkFERVNfVEFCTEUgPSBwcm9jZXNzLmVudi5CQVNFX1VQR1JBREVTX1RBQkxFID8/ICcnO1xuLy8gRW52aXJvbm1lbnQgYXZhaWxhYmxlIGlmIG5lZWRlZFxuXG5jb25zdCBVcGdyYWRlQmFzZVJlcXVlc3RTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIHBsYXllcklkOiB6LnN0cmluZygpLm1pbigxKS5tYXgoNTApLFxuICBiYXNlSWQ6IHouc3RyaW5nKCkubWluKDEpLm1heCg1MCksXG4gIHVwZ3JhZGVUeXBlOiB6LmVudW0oWydsZXZlbCcsICdkZWZlbnNlJywgJ3N0b3JhZ2UnLCAncHJvZHVjdGlvbicsICdzcGVjaWFsaXplZCddKSxcbiAgc2tpcFRpbWU6IHouYm9vbGVhbigpLm9wdGlvbmFsKCkuZGVmYXVsdChmYWxzZSkgLy8gRm9yIHByZW1pdW0gcGxheWVyc1xufSk7XG5cbnR5cGUgVXBncmFkZUJhc2VSZXF1ZXN0SW5wdXQgPSB6LmluZmVyPHR5cGVvZiBVcGdyYWRlQmFzZVJlcXVlc3RTY2hlbWE+O1xuXG5pbnRlcmZhY2UgQmFzZVVwZ3JhZGUge1xuICBwbGF5ZXJJZDogc3RyaW5nO1xuICB1cGdyYWRlSWQ6IHN0cmluZztcbiAgYmFzZUlkOiBzdHJpbmc7XG4gIHVwZ3JhZGVUeXBlOiBzdHJpbmc7XG4gIGZyb21MZXZlbDogbnVtYmVyO1xuICB0b0xldmVsOiBudW1iZXI7XG4gIHJlcXVpcmVtZW50czoge1xuICAgIHJlc291cmNlczogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcbiAgICB0aW1lOiBudW1iZXI7XG4gICAgZ29sZENvc3Q/OiBudW1iZXI7XG4gIH07XG4gIHN0YXR1czogJ2luX3Byb2dyZXNzJyB8ICdjb21wbGV0ZWQnIHwgJ2NhbmNlbGxlZCc7XG4gIHN0YXJ0ZWRBdDogbnVtYmVyO1xuICBjb21wbGV0aW9uVGltZTogbnVtYmVyO1xuICB0dGw/OiBudW1iZXI7XG59XG5cbi8qKlxuICogVXBncmFkZSBCYXNlIEhhbmRsZXJcbiAqIFxuICogSW1wbGVtZW50cyBiYXNlIHVwZ3JhZGUgc3lzdGVtIGZvbGxvd2luZyBTT0xJRCBwcmluY2lwbGVzOlxuICogLSBTaW5nbGUgUmVzcG9uc2liaWxpdHk6IE9ubHkgaGFuZGxlcyBiYXNlIHVwZ3JhZGVzXG4gKiAtIE9wZW4vQ2xvc2VkOiBFeHRlbnNpYmxlIGZvciBuZXcgdXBncmFkZSB0eXBlc1xuICogLSBMaXNrb3YgU3Vic3RpdHV0aW9uOiBBbGwgdXBncmFkZSB0eXBlcyBmb2xsb3cgc2FtZSBwYXR0ZXJuXG4gKiAtIEludGVyZmFjZSBTZWdyZWdhdGlvbjogQ2xlYXIgdXBncmFkZSBvcGVyYXRpb24gaW50ZXJmYWNlc1xuICogLSBEZXBlbmRlbmN5IEludmVyc2lvbjogRGVwZW5kcyBvbiBzaGFyZWQgYWJzdHJhY3Rpb25zXG4gKiBcbiAqIEdhbWUgTWVjaGFuaWNzOlxuICogLSBWYWxpZGF0ZXMgdXBncmFkZSByZXF1aXJlbWVudHMgKHJlc291cmNlcywgbGV2ZWwsIHRpbWUpXG4gKiAtIFN1cHBvcnRzIGluc3RhbnQgdXBncmFkZXMgZm9yIHByZW1pdW0gcGxheWVycyAoZ29sZCBjb3N0KVxuICogLSBUcmFja3MgdXBncmFkZSBwcm9ncmVzcyB3aXRoIGNvbXBsZXRpb24gdGltZXNcbiAqIC0gVXBkYXRlcyBiYXNlIHN0YXRzIHVwb24gY29tcGxldGlvblxuICogLSBJbXBsZW1lbnRzIHVwZ3JhZGUgcXVldWUgc3lzdGVtXG4gKi9cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIHJldHVybiB3aXRoRXJyb3JIYW5kbGluZyhhc3luYyAoKSA9PiB7XG4gICAgbG9nZ2VyLmluZm8oJ1Byb2Nlc3NpbmcgYmFzZSB1cGdyYWRlIHJlcXVlc3QnLCB7IFxuICAgICAgcmVxdWVzdElkOiBldmVudC5yZXF1ZXN0Q29udGV4dD8ucmVxdWVzdElkIFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVxdWVzdCA9IGF3YWl0IHZhbGlkYXRlUmVxdWVzdDxVcGdyYWRlQmFzZVJlcXVlc3RJbnB1dD4oVXBncmFkZUJhc2VSZXF1ZXN0U2NoZW1hLCBldmVudC5ib2R5KTtcbiAgICBcbiAgICAvLyBHZXQgY3VycmVudCBiYXNlIHN0YXRlXG4gICAgY29uc3QgY3VycmVudEJhc2UgPSBhd2FpdCBnZXRQbGF5ZXJCYXNlKHJlcXVlc3QucGxheWVySWQsIHJlcXVlc3QuYmFzZUlkKTtcbiAgICBcbiAgICAvLyBWYWxpZGF0ZSB1cGdyYWRlIGlzIHBvc3NpYmxlXG4gICAgY29uc3QgdXBncmFkZVRlbXBsYXRlID0gYXdhaXQgdmFsaWRhdGVVcGdyYWRlUmVxdWlyZW1lbnRzKGN1cnJlbnRCYXNlLCByZXF1ZXN0LnVwZ3JhZGVUeXBlKTtcbiAgICBcbiAgICAvLyBDaGVjayBmb3IgZXhpc3RpbmcgYWN0aXZlIHVwZ3JhZGVzXG4gICAgYXdhaXQgY2hlY2tBY3RpdmVVcGdyYWRlcyhyZXF1ZXN0LnBsYXllcklkLCByZXF1ZXN0LmJhc2VJZCk7XG4gICAgXG4gICAgLy8gQ3JlYXRlIHVwZ3JhZGUgcmVjb3JkXG4gICAgY29uc3QgdXBncmFkZSA9IGF3YWl0IGNyZWF0ZVVwZ3JhZGVSZWNvcmQocmVxdWVzdCwgY3VycmVudEJhc2UsIHVwZ3JhZGVUZW1wbGF0ZSk7XG4gICAgXG4gICAgLy8gSWYgaW5zdGFudCB1cGdyYWRlIChza2lwVGltZSksIGNvbXBsZXRlIGltbWVkaWF0ZWx5XG4gICAgaWYgKHJlcXVlc3Quc2tpcFRpbWUpIHtcbiAgICAgIGF3YWl0IGNvbXBsZXRlSW5zdGFudFVwZ3JhZGUodXBncmFkZSwgY3VycmVudEJhc2UpO1xuICAgIH1cblxuICAgIGxvZ2dlci5pbmZvKCdCYXNlIHVwZ3JhZGUgaW5pdGlhdGVkJywge1xuICAgICAgcGxheWVySWQ6IHJlcXVlc3QucGxheWVySWQsXG4gICAgICBiYXNlSWQ6IHJlcXVlc3QuYmFzZUlkLFxuICAgICAgdXBncmFkZVR5cGU6IHJlcXVlc3QudXBncmFkZVR5cGUsXG4gICAgICBpbnN0YW50OiByZXF1ZXN0LnNraXBUaW1lXG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonXG4gICAgICB9LFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdXBncmFkZTogdXBncmFkZSxcbiAgICAgICAgICBtZXNzYWdlOiByZXF1ZXN0LnNraXBUaW1lIFxuICAgICAgICAgICAgPyAnQmFzZSB1cGdyYWRlIGNvbXBsZXRlZCBpbnN0YW50bHknIFxuICAgICAgICAgICAgOiAnQmFzZSB1cGdyYWRlIHN0YXJ0ZWQgc3VjY2Vzc2Z1bGx5J1xuICAgICAgICB9XG4gICAgICB9KVxuICAgIH07XG4gIH0sIGxvZ2dlcik7XG59O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRQbGF5ZXJCYXNlKHBsYXllcklkOiBzdHJpbmcsIGJhc2VJZDogc3RyaW5nKTogUHJvbWlzZTxQbGF5ZXJCYXNlPiB7XG4gIHRyeSB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogUExBWUVSX0JBU0VTX1RBQkxFLFxuICAgICAgS2V5OiB7IHBsYXllcklkLCBiYXNlSWQgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBcbiAgICBpZiAoIXJlc3BvbnNlLkl0ZW0pIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdCYXNlIG5vdCBmb3VuZCcsXG4gICAgICAgICdCQVNFX05PVF9GT1VORCcsXG4gICAgICAgIHsgcGxheWVySWQsIGJhc2VJZCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IGJhc2UgPSByZXNwb25zZS5JdGVtIGFzIFBsYXllckJhc2U7XG4gICAgXG4gICAgaWYgKGJhc2Uuc3RhdHVzID09PSAnZGVzdHJveWVkJykge1xuICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgJ0Nhbm5vdCB1cGdyYWRlIGRlc3Ryb3llZCBiYXNlJyxcbiAgICAgICAgJ0lOVkFMSURfQkFTRV9TVEFUVVMnLFxuICAgICAgICB7IHBsYXllcklkLCBiYXNlSWQsIHN0YXR1czogYmFzZS5zdGF0dXMgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYmFzZTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBHYW1lRW5naW5lRXJyb3IpIHRocm93IGVycm9yO1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIHJldHJpZXZlIGJhc2UnLFxuICAgICAgJ0JBU0VfUkVUUklFVkFMX0VSUk9SJyxcbiAgICAgIHsgcGxheWVySWQsIGJhc2VJZCwgZXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSB9XG4gICAgKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB2YWxpZGF0ZVVwZ3JhZGVSZXF1aXJlbWVudHMoYmFzZTogUGxheWVyQmFzZSwgdXBncmFkZVR5cGU6IHN0cmluZyk6IFByb21pc2U8QmFzZVRlbXBsYXRlPiB7XG4gIHRyeSB7XG4gICAgY29uc3QgbmV4dExldmVsID0gYmFzZS5sZXZlbCArIDE7XG4gICAgY29uc3QgdGVtcGxhdGVJZCA9IGAke2Jhc2UuYmFzZVR5cGV9LWxldmVsLSR7bmV4dExldmVsfWA7XG4gICAgXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogQkFTRV9URU1QTEFURVNfVEFCTEUsXG4gICAgICBLZXk6IHsgdGVtcGxhdGVJZCB9XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIFxuICAgIGlmICghcmVzcG9uc2UuSXRlbSkge1xuICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgYE5vIHVwZ3JhZGUgdGVtcGxhdGUgZm91bmQgZm9yICR7YmFzZS5iYXNlVHlwZX0gbGV2ZWwgJHtuZXh0TGV2ZWx9YCxcbiAgICAgICAgJ1VQR1JBREVfVEVNUExBVEVfTk9UX0ZPVU5EJyxcbiAgICAgICAgeyBiYXNlVHlwZTogYmFzZS5iYXNlVHlwZSwgY3VycmVudExldmVsOiBiYXNlLmxldmVsLCBuZXh0TGV2ZWwgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCB0ZW1wbGF0ZSA9IHJlc3BvbnNlLkl0ZW0gYXMgQmFzZVRlbXBsYXRlO1xuICAgIFxuICAgIC8vIFRPRE86IFZhbGlkYXRlIHBsYXllciBoYXMgcmVxdWlyZWQgcmVzb3VyY2VzXG4gICAgLy8gVGhpcyB3b3VsZCBpbnRlZ3JhdGUgd2l0aCByZXNvdXJjZSBzZXJ2aWNlXG4gICAgXG4gICAgcmV0dXJuIHRlbXBsYXRlO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEdhbWVFbmdpbmVFcnJvcikgdGhyb3cgZXJyb3I7XG4gICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICdGYWlsZWQgdG8gdmFsaWRhdGUgdXBncmFkZSByZXF1aXJlbWVudHMnLFxuICAgICAgJ1VQR1JBREVfVkFMSURBVElPTl9FUlJPUicsXG4gICAgICB7IGJhc2VJZDogYmFzZS5iYXNlSWQsIHVwZ3JhZGVUeXBlLCBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIH1cbiAgICApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrQWN0aXZlVXBncmFkZXMocGxheWVySWQ6IHN0cmluZywgYmFzZUlkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgdHJ5IHtcbiAgICAvLyBDaGVjayBpZiBiYXNlIGFscmVhZHkgaGFzIGFjdGl2ZSB1cGdyYWRlXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogQkFTRV9VUEdSQURFU19UQUJMRSxcbiAgICAgIEtleTogeyBcbiAgICAgICAgcGxheWVySWQsXG4gICAgICAgIHVwZ3JhZGVJZDogYCR7YmFzZUlkfS1hY3RpdmVgXG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIFxuICAgIGlmIChyZXNwb25zZS5JdGVtICYmIHJlc3BvbnNlLkl0ZW0uc3RhdHVzID09PSAnaW5fcHJvZ3Jlc3MnKSB7XG4gICAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgICAnQmFzZSBhbHJlYWR5IGhhcyBhbiBhY3RpdmUgdXBncmFkZScsXG4gICAgICAgICdVUEdSQURFX0lOX1BST0dSRVNTJyxcbiAgICAgICAgeyBwbGF5ZXJJZCwgYmFzZUlkLCBhY3RpdmVVcGdyYWRlOiByZXNwb25zZS5JdGVtLnVwZ3JhZGVJZCB9XG4gICAgICApO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBHYW1lRW5naW5lRXJyb3IpIHRocm93IGVycm9yO1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIGNoZWNrIGFjdGl2ZSB1cGdyYWRlcycsXG4gICAgICAnQUNUSVZFX1VQR1JBREVfQ0hFQ0tfRVJST1InLFxuICAgICAgeyBwbGF5ZXJJZCwgYmFzZUlkLCBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIH1cbiAgICApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVVwZ3JhZGVSZWNvcmQoXG4gIHJlcXVlc3Q6IFVwZ3JhZGVCYXNlUmVxdWVzdElucHV0LFxuICBiYXNlOiBQbGF5ZXJCYXNlLFxuICB0ZW1wbGF0ZTogQmFzZVRlbXBsYXRlXG4pOiBQcm9taXNlPEJhc2VVcGdyYWRlPiB7XG4gIHRyeSB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCB1cGdyYWRlVGltZSA9IHRlbXBsYXRlLmJ1aWxkVGltZSA/PyAzNjAwOyAvLyBEZWZhdWx0IDEgaG91clxuICAgIGNvbnN0IGNvbXBsZXRpb25UaW1lID0gbm93ICsgKHVwZ3JhZGVUaW1lICogMTAwMCk7XG4gICAgXG4gICAgY29uc3QgdXBncmFkZTogQmFzZVVwZ3JhZGUgPSB7XG4gICAgICBwbGF5ZXJJZDogcmVxdWVzdC5wbGF5ZXJJZCxcbiAgICAgIHVwZ3JhZGVJZDogYCR7cmVxdWVzdC5iYXNlSWR9LSR7dXVpZHY0KCl9YCxcbiAgICAgIGJhc2VJZDogcmVxdWVzdC5iYXNlSWQsXG4gICAgICB1cGdyYWRlVHlwZTogcmVxdWVzdC51cGdyYWRlVHlwZSxcbiAgICAgIGZyb21MZXZlbDogYmFzZS5sZXZlbCxcbiAgICAgIHRvTGV2ZWw6IGJhc2UubGV2ZWwgKyAxLFxuICAgICAgcmVxdWlyZW1lbnRzOiB7XG4gICAgICAgIHJlc291cmNlczogdGVtcGxhdGUucmVxdWlyZW1lbnRzPy5yZXNvdXJjZXMgPz8ge30sXG4gICAgICAgIHRpbWU6IHVwZ3JhZGVUaW1lLFxuICAgICAgICBnb2xkQ29zdDogcmVxdWVzdC5za2lwVGltZSA/IGNhbGN1bGF0ZUluc3RhbnRVcGdyYWRlQ29zdCh1cGdyYWRlVGltZSkgOiB1bmRlZmluZWRcbiAgICAgIH0sXG4gICAgICBzdGF0dXM6ICdpbl9wcm9ncmVzcycsXG4gICAgICBzdGFydGVkQXQ6IG5vdyxcbiAgICAgIGNvbXBsZXRpb25UaW1lOiBjb21wbGV0aW9uVGltZSxcbiAgICAgIHR0bDogY29tcGxldGlvblRpbWUgKyAoNyAqIDI0ICogNjAgKiA2MCAqIDEwMDApIC8vIENsZWFudXAgYWZ0ZXIgNyBkYXlzXG4gICAgfTtcblxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUHV0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IEJBU0VfVVBHUkFERVNfVEFCTEUsXG4gICAgICBJdGVtOiB1cGdyYWRlXG4gICAgfSk7XG5cbiAgICBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICByZXR1cm4gdXBncmFkZTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgJ0ZhaWxlZCB0byBjcmVhdGUgdXBncmFkZSByZWNvcmQnLFxuICAgICAgJ1VQR1JBREVfUkVDT1JEX0VSUk9SJyxcbiAgICAgIHsgXG4gICAgICAgIHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLCBcbiAgICAgICAgYmFzZUlkOiByZXF1ZXN0LmJhc2VJZCwgXG4gICAgICAgIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgXG4gICAgICB9XG4gICAgKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBjb21wbGV0ZUluc3RhbnRVcGdyYWRlKHVwZ3JhZGU6IEJhc2VVcGdyYWRlLCBiYXNlOiBQbGF5ZXJCYXNlKTogUHJvbWlzZTx2b2lkPiB7XG4gIHRyeSB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICAvLyBVcGRhdGUgdXBncmFkZSByZWNvcmQgdG8gY29tcGxldGVkXG4gICAgY29uc3QgdXBkYXRlVXBncmFkZUNvbW1hbmQgPSBuZXcgVXBkYXRlQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IEJBU0VfVVBHUkFERVNfVEFCTEUsXG4gICAgICBLZXk6IHtcbiAgICAgICAgcGxheWVySWQ6IHVwZ3JhZGUucGxheWVySWQsXG4gICAgICAgIHVwZ3JhZGVJZDogdXBncmFkZS51cGdyYWRlSWRcbiAgICAgIH0sXG4gICAgICBVcGRhdGVFeHByZXNzaW9uOiAnU0VUICNzdGF0dXMgPSA6c3RhdHVzLCBjb21wbGV0aW9uVGltZSA9IDpub3cnLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICcjc3RhdHVzJzogJ3N0YXR1cydcbiAgICAgIH0sXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6c3RhdHVzJzogJ2NvbXBsZXRlZCcsXG4gICAgICAgICc6bm93Jzogbm93XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBVcGRhdGUgYmFzZSBsZXZlbCBhbmQgc3RhdHNcbiAgICBjb25zdCB1cGRhdGVCYXNlQ29tbWFuZCA9IG5ldyBVcGRhdGVDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogUExBWUVSX0JBU0VTX1RBQkxFLFxuICAgICAgS2V5OiB7XG4gICAgICAgIHBsYXllcklkOiBiYXNlLnBsYXllcklkLFxuICAgICAgICBiYXNlSWQ6IGJhc2UuYmFzZUlkXG4gICAgICB9LFxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogJ1NFVCAjbGV2ZWwgPSAjbGV2ZWwgKyA6aW5jLCBsYXN0QWN0aXZlQXQgPSA6bm93LCBzdGF0cy5kZWZlbnNlID0gc3RhdHMuZGVmZW5zZSArIDpkZWZlbnNlSW5jLCBzdGF0cy5zdG9yYWdlID0gc3RhdHMuc3RvcmFnZSArIDpzdG9yYWdlSW5jLCBzdGF0cy5wcm9kdWN0aW9uID0gc3RhdHMucHJvZHVjdGlvbiArIDpwcm9kSW5jJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAnI2xldmVsJzogJ2xldmVsJ1xuICAgICAgfSxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzppbmMnOiAxLFxuICAgICAgICAnOm5vdyc6IG5vdyxcbiAgICAgICAgJzpkZWZlbnNlSW5jJzogMTAsIC8vIFRPRE86IEdldCBmcm9tIHRlbXBsYXRlXG4gICAgICAgICc6c3RvcmFnZUluYyc6IDEwMCxcbiAgICAgICAgJzpwcm9kSW5jJzogNVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gRXhlY3V0ZSBib3RoIHVwZGF0ZXNcbiAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICBkb2NDbGllbnQuc2VuZCh1cGRhdGVVcGdyYWRlQ29tbWFuZCksXG4gICAgICBkb2NDbGllbnQuc2VuZCh1cGRhdGVCYXNlQ29tbWFuZClcbiAgICBdKTtcblxuICAgIC8vIFRPRE86IERlZHVjdCBnb2xkIGNvc3QgZnJvbSBwbGF5ZXIgcmVzb3VyY2VzIChpbnRlZ3JhdGUgd2l0aCByZXNvdXJjZSBzZXJ2aWNlKVxuICAgIFxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIGNvbXBsZXRlIGluc3RhbnQgdXBncmFkZScsXG4gICAgICAnSU5TVEFOVF9VUEdSQURFX0VSUk9SJyxcbiAgICAgIHsgdXBncmFkZUlkOiB1cGdyYWRlLnVwZ3JhZGVJZCwgZXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSB9XG4gICAgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVJbnN0YW50VXBncmFkZUNvc3QodXBncmFkZVRpbWVTZWNvbmRzOiBudW1iZXIpOiBudW1iZXIge1xuICAvLyBGb3JtdWxhOiAxIGdvbGQgcGVyIG1pbnV0ZSBvZiB1cGdyYWRlIHRpbWUgKG1pbmltdW0gMTAgZ29sZClcbiAgcmV0dXJuIE1hdGgubWF4KDEwLCBNYXRoLmNlaWwodXBncmFkZVRpbWVTZWNvbmRzIC8gNjApKTtcbn0iXX0=