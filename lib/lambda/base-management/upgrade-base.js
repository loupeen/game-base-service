"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const shared_mocks_1 = require("../../lib/shared-mocks");
const zod_1 = require("zod");
const uuid_1 = require("uuid");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const logger = new shared_mocks_1.StructuredLogger('UpgradeBaseHandler');
const PLAYER_BASES_TABLE = process.env.PLAYER_BASES_TABLE;
const BASE_TEMPLATES_TABLE = process.env.BASE_TEMPLATES_TABLE;
const BASE_UPGRADES_TABLE = process.env.BASE_UPGRADES_TABLE;
const ENVIRONMENT = process.env.ENVIRONMENT;
const UpgradeBaseRequestSchema = zod_1.z.object({
    playerId: zod_1.z.string().min(1).max(50),
    baseId: zod_1.z.string().min(1).max(50),
    upgradeType: zod_1.z.enum(['level', 'defense', 'storage', 'production', 'specialized']),
    skipTime: zod_1.z.boolean().optional().default(false) // For premium players
});
/**
 * Upgrade Base Handler
 *
 * Implements base upgrade system following SOLID principles:
 * - Single Responsibility: Only handles base upgrades
 * - Open/Closed: Extensible for new upgrade types
 * - Liskov Substitution: All upgrade types follow same pattern
 * - Interface Segregation: Clear upgrade operation interfaces
 * - Dependency Inversion: Depends on shared abstractions
 *
 * Game Mechanics:
 * - Validates upgrade requirements (resources, level, time)
 * - Supports instant upgrades for premium players (gold cost)
 * - Tracks upgrade progress with completion times
 * - Updates base stats upon completion
 * - Implements upgrade queue system
 */
const handler = async (event) => {
    return (0, shared_mocks_1.withErrorHandling)(async () => {
        logger.info('Processing base upgrade request', {
            requestId: event.requestContext?.requestId
        });
        const request = await (0, shared_mocks_1.validateRequest)(UpgradeBaseRequestSchema, event.body);
        // Get current base state
        const currentBase = await getPlayerBase(request.playerId, request.baseId);
        // Validate upgrade is possible
        const upgradeTemplate = await validateUpgradeRequirements(currentBase, request.upgradeType);
        // Check for existing active upgrades
        await checkActiveUpgrades(request.playerId, request.baseId);
        // Create upgrade record
        const upgrade = await createUpgradeRecord(request, currentBase, upgradeTemplate);
        // If instant upgrade (skipTime), complete immediately
        if (request.skipTime) {
            await completeInstantUpgrade(upgrade, currentBase);
        }
        logger.info('Base upgrade initiated', {
            playerId: request.playerId,
            baseId: request.baseId,
            upgradeType: request.upgradeType,
            instant: request.skipTime
        });
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                success: true,
                data: {
                    upgrade: upgrade,
                    message: request.skipTime
                        ? 'Base upgrade completed instantly'
                        : 'Base upgrade started successfully'
                }
            })
        };
    }, logger);
};
exports.handler = handler;
async function getPlayerBase(playerId, baseId) {
    try {
        const command = new lib_dynamodb_1.GetCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: { playerId, baseId }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError('Base not found', 'BASE_NOT_FOUND', { playerId, baseId });
        }
        if (response.Item.status === 'destroyed') {
            throw new shared_mocks_1.GameEngineError('Cannot upgrade destroyed base', 'INVALID_BASE_STATUS', { playerId, baseId, status: response.Item.status });
        }
        return response.Item;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to retrieve base', 'BASE_RETRIEVAL_ERROR', { playerId, baseId, error: error.message });
    }
}
async function validateUpgradeRequirements(base, upgradeType) {
    try {
        const nextLevel = base.level + 1;
        const templateId = `${base.baseType}-level-${nextLevel}`;
        const command = new lib_dynamodb_1.GetCommand({
            TableName: BASE_TEMPLATES_TABLE,
            Key: { templateId }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError(`No upgrade template found for ${base.baseType} level ${nextLevel}`, 'UPGRADE_TEMPLATE_NOT_FOUND', { baseType: base.baseType, currentLevel: base.level, nextLevel });
        }
        const template = response.Item;
        // TODO: Validate player has required resources
        // This would integrate with resource service
        return template;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to validate upgrade requirements', 'UPGRADE_VALIDATION_ERROR', { baseId: base.baseId, upgradeType, error: error.message });
    }
}
async function checkActiveUpgrades(playerId, baseId) {
    try {
        // Check if base already has active upgrade
        const command = new lib_dynamodb_1.GetCommand({
            TableName: BASE_UPGRADES_TABLE,
            Key: {
                playerId,
                upgradeId: `${baseId}-active`
            }
        });
        const response = await docClient.send(command);
        if (response.Item && response.Item.status === 'in_progress') {
            throw new shared_mocks_1.GameEngineError('Base already has an active upgrade', 'UPGRADE_IN_PROGRESS', { playerId, baseId, activeUpgrade: response.Item.upgradeId });
        }
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError)
            throw error;
        throw new shared_mocks_1.GameEngineError('Failed to check active upgrades', 'ACTIVE_UPGRADE_CHECK_ERROR', { playerId, baseId, error: error.message });
    }
}
async function createUpgradeRecord(request, base, template) {
    try {
        const now = Date.now();
        const upgradeTime = template.buildTime || 3600; // Default 1 hour
        const completionTime = now + (upgradeTime * 1000);
        const upgrade = {
            playerId: request.playerId,
            upgradeId: `${request.baseId}-${(0, uuid_1.v4)()}`,
            baseId: request.baseId,
            upgradeType: request.upgradeType,
            fromLevel: base.level,
            toLevel: base.level + 1,
            requirements: {
                resources: template.requirements?.resources || {},
                time: upgradeTime,
                goldCost: request.skipTime ? calculateInstantUpgradeCost(upgradeTime) : undefined
            },
            status: 'in_progress',
            startedAt: now,
            completionTime: completionTime,
            ttl: completionTime + (7 * 24 * 60 * 60 * 1000) // Cleanup after 7 days
        };
        const command = new lib_dynamodb_1.PutCommand({
            TableName: BASE_UPGRADES_TABLE,
            Item: upgrade
        });
        await docClient.send(command);
        return upgrade;
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to create upgrade record', 'UPGRADE_RECORD_ERROR', {
            playerId: request.playerId,
            baseId: request.baseId,
            error: error.message
        });
    }
}
async function completeInstantUpgrade(upgrade, base) {
    try {
        const now = Date.now();
        // Update upgrade record to completed
        const updateUpgradeCommand = new lib_dynamodb_1.UpdateCommand({
            TableName: BASE_UPGRADES_TABLE,
            Key: {
                playerId: upgrade.playerId,
                upgradeId: upgrade.upgradeId
            },
            UpdateExpression: 'SET #status = :status, completionTime = :now',
            ExpressionAttributeNames: {
                '#status': 'status'
            },
            ExpressionAttributeValues: {
                ':status': 'completed',
                ':now': now
            }
        });
        // Update base level and stats
        const updateBaseCommand = new lib_dynamodb_1.UpdateCommand({
            TableName: PLAYER_BASES_TABLE,
            Key: {
                playerId: base.playerId,
                baseId: base.baseId
            },
            UpdateExpression: 'SET #level = #level + :inc, lastActiveAt = :now, stats.defense = stats.defense + :defenseInc, stats.storage = stats.storage + :storageInc, stats.production = stats.production + :prodInc',
            ExpressionAttributeNames: {
                '#level': 'level'
            },
            ExpressionAttributeValues: {
                ':inc': 1,
                ':now': now,
                ':defenseInc': 10, // TODO: Get from template
                ':storageInc': 100,
                ':prodInc': 5
            }
        });
        // Execute both updates
        await Promise.all([
            docClient.send(updateUpgradeCommand),
            docClient.send(updateBaseCommand)
        ]);
        // TODO: Deduct gold cost from player resources (integrate with resource service)
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to complete instant upgrade', 'INSTANT_UPGRADE_ERROR', { upgradeId: upgrade.upgradeId, error: error.message });
    }
}
function calculateInstantUpgradeCost(upgradeTimeSeconds) {
    // Formula: 1 gold per minute of upgrade time (minimum 10 gold)
    return Math.max(10, Math.ceil(upgradeTimeSeconds / 60));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBncmFkZS1iYXNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGFtYmRhL2Jhc2UtbWFuYWdlbWVudC91cGdyYWRlLWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUFzRztBQUN0Ryx5REFLZ0M7QUFDaEMsNkJBQXdCO0FBQ3hCLCtCQUFvQztBQUVwQyxNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDNUMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQzVELE1BQU0sTUFBTSxHQUFHLElBQUksK0JBQWdCLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUUxRCxNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQW1CLENBQUM7QUFDM0QsTUFBTSxvQkFBb0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFxQixDQUFDO0FBQy9ELE1BQU0sbUJBQW1CLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBb0IsQ0FBQztBQUM3RCxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVksQ0FBQztBQUU3QyxNQUFNLHdCQUF3QixHQUFHLE9BQUMsQ0FBQyxNQUFNLENBQUM7SUFDeEMsUUFBUSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztJQUNuQyxNQUFNLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO0lBQ2pDLFdBQVcsRUFBRSxPQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lB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LCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBHZXRDb21tYW5kLCBVcGRhdGVDb21tYW5kLCBQdXRDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IFxuICBTdHJ1Y3R1cmVkTG9nZ2VyLCBcbiAgR2FtZUVuZ2luZUVycm9yLFxuICB3aXRoRXJyb3JIYW5kbGluZyxcbiAgdmFsaWRhdGVSZXF1ZXN0IFxufSBmcm9tICcuLi8uLi9saWIvc2hhcmVkLW1vY2tzJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5cbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vQ2xpZW50KTtcbmNvbnN0IGxvZ2dlciA9IG5ldyBTdHJ1Y3R1cmVkTG9nZ2VyKCdVcGdyYWRlQmFzZUhhbmRsZXInKTtcblxuY29uc3QgUExBWUVSX0JBU0VTX1RBQkxFID0gcHJvY2Vzcy5lbnYuUExBWUVSX0JBU0VTX1RBQkxFITtcbmNvbnN0IEJBU0VfVEVNUExBVEVTX1RBQkxFID0gcHJvY2Vzcy5lbnYuQkFTRV9URU1QTEFURVNfVEFCTEUhO1xuY29uc3QgQkFTRV9VUEdSQURFU19UQUJMRSA9IHByb2Nlc3MuZW52LkJBU0VfVVBHUkFERVNfVEFCTEUhO1xuY29uc3QgRU5WSVJPTk1FTlQgPSBwcm9jZXNzLmVudi5FTlZJUk9OTUVOVCE7XG5cbmNvbnN0IFVwZ3JhZGVCYXNlUmVxdWVzdFNjaGVtYSA9IHoub2JqZWN0KHtcbiAgcGxheWVySWQ6IHouc3RyaW5nKCkubWluKDEpLm1heCg1MCksXG4gIGJhc2VJZDogei5zdHJpbmcoKS5taW4oMSkubWF4KDUwKSxcbiAgdXBncmFkZVR5cGU6IHouZW51bShbJ2xldmVsJywgJ2RlZmVuc2UnLCAnc3RvcmFnZScsICdwcm9kdWN0aW9uJywgJ3NwZWNpYWxpemVkJ10pLFxuICBza2lwVGltZTogei5ib29sZWFuKCkub3B0aW9uYWwoKS5kZWZhdWx0KGZhbHNlKSAvLyBGb3IgcHJlbWl1bSBwbGF5ZXJzXG59KTtcblxudHlwZSBVcGdyYWRlQmFzZVJlcXVlc3QgPSB6LmluZmVyPHR5cGVvZiBVcGdyYWRlQmFzZVJlcXVlc3RTY2hlbWE+O1xuXG5pbnRlcmZhY2UgQmFzZVVwZ3JhZGUge1xuICBwbGF5ZXJJZDogc3RyaW5nO1xuICB1cGdyYWRlSWQ6IHN0cmluZztcbiAgYmFzZUlkOiBzdHJpbmc7XG4gIHVwZ3JhZGVUeXBlOiBzdHJpbmc7XG4gIGZyb21MZXZlbDogbnVtYmVyO1xuICB0b0xldmVsOiBudW1iZXI7XG4gIHJlcXVpcmVtZW50czoge1xuICAgIHJlc291cmNlczogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcbiAgICB0aW1lOiBudW1iZXI7XG4gICAgZ29sZENvc3Q/OiBudW1iZXI7XG4gIH07XG4gIHN0YXR1czogJ2luX3Byb2dyZXNzJyB8ICdjb21wbGV0ZWQnIHwgJ2NhbmNlbGxlZCc7XG4gIHN0YXJ0ZWRBdDogbnVtYmVyO1xuICBjb21wbGV0aW9uVGltZTogbnVtYmVyO1xuICB0dGw/OiBudW1iZXI7XG59XG5cbi8qKlxuICogVXBncmFkZSBCYXNlIEhhbmRsZXJcbiAqIFxuICogSW1wbGVtZW50cyBiYXNlIHVwZ3JhZGUgc3lzdGVtIGZvbGxvd2luZyBTT0xJRCBwcmluY2lwbGVzOlxuICogLSBTaW5nbGUgUmVzcG9uc2liaWxpdHk6IE9ubHkgaGFuZGxlcyBiYXNlIHVwZ3JhZGVzXG4gKiAtIE9wZW4vQ2xvc2VkOiBFeHRlbnNpYmxlIGZvciBuZXcgdXBncmFkZSB0eXBlc1xuICogLSBMaXNrb3YgU3Vic3RpdHV0aW9uOiBBbGwgdXBncmFkZSB0eXBlcyBmb2xsb3cgc2FtZSBwYXR0ZXJuXG4gKiAtIEludGVyZmFjZSBTZWdyZWdhdGlvbjogQ2xlYXIgdXBncmFkZSBvcGVyYXRpb24gaW50ZXJmYWNlc1xuICogLSBEZXBlbmRlbmN5IEludmVyc2lvbjogRGVwZW5kcyBvbiBzaGFyZWQgYWJzdHJhY3Rpb25zXG4gKiBcbiAqIEdhbWUgTWVjaGFuaWNzOlxuICogLSBWYWxpZGF0ZXMgdXBncmFkZSByZXF1aXJlbWVudHMgKHJlc291cmNlcywgbGV2ZWwsIHRpbWUpXG4gKiAtIFN1cHBvcnRzIGluc3RhbnQgdXBncmFkZXMgZm9yIHByZW1pdW0gcGxheWVycyAoZ29sZCBjb3N0KVxuICogLSBUcmFja3MgdXBncmFkZSBwcm9ncmVzcyB3aXRoIGNvbXBsZXRpb24gdGltZXNcbiAqIC0gVXBkYXRlcyBiYXNlIHN0YXRzIHVwb24gY29tcGxldGlvblxuICogLSBJbXBsZW1lbnRzIHVwZ3JhZGUgcXVldWUgc3lzdGVtXG4gKi9cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIHJldHVybiB3aXRoRXJyb3JIYW5kbGluZyhhc3luYyAoKSA9PiB7XG4gICAgbG9nZ2VyLmluZm8oJ1Byb2Nlc3NpbmcgYmFzZSB1cGdyYWRlIHJlcXVlc3QnLCB7IFxuICAgICAgcmVxdWVzdElkOiBldmVudC5yZXF1ZXN0Q29udGV4dD8ucmVxdWVzdElkIFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVxdWVzdCA9IGF3YWl0IHZhbGlkYXRlUmVxdWVzdDxVcGdyYWRlQmFzZVJlcXVlc3Q+KFVwZ3JhZGVCYXNlUmVxdWVzdFNjaGVtYSwgZXZlbnQuYm9keSk7XG4gICAgXG4gICAgLy8gR2V0IGN1cnJlbnQgYmFzZSBzdGF0ZVxuICAgIGNvbnN0IGN1cnJlbnRCYXNlID0gYXdhaXQgZ2V0UGxheWVyQmFzZShyZXF1ZXN0LnBsYXllcklkLCByZXF1ZXN0LmJhc2VJZCk7XG4gICAgXG4gICAgLy8gVmFsaWRhdGUgdXBncmFkZSBpcyBwb3NzaWJsZVxuICAgIGNvbnN0IHVwZ3JhZGVUZW1wbGF0ZSA9IGF3YWl0IHZhbGlkYXRlVXBncmFkZVJlcXVpcmVtZW50cyhjdXJyZW50QmFzZSwgcmVxdWVzdC51cGdyYWRlVHlwZSk7XG4gICAgXG4gICAgLy8gQ2hlY2sgZm9yIGV4aXN0aW5nIGFjdGl2ZSB1cGdyYWRlc1xuICAgIGF3YWl0IGNoZWNrQWN0aXZlVXBncmFkZXMocmVxdWVzdC5wbGF5ZXJJZCwgcmVxdWVzdC5iYXNlSWQpO1xuICAgIFxuICAgIC8vIENyZWF0ZSB1cGdyYWRlIHJlY29yZFxuICAgIGNvbnN0IHVwZ3JhZGUgPSBhd2FpdCBjcmVhdGVVcGdyYWRlUmVjb3JkKHJlcXVlc3QsIGN1cnJlbnRCYXNlLCB1cGdyYWRlVGVtcGxhdGUpO1xuICAgIFxuICAgIC8vIElmIGluc3RhbnQgdXBncmFkZSAoc2tpcFRpbWUpLCBjb21wbGV0ZSBpbW1lZGlhdGVseVxuICAgIGlmIChyZXF1ZXN0LnNraXBUaW1lKSB7XG4gICAgICBhd2FpdCBjb21wbGV0ZUluc3RhbnRVcGdyYWRlKHVwZ3JhZGUsIGN1cnJlbnRCYXNlKTtcbiAgICB9XG5cbiAgICBsb2dnZXIuaW5mbygnQmFzZSB1cGdyYWRlIGluaXRpYXRlZCcsIHtcbiAgICAgIHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLFxuICAgICAgYmFzZUlkOiByZXF1ZXN0LmJhc2VJZCxcbiAgICAgIHVwZ3JhZGVUeXBlOiByZXF1ZXN0LnVwZ3JhZGVUeXBlLFxuICAgICAgaW5zdGFudDogcmVxdWVzdC5za2lwVGltZVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJ1xuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHVwZ3JhZGU6IHVwZ3JhZGUsXG4gICAgICAgICAgbWVzc2FnZTogcmVxdWVzdC5za2lwVGltZSBcbiAgICAgICAgICAgID8gJ0Jhc2UgdXBncmFkZSBjb21wbGV0ZWQgaW5zdGFudGx5JyBcbiAgICAgICAgICAgIDogJ0Jhc2UgdXBncmFkZSBzdGFydGVkIHN1Y2Nlc3NmdWxseSdcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9O1xuICB9LCBsb2dnZXIpO1xufTtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0UGxheWVyQmFzZShwbGF5ZXJJZDogc3RyaW5nLCBiYXNlSWQ6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogUExBWUVSX0JBU0VTX1RBQkxFLFxuICAgICAgS2V5OiB7IHBsYXllcklkLCBiYXNlSWQgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBcbiAgICBpZiAoIXJlc3BvbnNlLkl0ZW0pIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdCYXNlIG5vdCBmb3VuZCcsXG4gICAgICAgICdCQVNFX05PVF9GT1VORCcsXG4gICAgICAgIHsgcGxheWVySWQsIGJhc2VJZCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChyZXNwb25zZS5JdGVtLnN0YXR1cyA9PT0gJ2Rlc3Ryb3llZCcpIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdDYW5ub3QgdXBncmFkZSBkZXN0cm95ZWQgYmFzZScsXG4gICAgICAgICdJTlZBTElEX0JBU0VfU1RBVFVTJyxcbiAgICAgICAgeyBwbGF5ZXJJZCwgYmFzZUlkLCBzdGF0dXM6IHJlc3BvbnNlLkl0ZW0uc3RhdHVzIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3BvbnNlLkl0ZW07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgR2FtZUVuZ2luZUVycm9yKSB0aHJvdyBlcnJvcjtcbiAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgJ0ZhaWxlZCB0byByZXRyaWV2ZSBiYXNlJyxcbiAgICAgICdCQVNFX1JFVFJJRVZBTF9FUlJPUicsXG4gICAgICB7IHBsYXllcklkLCBiYXNlSWQsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gdmFsaWRhdGVVcGdyYWRlUmVxdWlyZW1lbnRzKGJhc2U6IGFueSwgdXBncmFkZVR5cGU6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgbmV4dExldmVsID0gYmFzZS5sZXZlbCArIDE7XG4gICAgY29uc3QgdGVtcGxhdGVJZCA9IGAke2Jhc2UuYmFzZVR5cGV9LWxldmVsLSR7bmV4dExldmVsfWA7XG4gICAgXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogQkFTRV9URU1QTEFURVNfVEFCTEUsXG4gICAgICBLZXk6IHsgdGVtcGxhdGVJZCB9XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIFxuICAgIGlmICghcmVzcG9uc2UuSXRlbSkge1xuICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgYE5vIHVwZ3JhZGUgdGVtcGxhdGUgZm91bmQgZm9yICR7YmFzZS5iYXNlVHlwZX0gbGV2ZWwgJHtuZXh0TGV2ZWx9YCxcbiAgICAgICAgJ1VQR1JBREVfVEVNUExBVEVfTk9UX0ZPVU5EJyxcbiAgICAgICAgeyBiYXNlVHlwZTogYmFzZS5iYXNlVHlwZSwgY3VycmVudExldmVsOiBiYXNlLmxldmVsLCBuZXh0TGV2ZWwgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCB0ZW1wbGF0ZSA9IHJlc3BvbnNlLkl0ZW07XG4gICAgXG4gICAgLy8gVE9ETzogVmFsaWRhdGUgcGxheWVyIGhhcyByZXF1aXJlZCByZXNvdXJjZXNcbiAgICAvLyBUaGlzIHdvdWxkIGludGVncmF0ZSB3aXRoIHJlc291cmNlIHNlcnZpY2VcbiAgICBcbiAgICByZXR1cm4gdGVtcGxhdGU7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgR2FtZUVuZ2luZUVycm9yKSB0aHJvdyBlcnJvcjtcbiAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgJ0ZhaWxlZCB0byB2YWxpZGF0ZSB1cGdyYWRlIHJlcXVpcmVtZW50cycsXG4gICAgICAnVVBHUkFERV9WQUxJREFUSU9OX0VSUk9SJyxcbiAgICAgIHsgYmFzZUlkOiBiYXNlLmJhc2VJZCwgdXBncmFkZVR5cGUsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tBY3RpdmVVcGdyYWRlcyhwbGF5ZXJJZDogc3RyaW5nLCBiYXNlSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICB0cnkge1xuICAgIC8vIENoZWNrIGlmIGJhc2UgYWxyZWFkeSBoYXMgYWN0aXZlIHVwZ3JhZGVcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBCQVNFX1VQR1JBREVTX1RBQkxFLFxuICAgICAgS2V5OiB7IFxuICAgICAgICBwbGF5ZXJJZCxcbiAgICAgICAgdXBncmFkZUlkOiBgJHtiYXNlSWR9LWFjdGl2ZWBcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgXG4gICAgaWYgKHJlc3BvbnNlLkl0ZW0gJiYgcmVzcG9uc2UuSXRlbS5zdGF0dXMgPT09ICdpbl9wcm9ncmVzcycpIHtcbiAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICdCYXNlIGFscmVhZHkgaGFzIGFuIGFjdGl2ZSB1cGdyYWRlJyxcbiAgICAgICAgJ1VQR1JBREVfSU5fUFJPR1JFU1MnLFxuICAgICAgICB7IHBsYXllcklkLCBiYXNlSWQsIGFjdGl2ZVVwZ3JhZGU6IHJlc3BvbnNlLkl0ZW0udXBncmFkZUlkIH1cbiAgICAgICk7XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEdhbWVFbmdpbmVFcnJvcikgdGhyb3cgZXJyb3I7XG4gICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICdGYWlsZWQgdG8gY2hlY2sgYWN0aXZlIHVwZ3JhZGVzJyxcbiAgICAgICdBQ1RJVkVfVVBHUkFERV9DSEVDS19FUlJPUicsXG4gICAgICB7IHBsYXllcklkLCBiYXNlSWQsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlVXBncmFkZVJlY29yZChcbiAgcmVxdWVzdDogVXBncmFkZUJhc2VSZXF1ZXN0LFxuICBiYXNlOiBhbnksXG4gIHRlbXBsYXRlOiBhbnlcbik6IFByb21pc2U8QmFzZVVwZ3JhZGU+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IHVwZ3JhZGVUaW1lID0gdGVtcGxhdGUuYnVpbGRUaW1lIHx8IDM2MDA7IC8vIERlZmF1bHQgMSBob3VyXG4gICAgY29uc3QgY29tcGxldGlvblRpbWUgPSBub3cgKyAodXBncmFkZVRpbWUgKiAxMDAwKTtcbiAgICBcbiAgICBjb25zdCB1cGdyYWRlOiBCYXNlVXBncmFkZSA9IHtcbiAgICAgIHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLFxuICAgICAgdXBncmFkZUlkOiBgJHtyZXF1ZXN0LmJhc2VJZH0tJHt1dWlkdjQoKX1gLFxuICAgICAgYmFzZUlkOiByZXF1ZXN0LmJhc2VJZCxcbiAgICAgIHVwZ3JhZGVUeXBlOiByZXF1ZXN0LnVwZ3JhZGVUeXBlLFxuICAgICAgZnJvbUxldmVsOiBiYXNlLmxldmVsLFxuICAgICAgdG9MZXZlbDogYmFzZS5sZXZlbCArIDEsXG4gICAgICByZXF1aXJlbWVudHM6IHtcbiAgICAgICAgcmVzb3VyY2VzOiB0ZW1wbGF0ZS5yZXF1aXJlbWVudHM/LnJlc291cmNlcyB8fCB7fSxcbiAgICAgICAgdGltZTogdXBncmFkZVRpbWUsXG4gICAgICAgIGdvbGRDb3N0OiByZXF1ZXN0LnNraXBUaW1lID8gY2FsY3VsYXRlSW5zdGFudFVwZ3JhZGVDb3N0KHVwZ3JhZGVUaW1lKSA6IHVuZGVmaW5lZFxuICAgICAgfSxcbiAgICAgIHN0YXR1czogJ2luX3Byb2dyZXNzJyxcbiAgICAgIHN0YXJ0ZWRBdDogbm93LFxuICAgICAgY29tcGxldGlvblRpbWU6IGNvbXBsZXRpb25UaW1lLFxuICAgICAgdHRsOiBjb21wbGV0aW9uVGltZSArICg3ICogMjQgKiA2MCAqIDYwICogMTAwMCkgLy8gQ2xlYW51cCBhZnRlciA3IGRheXNcbiAgICB9O1xuXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBQdXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogQkFTRV9VUEdSQURFU19UQUJMRSxcbiAgICAgIEl0ZW06IHVwZ3JhZGVcbiAgICB9KTtcblxuICAgIGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIHJldHVybiB1cGdyYWRlO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIGNyZWF0ZSB1cGdyYWRlIHJlY29yZCcsXG4gICAgICAnVVBHUkFERV9SRUNPUkRfRVJST1InLFxuICAgICAgeyBcbiAgICAgICAgcGxheWVySWQ6IHJlcXVlc3QucGxheWVySWQsIFxuICAgICAgICBiYXNlSWQ6IHJlcXVlc3QuYmFzZUlkLCBcbiAgICAgICAgZXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSBcbiAgICAgIH1cbiAgICApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbXBsZXRlSW5zdGFudFVwZ3JhZGUodXBncmFkZTogQmFzZVVwZ3JhZGUsIGJhc2U6IGFueSk6IFByb21pc2U8dm9pZD4ge1xuICB0cnkge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgXG4gICAgLy8gVXBkYXRlIHVwZ3JhZGUgcmVjb3JkIHRvIGNvbXBsZXRlZFxuICAgIGNvbnN0IHVwZGF0ZVVwZ3JhZGVDb21tYW5kID0gbmV3IFVwZGF0ZUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBCQVNFX1VQR1JBREVTX1RBQkxFLFxuICAgICAgS2V5OiB7XG4gICAgICAgIHBsYXllcklkOiB1cGdyYWRlLnBsYXllcklkLFxuICAgICAgICB1cGdyYWRlSWQ6IHVwZ3JhZGUudXBncmFkZUlkXG4gICAgICB9LFxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogJ1NFVCAjc3RhdHVzID0gOnN0YXR1cywgY29tcGxldGlvblRpbWUgPSA6bm93JyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAnI3N0YXR1cyc6ICdzdGF0dXMnXG4gICAgICB9LFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOnN0YXR1cyc6ICdjb21wbGV0ZWQnLFxuICAgICAgICAnOm5vdyc6IG5vd1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gVXBkYXRlIGJhc2UgbGV2ZWwgYW5kIHN0YXRzXG4gICAgY29uc3QgdXBkYXRlQmFzZUNvbW1hbmQgPSBuZXcgVXBkYXRlQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFBMQVlFUl9CQVNFU19UQUJMRSxcbiAgICAgIEtleToge1xuICAgICAgICBwbGF5ZXJJZDogYmFzZS5wbGF5ZXJJZCxcbiAgICAgICAgYmFzZUlkOiBiYXNlLmJhc2VJZFxuICAgICAgfSxcbiAgICAgIFVwZGF0ZUV4cHJlc3Npb246ICdTRVQgI2xldmVsID0gI2xldmVsICsgOmluYywgbGFzdEFjdGl2ZUF0ID0gOm5vdywgc3RhdHMuZGVmZW5zZSA9IHN0YXRzLmRlZmVuc2UgKyA6ZGVmZW5zZUluYywgc3RhdHMuc3RvcmFnZSA9IHN0YXRzLnN0b3JhZ2UgKyA6c3RvcmFnZUluYywgc3RhdHMucHJvZHVjdGlvbiA9IHN0YXRzLnByb2R1Y3Rpb24gKyA6cHJvZEluYycsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgJyNsZXZlbCc6ICdsZXZlbCdcbiAgICAgIH0sXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6aW5jJzogMSxcbiAgICAgICAgJzpub3cnOiBub3csXG4gICAgICAgICc6ZGVmZW5zZUluYyc6IDEwLCAvLyBUT0RPOiBHZXQgZnJvbSB0ZW1wbGF0ZVxuICAgICAgICAnOnN0b3JhZ2VJbmMnOiAxMDAsXG4gICAgICAgICc6cHJvZEluYyc6IDVcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIEV4ZWN1dGUgYm90aCB1cGRhdGVzXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgZG9jQ2xpZW50LnNlbmQodXBkYXRlVXBncmFkZUNvbW1hbmQpLFxuICAgICAgZG9jQ2xpZW50LnNlbmQodXBkYXRlQmFzZUNvbW1hbmQpXG4gICAgXSk7XG5cbiAgICAvLyBUT0RPOiBEZWR1Y3QgZ29sZCBjb3N0IGZyb20gcGxheWVyIHJlc291cmNlcyAoaW50ZWdyYXRlIHdpdGggcmVzb3VyY2Ugc2VydmljZSlcbiAgICBcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgJ0ZhaWxlZCB0byBjb21wbGV0ZSBpbnN0YW50IHVwZ3JhZGUnLFxuICAgICAgJ0lOU1RBTlRfVVBHUkFERV9FUlJPUicsXG4gICAgICB7IHVwZ3JhZGVJZDogdXBncmFkZS51cGdyYWRlSWQsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlSW5zdGFudFVwZ3JhZGVDb3N0KHVwZ3JhZGVUaW1lU2Vjb25kczogbnVtYmVyKTogbnVtYmVyIHtcbiAgLy8gRm9ybXVsYTogMSBnb2xkIHBlciBtaW51dGUgb2YgdXBncmFkZSB0aW1lIChtaW5pbXVtIDEwIGdvbGQpXG4gIHJldHVybiBNYXRoLm1heCgxMCwgTWF0aC5jZWlsKHVwZ3JhZGVUaW1lU2Vjb25kcyAvIDYwKSk7XG59Il19