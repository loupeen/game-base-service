"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const shared_mocks_1 = require("../../lib/shared-mocks");
const zod_1 = require("zod");
const uuid_1 = require("uuid");
// Initialize AWS clients following shared patterns
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const logger = new shared_mocks_1.StructuredLogger('CreateBaseHandler');
// Environment variables
const PLAYER_BASES_TABLE = process.env.PLAYER_BASES_TABLE ?? '';
const BASE_TEMPLATES_TABLE = process.env.BASE_TEMPLATES_TABLE ?? '';
const SPAWN_LOCATIONS_TABLE = process.env.SPAWN_LOCATIONS_TABLE ?? '';
const ENVIRONMENT = process.env.ENVIRONMENT ?? 'test';
// Request validation schema following shared-js-utils patterns
const CreateBaseRequestSchema = zod_1.z.object({
    playerId: zod_1.z.string().min(1).max(50),
    baseType: zod_1.z.enum(['command_center', 'outpost', 'fortress', 'mining_station', 'research_lab']),
    baseName: zod_1.z.string().min(1).max(100),
    coordinates: zod_1.z.object({
        x: zod_1.z.number().min(-1000000).max(1000000),
        y: zod_1.z.number().min(-1000000).max(1000000)
    }).optional(),
    spawnLocationId: zod_1.z.string().optional(),
    allianceId: zod_1.z.string().optional()
});
/**
 * Create Base Handler
 *
 * Implements base creation following SOLID principles:
 * - Single Responsibility: Only handles base creation logic
 * - Open/Closed: Extensible for new base types via templates
 * - Liskov Substitution: All base types follow same creation pattern
 * - Interface Segregation: Clear separation of creation concerns
 * - Dependency Inversion: Depends on shared utilities and abstractions
 *
 * Game Logic:
 * - Validates player can create new base (subscription limits)
 * - Finds optimal spawn location if not provided
 * - Creates base from template with proper stats
 * - Handles coordinate validation and map sectioning
 * - Implements building time mechanics
 */
const handler = async (event) => {
    return (0, shared_mocks_1.withErrorHandling)(async () => {
        logger.info('Processing create base request', {
            requestId: event.requestContext?.requestId,
            environment: ENVIRONMENT
        });
        // Validate request using shared validation patterns
        const request = await (0, shared_mocks_1.validateRequest)(CreateBaseRequestSchema, event.body);
        // Check if player can create more bases (subscription limits)
        await validatePlayerBaseLimit(request.playerId);
        // Get base template for stats and requirements
        const template = await getBaseTemplate(request.baseType);
        // Determine coordinates (use provided or calculate spawn location)
        const coordinates = request.coordinates ?? await calculateSpawnCoordinates(request.spawnLocationId);
        // Create the new base
        const newBase = await createPlayerBase(request, template, coordinates);
        logger.info('Base created successfully', {
            playerId: request.playerId,
            baseId: newBase.baseId,
            baseType: request.baseType,
            coordinates
        });
        return {
            statusCode: 201,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                success: true,
                data: {
                    base: newBase,
                    buildTime: template.buildTime,
                    message: 'Base creation initiated successfully'
                }
            })
        };
    }, logger);
};
exports.handler = handler;
/**
 * Validate player base creation limits based on subscription status
 */
async function validatePlayerBaseLimit(playerId) {
    try {
        // Query existing bases for player
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: PLAYER_BASES_TABLE,
            KeyConditionExpression: 'playerId = :playerId',
            FilterExpression: '#status <> :destroyed',
            ExpressionAttributeNames: {
                '#status': 'status'
            },
            ExpressionAttributeValues: {
                ':playerId': playerId,
                ':destroyed': 'destroyed'
            },
            Select: 'COUNT'
        });
        const response = await docClient.send(command);
        const currentBaseCount = response.Count ?? 0;
        // TODO: Get player subscription status from player service
        const maxBases = 5; // Default for free players, 10 for subscribers
        if (currentBaseCount >= maxBases) {
            throw new shared_mocks_1.GameEngineError(`Player has reached maximum base limit (${maxBases})`, 'BASE_LIMIT_EXCEEDED', { playerId, currentCount: currentBaseCount, maxBases });
        }
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError) {
            throw error;
        }
        throw new shared_mocks_1.GameEngineError('Failed to validate player base limit', 'VALIDATION_ERROR', { playerId, error: error.message });
    }
}
/**
 * Get base template with stats and requirements
 */
async function getBaseTemplate(baseType) {
    try {
        const command = new lib_dynamodb_1.GetCommand({
            TableName: BASE_TEMPLATES_TABLE,
            Key: {
                templateId: `${baseType}-level-1` // Start with level 1 template
            }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError(`Base template not found for type: ${baseType}`, 'TEMPLATE_NOT_FOUND', { baseType });
        }
        return response.Item;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError) {
            throw error;
        }
        throw new shared_mocks_1.GameEngineError('Failed to retrieve base template', 'TEMPLATE_RETRIEVAL_ERROR', { baseType, error: error.message });
    }
}
/**
 * Calculate spawn coordinates for new base
 */
async function calculateSpawnCoordinates(spawnLocationId) {
    try {
        if (spawnLocationId) {
            // Use specific spawn location
            const command = new lib_dynamodb_1.GetCommand({
                TableName: SPAWN_LOCATIONS_TABLE,
                Key: {
                    spawnRegionId: 'default',
                    spawnLocationId: spawnLocationId
                }
            });
            const response = await docClient.send(command);
            const item = response.Item;
            if (!item?.isAvailable) {
                throw new shared_mocks_1.GameEngineError('Spawn location not available', 'SPAWN_LOCATION_UNAVAILABLE', { spawnLocationId });
            }
            return {
                x: item.coordinates.x,
                y: item.coordinates.y
            };
        }
        // Generate random coordinates in starter region
        // TODO: Implement proper spawn location algorithm based on population density
        const spawnRadius = 1000; // 1000 unit radius for new players
        const angle = Math.random() * 2 * Math.PI;
        const distance = Math.random() * spawnRadius;
        return {
            x: Math.floor(Math.cos(angle) * distance),
            y: Math.floor(Math.sin(angle) * distance)
        };
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError) {
            throw error;
        }
        throw new shared_mocks_1.GameEngineError('Failed to calculate spawn coordinates', 'SPAWN_CALCULATION_ERROR', { spawnLocationId, error: error.message });
    }
}
/**
 * Create the player base record
 */
async function createPlayerBase(request, template, coordinates) {
    try {
        const now = Date.now();
        const baseId = (0, uuid_1.v4)();
        // Calculate map section for indexing (divide coordinates into 100x100 sections)
        const mapSectionId = `${Math.floor(coordinates.x / 100)},${Math.floor(coordinates.y / 100)}`;
        const coordinateHash = `${coordinates.x},${coordinates.y}`;
        const newBase = {
            playerId: request.playerId,
            baseId: baseId,
            baseType: request.baseType,
            baseName: request.baseName,
            level: 1,
            coordinates: coordinates,
            mapSectionId: mapSectionId,
            coordinateHash: coordinateHash,
            allianceId: request.allianceId,
            status: template.buildTime > 0 ? 'building' : 'active',
            stats: {
                defense: template.stats.defense,
                storage: template.stats.storage,
                production: template.stats.production
            },
            createdAt: now,
            lastActiveAt: now,
            buildCompletionTime: template.buildTime > 0 ? now + (template.buildTime * 1000) : undefined
        };
        // Store base in DynamoDB
        const command = new lib_dynamodb_1.PutCommand({
            TableName: PLAYER_BASES_TABLE,
            Item: newBase,
            ConditionExpression: 'attribute_not_exists(playerId) AND attribute_not_exists(baseId)'
        });
        await docClient.send(command);
        return newBase;
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to create player base', 'BASE_CREATION_ERROR', {
            playerId: request.playerId,
            baseType: request.baseType,
            error: error.message
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYmFzZS1tYW5hZ2VtZW50L2NyZWF0ZS1iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDhEQUEwRDtBQUMxRCx3REFBcUc7QUFDckcseURBS2dDO0FBQ2hDLDZCQUF3QjtBQUN4QiwrQkFBb0M7QUFTcEMsbURBQW1EO0FBQ25ELE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUM1QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDNUQsTUFBTSxNQUFNLEdBQUcsSUFBSSwrQkFBZ0IsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBRXpELHdCQUF3QjtBQUN4QixNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDO0FBQ2hFLE1BQU0sb0JBQW9CLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsSUFBSSxFQUFFLENBQUM7QUFDcEUsTUFBTSxxQkFBcUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixJQUFJLEVBQUUsQ0FBQztBQUN0RSxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsSUFBSSxNQUFNLENBQUM7QUFFdEQsK0RBQStEO0FBQy9ELE1BQU0sdUJBQXVCLEdBQUcsT0FBQyxDQUFDLE1BQU0sQ0FBQztJQUN2QyxRQUFRLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO0lBQ25DLFFBQVEsRUFBRSxPQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUM3RixR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QjtRQUN6QixNQUFNLE9BQU8sR0FBRyxJQUFJLHlCQUFVLENBQUM7WUFDN0IsU0FBUyxFQUFFLGtCQUFrQjtZQUM3QixJQUFJLEVBQUUsT0FBTztZQUNiLG1CQUFtQixFQUFFLGlFQUFpRTtTQUN2RixDQUFDLENBQUM7UUFFSCxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFOUIsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixNQUFNLElBQUksOEJBQWUsQ0FDdkIsOEJBQThCLEVBQzlCLHFCQUFxQixFQUNyQjtZQUNFLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtZQUMxQixRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7WUFDMUIsS0FBSyxFQUFHLEtBQWUsQ0FBQyxPQUFPO1NBQ2hDLENBQ0YsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgUHV0Q29tbWFuZCwgUXVlcnlDb21tYW5kLCBHZXRDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IFxuICBTdHJ1Y3R1cmVkTG9nZ2VyLCBcbiAgR2FtZUVuZ2luZUVycm9yLFxuICB3aXRoRXJyb3JIYW5kbGluZyxcbiAgdmFsaWRhdGVSZXF1ZXN0XG59IGZyb20gJy4uLy4uL2xpYi9zaGFyZWQtbW9ja3MnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcbmltcG9ydCB7IFxuICBCYXNlVGVtcGxhdGUsIFxuICBQbGF5ZXJCYXNlLCBcbiAgQ3JlYXRlQmFzZVJlcXVlc3QsIFxuICBDb29yZGluYXRlcywgXG4gIFNwYXduTG9jYXRpb24gXG59IGZyb20gJy4uL3R5cGVzL2dhbWUtYmFzZS10eXBlcyc7XG5cbi8vIEluaXRpYWxpemUgQVdTIGNsaWVudHMgZm9sbG93aW5nIHNoYXJlZCBwYXR0ZXJuc1xuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkeW5hbW9DbGllbnQpO1xuY29uc3QgbG9nZ2VyID0gbmV3IFN0cnVjdHVyZWRMb2dnZXIoJ0NyZWF0ZUJhc2VIYW5kbGVyJyk7XG5cbi8vIEVudmlyb25tZW50IHZhcmlhYmxlc1xuY29uc3QgUExBWUVSX0JBU0VTX1RBQkxFID0gcHJvY2Vzcy5lbnYuUExBWUVSX0JBU0VTX1RBQkxFID8/ICcnO1xuY29uc3QgQkFTRV9URU1QTEFURVNfVEFCTEUgPSBwcm9jZXNzLmVudi5CQVNFX1RFTVBMQVRFU19UQUJMRSA/PyAnJztcbmNvbnN0IFNQQVdOX0xPQ0FUSU9OU19UQUJMRSA9IHByb2Nlc3MuZW52LlNQQVdOX0xPQ0FUSU9OU19UQUJMRSA/PyAnJztcbmNvbnN0IEVOVklST05NRU5UID0gcHJvY2Vzcy5lbnYuRU5WSVJPTk1FTlQgPz8gJ3Rlc3QnO1xuXG4vLyBSZXF1ZXN0IHZhbGlkYXRpb24gc2NoZW1hIGZvbGxvd2luZyBzaGFyZWQtanMtdXRpbHMgcGF0dGVybnNcbmNvbnN0IENyZWF0ZUJhc2VSZXF1ZXN0U2NoZW1hID0gei5vYmplY3Qoe1xuICBwbGF5ZXJJZDogei5zdHJpbmcoKS5taW4oMSkubWF4KDUwKSxcbiAgYmFzZVR5cGU6IHouZW51bShbJ2NvbW1hbmRfY2VudGVyJywgJ291dHBvc3QnLCAnZm9ydHJlc3MnLCAnbWluaW5nX3N0YXRpb24nLCAncmVzZWFyY2hfbGFiJ10pLFxuICBiYXNlTmFtZTogei5zdHJpbmcoKS5taW4oMSkubWF4KDEwMCksXG4gIGNvb3JkaW5hdGVzOiB6Lm9iamVjdCh7XG4gICAgeDogei5udW1iZXIoKS5taW4oLTEwMDAwMDApLm1heCgxMDAwMDAwKSxcbiAgICB5OiB6Lm51bWJlcigpLm1pbigtMTAwMDAwMCkubWF4KDEwMDAwMDApXG4gIH0pLm9wdGlvbmFsKCksXG4gIHNwYXduTG9jYXRpb25JZDogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBhbGxpYW5jZUlkOiB6LnN0cmluZygpLm9wdGlvbmFsKClcbn0pO1xuXG50eXBlIENyZWF0ZUJhc2VSZXF1ZXN0SW5wdXQgPSB6LmluZmVyPHR5cGVvZiBDcmVhdGVCYXNlUmVxdWVzdFNjaGVtYT47XG5cbi8qKlxuICogQ3JlYXRlIEJhc2UgSGFuZGxlclxuICogXG4gKiBJbXBsZW1lbnRzIGJhc2UgY3JlYXRpb24gZm9sbG93aW5nIFNPTElEIHByaW5jaXBsZXM6XG4gKiAtIFNpbmdsZSBSZXNwb25zaWJpbGl0eTogT25seSBoYW5kbGVzIGJhc2UgY3JlYXRpb24gbG9naWNcbiAqIC0gT3Blbi9DbG9zZWQ6IEV4dGVuc2libGUgZm9yIG5ldyBiYXNlIHR5cGVzIHZpYSB0ZW1wbGF0ZXNcbiAqIC0gTGlza292IFN1YnN0aXR1dGlvbjogQWxsIGJhc2UgdHlwZXMgZm9sbG93IHNhbWUgY3JlYXRpb24gcGF0dGVyblxuICogLSBJbnRlcmZhY2UgU2VncmVnYXRpb246IENsZWFyIHNlcGFyYXRpb24gb2YgY3JlYXRpb24gY29uY2VybnNcbiAqIC0gRGVwZW5kZW5jeSBJbnZlcnNpb246IERlcGVuZHMgb24gc2hhcmVkIHV0aWxpdGllcyBhbmQgYWJzdHJhY3Rpb25zXG4gKiBcbiAqIEdhbWUgTG9naWM6XG4gKiAtIFZhbGlkYXRlcyBwbGF5ZXIgY2FuIGNyZWF0ZSBuZXcgYmFzZSAoc3Vic2NyaXB0aW9uIGxpbWl0cylcbiAqIC0gRmluZHMgb3B0aW1hbCBzcGF3biBsb2NhdGlvbiBpZiBub3QgcHJvdmlkZWRcbiAqIC0gQ3JlYXRlcyBiYXNlIGZyb20gdGVtcGxhdGUgd2l0aCBwcm9wZXIgc3RhdHNcbiAqIC0gSGFuZGxlcyBjb29yZGluYXRlIHZhbGlkYXRpb24gYW5kIG1hcCBzZWN0aW9uaW5nXG4gKiAtIEltcGxlbWVudHMgYnVpbGRpbmcgdGltZSBtZWNoYW5pY3NcbiAqL1xuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgcmV0dXJuIHdpdGhFcnJvckhhbmRsaW5nKGFzeW5jICgpID0+IHtcbiAgICBsb2dnZXIuaW5mbygnUHJvY2Vzc2luZyBjcmVhdGUgYmFzZSByZXF1ZXN0JywgeyBcbiAgICAgIHJlcXVlc3RJZDogZXZlbnQucmVxdWVzdENvbnRleHQ/LnJlcXVlc3RJZCxcbiAgICAgIGVudmlyb25tZW50OiBFTlZJUk9OTUVOVCBcbiAgICB9KTtcblxuICAgIC8vIFZhbGlkYXRlIHJlcXVlc3QgdXNpbmcgc2hhcmVkIHZhbGlkYXRpb24gcGF0dGVybnNcbiAgICBjb25zdCByZXF1ZXN0ID0gYXdhaXQgdmFsaWRhdGVSZXF1ZXN0PENyZWF0ZUJhc2VSZXF1ZXN0SW5wdXQ+KENyZWF0ZUJhc2VSZXF1ZXN0U2NoZW1hLCBldmVudC5ib2R5KTtcbiAgICBcbiAgICAvLyBDaGVjayBpZiBwbGF5ZXIgY2FuIGNyZWF0ZSBtb3JlIGJhc2VzIChzdWJzY3JpcHRpb24gbGltaXRzKVxuICAgIGF3YWl0IHZhbGlkYXRlUGxheWVyQmFzZUxpbWl0KHJlcXVlc3QucGxheWVySWQpO1xuICAgIFxuICAgIC8vIEdldCBiYXNlIHRlbXBsYXRlIGZvciBzdGF0cyBhbmQgcmVxdWlyZW1lbnRzXG4gICAgY29uc3QgdGVtcGxhdGUgPSBhd2FpdCBnZXRCYXNlVGVtcGxhdGUocmVxdWVzdC5iYXNlVHlwZSk7XG4gICAgXG4gICAgLy8gRGV0ZXJtaW5lIGNvb3JkaW5hdGVzICh1c2UgcHJvdmlkZWQgb3IgY2FsY3VsYXRlIHNwYXduIGxvY2F0aW9uKVxuICAgIGNvbnN0IGNvb3JkaW5hdGVzID0gcmVxdWVzdC5jb29yZGluYXRlcyA/PyBhd2FpdCBjYWxjdWxhdGVTcGF3bkNvb3JkaW5hdGVzKHJlcXVlc3Quc3Bhd25Mb2NhdGlvbklkKTtcbiAgICBcbiAgICAvLyBDcmVhdGUgdGhlIG5ldyBiYXNlXG4gICAgY29uc3QgbmV3QmFzZSA9IGF3YWl0IGNyZWF0ZVBsYXllckJhc2UocmVxdWVzdCwgdGVtcGxhdGUsIGNvb3JkaW5hdGVzKTtcbiAgICBcbiAgICBsb2dnZXIuaW5mbygnQmFzZSBjcmVhdGVkIHN1Y2Nlc3NmdWxseScsIHtcbiAgICAgIHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLFxuICAgICAgYmFzZUlkOiBuZXdCYXNlLmJhc2VJZCxcbiAgICAgIGJhc2VUeXBlOiByZXF1ZXN0LmJhc2VUeXBlLFxuICAgICAgY29vcmRpbmF0ZXNcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDEsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKidcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBiYXNlOiBuZXdCYXNlLFxuICAgICAgICAgIGJ1aWxkVGltZTogdGVtcGxhdGUuYnVpbGRUaW1lLFxuICAgICAgICAgIG1lc3NhZ2U6ICdCYXNlIGNyZWF0aW9uIGluaXRpYXRlZCBzdWNjZXNzZnVsbHknXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfTtcbiAgfSwgbG9nZ2VyKTtcbn07XG5cbi8qKlxuICogVmFsaWRhdGUgcGxheWVyIGJhc2UgY3JlYXRpb24gbGltaXRzIGJhc2VkIG9uIHN1YnNjcmlwdGlvbiBzdGF0dXNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gdmFsaWRhdGVQbGF5ZXJCYXNlTGltaXQocGxheWVySWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICB0cnkge1xuICAgIC8vIFF1ZXJ5IGV4aXN0aW5nIGJhc2VzIGZvciBwbGF5ZXJcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFBMQVlFUl9CQVNFU19UQUJMRSxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwbGF5ZXJJZCA9IDpwbGF5ZXJJZCcsXG4gICAgICBGaWx0ZXJFeHByZXNzaW9uOiAnI3N0YXR1cyA8PiA6ZGVzdHJveWVkJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAnI3N0YXR1cyc6ICdzdGF0dXMnXG4gICAgICB9LFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOnBsYXllcklkJzogcGxheWVySWQsXG4gICAgICAgICc6ZGVzdHJveWVkJzogJ2Rlc3Ryb3llZCdcbiAgICAgIH0sXG4gICAgICBTZWxlY3Q6ICdDT1VOVCdcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgY29uc3QgY3VycmVudEJhc2VDb3VudCA9IHJlc3BvbnNlLkNvdW50ID8/IDA7XG5cbiAgICAvLyBUT0RPOiBHZXQgcGxheWVyIHN1YnNjcmlwdGlvbiBzdGF0dXMgZnJvbSBwbGF5ZXIgc2VydmljZVxuICAgIGNvbnN0IG1heEJhc2VzID0gNTsgLy8gRGVmYXVsdCBmb3IgZnJlZSBwbGF5ZXJzLCAxMCBmb3Igc3Vic2NyaWJlcnNcbiAgICBcbiAgICBpZiAoY3VycmVudEJhc2VDb3VudCA+PSBtYXhCYXNlcykge1xuICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgYFBsYXllciBoYXMgcmVhY2hlZCBtYXhpbXVtIGJhc2UgbGltaXQgKCR7bWF4QmFzZXN9KWAsXG4gICAgICAgICdCQVNFX0xJTUlUX0VYQ0VFREVEJyxcbiAgICAgICAgeyBwbGF5ZXJJZCwgY3VycmVudENvdW50OiBjdXJyZW50QmFzZUNvdW50LCBtYXhCYXNlcyB9XG4gICAgICApO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBHYW1lRW5naW5lRXJyb3IpIHtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgJ0ZhaWxlZCB0byB2YWxpZGF0ZSBwbGF5ZXIgYmFzZSBsaW1pdCcsXG4gICAgICAnVkFMSURBVElPTl9FUlJPUicsXG4gICAgICB7IHBsYXllcklkLCBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIH1cbiAgICApO1xuICB9XG59XG5cbi8qKlxuICogR2V0IGJhc2UgdGVtcGxhdGUgd2l0aCBzdGF0cyBhbmQgcmVxdWlyZW1lbnRzXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldEJhc2VUZW1wbGF0ZShiYXNlVHlwZTogc3RyaW5nKTogUHJvbWlzZTxCYXNlVGVtcGxhdGU+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBCQVNFX1RFTVBMQVRFU19UQUJMRSxcbiAgICAgIEtleToge1xuICAgICAgICB0ZW1wbGF0ZUlkOiBgJHtiYXNlVHlwZX0tbGV2ZWwtMWAgLy8gU3RhcnQgd2l0aCBsZXZlbCAxIHRlbXBsYXRlXG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIFxuICAgIGlmICghcmVzcG9uc2UuSXRlbSkge1xuICAgICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICAgYEJhc2UgdGVtcGxhdGUgbm90IGZvdW5kIGZvciB0eXBlOiAke2Jhc2VUeXBlfWAsXG4gICAgICAgICdURU1QTEFURV9OT1RfRk9VTkQnLFxuICAgICAgICB7IGJhc2VUeXBlIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3BvbnNlLkl0ZW0gYXMgQmFzZVRlbXBsYXRlO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEdhbWVFbmdpbmVFcnJvcikge1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIHJldHJpZXZlIGJhc2UgdGVtcGxhdGUnLFxuICAgICAgJ1RFTVBMQVRFX1JFVFJJRVZBTF9FUlJPUicsXG4gICAgICB7IGJhc2VUeXBlLCBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIH1cbiAgICApO1xuICB9XG59XG5cbi8qKlxuICogQ2FsY3VsYXRlIHNwYXduIGNvb3JkaW5hdGVzIGZvciBuZXcgYmFzZVxuICovXG5hc3luYyBmdW5jdGlvbiBjYWxjdWxhdGVTcGF3bkNvb3JkaW5hdGVzKHNwYXduTG9jYXRpb25JZD86IHN0cmluZyk6IFByb21pc2U8Q29vcmRpbmF0ZXM+IHtcbiAgdHJ5IHtcbiAgICBpZiAoc3Bhd25Mb2NhdGlvbklkKSB7XG4gICAgICAvLyBVc2Ugc3BlY2lmaWMgc3Bhd24gbG9jYXRpb25cbiAgICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogU1BBV05fTE9DQVRJT05TX1RBQkxFLFxuICAgICAgICBLZXk6IHtcbiAgICAgICAgICBzcGF3blJlZ2lvbklkOiAnZGVmYXVsdCcsXG4gICAgICAgICAgc3Bhd25Mb2NhdGlvbklkOiBzcGF3bkxvY2F0aW9uSWRcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgICBjb25zdCBpdGVtID0gcmVzcG9uc2UuSXRlbSBhcyBTcGF3bkxvY2F0aW9uIHwgdW5kZWZpbmVkO1xuICAgICAgXG4gICAgICBpZiAoIWl0ZW0/LmlzQXZhaWxhYmxlKSB7XG4gICAgICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAgICAgJ1NwYXduIGxvY2F0aW9uIG5vdCBhdmFpbGFibGUnLFxuICAgICAgICAgICdTUEFXTl9MT0NBVElPTl9VTkFWQUlMQUJMRScsXG4gICAgICAgICAgeyBzcGF3bkxvY2F0aW9uSWQgfVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICB4OiBpdGVtLmNvb3JkaW5hdGVzLngsXG4gICAgICAgIHk6IGl0ZW0uY29vcmRpbmF0ZXMueVxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBHZW5lcmF0ZSByYW5kb20gY29vcmRpbmF0ZXMgaW4gc3RhcnRlciByZWdpb25cbiAgICAvLyBUT0RPOiBJbXBsZW1lbnQgcHJvcGVyIHNwYXduIGxvY2F0aW9uIGFsZ29yaXRobSBiYXNlZCBvbiBwb3B1bGF0aW9uIGRlbnNpdHlcbiAgICBjb25zdCBzcGF3blJhZGl1cyA9IDEwMDA7IC8vIDEwMDAgdW5pdCByYWRpdXMgZm9yIG5ldyBwbGF5ZXJzXG4gICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogMiAqIE1hdGguUEk7XG4gICAgY29uc3QgZGlzdGFuY2UgPSBNYXRoLnJhbmRvbSgpICogc3Bhd25SYWRpdXM7XG4gICAgXG4gICAgcmV0dXJuIHtcbiAgICAgIHg6IE1hdGguZmxvb3IoTWF0aC5jb3MoYW5nbGUpICogZGlzdGFuY2UpLFxuICAgICAgeTogTWF0aC5mbG9vcihNYXRoLnNpbihhbmdsZSkgKiBkaXN0YW5jZSlcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEdhbWVFbmdpbmVFcnJvcikge1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIGNhbGN1bGF0ZSBzcGF3biBjb29yZGluYXRlcycsXG4gICAgICAnU1BBV05fQ0FMQ1VMQVRJT05fRVJST1InLFxuICAgICAgeyBzcGF3bkxvY2F0aW9uSWQsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuLyoqXG4gKiBDcmVhdGUgdGhlIHBsYXllciBiYXNlIHJlY29yZFxuICovXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVQbGF5ZXJCYXNlKFxuICByZXF1ZXN0OiBDcmVhdGVCYXNlUmVxdWVzdElucHV0LCBcbiAgdGVtcGxhdGU6IEJhc2VUZW1wbGF0ZSwgXG4gIGNvb3JkaW5hdGVzOiBDb29yZGluYXRlc1xuKTogUHJvbWlzZTxQbGF5ZXJCYXNlPiB7XG4gIHRyeSB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCBiYXNlSWQgPSB1dWlkdjQoKTtcbiAgICBcbiAgICAvLyBDYWxjdWxhdGUgbWFwIHNlY3Rpb24gZm9yIGluZGV4aW5nIChkaXZpZGUgY29vcmRpbmF0ZXMgaW50byAxMDB4MTAwIHNlY3Rpb25zKVxuICAgIGNvbnN0IG1hcFNlY3Rpb25JZCA9IGAke01hdGguZmxvb3IoY29vcmRpbmF0ZXMueCAvIDEwMCl9LCR7TWF0aC5mbG9vcihjb29yZGluYXRlcy55IC8gMTAwKX1gO1xuICAgIGNvbnN0IGNvb3JkaW5hdGVIYXNoID0gYCR7Y29vcmRpbmF0ZXMueH0sJHtjb29yZGluYXRlcy55fWA7XG5cbiAgICBjb25zdCBuZXdCYXNlOiBQbGF5ZXJCYXNlID0ge1xuICAgICAgcGxheWVySWQ6IHJlcXVlc3QucGxheWVySWQsXG4gICAgICBiYXNlSWQ6IGJhc2VJZCxcbiAgICAgIGJhc2VUeXBlOiByZXF1ZXN0LmJhc2VUeXBlLFxuICAgICAgYmFzZU5hbWU6IHJlcXVlc3QuYmFzZU5hbWUsXG4gICAgICBsZXZlbDogMSxcbiAgICAgIGNvb3JkaW5hdGVzOiBjb29yZGluYXRlcyxcbiAgICAgIG1hcFNlY3Rpb25JZDogbWFwU2VjdGlvbklkLFxuICAgICAgY29vcmRpbmF0ZUhhc2g6IGNvb3JkaW5hdGVIYXNoLFxuICAgICAgYWxsaWFuY2VJZDogcmVxdWVzdC5hbGxpYW5jZUlkLFxuICAgICAgc3RhdHVzOiB0ZW1wbGF0ZS5idWlsZFRpbWUgPiAwID8gJ2J1aWxkaW5nJyA6ICdhY3RpdmUnLFxuICAgICAgc3RhdHM6IHtcbiAgICAgICAgZGVmZW5zZTogdGVtcGxhdGUuc3RhdHMuZGVmZW5zZSxcbiAgICAgICAgc3RvcmFnZTogdGVtcGxhdGUuc3RhdHMuc3RvcmFnZSxcbiAgICAgICAgcHJvZHVjdGlvbjogdGVtcGxhdGUuc3RhdHMucHJvZHVjdGlvblxuICAgICAgfSxcbiAgICAgIGNyZWF0ZWRBdDogbm93LFxuICAgICAgbGFzdEFjdGl2ZUF0OiBub3csXG4gICAgICBidWlsZENvbXBsZXRpb25UaW1lOiB0ZW1wbGF0ZS5idWlsZFRpbWUgPiAwID8gbm93ICsgKHRlbXBsYXRlLmJ1aWxkVGltZSAqIDEwMDApIDogdW5kZWZpbmVkXG4gICAgfTtcblxuICAgIC8vIFN0b3JlIGJhc2UgaW4gRHluYW1vREJcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFB1dENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBQTEFZRVJfQkFTRVNfVEFCTEUsXG4gICAgICBJdGVtOiBuZXdCYXNlLFxuICAgICAgQ29uZGl0aW9uRXhwcmVzc2lvbjogJ2F0dHJpYnV0ZV9ub3RfZXhpc3RzKHBsYXllcklkKSBBTkQgYXR0cmlidXRlX25vdF9leGlzdHMoYmFzZUlkKSdcbiAgICB9KTtcblxuICAgIGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuXG4gICAgcmV0dXJuIG5ld0Jhc2U7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICdGYWlsZWQgdG8gY3JlYXRlIHBsYXllciBiYXNlJyxcbiAgICAgICdCQVNFX0NSRUFUSU9OX0VSUk9SJyxcbiAgICAgIHsgXG4gICAgICAgIHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLCBcbiAgICAgICAgYmFzZVR5cGU6IHJlcXVlc3QuYmFzZVR5cGUsXG4gICAgICAgIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgXG4gICAgICB9XG4gICAgKTtcbiAgfVxufSJdfQ==