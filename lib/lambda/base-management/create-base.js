"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const shared_mocks_1 = require("../../lib/shared-mocks");
const zod_1 = require("zod");
const uuid_1 = require("uuid");
// Initialize AWS clients following shared patterns
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const logger = new shared_mocks_1.StructuredLogger('CreateBaseHandler');
// Environment variables
const PLAYER_BASES_TABLE = process.env.PLAYER_BASES_TABLE;
const BASE_TEMPLATES_TABLE = process.env.BASE_TEMPLATES_TABLE;
const SPAWN_LOCATIONS_TABLE = process.env.SPAWN_LOCATIONS_TABLE;
const ENVIRONMENT = process.env.ENVIRONMENT;
// Request validation schema following shared-js-utils patterns
const CreateBaseRequestSchema = zod_1.z.object({
    playerId: zod_1.z.string().min(1).max(50),
    baseType: zod_1.z.enum(['command_center', 'outpost', 'fortress', 'mining_station', 'research_lab']),
    baseName: zod_1.z.string().min(1).max(100),
    coordinates: zod_1.z.object({
        x: zod_1.z.number().min(-1000000).max(1000000),
        y: zod_1.z.number().min(-1000000).max(1000000)
    }).optional(),
    spawnLocationId: zod_1.z.string().optional(),
    allianceId: zod_1.z.string().optional()
});
/**
 * Create Base Handler
 *
 * Implements base creation following SOLID principles:
 * - Single Responsibility: Only handles base creation logic
 * - Open/Closed: Extensible for new base types via templates
 * - Liskov Substitution: All base types follow same creation pattern
 * - Interface Segregation: Clear separation of creation concerns
 * - Dependency Inversion: Depends on shared utilities and abstractions
 *
 * Game Logic:
 * - Validates player can create new base (subscription limits)
 * - Finds optimal spawn location if not provided
 * - Creates base from template with proper stats
 * - Handles coordinate validation and map sectioning
 * - Implements building time mechanics
 */
const handler = async (event) => {
    return (0, shared_mocks_1.withErrorHandling)(async () => {
        logger.info('Processing create base request', {
            requestId: event.requestContext?.requestId,
            environment: ENVIRONMENT
        });
        // Validate request using shared validation patterns
        const request = await (0, shared_mocks_1.validateRequest)(CreateBaseRequestSchema, event.body);
        // Check if player can create more bases (subscription limits)
        await validatePlayerBaseLimit(request.playerId);
        // Get base template for stats and requirements
        const template = await getBaseTemplate(request.baseType);
        // Determine coordinates (use provided or calculate spawn location)
        const coordinates = request.coordinates || await calculateSpawnCoordinates(request.spawnLocationId);
        // Create the new base
        const newBase = await createPlayerBase(request, template, coordinates);
        logger.info('Base created successfully', {
            playerId: request.playerId,
            baseId: newBase.baseId,
            baseType: request.baseType,
            coordinates
        });
        return {
            statusCode: 201,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                success: true,
                data: {
                    base: newBase,
                    buildTime: template.buildTime,
                    message: 'Base creation initiated successfully'
                }
            })
        };
    }, logger);
};
exports.handler = handler;
/**
 * Validate player base creation limits based on subscription status
 */
async function validatePlayerBaseLimit(playerId) {
    try {
        // Query existing bases for player
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: PLAYER_BASES_TABLE,
            KeyConditionExpression: 'playerId = :playerId',
            FilterExpression: '#status <> :destroyed',
            ExpressionAttributeNames: {
                '#status': 'status'
            },
            ExpressionAttributeValues: {
                ':playerId': playerId,
                ':destroyed': 'destroyed'
            },
            Select: 'COUNT'
        });
        const response = await docClient.send(command);
        const currentBaseCount = response.Count || 0;
        // TODO: Get player subscription status from player service
        const maxBases = 5; // Default for free players, 10 for subscribers
        if (currentBaseCount >= maxBases) {
            throw new shared_mocks_1.GameEngineError(`Player has reached maximum base limit (${maxBases})`, 'BASE_LIMIT_EXCEEDED', { playerId, currentCount: currentBaseCount, maxBases });
        }
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError) {
            throw error;
        }
        throw new shared_mocks_1.GameEngineError('Failed to validate player base limit', 'VALIDATION_ERROR', { playerId, error: error.message });
    }
}
/**
 * Get base template with stats and requirements
 */
async function getBaseTemplate(baseType) {
    try {
        const command = new lib_dynamodb_1.GetCommand({
            TableName: BASE_TEMPLATES_TABLE,
            Key: {
                templateId: `${baseType}-level-1` // Start with level 1 template
            }
        });
        const response = await docClient.send(command);
        if (!response.Item) {
            throw new shared_mocks_1.GameEngineError(`Base template not found for type: ${baseType}`, 'TEMPLATE_NOT_FOUND', { baseType });
        }
        return response.Item;
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError) {
            throw error;
        }
        throw new shared_mocks_1.GameEngineError('Failed to retrieve base template', 'TEMPLATE_RETRIEVAL_ERROR', { baseType, error: error.message });
    }
}
/**
 * Calculate spawn coordinates for new base
 */
async function calculateSpawnCoordinates(spawnLocationId) {
    try {
        if (spawnLocationId) {
            // Use specific spawn location
            const command = new lib_dynamodb_1.GetCommand({
                TableName: SPAWN_LOCATIONS_TABLE,
                Key: {
                    spawnRegionId: 'default',
                    spawnLocationId: spawnLocationId
                }
            });
            const response = await docClient.send(command);
            if (!response.Item || !response.Item.isAvailable) {
                throw new shared_mocks_1.GameEngineError('Spawn location not available', 'SPAWN_LOCATION_UNAVAILABLE', { spawnLocationId });
            }
            return {
                x: response.Item.coordinates.x,
                y: response.Item.coordinates.y
            };
        }
        // Generate random coordinates in starter region
        // TODO: Implement proper spawn location algorithm based on population density
        const spawnRadius = 1000; // 1000 unit radius for new players
        const angle = Math.random() * 2 * Math.PI;
        const distance = Math.random() * spawnRadius;
        return {
            x: Math.floor(Math.cos(angle) * distance),
            y: Math.floor(Math.sin(angle) * distance)
        };
    }
    catch (error) {
        if (error instanceof shared_mocks_1.GameEngineError) {
            throw error;
        }
        throw new shared_mocks_1.GameEngineError('Failed to calculate spawn coordinates', 'SPAWN_CALCULATION_ERROR', { spawnLocationId, error: error.message });
    }
}
/**
 * Create the player base record
 */
async function createPlayerBase(request, template, coordinates) {
    try {
        const now = Date.now();
        const baseId = (0, uuid_1.v4)();
        // Calculate map section for indexing (divide coordinates into 100x100 sections)
        const mapSectionId = `${Math.floor(coordinates.x / 100)},${Math.floor(coordinates.y / 100)}`;
        const coordinateHash = `${coordinates.x},${coordinates.y}`;
        const newBase = {
            playerId: request.playerId,
            baseId: baseId,
            baseType: request.baseType,
            baseName: request.baseName,
            level: 1,
            coordinates: coordinates,
            mapSectionId: mapSectionId,
            coordinateHash: coordinateHash,
            allianceId: request.allianceId,
            status: template.buildTime > 0 ? 'building' : 'active',
            stats: {
                defense: template.stats.defense,
                storage: template.stats.storage,
                production: template.stats.production
            },
            createdAt: now,
            lastActiveAt: now,
            buildCompletionTime: template.buildTime > 0 ? now + (template.buildTime * 1000) : undefined
        };
        // Store base in DynamoDB
        const command = new lib_dynamodb_1.PutCommand({
            TableName: PLAYER_BASES_TABLE,
            Item: newBase,
            ConditionExpression: 'attribute_not_exists(playerId) AND attribute_not_exists(baseId)'
        });
        await docClient.send(command);
        return newBase;
    }
    catch (error) {
        throw new shared_mocks_1.GameEngineError('Failed to create player base', 'BASE_CREATION_ERROR', {
            playerId: request.playerId,
            baseType: request.baseType,
            error: error.message
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYmFzZS1tYW5hZ2VtZW50L2NyZWF0ZS1iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDhEQUEwRDtBQUMxRCx3REFBcUc7QUFDckcseURBTWdDO0FBQ2hDLDZCQUF3QjtBQUN4QiwrQkFBb0M7QUFFcEMsbURBQW1EO0FBQ25ELE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUM1QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDNUQsTUFBTSxNQUFNLEdBQUcsSUFBSSwrQkFBZ0IsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBRXpELHdCQUF3QjtBQUN4QixNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQW1CLENBQUM7QUFDM0QsTUFBTSxvQkFBb0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFxQixDQUFDO0FBQy9ELE1BQU0scUJBQXFCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBc0IsQ0FBQztBQUNqRSxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVksQ0FBQztBQUU3QywrREFBK0Q7QUFDL0QsTUFBTSx1QkFBdUIsR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3ZDLFFBQVEsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7SUFDbkMsUUFBUSxFQUFFLE9BQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLGdCQUFnQixFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBQzdGLFFBQVEsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxD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SSx5QkFBVSxDQUFDO1lBQzdCLFNBQVMsRUFBRSxrQkFBa0I7WUFDN0IsSUFBSSxFQUFFLE9BQU87WUFDYixtQkFBbUIsRUFBRSxpRUFBaUU7U0FDdkYsQ0FBQyxDQUFDO1FBRUgsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRTlCLE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsTUFBTSxJQUFJLDhCQUFlLENBQ3ZCLDhCQUE4QixFQUM5QixxQkFBcUIsRUFDckI7WUFDRSxRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7WUFDMUIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxRQUFRO1lBQzFCLEtBQUssRUFBRyxLQUFlLENBQUMsT0FBTztTQUNoQyxDQUNGLENBQUM7SUFDSixDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFB1dENvbW1hbmQsIFF1ZXJ5Q29tbWFuZCwgR2V0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBcbiAgU3RydWN0dXJlZExvZ2dlciwgXG4gIEdhbWVFbmdpbmVFcnJvcixcbiAgd2l0aEVycm9ySGFuZGxpbmcsXG4gIHZhbGlkYXRlUmVxdWVzdCxcbiAgcHVibGlzaEN1c3RvbU1ldHJpYyBcbn0gZnJvbSAnLi4vLi4vbGliL3NoYXJlZC1tb2Nrcyc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuXG4vLyBJbml0aWFsaXplIEFXUyBjbGllbnRzIGZvbGxvd2luZyBzaGFyZWQgcGF0dGVybnNcbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vQ2xpZW50KTtcbmNvbnN0IGxvZ2dlciA9IG5ldyBTdHJ1Y3R1cmVkTG9nZ2VyKCdDcmVhdGVCYXNlSGFuZGxlcicpO1xuXG4vLyBFbnZpcm9ubWVudCB2YXJpYWJsZXNcbmNvbnN0IFBMQVlFUl9CQVNFU19UQUJMRSA9IHByb2Nlc3MuZW52LlBMQVlFUl9CQVNFU19UQUJMRSE7XG5jb25zdCBCQVNFX1RFTVBMQVRFU19UQUJMRSA9IHByb2Nlc3MuZW52LkJBU0VfVEVNUExBVEVTX1RBQkxFITtcbmNvbnN0IFNQQVdOX0xPQ0FUSU9OU19UQUJMRSA9IHByb2Nlc3MuZW52LlNQQVdOX0xPQ0FUSU9OU19UQUJMRSE7XG5jb25zdCBFTlZJUk9OTUVOVCA9IHByb2Nlc3MuZW52LkVOVklST05NRU5UITtcblxuLy8gUmVxdWVzdCB2YWxpZGF0aW9uIHNjaGVtYSBmb2xsb3dpbmcgc2hhcmVkLWpzLXV0aWxzIHBhdHRlcm5zXG5jb25zdCBDcmVhdGVCYXNlUmVxdWVzdFNjaGVtYSA9IHoub2JqZWN0KHtcbiAgcGxheWVySWQ6IHouc3RyaW5nKCkubWluKDEpLm1heCg1MCksXG4gIGJhc2VUeXBlOiB6LmVudW0oWydjb21tYW5kX2NlbnRlcicsICdvdXRwb3N0JywgJ2ZvcnRyZXNzJywgJ21pbmluZ19zdGF0aW9uJywgJ3Jlc2VhcmNoX2xhYiddKSxcbiAgYmFzZU5hbWU6IHouc3RyaW5nKCkubWluKDEpLm1heCgxMDApLFxuICBjb29yZGluYXRlczogei5vYmplY3Qoe1xuICAgIHg6IHoubnVtYmVyKCkubWluKC0xMDAwMDAwKS5tYXgoMTAwMDAwMCksXG4gICAgeTogei5udW1iZXIoKS5taW4oLTEwMDAwMDApLm1heCgxMDAwMDAwKVxuICB9KS5vcHRpb25hbCgpLFxuICBzcGF3bkxvY2F0aW9uSWQ6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgYWxsaWFuY2VJZDogei5zdHJpbmcoKS5vcHRpb25hbCgpXG59KTtcblxudHlwZSBDcmVhdGVCYXNlUmVxdWVzdCA9IHouaW5mZXI8dHlwZW9mIENyZWF0ZUJhc2VSZXF1ZXN0U2NoZW1hPjtcblxuaW50ZXJmYWNlIEJhc2VUZW1wbGF0ZSB7XG4gIHRlbXBsYXRlSWQ6IHN0cmluZztcbiAgYmFzZVR5cGU6IHN0cmluZztcbiAgbGV2ZWw6IG51bWJlcjtcbiAgcmVxdWlyZW1lbnRzOiB7XG4gICAgcmVzb3VyY2VzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+O1xuICAgIHBsYXllckxldmVsOiBudW1iZXI7XG4gIH07XG4gIHN0YXRzOiB7XG4gICAgZGVmZW5zZTogbnVtYmVyO1xuICAgIHN0b3JhZ2U6IG51bWJlcjtcbiAgICBwcm9kdWN0aW9uOiBudW1iZXI7XG4gIH07XG4gIGJ1aWxkVGltZTogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgUGxheWVyQmFzZSB7XG4gIHBsYXllcklkOiBzdHJpbmc7XG4gIGJhc2VJZDogc3RyaW5nO1xuICBiYXNlVHlwZTogc3RyaW5nO1xuICBiYXNlTmFtZTogc3RyaW5nO1xuICBsZXZlbDogbnVtYmVyO1xuICBjb29yZGluYXRlczoge1xuICAgIHg6IG51bWJlcjtcbiAgICB5OiBudW1iZXI7XG4gIH07XG4gIG1hcFNlY3Rpb25JZDogc3RyaW5nO1xuICBjb29yZGluYXRlSGFzaDogc3RyaW5nO1xuICBhbGxpYW5jZUlkPzogc3RyaW5nO1xuICBzdGF0dXM6ICdhY3RpdmUnIHwgJ2J1aWxkaW5nJyB8ICdtb3ZpbmcnIHwgJ2Rlc3Ryb3llZCc7XG4gIHN0YXRzOiB7XG4gICAgZGVmZW5zZTogbnVtYmVyO1xuICAgIHN0b3JhZ2U6IG51bWJlcjtcbiAgICBwcm9kdWN0aW9uOiBudW1iZXI7XG4gIH07XG4gIGNyZWF0ZWRBdDogbnVtYmVyO1xuICBsYXN0QWN0aXZlQXQ6IG51bWJlcjtcbiAgYnVpbGRDb21wbGV0aW9uVGltZT86IG51bWJlcjtcbiAgdHRsPzogbnVtYmVyO1xufVxuXG4vKipcbiAqIENyZWF0ZSBCYXNlIEhhbmRsZXJcbiAqIFxuICogSW1wbGVtZW50cyBiYXNlIGNyZWF0aW9uIGZvbGxvd2luZyBTT0xJRCBwcmluY2lwbGVzOlxuICogLSBTaW5nbGUgUmVzcG9uc2liaWxpdHk6IE9ubHkgaGFuZGxlcyBiYXNlIGNyZWF0aW9uIGxvZ2ljXG4gKiAtIE9wZW4vQ2xvc2VkOiBFeHRlbnNpYmxlIGZvciBuZXcgYmFzZSB0eXBlcyB2aWEgdGVtcGxhdGVzXG4gKiAtIExpc2tvdiBTdWJzdGl0dXRpb246IEFsbCBiYXNlIHR5cGVzIGZvbGxvdyBzYW1lIGNyZWF0aW9uIHBhdHRlcm5cbiAqIC0gSW50ZXJmYWNlIFNlZ3JlZ2F0aW9uOiBDbGVhciBzZXBhcmF0aW9uIG9mIGNyZWF0aW9uIGNvbmNlcm5zXG4gKiAtIERlcGVuZGVuY3kgSW52ZXJzaW9uOiBEZXBlbmRzIG9uIHNoYXJlZCB1dGlsaXRpZXMgYW5kIGFic3RyYWN0aW9uc1xuICogXG4gKiBHYW1lIExvZ2ljOlxuICogLSBWYWxpZGF0ZXMgcGxheWVyIGNhbiBjcmVhdGUgbmV3IGJhc2UgKHN1YnNjcmlwdGlvbiBsaW1pdHMpXG4gKiAtIEZpbmRzIG9wdGltYWwgc3Bhd24gbG9jYXRpb24gaWYgbm90IHByb3ZpZGVkXG4gKiAtIENyZWF0ZXMgYmFzZSBmcm9tIHRlbXBsYXRlIHdpdGggcHJvcGVyIHN0YXRzXG4gKiAtIEhhbmRsZXMgY29vcmRpbmF0ZSB2YWxpZGF0aW9uIGFuZCBtYXAgc2VjdGlvbmluZ1xuICogLSBJbXBsZW1lbnRzIGJ1aWxkaW5nIHRpbWUgbWVjaGFuaWNzXG4gKi9cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIHJldHVybiB3aXRoRXJyb3JIYW5kbGluZyhhc3luYyAoKSA9PiB7XG4gICAgbG9nZ2VyLmluZm8oJ1Byb2Nlc3NpbmcgY3JlYXRlIGJhc2UgcmVxdWVzdCcsIHsgXG4gICAgICByZXF1ZXN0SWQ6IGV2ZW50LnJlcXVlc3RDb250ZXh0Py5yZXF1ZXN0SWQsXG4gICAgICBlbnZpcm9ubWVudDogRU5WSVJPTk1FTlQgXG4gICAgfSk7XG5cbiAgICAvLyBWYWxpZGF0ZSByZXF1ZXN0IHVzaW5nIHNoYXJlZCB2YWxpZGF0aW9uIHBhdHRlcm5zXG4gICAgY29uc3QgcmVxdWVzdCA9IGF3YWl0IHZhbGlkYXRlUmVxdWVzdDxDcmVhdGVCYXNlUmVxdWVzdD4oQ3JlYXRlQmFzZVJlcXVlc3RTY2hlbWEsIGV2ZW50LmJvZHkpO1xuICAgIFxuICAgIC8vIENoZWNrIGlmIHBsYXllciBjYW4gY3JlYXRlIG1vcmUgYmFzZXMgKHN1YnNjcmlwdGlvbiBsaW1pdHMpXG4gICAgYXdhaXQgdmFsaWRhdGVQbGF5ZXJCYXNlTGltaXQocmVxdWVzdC5wbGF5ZXJJZCk7XG4gICAgXG4gICAgLy8gR2V0IGJhc2UgdGVtcGxhdGUgZm9yIHN0YXRzIGFuZCByZXF1aXJlbWVudHNcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IGF3YWl0IGdldEJhc2VUZW1wbGF0ZShyZXF1ZXN0LmJhc2VUeXBlKTtcbiAgICBcbiAgICAvLyBEZXRlcm1pbmUgY29vcmRpbmF0ZXMgKHVzZSBwcm92aWRlZCBvciBjYWxjdWxhdGUgc3Bhd24gbG9jYXRpb24pXG4gICAgY29uc3QgY29vcmRpbmF0ZXMgPSByZXF1ZXN0LmNvb3JkaW5hdGVzIHx8IGF3YWl0IGNhbGN1bGF0ZVNwYXduQ29vcmRpbmF0ZXMocmVxdWVzdC5zcGF3bkxvY2F0aW9uSWQpO1xuICAgIFxuICAgIC8vIENyZWF0ZSB0aGUgbmV3IGJhc2VcbiAgICBjb25zdCBuZXdCYXNlID0gYXdhaXQgY3JlYXRlUGxheWVyQmFzZShyZXF1ZXN0LCB0ZW1wbGF0ZSwgY29vcmRpbmF0ZXMpO1xuICAgIFxuICAgIGxvZ2dlci5pbmZvKCdCYXNlIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5Jywge1xuICAgICAgcGxheWVySWQ6IHJlcXVlc3QucGxheWVySWQsXG4gICAgICBiYXNlSWQ6IG5ld0Jhc2UuYmFzZUlkLFxuICAgICAgYmFzZVR5cGU6IHJlcXVlc3QuYmFzZVR5cGUsXG4gICAgICBjb29yZGluYXRlc1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMSxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJ1xuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGJhc2U6IG5ld0Jhc2UsXG4gICAgICAgICAgYnVpbGRUaW1lOiB0ZW1wbGF0ZS5idWlsZFRpbWUsXG4gICAgICAgICAgbWVzc2FnZTogJ0Jhc2UgY3JlYXRpb24gaW5pdGlhdGVkIHN1Y2Nlc3NmdWxseSdcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9O1xuICB9LCBsb2dnZXIpO1xufTtcblxuLyoqXG4gKiBWYWxpZGF0ZSBwbGF5ZXIgYmFzZSBjcmVhdGlvbiBsaW1pdHMgYmFzZWQgb24gc3Vic2NyaXB0aW9uIHN0YXR1c1xuICovXG5hc3luYyBmdW5jdGlvbiB2YWxpZGF0ZVBsYXllckJhc2VMaW1pdChwbGF5ZXJJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gIHRyeSB7XG4gICAgLy8gUXVlcnkgZXhpc3RpbmcgYmFzZXMgZm9yIHBsYXllclxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogUExBWUVSX0JBU0VTX1RBQkxFLFxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ3BsYXllcklkID0gOnBsYXllcklkJyxcbiAgICAgIEZpbHRlckV4cHJlc3Npb246ICcjc3RhdHVzIDw+IDpkZXN0cm95ZWQnLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICcjc3RhdHVzJzogJ3N0YXR1cydcbiAgICAgIH0sXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6cGxheWVySWQnOiBwbGF5ZXJJZCxcbiAgICAgICAgJzpkZXN0cm95ZWQnOiAnZGVzdHJveWVkJ1xuICAgICAgfSxcbiAgICAgIFNlbGVjdDogJ0NPVU5UJ1xuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBjb25zdCBjdXJyZW50QmFzZUNvdW50ID0gcmVzcG9uc2UuQ291bnQgfHwgMDtcblxuICAgIC8vIFRPRE86IEdldCBwbGF5ZXIgc3Vic2NyaXB0aW9uIHN0YXR1cyBmcm9tIHBsYXllciBzZXJ2aWNlXG4gICAgY29uc3QgbWF4QmFzZXMgPSA1OyAvLyBEZWZhdWx0IGZvciBmcmVlIHBsYXllcnMsIDEwIGZvciBzdWJzY3JpYmVyc1xuICAgIFxuICAgIGlmIChjdXJyZW50QmFzZUNvdW50ID49IG1heEJhc2VzKSB7XG4gICAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgICBgUGxheWVyIGhhcyByZWFjaGVkIG1heGltdW0gYmFzZSBsaW1pdCAoJHttYXhCYXNlc30pYCxcbiAgICAgICAgJ0JBU0VfTElNSVRfRVhDRUVERUQnLFxuICAgICAgICB7IHBsYXllcklkLCBjdXJyZW50Q291bnQ6IGN1cnJlbnRCYXNlQ291bnQsIG1heEJhc2VzIH1cbiAgICAgICk7XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEdhbWVFbmdpbmVFcnJvcikge1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICAgIHRocm93IG5ldyBHYW1lRW5naW5lRXJyb3IoXG4gICAgICAnRmFpbGVkIHRvIHZhbGlkYXRlIHBsYXllciBiYXNlIGxpbWl0JyxcbiAgICAgICdWQUxJREFUSU9OX0VSUk9SJyxcbiAgICAgIHsgcGxheWVySWQsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuLyoqXG4gKiBHZXQgYmFzZSB0ZW1wbGF0ZSB3aXRoIHN0YXRzIGFuZCByZXF1aXJlbWVudHNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZ2V0QmFzZVRlbXBsYXRlKGJhc2VUeXBlOiBzdHJpbmcpOiBQcm9taXNlPEJhc2VUZW1wbGF0ZT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IEJBU0VfVEVNUExBVEVTX1RBQkxFLFxuICAgICAgS2V5OiB7XG4gICAgICAgIHRlbXBsYXRlSWQ6IGAke2Jhc2VUeXBlfS1sZXZlbC0xYCAvLyBTdGFydCB3aXRoIGxldmVsIDEgdGVtcGxhdGVcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgXG4gICAgaWYgKCFyZXNwb25zZS5JdGVtKSB7XG4gICAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgICBgQmFzZSB0ZW1wbGF0ZSBub3QgZm91bmQgZm9yIHR5cGU6ICR7YmFzZVR5cGV9YCxcbiAgICAgICAgJ1RFTVBMQVRFX05PVF9GT1VORCcsXG4gICAgICAgIHsgYmFzZVR5cGUgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzcG9uc2UuSXRlbSBhcyBCYXNlVGVtcGxhdGU7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgR2FtZUVuZ2luZUVycm9yKSB7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICdGYWlsZWQgdG8gcmV0cmlldmUgYmFzZSB0ZW1wbGF0ZScsXG4gICAgICAnVEVNUExBVEVfUkVUUklFVkFMX0VSUk9SJyxcbiAgICAgIHsgYmFzZVR5cGUsIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICk7XG4gIH1cbn1cblxuLyoqXG4gKiBDYWxjdWxhdGUgc3Bhd24gY29vcmRpbmF0ZXMgZm9yIG5ldyBiYXNlXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGNhbGN1bGF0ZVNwYXduQ29vcmRpbmF0ZXMoc3Bhd25Mb2NhdGlvbklkPzogc3RyaW5nKTogUHJvbWlzZTx7IHg6IG51bWJlcjsgeTogbnVtYmVyIH0+IHtcbiAgdHJ5IHtcbiAgICBpZiAoc3Bhd25Mb2NhdGlvbklkKSB7XG4gICAgICAvLyBVc2Ugc3BlY2lmaWMgc3Bhd24gbG9jYXRpb25cbiAgICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogU1BBV05fTE9DQVRJT05TX1RBQkxFLFxuICAgICAgICBLZXk6IHtcbiAgICAgICAgICBzcGF3blJlZ2lvbklkOiAnZGVmYXVsdCcsXG4gICAgICAgICAgc3Bhd25Mb2NhdGlvbklkOiBzcGF3bkxvY2F0aW9uSWRcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgICBcbiAgICAgIGlmICghcmVzcG9uc2UuSXRlbSB8fCAhcmVzcG9uc2UuSXRlbS5pc0F2YWlsYWJsZSkge1xuICAgICAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgICAgICdTcGF3biBsb2NhdGlvbiBub3QgYXZhaWxhYmxlJyxcbiAgICAgICAgICAnU1BBV05fTE9DQVRJT05fVU5BVkFJTEFCTEUnLFxuICAgICAgICAgIHsgc3Bhd25Mb2NhdGlvbklkIH1cbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgeDogcmVzcG9uc2UuSXRlbS5jb29yZGluYXRlcy54LFxuICAgICAgICB5OiByZXNwb25zZS5JdGVtLmNvb3JkaW5hdGVzLnlcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gR2VuZXJhdGUgcmFuZG9tIGNvb3JkaW5hdGVzIGluIHN0YXJ0ZXIgcmVnaW9uXG4gICAgLy8gVE9ETzogSW1wbGVtZW50IHByb3BlciBzcGF3biBsb2NhdGlvbiBhbGdvcml0aG0gYmFzZWQgb24gcG9wdWxhdGlvbiBkZW5zaXR5XG4gICAgY29uc3Qgc3Bhd25SYWRpdXMgPSAxMDAwOyAvLyAxMDAwIHVuaXQgcmFkaXVzIGZvciBuZXcgcGxheWVyc1xuICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIDIgKiBNYXRoLlBJO1xuICAgIGNvbnN0IGRpc3RhbmNlID0gTWF0aC5yYW5kb20oKSAqIHNwYXduUmFkaXVzO1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICB4OiBNYXRoLmZsb29yKE1hdGguY29zKGFuZ2xlKSAqIGRpc3RhbmNlKSxcbiAgICAgIHk6IE1hdGguZmxvb3IoTWF0aC5zaW4oYW5nbGUpICogZGlzdGFuY2UpXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBHYW1lRW5naW5lRXJyb3IpIHtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgR2FtZUVuZ2luZUVycm9yKFxuICAgICAgJ0ZhaWxlZCB0byBjYWxjdWxhdGUgc3Bhd24gY29vcmRpbmF0ZXMnLFxuICAgICAgJ1NQQVdOX0NBTENVTEFUSU9OX0VSUk9SJyxcbiAgICAgIHsgc3Bhd25Mb2NhdGlvbklkLCBlcnJvcjogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIH1cbiAgICApO1xuICB9XG59XG5cbi8qKlxuICogQ3JlYXRlIHRoZSBwbGF5ZXIgYmFzZSByZWNvcmRcbiAqL1xuYXN5bmMgZnVuY3Rpb24gY3JlYXRlUGxheWVyQmFzZShcbiAgcmVxdWVzdDogQ3JlYXRlQmFzZVJlcXVlc3QsIFxuICB0ZW1wbGF0ZTogQmFzZVRlbXBsYXRlLCBcbiAgY29vcmRpbmF0ZXM6IHsgeDogbnVtYmVyOyB5OiBudW1iZXIgfVxuKTogUHJvbWlzZTxQbGF5ZXJCYXNlPiB7XG4gIHRyeSB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCBiYXNlSWQgPSB1dWlkdjQoKTtcbiAgICBcbiAgICAvLyBDYWxjdWxhdGUgbWFwIHNlY3Rpb24gZm9yIGluZGV4aW5nIChkaXZpZGUgY29vcmRpbmF0ZXMgaW50byAxMDB4MTAwIHNlY3Rpb25zKVxuICAgIGNvbnN0IG1hcFNlY3Rpb25JZCA9IGAke01hdGguZmxvb3IoY29vcmRpbmF0ZXMueCAvIDEwMCl9LCR7TWF0aC5mbG9vcihjb29yZGluYXRlcy55IC8gMTAwKX1gO1xuICAgIGNvbnN0IGNvb3JkaW5hdGVIYXNoID0gYCR7Y29vcmRpbmF0ZXMueH0sJHtjb29yZGluYXRlcy55fWA7XG5cbiAgICBjb25zdCBuZXdCYXNlOiBQbGF5ZXJCYXNlID0ge1xuICAgICAgcGxheWVySWQ6IHJlcXVlc3QucGxheWVySWQsXG4gICAgICBiYXNlSWQ6IGJhc2VJZCxcbiAgICAgIGJhc2VUeXBlOiByZXF1ZXN0LmJhc2VUeXBlLFxuICAgICAgYmFzZU5hbWU6IHJlcXVlc3QuYmFzZU5hbWUsXG4gICAgICBsZXZlbDogMSxcbiAgICAgIGNvb3JkaW5hdGVzOiBjb29yZGluYXRlcyxcbiAgICAgIG1hcFNlY3Rpb25JZDogbWFwU2VjdGlvbklkLFxuICAgICAgY29vcmRpbmF0ZUhhc2g6IGNvb3JkaW5hdGVIYXNoLFxuICAgICAgYWxsaWFuY2VJZDogcmVxdWVzdC5hbGxpYW5jZUlkLFxuICAgICAgc3RhdHVzOiB0ZW1wbGF0ZS5idWlsZFRpbWUgPiAwID8gJ2J1aWxkaW5nJyA6ICdhY3RpdmUnLFxuICAgICAgc3RhdHM6IHtcbiAgICAgICAgZGVmZW5zZTogdGVtcGxhdGUuc3RhdHMuZGVmZW5zZSxcbiAgICAgICAgc3RvcmFnZTogdGVtcGxhdGUuc3RhdHMuc3RvcmFnZSxcbiAgICAgICAgcHJvZHVjdGlvbjogdGVtcGxhdGUuc3RhdHMucHJvZHVjdGlvblxuICAgICAgfSxcbiAgICAgIGNyZWF0ZWRBdDogbm93LFxuICAgICAgbGFzdEFjdGl2ZUF0OiBub3csXG4gICAgICBidWlsZENvbXBsZXRpb25UaW1lOiB0ZW1wbGF0ZS5idWlsZFRpbWUgPiAwID8gbm93ICsgKHRlbXBsYXRlLmJ1aWxkVGltZSAqIDEwMDApIDogdW5kZWZpbmVkXG4gICAgfTtcblxuICAgIC8vIFN0b3JlIGJhc2UgaW4gRHluYW1vREJcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFB1dENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBQTEFZRVJfQkFTRVNfVEFCTEUsXG4gICAgICBJdGVtOiBuZXdCYXNlLFxuICAgICAgQ29uZGl0aW9uRXhwcmVzc2lvbjogJ2F0dHJpYnV0ZV9ub3RfZXhpc3RzKHBsYXllcklkKSBBTkQgYXR0cmlidXRlX25vdF9leGlzdHMoYmFzZUlkKSdcbiAgICB9KTtcblxuICAgIGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuXG4gICAgcmV0dXJuIG5ld0Jhc2U7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgdGhyb3cgbmV3IEdhbWVFbmdpbmVFcnJvcihcbiAgICAgICdGYWlsZWQgdG8gY3JlYXRlIHBsYXllciBiYXNlJyxcbiAgICAgICdCQVNFX0NSRUFUSU9OX0VSUk9SJyxcbiAgICAgIHsgXG4gICAgICAgIHBsYXllcklkOiByZXF1ZXN0LnBsYXllcklkLCBcbiAgICAgICAgYmFzZVR5cGU6IHJlcXVlc3QuYmFzZVR5cGUsXG4gICAgICAgIGVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgXG4gICAgICB9XG4gICAgKTtcbiAgfVxufSJdfQ==